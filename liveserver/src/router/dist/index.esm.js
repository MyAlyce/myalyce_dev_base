/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
function e(e,t,s,i){return new(s||(s=Promise))((function(n,o){function r(e){try{h(i.next(e))}catch(e){o(e)}}function l(e){try{h(i.throw(e))}catch(e){o(e)}}function h(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,l)}h((i=i.apply(e,t||[])).next())}))}const t=e=>(e?`${e}_`:"")+Math.floor(1e5*Math.random()),s=(e=Math,t=Date,s=16,i=(t=>e.floor(t).toString(s)))=>i(t.now()/1e3)+" ".repeat(s).replace(/./g,(()=>i(e.random()*s)));class i{constructor(s){var i;this.id=t("service"),this.name="service",this.callbacks=new Map,this.status=!1,this.serviceType="default",this.routes=[],this.delegate=null===(i=null===globalThis||void 0===globalThis?void 0:globalThis.document)||void 0===i?void 0:i.createDocumentFragment(),this.protocols={},this.services={},this.setEndpointRoute=e=>{this.route=e},this.notify=(t,s,i)=>e(this,void 0,void 0,(function*(){let n=[];return yield Promise.all(Array.from(this.callbacks).map(((o,r)=>e(this,void 0,void 0,(function*(){const e=yield o[1](t,s,i);!e||e instanceof Error||n.push(e)}))))),null==n?void 0:n[0]})),this.setEndpoint=e=>{this.endpoint=e},this.subscribe=e=>{if(e instanceof Function){let s=t();return this.callbacks.set(s,e),s}},this.unsubscribe=e=>this.callbacks.delete(e),this.router=s}addEventListener(...e){var t;null===(t=this.delegate)||void 0===t||t.addEventListener.apply(this.delegate,e)}dispatchEvent(...e){var t;return null===(t=this.delegate)||void 0===t?void 0:t.dispatchEvent.apply(this.delegate,e)}removeEventListener(...e){var t;return null===(t=this.delegate)||void 0===t?void 0:t.removeEventListener.apply(this.delegate,e)}}function n(e,t=!0){let s=(e=e.replace(/\/\*\*?/,"")).split("/");t&&(s=s.slice(0,s.length-1));let i=[e];return i.push(e+"/*"),i.push(e+"/**"),s.forEach(((t,n)=>{let o=s.slice(0,n+1).join("/");o!=e&&(n===s.length-1&&i.push(o+"/*"),i.push(o+"/**"))})),i}class o extends i{constructor(t){super(t),this.responses=new Map,this.serviceType="subscription",this.subscribers=new Map,this.updateSubscribers=(e,t)=>{this.subscribers.forEach((s=>{n(t.route,!1).forEach((i=>{s.routes[i]&&(null==s?void 0:s.send)&&s.send(e.format(t))}))}))},this.add=(e,t)=>{throw"Add not implemented"},this.addResponse=(e,t)=>{this.responses.set(e,t)},this.removeResponse=e=>{e?this.responses.delete(e):this.responses=new Map},this.send=(t,s)=>e(this,void 0,void 0,(function*(){throw"Send not implemented"}))}}function r(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class l{constructor(e=!1,t=!1){r(this,"addFunc",((e=null,t=null,s=!0)=>{var i=null;return null!==t&&(null==e?this.listeners.forEach(((e,n)=>{i=e.listener.addFunc(t),0==e.listener.running&&1==s&&e.listener.start()})):this.listeners.find(((n,o)=>{n.key===e&&(i=n.listener.addFunc(t),0==n.listener.running&&1==s&&n.listener.start())}))),i})),r(this,"getFuncs",(e=>e?this.listeners.find(((t,s)=>{if(t.key===e)return!0})).onchangeFuncs:void 0)),r(this,"removeFuncs",((e=null,t=null,s=!1)=>{null==e?this.listeners.forEach(((e,s)=>{e.listener.removeFuncs(t)})):this.listeners.find(((i,n)=>{i.key===e&&(i.listener.removeFuncs(t),0!==i.listener.onchangeFuncs.length&&!0!==s||i.listener.stop())}))})),this.debug=e,this.listeners=[],this.synchronous=t,this.syncInterval="FRAMERATE",this.syncAnim=void 0,!0===t&&this.startSync()}addListener(e=null,t,s,i,n,o=this.debug,r=!0){if(void 0!==t){var l=e;null==l&&(l=Math.floor(1e5*Math.random())),!0===this.synchronous&&(r=!1);var a={key:l,listener:new h(t,s,i,n,o,r)};this.listeners.push(a)}else console.error("You must assign an object")}getListener(e){return this.listeners.find(((t,s)=>{if(t.key===e)return!0}))}hasKey(e){var t=!1;return this.listeners.forEach(((s,i)=>{if(s.key===e)return t=!0,!0})),t}getKeyIndices(e){var t=[];return this.listeners.find(((s,i)=>{s.key===e&&t.push(i)})),t}onchange(e=null,t=null){null==e?this.listeners.forEach(((e,s)=>{e.listener.onchange=t})):this.listeners.find(((s,i)=>{s.name===e&&(s.listener.onchange=t)}))}stop(e=null){this.synchronous&&this.stopSync(),null==e?this.listeners.forEach(((e,t)=>{e.listener.stop()})):this.listeners.find(((t,s)=>{t.name===e&&t.listener.stop()}))}start(e=null){this.synchronous&&this.stopSync(),null==e?this.listeners.forEach(((e,t)=>{e.listener.start()})):this.listeners.find(((t,s)=>{t.name===e&&t.listener.start()}))}startSync(){if(!1===this.synchronous){this.synchronous=!0,this.stop();let e=()=>{!0===this.synchronous&&(this.listeners.forEach((e=>{e.listener.check()})),"FRAMERATE"===this.syncInterval?this.syncAnim=requestAnimationFrame(e):"number"==typeof this.syncInterval&&setTimeout(e,this.syncInterval))};e()}}stopSync(){this.synchronous=!1,this.syncAnim&&cancelAnimationFrame(this.syncAnim)}remove(e=null){if(null==e)this.listeners.forEach((e=>{e.listener.stop()})),this.listeners.splice(0,this.listeners.length);else{var t=[];this.listeners.forEach(((s,i)=>{s.key===e&&t.push(i)})),t.reverse().forEach((e=>{this.listeners[e].listener.stop(),this.listeners.splice(e,1)}))}}}class h{constructor(e,t="__ANY__",s=this.onchange,i="FRAMERATE",n=!1,o=!0){r(this,"onchange",(e=>{console.log(this.propName," changed from: ",this.propOld," to: ",this.object[this.propName])})),r(this,"addFunc",((e=null)=>{let t=0;return null!==e&&(this.onchangeFuncs.push({idx:this.funcs,onchange:e}),t=this.funcs,this.funcs++),t})),r(this,"onchangeMulti",(e=>{[...this.onchangeFuncs].forEach(((t,s)=>{!0===this.debug&&console.log(t.onchange),t.onchange(e)}))})),r(this,"setListenerRef",(e=>{"__ANY__"===e||null==e?this.propOld=JSON.stringifyFast(this.object):Array.isArray(this.object[e])?this.propOld=JSON.stringifyFast(this.object[e].slice(this.object[e].length-20)):"object"==typeof this.object[e]?this.propOld=JSON.stringifyFast(this.object[e]):"function"==typeof this.object[e]?this.propOld=this.object[e].toString():this.propOld=this.object[e],!0===this.debug&&console.log("propname",e,", new assignment: ",this.propOld)})),r(this,"check",(()=>{let e=!1;if("__ANY__"===this.propName||null===this.propName||void 0===this.propName)this.propOld!==JSON.stringifyFast(this.object)&&(!0===this.debug&&console.log("onchange: ",this.onchange),this.onchange(this.object),this.onchangeFuncs.length>0&&this.onchangeMulti(this.object),this.setListenerRef(this.propName),e=!0);else if(Array.isArray(this.object[this.propName]))this.propOld!==JSON.stringifyFast(this.object[this.propName].slice(this.object[this.propName].length-20))&&(!0===this.debug&&console.log("onchange: ",this.onchange),this.onchange(this.object[this.propName]),this.onchangeFuncs.length>0&&this.onchangeMulti(this.object[this.propName]),this.setListenerRef(this.propName),e=!0);else if("object"==typeof this.object[this.propName]){let t=JSON.stringifyFast(this.object[this.propName]);this.propOld!==t&&(!0===this.debug&&console.log("onchange: ",this.onchange),this.onchange(this.object[this.propName]),this.onchangeFuncs.length>0&&this.onchangeMulti(this.object[this.propName]),this.setListenerRef(this.propName),e=!0)}else"function"==typeof this.object[this.propName]?this.propOld!==this.object[this.propName].toString()&&(!0===this.debug&&console.log("onchange: ",this.onchange),this.onchange(this.object[this.propName].toString()),this.onchangeFuncs.length>0&&this.onchangeMulti(this.object[this.propName].toString()),this.setListenerRef(this.propName),e=!0):this.object[this.propName]!==this.propOld&&(!0===this.debug&&console.log("onchange: ",this.onchange),this.onchange(this.object[this.propName]),this.onchangeFuncs.length>0&&this.onchangeMulti(this.object[this.propName]),this.setListenerRef(this.propName),e=!0);return!0===this.running&&(!0===this.debug&&console.log("checking",this.object,this.propName),"FRAMERATE"===this.interval?"undefined"==typeof window?setTimeout((()=>{this.check()}),16):this.checker=requestAnimationFrame(this.check):setTimeout((()=>{this.check()}),this.interval)),e})),this.debug=n,this.onchange=s,this.onchangeFuncs=[],this.object=e,this.propName=t,this.propOld=void 0,this.setListenerRef(t),this.running=o,this.funcs=0,this.interval,i<10?(this.interval=10,console.log("Min recommended interval set: 10ms")):this.interval=i,!0===o&&("undefined"==typeof window?setTimeout((()=>{this.check()}),60):this.checker=requestAnimationFrame(this.check))}removeFuncs(e=null){let t=0;null===e?this.onchangeFuncs=[]:void 0!==this.onchangeFuncs.find(((s,i)=>{if(s.idx===e)return t=i,!0}))&&this.onchangeFuncs.splice(t,1)}start(){this.running=!0,"undefined"==typeof window?setTimeout((()=>{this.check()}),16):this.checker=requestAnimationFrame(this.check)}stop(){this.running=!1,cancelAnimationFrame(this.checker)}}void 0===JSON.stringifyFast&&(JSON.stringifyFast=function(){const e=new Map,t=[],s=["this"];function i(i,n){let o;if(null!=n)if("object"==typeof n){let r=n.constructor.name;i&&"Object"===r&&function(e,i){var n=t.length-1;if(t[n]){var o=t[n];if("object"==typeof o)if(o[e]===i||0===n)s.push(e),t.push(i.pushed);else for(;n-- >=0;){if("object"==typeof(o=t[n])&&o[e]===i){n+=2,t.length=n,s.length=n,--n,t[n]=i,s[n]=e;break}n--}}}(i,n);let l=e.get(n);if(l)return"[Circular Reference]"+l;if(e.set(n,s.join(".")),"Array"===r)o=n.length>20?n.slice(n.length-20):n;else if(r.includes("Set"))o=Array.from(n);else if("Object"!==r&&"Number"!==r&&"String"!==r&&"Boolean"!==r)o="instanceof_"+r;else if("Object"===r){let e={};for(const t in n)if(null==n[t])e[t]=n[t];else if(Array.isArray(n[t]))n[t].length>20?e[t]=n[t].slice(n[t].length-20):e[t]=n[t];else if("Object"===n[t].constructor.name){e[t]={};for(const s in n[t])if(Array.isArray(n[t][s]))n[t][s].length>20?e[t][s]=n[t][s].slice(n[t][s].length-20):e[t][s]=n[t][s];else if(null!=n[t][s]){let i=n[t][s].constructor.name;i.includes("Set")?e[t][s]=Array.from(n[t][s]):e[t][s]="Number"!==i&&"String"!==i&&"Boolean"!==i?"instanceof_"+i:n[t][s]}else e[t][s]=n[t][s]}else{let s=n[t].constructor.name;s.includes("Set")?e[t]=Array.from(n[t]):e[t]="Number"!==s&&"String"!==s&&"Boolean"!==s?"instanceof_"+s:n[t]}o=e}else o=n}else o=n;return o}return function(n,o){t.push(n);let r=JSON.stringify(n,i,o);return e.clear(),t.length=0,s.length=1,r}}()),void 0===JSON.stringifyWithCircularRefs&&(JSON.stringifyWithCircularRefs=function(){const e=new Map,t=[],s=["this"];function i(i,n){if(null!=n&&"object"==typeof n){i&&function(e,i){var n=t.length-1,o=t[n];if(o[e]===i||0===n)s.push(e),t.push(i);else for(;n-- >=0;)if((o=t[n])[e]===i){n+=2,t.length=n,s.length=n,--n,t[n]=i,s[n]=e;break}}(i,n);let o=e.get(n);if(o)return"[Circular Reference]"+o;e.set(n,s.join("."))}return n}return function(n,o){try{return t.push(n),JSON.stringify(n,i,o)}finally{e.clear(),t.length=0,s.length=1}}}());class a{constructor(e={},t="FRAMERATE",s=!0){r(this,"setupSynchronousUpdates",(()=>{if(!this.listener.hasKey("pushToState")){const e=()=>{if(Object.keys(this.pushToState).length>0){Object.assign(this.data,this.pushToState);for(const e of Object.getOwnPropertyNames(this.pushToState))delete this.pushToState[e]}};this.listener.addListener("pushToState",this.pushToState,"__ANY__",e,this.interval),this.addToState("pushRecord",this.pushRecord,(e=>{let t=e.pushed.length;for(let s=0;s<t;s++){let t=e.pushed[s];this.pushCallbacks.state&&this.pushCallbacks.state.forEach((e=>{e.onchange(t)}));for(const e in t)this.pushCallbacks[e]&&this.pushCallbacks[e].forEach((s=>{"object"==typeof s&&s.onchange(t[e])}))}this.pushRecord.pushed.splice(0,t)}))}})),r(this,"addSecondaryKeyResponse",((e=null,t=null,s=!1,i=this.defaultStartListenerEventLoop)=>{if(null!=t){if(this.listener.hasKey(e))return this.listener.addFunc(e,t);if(null!=e&&"state"!==e)return this.listener.addListener(e,this.data,e,(()=>{}),this.data.stateUpdateInterval,s,i),this.listener.addFunc(e,t);if(!this.listener.hasKey("state")){const e=()=>{this.prev=Object.assign({},this.data)};this.listener.addListener("state",this.data,"__ANY__",e,this.interval)}return this.listener.addFunc("state",t)}})),r(this,"removeState",this.unsubscribeAll),this.data=e,this.interval=t,this.pushToState={},this.pushRecord={pushed:[]},this.pushCallbacks={},this.triggers={},this.prev={},this.listener=new l,this.defaultStartListenerEventLoop=s}subscribe(e,t,s=this.defaultStartListenerEventLoop){return e&&"state"!==e?void 0!==this.data[e]?this.addSecondaryKeyResponse(e,t,void 0,s):void this.addToState(e,null,t,s):this.addSecondaryKeyResponse(e,t,void 0,s)}subscribeOnce(e,t=(e=>{})){let s;s=this.subscribe(e,(i=>{t(i),this.unsubscribe(e,s)}))}unsubscribe(e,t=null){null!==t?this.removeSecondaryKeyResponse(e,t,!0):console.error("Specify a subcription function index")}unsubscribeAll(e){this.unsubscribeAllSequential(e),this.unsubscribeAllTriggers(e),this.clearAllKeyResponses(e),this.data[e]&&delete this.data[e],this.listener.hasKey("pushToState")&&this.setSequentialState({stateRemoved:e})}setInterval(e="FRAMERATE"){this.interval=e,this.listener.listeners.forEach(((e,t)=>{e.interval=this.interval}))}updateState(e,t){null==this.data[e]?this.addToState(e,t):this.data[e]=t}addToState(e,t,s=null,i=this.defaultStartListenerEventLoop,n=!1){if(!this.listener.hasKey("pushToState")&&this.defaultStartListenerEventLoop&&this.setupSynchronousUpdates(),this.data[e]=t,this.setSequentialState({stateAdded:e}),null!==s)return this.addSecondaryKeyResponse(e,s,n,i)}get(e){return this.data[e]}getState(){return JSON.parse(JSON.stringifyFast(this.data))}setState(e={},t=!1){if(!this.listener.hasKey("pushToState")&&this.defaultStartListenerEventLoop&&(this.setupSynchronousUpdates(),this.pushRecord.pushed.push(JSON.parse(JSON.stringifyWithCircularRefs(e)))),e.stateUpdateTimeStamp=Date.now(),t)for(const t in e)if(t in this.pushToState)if(Array.isArray(this.pushToState[t])&&Array.isArray(e[t]))e[t]=this.pushToState[t].push(...e[t]);else if("object"==typeof this.pushToState[t]&&"object"==typeof e[t])for(const s in e[t])if(this.pushToState[t][s])if(Array.isArray(this.pushToState[t][s])&&Array.isArray(e[t][s]))e[t][s]=this.pushToState[t][s].push(...e[t][s]);else if("object"==typeof this.pushToState[t][s]&&"object"==typeof e[t][s])for(const i in e[t][s])if(this.pushToState[t][s][i])Array.isArray(this.pushToState[t][s][i])&&Array.isArray(e[t][s][i])&&(e[t][s][i]=this.pushToState[t][s][i].push(...e[t][s][i]));else if("object"==typeof this.pushToState[t][s][i]&&"object"==typeof e[t][s][i])for(const n in e[t][s][i])this.pushToState[t][s][i][n]&&Array.isArray(this.pushToState[t][s][i][n])&&Array.isArray(e[t][s][i][n])&&(e[t][s][i][n]=this.pushToState[t][s][i][n].push(...e[t][s][i][n]));if(Object.assign(this.pushToState,e),Object.keys(this.triggers).length>0){this.triggers.state&&this.triggers.state.forEach((e=>{e.onchange(this.data)}));for(const e of Object.getOwnPropertyNames(this.triggers))e in this.pushToState&&(this.data[e]=this.pushToState[e],delete this.pushToState[e],this.triggers[e].forEach((t=>{t.onchange(this.data[e])})))}return this.pushToState}subscribeTrigger(e,t=(e=>{})){if(e){this.triggers[e]||(this.triggers[e]=[]);let s=this.triggers[e].length;return this.triggers[e].push({idx:s,onchange:t}),this.triggers[e].length-1}}subscribeTriggerOnce(e,t=(e=>{})){let s;s=this.subscribeTrigger(e,(i=>{t(i),this.unsubscribeTrigger(e,s)}))}unsubscribeTrigger(e,t=0){let s,i=this.triggers[e];if(i){i.find((e=>{if(e.idx===t)return!0}))&&i.splice(s,1)}}unsubscribeAllTriggers(e){e&&this.triggers[e]&&delete this.triggers[e]}setSequentialState(e={}){this.listener.hasKey("pushToState")||this.setupSynchronousUpdates(),e.stateUpdateTimeStamp=Date.now(),this.pushRecord.pushed.push(JSON.parse(JSON.stringify(e)))}subscribeSequential(e,t){if(e){if(void 0===this.data[e]&&"state"!==e&&this.addToState(e,null,void 0),this.pushCallbacks[e]||(this.pushCallbacks[e]=[]),t){let s=this.pushCallbacks[e].length;return this.pushCallbacks[e].push({idx:s,onchange:t}),this.pushCallbacks[e].length-1}}else;}subscribeSequentialOnce(e,t=(e=>{})){let s;s=this.subscribeSequential(e,(i=>{t(i),this.unsubscribeSequential(e,s)}))}unsubscribeSequential(e,t=0){e&&this.pushCallbacks[e]&&this.pushCallbacks[e].find(((s,i)=>{if(s.idx===t)return this.pushCallbacks[e].splice(i,1),!0}))}unsubscribeAllSequential(e){e&&this.pushCallbacks[e]&&this.pushCallbacks[e]&&delete this.pushCallbacks[e]}setPrimaryKeyResponse(e=null,t=null,s=!1,i=this.defaultStartListenerEventLoop){if(null!==t)if(this.listener.hasKey(e))this.listener.onchange(e,t);else{if(null==e||"state"===e){if(!this.listener.hasKey("state")){const e=()=>{this.prev=Object.assign({},this.data)};this.listener.addListener("state",this.data,"__ANY__",e,this.interval)}return this.listener.addFunc("state",t)}this.listener.addListener(e,this.data,e,t,this.data.stateUpdateInterval,s,i)}}removeSecondaryKeyResponse(e=null,t=null,s=!0){null!==e?this.listener.hasKey(e)?this.listener.removeFuncs(e,t,s):console.error("key does not exist"):console.error("provide key")}clearAllKeyResponses(e=null){null===e?this.listener.remove(null):this.listener.hasKey(e)&&this.listener.remove(e)}getKeySubCallbacks(e){return this.listener.getFuncs(e)}runSynchronousListeners(){this.defaultStartListenerEventLoop=!1,this.listener.startSync()}stop(e=null){this.listener.stop(e)}}void 0===JSON.stringifyFast&&(JSON.stringifyFast=function(){const e=new Map,t=[],s=["this"];function i(i,n){let o;if(null!=n)if("object"==typeof n){let r=n.constructor.name;i&&"Object"===r&&function(e,i){var n=t.length-1;if(t[n]){var o=t[n];if("object"==typeof o)if(o[e]===i||0===n)s.push(e),t.push(i.pushed);else for(;n-- >=0;){if("object"==typeof(o=t[n])&&o[e]===i){n+=2,t.length=n,s.length=n,--n,t[n]=i,s[n]=e;break}n++}}}(i,n);let l=e.get(n);if(l)return"[Circular Reference]"+l;if(e.set(n,s.join(".")),"Array"===r)o=n.length>20?n.slice(n.length-20):n;else if(r.includes("Set"))o=Array.from(n);else if("Object"!==r&&"Number"!==r&&"String"!==r&&"Boolean"!==r)o="instanceof_"+r;else if("Object"===r){let e={};for(const t in n)if(null==n[t])e[t]=n[t];else if(Array.isArray(n[t]))n[t].length>20?e[t]=n[t].slice(n[t].length-20):e[t]=n[t];else if("Object"===n[t].constructor.name){e[t]={};for(const s in n[t])if(Array.isArray(n[t][s]))n[t][s].length>20?e[t][s]=n[t][s].slice(n[t][s].length-20):e[t][s]=n[t][s];else if(null!=n[t][s]){let i=n[t][s].constructor.name;i.includes("Set")?e[t][s]=Array.from(n[t][s]):e[t][s]="Number"!==i&&"String"!==i&&"Boolean"!==i?"instanceof_"+i:n[t][s]}else e[t][s]=n[t][s]}else{let s=n[t].constructor.name;s.includes("Set")?e[t]=Array.from(n[t]):e[t]="Number"!==s&&"String"!==s&&"Boolean"!==s?"instanceof_"+s:n[t]}o=e}else o=n}else o=n;return o}return function(n,o){t.push(n);let r=JSON.stringify(n,i,o);return e.clear(),t.length=0,s.length=1,r}}()),void 0===JSON.stringifyWithCircularRefs&&(JSON.stringifyWithCircularRefs=function(){const e=new Map,t=[],s=["this"];function i(i,n){if(null!=n&&"object"==typeof n){i&&function(e,i){var n=t.length-1,o=t[n];if("object"==typeof o)if(o[e]===i||0===n)s.push(e),t.push(i.pushed);else for(;n-- >=0;){if("object"==typeof(o=t[n])&&o[e]===i){n+=2,t.length=n,s.length=n,--n,t[n]=i,s[n]=e;break}n--}}(i,n);let o=e.get(n);if(o)return"[Circular Reference]"+o;e.set(n,s.join("."))}return n}return function(n,o){try{return t.push(n),JSON.stringify(n,i,o)}finally{e.clear(),t.length=0,s.length=1}}}());const c=(e,t=!0)=>{e instanceof Object&&(e=Array.isArray(e)?[...e]:Object.assign({},e));for(let t in e)e[t]instanceof Function&&(e[t]=e[t].toString()),e[t]instanceof Object&&(e[t]=c(e[t],!1));return t?JSON.stringify(e):e};var u=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,d=/([^\s,]+)/g;try{if("object"==typeof process){const e=require("node-fetch");"function"!=typeof globalThis.fetch&&(globalThis.fetch=e)}}catch(e){}class p{constructor(i="https://localhost",n,o){let r,l;this.id=null,this.target=null,this.type=null,this.link=null,this.credentials={},this.connection=null,this.services={available:{},connecting:{},queue:{}},this.router=null,this.clients={},this.user=s(),this.status=!1,this.responses={},this.setCredentials=e=>{var t;e&&(e._id||e.id)&&(this.credentials={_id:null!==(t=e._id)&&void 0!==t?t:s(),id:e.id||e._id})},this.check=()=>e(this,void 0,void 0,(function*(){var t,s,i,n,o,r;"webrtc"===this.type&&(yield this._subscribe({protocol:"webrtc",force:!0}).then((e=>{this.status=!0})).catch((e=>console.log("Link doesn't have WebRTC enabled.",e))));const l=()=>e(this,void 0,void 0,(function*(){return yield this._subscribe({protocol:"websocket",force:!0}).then((e=>(this.status=!0,e))),yield this.send("services")})),h=()=>e(this,void 0,void 0,(function*(){return yield this.send("services")}));let a;if("websocket"===this.type?yield l().then((e=>(this.status=!0,e))).catch((t=>e(this,void 0,void 0,(function*(){if("websocket"===this.type)return console.log("Falling back to http"),yield h()})))):a=yield h().then((e=>(this.status=!0,e))).catch((t=>e(this,void 0,void 0,(function*(){return console.log("Falling back to websockets"),yield l()})))),a){console.log("Connection successful!");const e=a.message[0];for(let r in e){const l=e[r].replace(/Backend|Service/,"").toLowerCase();this.services.available[l]=r,(null===(i=null===(s=null===(t=this.router)||void 0===t?void 0:t.SERVICES)||void 0===s?void 0:s[l])||void 0===i?void 0:i.status)instanceof Function&&this.router.SERVICES[l].status(r),"subscription"===(null===(n=this.clients[l])||void 0===n?void 0:n.serviceType)&&(null===(o=this.services.queue[l])||void 0===o||o.forEach((e=>e())),this.services.queue[l]=[])}null===(r=this.services.queue[void 0])||void 0===r||r.forEach((e=>e())),this.services.queue[void 0]=[]}else console.log("Connection failed!");return null==a?void 0:a.message})),this.send=(t,s={},i=(()=>{}))=>e(this,void 0,void 0,(function*(){var n,o,r,l,h,a,u,d;if("string"==typeof t)s.route=t;else{const e=this.services[t.service];s.route=e?`${e}/${t.route}`:t.route}let p;s.suppress=!!this.connection;const f={suppress:s.suppress,id:null===(n=this.link.connection)||void 0===n?void 0:n.id};if("websocket"===(null===(o=this.connection)||void 0===o?void 0:o.protocol))s.id=null===(r=this.link.credentials)||void 0===r?void 0:r.id,p=yield this.link.connection.service.send(s,f);else if("webrtc"===(null===(l=null==this?void 0:this.connection)||void 0===l?void 0:l.protocol))s.id=(null===(h=this.credentials)||void 0===h?void 0:h.id)||(null===(a=this.link.credentials)||void 0===a?void 0:a.id),p=yield this.connection.service.send(s,f);else{s.id=null===(u=this.link.credentials)||void 0===u?void 0:u.id,s.method||(s.method=(null===(d=s.message)||void 0===d?void 0:d.length)>0?"POST":"GET");const t={method:s.method.toUpperCase(),mode:"cors",headers:{"Content-Type":"application/json"}};"GET"!=t.method&&(t.body=c(s)),p=yield fetch(function(e,t){let s=t instanceof URL?t:new URL(t);return e="/"===s.pathname?e:s.pathname+e,new URL(e,s.href).href}(s.route,this.link.target),t).then((t=>e(this,void 0,void 0,(function*(){const s=t.body.getReader(),n=t.headers.get("Content-Length");let o=0;if(globalThis.ReadableStream){const r=new ReadableStream({start(t){const r=()=>e(this,void 0,void 0,(function*(){s.read().then((({value:e,done:s})=>{s?t.close():(o+=e.length,i(o/n,n),t.enqueue(e),r())}))}));r()}});return new Response(r,{headers:t.headers})}return t})))),p=p?yield p.json().then((e=>{if(p.ok)return e;throw e.message})).catch((t=>e(this,void 0,void 0,(function*(){throw"Invalid JSON"})))):p}return p&&!(null==p?void 0:p.route)&&(p.route=s.route,p.block=!0),p})),this._subscribe=(t={})=>e(this,void 0,void 0,(function*(){let s=()=>new Promise((i=>e(this,void 0,void 0,(function*(){var n;let o=null!==(n=t.protocol)&&void 0!==n?n:this.type;(o?[this.clients[o]]:Object.values(this.clients)).forEach((s=>e(this,void 0,void 0,(function*(){var e;if(s&&t.force||!0===(null==s?void 0:s.status)&&"subscription"===(null==s?void 0:s.serviceType)){let n=`${null!==(e=this.link.services.available[null==s?void 0:s.service])&&void 0!==e?e:s.name.toLowerCase()}/subscribe`;if(s.setEndpoint(this.link),!this.connection){const e="http"===this.type||"websocket"===this.type?new URL(n,this.target):this.target,t=yield s.add(this.credentials,e.href);this.router&&s.addResponse("router",(e=>{const t="string"==typeof e?JSON.parse(e):e;Object.values(this.responses).forEach((e=>{e(t)})),this.router&&this.router.handleLocalRoute(t)})),this.connection={service:s,id:t,protocol:s.name}}return"webrtc"===this.type&&(t.routes=[this.target]),yield this.link.send(n,Object.assign({route:t.route,message:t.message,protocol:t.protocol},{message:[t.routes,this.connection.id]})),void i(this.connection)}})))),this.services.queue[o]||(this.services.queue[o]=[]),this.services.queue[o].push((()=>e(this,void 0,void 0,(function*(){let e=yield s();i(e)}))))}))));return yield s()})),this.subscribe=e=>{if(e){let s=t("response");return this.responses[s]=e,s}},this.unsubscribe=e=>{e?delete this.responses[e]:this.responses={}},"object"==typeof i?i instanceof URL?r=i:(r=i.target,l=i.type,this.link=i.link,this.setCredentials(i.credentials)):r=i,l||(l="http"),this.link||(this.link=this),"http"===l||"websocket"===l?(r=r instanceof URL?r:new URL(r),this.id=r.origin):this.id=r,this.target=r,this.type=l,this.router=o,n&&(this.clients=n)}}const f="DONOTSEND";class g{constructor(s={debug:!1}){this.id=t(),this.USERS={},this.CONNECTIONS=new Map,this.SUBSCRIPTIONS=[],this.ENDPOINTS={},this.SERVICES={},this.ROUTES={},this.INTERVAL=10,this.DEFAULTROUTES=[{route:"ping",post:()=>"pong"},{route:"services/**",get:{object:this.SERVICES,transform:(e,...t)=>{let s={};return(t.length>0?[t[0]]:Object.keys(e)).forEach((t=>{const i=e[t];"default"===(null==i?void 0:i.serviceType)&&(s[t]=i.name)})),t.forEach(((e,t)=>s=s[e])),s}}},{route:"/",aliases:["routes/**"],get:{object:this.ROUTES,transform:(e,...t)=>{let s={};return(t.length>0?[t[0]]:Object.keys(e)).forEach((t=>{t&&(s[t]={route:e[t].route.split("/").filter((e=>!e.match(/\*\*?/))).join("/"),args:e[t].args,wildcard:t.includes("*")})})),t.forEach(((e,t)=>s=s[e])),s}}},{route:"sendMessage",aliases:["message","sendMsg"],post:(e,t)=>e.sendMsg(t[0],t[1],t[2])},{route:"setUserServerDetails",post:(e,t,s)=>{let i=e.USERS[s];if(!i)return!1;t[0]&&(i.username=t[0]),t[1]&&(i.password=t[1]),t[2]&&(i.props=t[2]),t[3]&&(i._id=t[3],i.id=t[3])}},{route:"setProps",post:(e,t,s)=>{let i=e.USERS[s];if(!i)return!1;if("object"==typeof t&&!Array.isArray(t))return Object.assign(i.props,t),!0;if(Array.isArray(t)&&"object"==typeof t[1]){let s=e.USERS[t[0]];return s&&Object.assign(s.props,t[1]),!0}return!1}},{route:"getProps",post:(e,t,s)=>{let i=e.USERS[s];if(!i)return!1;if(!t[0])return i.props;{let s=e.USERS[t[0]];if(s)return s.props}}},{route:"blockUser",post:(e,t,s)=>{let i=e.USERS[s];return!!i&&this.blockUser(i,t[0])}},{route:"users/**",get:{object:this.USERS,transform:(e,...t)=>{let s={};return(t.length>0?[t[0]]:Object.keys(e)).forEach((t=>{const i=e[t];s[t]={_id:i._id,username:i.username,origin:i.origin,props:i.props,updatedPropNames:i.updatedPropNames,lastUpdate:i.lastUpdate,lastTransmit:i.lastTransmit,latency:i.latency}})),t.forEach(((e,t)=>s=s[e])),s}}},{route:"getUser",post:(e,t,s)=>{let i=e.USERS[s];if(!i)return!1;if(!t[0])return{_id:i._id,username:i.username,origin:i.origin,props:i.props,updatedPropNames:i.updatedPropNames,lastUpdate:i.lastUpdate,lastTransmit:i.lastTransmit,latency:i.latency};{let e=this.USERS[t[0]];if(e)return{_id:e._id,username:e.username,origin:e.origin,props:e.props,updatedPropNames:e.updatedPropNames,lastUpdate:e.lastUpdate,lastTransmit:e.lastTransmit,latency:e.latency}}}},{route:"login",aliases:["addUser","startSession"],post:(t,s,i)=>e(this,void 0,void 0,(function*(){let e=yield t.addUser(...s);return{message:!!e,id:e.id}}))},{route:"logout",aliases:["removeUser","endSession"],post:(e,t,s)=>{let i=e.USERS[s];if(!i)return!1;t[0]?e.removeUser(...t):e.removeUser(i)}}],this.protocols={},this.connect=(e,t)=>{let s=new p(e,this.SERVICES,this);return this.ENDPOINTS[s.id]=s,s.check().then((e=>{e&&(t&&t(s),this.login(s))})),s},this.disconnect=t=>e(this,void 0,void 0,(function*(){this.logout(this.ENDPOINTS[t]),delete this.ENDPOINTS[t]})),this._loadBackend=(t,s=t.name)=>{var i;this.SERVICES[s]=t,this.SERVICES[s].status=!0,null===(i=t.routes)||void 0===i||i.forEach((e=>this.addRoute(Object.assign({service:s},e)))),t.subscribe&&t.subscribe(((s,i,n)=>e(this,void 0,void 0,(function*(){let e=yield this.handleMessage(s,i);if(null==n?void 0:n.includes("worker")){if(null===e||!t[n])return e;t[n].postMessage({route:"worker/workerPost",message:e,origin:t.id,callbackId:s.callbackId})}return e})))),"subscription"===(null==t?void 0:t.serviceType)&&this.SUBSCRIPTIONS.push(t.updateSubscribers)},this._loadService=(t,s=(null==t?void 0:t.name))=>e(this,void 0,void 0,(function*(){return this._loadBackend(t,s),yield this._loadClient(t,s,!0)})),this._loadClient=(t,s,i=!1)=>new Promise((s=>{const n=t.name;if(t.subscribe&&t.subscribe(((s,i)=>e(this,void 0,void 0,(function*(){var e;const o=this.SERVICES[n],r=!0===o.status;let l;return"local"===i?l=yield this.handleLocalRoute(s):r&&(l=yield this.send({route:`${o.route}/${s.route}`,endpoint:null==t?void 0:t.endpoint},...null!==(e=s.message)&&void 0!==e?e:[])),l})))),i)s(t);else{this.SERVICES[n]=t;const e=e=>{this.SERVICES[n].status=!0,t.setEndpointRoute instanceof Function&&t.setEndpointRoute(e),t.routes.forEach((t=>{this.ROUTES[`${e}/${t.route}`]=t})),s(t)};!0===this.SERVICES[n].status?e(this.SERVICES[n]):this.SERVICES[n].status=e}})),this.get=(e,...t)=>this._send(e,"GET",...t),this.delete=(e,...t)=>this._send(e,"DELETE",...t),this.post=(e,...t)=>this._send(e,"POST",...t),this.send=this.post,this._send=(t,s,...i)=>e(this,void 0,void 0,(function*(){let e,n;if(e="string"==typeof t||null==(null==t?void 0:t.endpoint)?Object.values(this.ENDPOINTS)[0]:t.endpoint,e)return n=yield e.send(t,{message:i,method:s}),n&&this.handleLocalRoute(n,e),null==n?void 0:n.message})),this.handleLocalRoute=(t,s,i)=>e(this,void 0,void 0,(function*(){var e,n,o;if(s&&i&&!t.suppress&&s.connection&&(null===(o=null===(n=null===(e=s.connection)||void 0===e?void 0:e.service)||void 0===n?void 0:n.responses)||void 0===o||o.forEach((e=>e(Object.assign({route:i},t))))),!t.block){let e=this.ROUTES[null==t?void 0:t.route];if((null==e?void 0:e.post)instanceof Function)return e.post(this,t.message,t.id)}})),this.subscribe=(t,s={})=>e(this,void 0,void 0,(function*(){if(Object.keys(this.ENDPOINTS).length>0||(null==s?void 0:s.endpoint)){s.endpoint||(s.endpoint=Object.values(this.ENDPOINTS)[0]);return yield s.endpoint._subscribe(s).then((e=>s.endpoint.subscribe(t)))}throw"Remote is not specified"})),this.handleMessage=(t,s)=>e(this,void 0,void 0,(function*(){var e;let s={};if(Array.isArray(t))s.route=t[0],s.message=t.slice(1),s.callbackId=void 0;else if("string"==typeof t){let e=t.split(" ");s.route=e[0],s.message=e.slice(1),s.callbackId=void 0}else"object"==typeof t&&Object.assign(s,t);if("object"==typeof s&&!Array.isArray(s)&&null!=s.route){let t=this.USERS[null==s?void 0:s.id];console.log("runRoute",s.route);const i=yield this.runRoute(s.route,s.method,s.message,null!==(e=null==t?void 0:t.id)&&void 0!==e?e:s.id,s.callbackId);return i&&s.suppress&&(i.suppress=s.suppress),i}return null})),s.interval&&(this.INTERVAL=s.interval),this.STATE=new a({},this.INTERVAL,void 0),this.DEBUG=null==s?void 0:s.debug,"onbeforeunload"in globalThis&&(globalThis.onbeforeunload=()=>{Object.values(this.ENDPOINTS).forEach((e=>{"webrtc"!=e.type&&this.logout(e)}))}),this.load({routes:this.DEFAULTROUTES}),this.DEBUG&&this.runCallback("routes",[!0]),(null==s?void 0:s.endpoints)&&s.endpoints.forEach((e=>this.connect(e)))}login(t,s){return e(this,void 0,void 0,(function*(){yield this.logout(t);const i=Object.values(t?{endpoint:t}:this.ENDPOINTS);let n=yield Promise.all(i.map((t=>e(this,void 0,void 0,(function*(){let e=yield this.send({route:"login",endpoint:t},s);return console.log(e),t.setCredentials(e),e})))));return 1===n.reduce(((e,t)=>e*t[0]),!0)}))}logout(t){return e(this,void 0,void 0,(function*(){return 1===(yield Promise.all(Object.values(t?{endpoint:t}:this.ENDPOINTS).map((t=>e(this,void 0,void 0,(function*(){return yield this.send({route:"logout",endpoint:t},t.credentials)})))))).reduce(((e,t)=>e*t[0]),!0)}))}load(t,s=t.name){return e(this,void 0,void 0,(function*(){let e="client"===t.constructor.type,i=!t.constructor.type||"service"===t.constructor.type,n="backend"===t.constructor.type;return i&&(yield this._loadService(t,s)),n&&(yield this._loadBackend(t,s)),e&&(yield this._loadClient(t)),t}))}format(e,t={}){return void 0!==e&&(e&&"object"==typeof e&&("message"in e||"route"in e)||(e={message:e}),Array.isArray(e.message)||(e.message=[e.message]),t.service&&(null==e?void 0:e.route)&&(e.route=`${t.service}/${e.route}`),t.headers&&(e.headers=t.headers)),(null==e?void 0:e.route)&&(e.route=e.route.replace(/\/\*\*?/,"")),e}runRoute(t,s,i=[],n,o){return e(this,void 0,void 0,(function*(){try{if(null==t)return;return!s&&Array.isArray(i)&&(s=i.length>0?"POST":"GET"),this.DEBUG&&console.log("route",t),yield this.runCallback(t,i,n,s).then((e=>{if(this.DEBUG&&console.log("Result:",e),void 0!==e&&((e=this.format(e)).callbackId=o,this.ROUTES[e.route]&&(e.block=!0),"DONOTSEND"!==e.message))return e})).catch(console.error)}catch(e){return new Error("Route failed...")}}))}addUser(e){if(e&&(e.id||e._id)){e._id||(e._id=s()),e.id||(e.id=e._id);const t=this.USERS[e._id];let i=null!=t?t:{id:e.id,_id:e._id,username:e.id,origin:e.id,props:{},updatedPropNames:[],sessions:[],blocked:[],lastUpdate:Date.now(),lastTransmit:0,latency:0,routes:new Map};Object.assign(i,e),this.DEBUG&&console.log("Adding User, Id:",e._id),this.USERS[e.id]=i;for(let t in this.SERVICES){const s=this.SERVICES[t];if(!0===s.status){n(s.name+"/users").forEach((t=>{this.ROUTES[t]&&this.runRoute(t,"POST",[i],e._id)}))}}return i}return!1}removeUser(e){let t="string"==typeof e?this.USERS[e]:e;return!!t&&(Object.values(this.SERVICES).forEach((e=>{if(!0===e.status){const s=e.name+"/users";this.ROUTES[s]&&this.runRoute(s,"DELETE",[t],t.id)}})),delete t.id,!0)}blockUser(e,t=""){return!(!this.USERS[t]||e.blocked.includes(t)||e.id===t)&&(e.blocked.push(t),!0)}sendMsg(e="",t="",s){let i=s?Object.assign(s,{message:t}):{message:t};if("string"==typeof e){let t=this.USERS[e];t&&t.send(i)}else if("object"==typeof e)return e.send(i),!0;return!1}addRoute(e){const t=[(e=Object.assign({},e)).route,...e.aliases?e.aliases:[]];return delete e.aliases,t.forEach((t=>{var s,i;if(!t||!e.post&&!e.get)return!1;t=e.route=""+(e.service?`${e.service}/`:"")+t,this.removeRoute(t),"/"===t[0]&&(t=t.slice(1)),e.args=function(e){if(e instanceof Function){var t=e.toString().replace(u,""),s=t.slice(t.indexOf("(")+1,t.indexOf(")")).match(d);return null===s&&(s=[]),s}}(e.post),this.ROUTES[t]=Object.assign(e,{route:t}),e.get&&(this.STATE.setState({[t]:null!==(i=null===(s=e.get)||void 0===s?void 0:s.object)&&void 0!==i?i:e.get}),this.STATE.subscribe(t,(s=>{var i;const n=(null===(i=e.get)||void 0===i?void 0:i.transform)?e.get.transform(s):s;this.SUBSCRIPTIONS.forEach((e=>e(this,{route:t,message:n})))})))})),!0}removeRoute(e){return delete this.ROUTES[e]}runCallback(t,s=[],i,o=(s.length>0?"POST":"GET")){return new Promise((r=>e(this,void 0,void 0,(function*(){let l=n(t),h={route:t,block:!0,message:{html:'<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="utf-8">\n<title>Error</title>\n</head>\n<body>\n<pre>404 Not Found</pre>\n</body>\n</html>'},headers:{"Content-Type":"text/html"}};Promise.all(l.map((n=>e(this,void 0,void 0,(function*(){var e;let l=this.ROUTES[n];if(l){this.DEBUG&&console.log("routeInfo",l);try{let n;if((null==l?void 0:l.delete)&&"DELETE"===o.toUpperCase())n=yield l.delete(this,s,i);else if("GET"!==o.toUpperCase()&&(null==l?void 0:l.post))n=(null==l?void 0:l.post)?yield null==l?void 0:l.post(this,s,i):h;else{const s=this.STATE.data[l.route];if(s){const i=t.replace(l.route.split("/").filter((e=>"*"!=e&&"**"!=e)).join("/"),"").split("/").filter((e=>!!e));n={message:(null===(e=l.get)||void 0===e?void 0:e.transform)?yield l.get.transform(s,...i):s}}else n=h}r(this.format(n,l))}catch(e){console.log("Callback Failed: ",e)}}}))))).then((e=>r(h)))}))))}checkRoutes(t){var s,i;return e(this,void 0,void 0,(function*(){if(!t.data)return;let e=null!==(i=null!==(s=this.ROUTES[t.data.foo])&&void 0!==s?s:this.ROUTES[t.data.route])&&void 0!==i?i:this.ROUTES[t.data.functionName];return e||(e=this.ROUTES[t.data.foo]),!!e&&(t.data.message?yield e.post(this,t.data.message,t.data.origin):void 0)}))}}export{f as DONOTSEND,p as Endpoint,g as Router,i as Service,o as SubscriptionService};
