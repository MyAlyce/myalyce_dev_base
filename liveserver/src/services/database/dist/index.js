!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).database={})}(this,(function(t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function e(t,e,i,s){return new(i||(i=Promise))((function(r,n){function o(t){try{l(s.next(t))}catch(t){n(t)}}function a(t){try{l(s.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}l((s=s.apply(t,e||[])).next())}))}const i=t=>(t?`${t}_`:"")+Math.floor(1e5*Math.random()),s=(t=Math,e=Date,i=16,s=(e=>t.floor(e).toString(i)))=>s(e.now()/1e3)+" ".repeat(i).replace(/./g,(()=>s(t.random()*i)));for(var r=Math.floor(16777215*Math.random()),n=c.index=parseInt(16777215*Math.random(),10),o=("undefined"==typeof process||"number"!=typeof process.pid?Math.floor(1e5*Math.random()):process.pid)%65535,a=function(t){return!(null==t||!t.constructor||"function"!=typeof t.constructor.isBuffer||!t.constructor.isBuffer(t))},l=[],h=0;h<256;h++)l[h]=(h<=15?"0":"")+h.toString(16);var d=new RegExp("^[0-9a-fA-F]{24}$"),u=[];for(h=0;h<10;)u[48+h]=h++;for(;h<16;)u[55+h]=u[87+h]=h++;function c(t){if(!(this instanceof c))return new c(t);if(t&&(t instanceof c||"ObjectID"===t._bsontype))return t;if(this._bsontype="ObjectID",null!=t&&"number"!=typeof t){var e=c.isValid(t);if(!e&&null!=t)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");if(e&&"string"==typeof t&&24===t.length)return c.createFromHexString(t);if(null==t||12!==t.length){if(null!=t&&"function"==typeof t.toHexString)return t;throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters")}this.id=t}else this.id=this.generate(t)}var f=c;c.default=c,c.createFromTime=function(t){return t=parseInt(t,10)%4294967295,new c((e=8,((i=(i=t).toString(16)).length===e?i:"00000000".substring(i.length,e)+i)+"0000000000000000"));var e,i},c.createFromHexString=function(t){if(void 0===t||null!=t&&24!==t.length)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");for(var e="",i=0;i<24;)e+=String.fromCharCode(u[t.charCodeAt(i++)]<<4|u[t.charCodeAt(i++)]);return new c(e)},c.isValid=function(t){return null!=t&&("number"==typeof t||("string"==typeof t?12===t.length||24===t.length&&d.test(t):t instanceof c||(!!a(t)||"function"==typeof t.toHexString&&(t.id instanceof _Buffer||"string"==typeof t.id)&&(12===t.id.length||24===t.id.length&&d.test(t.id)))))},c.prototype={constructor:c,toHexString:function(){if(!this.id||!this.id.length)throw new Error("invalid ObjectId, ObjectId.id must be either a string or a Buffer, but is ["+JSON.stringify(this.id)+"]");if(24===this.id.length)return this.id;if(a(this.id))return this.id.toString("hex");for(var t="",e=0;e<this.id.length;e++)t+=l[this.id.charCodeAt(e)];return t},equals:function(t){return t instanceof c?this.toString()===t.toString():"string"==typeof t&&c.isValid(t)&&12===t.length&&a(this.id)?t===this.id.toString("binary"):"string"==typeof t&&c.isValid(t)&&24===t.length?t.toLowerCase()===this.toHexString():"string"==typeof t&&c.isValid(t)&&12===t.length?t===this.id:!(null==t||!(t instanceof c||t.toHexString))&&t.toHexString()===this.toHexString()},getTimestamp:function(){var t,e=new Date;return t=a(this.id)?this.id[3]|this.id[2]<<8|this.id[1]<<16|this.id[0]<<24:this.id.charCodeAt(3)|this.id.charCodeAt(2)<<8|this.id.charCodeAt(1)<<16|this.id.charCodeAt(0)<<24,e.setTime(1e3*Math.floor(t)),e},generate:function(t){"number"!=typeof t&&(t=~~(Date.now()/1e3)),t=parseInt(t,10)%4294967295;var e=n=(n+1)%16777215;return String.fromCharCode(t>>24&255,t>>16&255,t>>8&255,255&t,r>>16&255,r>>8&255,255&r,o>>8&255,255&o,e>>16&255,e>>8&255,255&e)}};var p=Symbol&&Symbol.for&&Symbol.for("nodejs.util.inspect.custom")||"inspect";c.prototype[p]=function(){return"ObjectID("+this+")"},c.prototype.toJSON=c.prototype.toHexString,c.prototype.toString=c.prototype.toHexString;var g=Object.defineProperty,v=(t,e)=>{for(var i in e)g(t,i,{get:e[i],enumerable:!0})},y=(t,e,i)=>(((t,e,i)=>{e in t?g(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i})(t,"symbol"!=typeof e?e+"":e,i),i),m={};function b(t="struct",e={},i={_id:""},s={structType:"struct",_id:""}){let r={_id:function(t=""){return`${t+Math.floor(Math.random()+Math.random()*Math.random()*1e16)}`}(t+"defaultId"),structType:t,ownerId:i?._id,timestamp:Date.now(),parent:{structType:s?.structType,_id:s?._id}};return r.ownerId||delete r.ownerId,r?.parent?._id||delete r.parent,Object.keys(e).length>0&&Object.assign(r,e),r}v(m,{AuthorizationStruct:()=>C,ChatroomStruct:()=>B,CoherenceMap:()=>O,CoherenceStruct:()=>w,CommentStruct:()=>G,DataStruct:()=>P,DateStruct:()=>$,ECGStruct:()=>R,EDAStruct:()=>z,EEGCoordinates:()=>I,EEGStruct:()=>E,EMGStruct:()=>M,EventStruct:()=>F,EyeTrackerStruct:()=>D,FNIRSStruct:()=>A,FrequencyBandsStruct:()=>T,GroupStruct:()=>L,HRVStruct:()=>N,IMUStruct:()=>k,NotificationStruct:()=>J,PPGStruct:()=>U,ProfileStruct:()=>j,ScheduleStruct:()=>q,Struct:()=>b,eegCoordinates:()=>S,setCoordinate:()=>_,structRegistry:()=>W});var S={FP1:[-21.2,66.9,12.1],FPZ:[1.4,65.1,11.3],FP2:[24.3,66.3,12.5],AF7:[-41.7,52.8,11.3],AF3:[-32.7,48.4,32.8],AFZ:[1.8,54.8,37.9],AF4:[35.1,50.1,31.1],AF8:[43.9,52.7,9.3],F5:[-51.4,26.7,24.7],F3:[-39.7,25.3,44.7],F1:[-22.1,26.8,54.9],FZ:[0,26.8,60.6],F2:[23.6,28.2,55.6],F4:[41.9,27.5,43.9],F6:[52.9,28.7,25.2],F7:[-52.1,28.6,3.8],F8:[53.2,28.4,3.1],FC5:[-59.1,3,26.1],FC3:[-45.5,2.4,51.3],FC1:[-24.7,.3,66.4],FCZ:[1,1,72.8],FC2:[26.1,3.2,66],FC4:[47.5,4.6,49.7],FC6:[60.5,4.9,25.5],FT9:[-53.8,-2.1,-29.1],FT7:[-59.2,3.4,-2.1],FT8:[60.2,4.7,-2.8],FT10:[55,-3.6,-31],T7:[-65.8,-17.8,-2.9],T5:[-61.5,-65.3,1.1],T3:[-70.2,-21.3,-10.7],T4:[71.9,-25.2,-8.2],T6:[59.3,-67.6,3.8],T8:[67.4,-18.5,-3.4],C5:[-63.6,-18.9,25.8],C3:[-49.1,-20.7,53.2],C1:[-25.1,-22.5,70.1],CZ:[.8,-21.9,77.4],C2:[26.7,-20.9,69.5],C4:[50.3,-18.8,53],C6:[65.2,-18,26.4],CP5:[-61.8,-46.2,22.5],CP3:[-46.9,-47.7,49.7],CP1:[-24,-49.1,66.1],CPZ:[.7,-47.9,72.6],CP2:[25.8,-47.1,66],CP4:[49.5,-45.5,50.7],CP6:[62.9,-44.6,24.4],TP9:[-73.6,-46.7,-4],TP7:[-63.6,-44.7,-4],TP8:[64.6,-45.4,-3.7],TP10:[74.6,-47.4,-3.7],P9:[-50.8,-51.3,-37.7],P7:[-55.9,-64.8,0],P5:[-52.7,-67.1,19.9],P3:[-41.4,-67.8,42.4],P1:[-21.6,-71.3,52.6],PZ:[.7,-69.3,56.9],P2:[24.4,-69.9,53.5],P4:[44.2,-65.8,42.7],P6:[54.4,-65.3,20.2],P8:[56.4,-64.4,.1],P10:[51,-53.9,-36.5],PO7:[-44,-81.7,1.6],PO3:[-33.3,-84.3,26.5],POZ:[0,-87.9,33.5],PO4:[35.2,-82.6,26.1],PO8:[43.3,-82,.7],O1:[-25.8,-93.3,7.7],OZ:[.3,-97.1,8.7],O2:[25,-95.2,6.2]};function _(t,e={}){if(!S[t.tag]&&t.position&&(S[t.tag]=[t.position.x,t.position.y,t.position.z]),S[t.tag]){let i={channel:"",position:{x:S[t.tag][0],y:S[t.tag][1],z:S[t.tag][2]}};return Object.assign(e,i)}return Object.assign(e,t)}function I(t=[],e=!0){let i=[];for(let e of t){let t=E(e);i.push(t)}return e&&i.push(...O({channelDicts:t})),i}function T(t=[],e={}){let i={scp:[],delta:[],theta:[],alpha1:[],alpha2:[],beta:[],lowgamma:[],highgamma:[]};return t.forEach((t=>i[t]=[])),Object.assign(e,i)}function E(t="",e={},i={_id:""},s={structType:"struct",_id:""}){let r=T(),n={tag:t,position:{x:0,y:0,z:0},count:0,times:[],raw:[],filtered:[],fftCount:0,fftTimes:[],ffts:[],slices:JSON.parse(JSON.stringify(r)),means:JSON.parse(JSON.stringify(r)),startTime:Date.now()},o=b("eeg",n,i,s);return t&&_(n,o),Object.assign(o,e)}function w(t={0:E("FP1"),1:E("FP2")},e={},i={_id:""},s={structType:"struct",_id:""}){let r=T(),n=b("coherence",{tag:t[0]?.tag+"::"+t[1]?.tag,x0:t[0]?.position?.x,y0:t[0]?.position?.y,z0:t[0]?.position?.z,x1:t[1]?.position?.x,y1:t[1]?.position?.y,z1:t[1]?.position?.z,fftCount:0,fftTimes:[],ffts:[],slices:JSON.parse(JSON.stringify(r)),means:JSON.parse(JSON.stringify(r)),startTime:Date.now()},i,s);return Object.assign(n,e)}function O(t={channelDicts:[{ch:0,tag:"FP1",analyze:!1},{ch:1,tag:"FP2",analyze:!1}],taggedOnly:!0},e={},i={_id:""},s={structType:"struct",_id:""}){for(var r=[],n=1,o=0,a=0;a<t.channelDicts.length*(t.channelDicts.length+1)/2-t.channelDicts.length;a++){if(!1===t.taggedOnly||!0===t.taggedOnly&&null!==t.channelDicts[o].tag&&null!==t.channelDicts[o+n].tag&&"other"!==t.channelDicts[o].tag&&"other"!==t.channelDicts[o+n].tag&&!0===t.channelDicts[o].analyze&&!0===t.channelDicts[o+n].analyze){var l=E(t.channelDicts[o].tag),h=E(t.channelDicts[o+n].tag);r.push(w({0:l,1:h},{},i,s))}++n+o===t.channelDicts.length&&(o++,n=1)}return r}function A(t="",e={},i={_id:""},s={structType:"struct",_id:""}){let r={tag:t,position:{x:0,y:0,z:0},count:0,times:[],red:[],ir:[],ir2:[],ambient:[],ratio:[],temp:[],beat_detect:{beats:[],breaths:[],rir:[],rir2:[],drir_dt:[],localmins:[],localmaxs:[],val_dists:[],peak_dists:[],localmins2:[],localmaxs2:[],val_dists2:[],peak_dists2:[]},startTime:Date.now()},n=b("fnirs",r,i,s);return t&&_(r,n),Object.assign(n,e)}function k(t="",e={},i={_id:""},s={structType:"struct",_id:""}){let r={tag:t,Ax:[],Ay:[],Az:[],Gx:[],Gy:[],Gz:[],startTime:Date.now()},n=b("imu",r,i,s);return t&&_(r,n),Object.assign(n,e)}function D(t="",e={},i={_id:""},s={structType:"struct",_id:""}){let r=b("eyetracker",{tag:t,count:0,times:[],x:[],y:[],smax:[],smay:[],startTime:Date.now()},i,s);return Object.assign(r,e)}function R(t="",e={},i={_id:""},s={structType:"struct",_id:""}){let r=b("ecg",{tag:t,count:0,times:[],raw:[],filtered:[],bpm:[],hrv:[],startTime:Date.now()},i,s);return Object.assign(r,e)}function z(t="",e={},i={_id:""},s={structType:"struct",_id:""}){}function U(t="",e={},i={_id:""},s={structType:"struct",_id:""}){let r=A(t,i,s,e);return r.structType="ppg",r}function N(t="",e={},i={_id:""},s={structType:"struct",_id:""}){let r=R(t,i,s,e);return r.structType="hrv",r}function M(t="",e={},i={_id:""},s={structType:"struct",_id:""}){let r=E(t,i,s,e);return r.structType="emg",r}function j(t="",e={},i={_id:""},s={structType:"struct",_id:""}){let r=b("profile",{tag:t,name:"",username:"",firstName:"",lastName:"",email:"",sex:"",birthday:"",type:"",userRoles:[],id:""},i,s);return Object.assign(r,e)}function C(t="",e={},i={_id:""},s={structType:"struct",_id:""}){let r=b("authorization",{tag:t,authorizedId:"",authorizedName:"",authorizerId:"",authorizerName:"",authorizations:new Array,structs:new Array,excluded:new Array,groups:new Array,status:"PENDING",expires:!1,associatedAuthId:""},i,s);return Object.assign(r,e)}function L(t="",e={},i={_id:""},s={structType:"struct",_id:""}){let r=b("group",{tag:t,name:"",details:"",admins:new Array,peers:new Array,clients:new Array,users:new Array},i,s);return Object.assign(r,e)}function P(t="",e={},i={_id:""},s={structType:"struct",_id:""}){let r=b("data",{tag:t,title:"",author:"",expires:!1,type:"",data:new Array},i,s);return Object.assign(r,e)}function F(t="",e={},i={_id:""},s={structType:"struct",_id:""}){let r=b("event",{tag:t,event:"",author:"",startTime:"",endTime:"",grade:0,notes:"",attachments:new Array,users:new Array},i,s);return Object.assign(r,e)}function B(t="",e={},i={_id:""},s={structType:"struct",_id:""}){let r=b("chatroom",{tag:t,message:"",topic:"",author:"",attachments:new Array,comments:new Array,replies:new Array,users:new Array,audioChatActive:!1,videoChatActive:!1},i,s);return Object.assign(r,e)}function G(t="",e={},i={_id:""},s={structType:"struct",_id:""}){let r=b("comment",{tag:t,author:"",replyTo:"",message:"",rating:0,replies:new Array,users:new Array,attachments:new Array},i,s);return Object.assign(r,e)}function J(t="",e={},i={_id:""},s={structType:"struct",_id:""}){let r=b("notification",{tag:t,note:"",parentUserId:""},i,s);return Object.assign(r,e)}function q(t="",e={},i={_id:""},s={structType:"struct",_id:""}){let r=b("schedule",{tag:t,title:"",author:"",attachments:new Array,dates:new Array},i,s);return Object.assign(r,e)}function $(t="",e={},i={_id:""},s={structType:"struct",_id:""}){let r=b("date",{tag:t,timeSet:"",notes:"",recurs:"NEVER",attachments:new Array},i,s);return Object.assign(r,e)}var W={Struct:b,EEGStruct:E,FNIRSStruct:A,CoherenceStruct:w,CoherenceMap:O,FrequencyBandsStruct:T,IMUStruct:k,EyeTrackerStruct:D,ECGStruct:R,EDAStruct:z,PPGStruct:U,HRVStruct:N,EMGStruct:M,ProfileStruct:j,AuthorizationStruct:C,GroupStruct:L,DataStruct:P,EventStruct:F,ChatroomStruct:B,CommentStruct:G,NotificationStruct:J,ScheduleStruct:q,DateStruct:$};v({},{bandpassWindow:()=>ot,get40HzGamma:()=>tt,getAlphaBetaRatio:()=>Q,getAlphaRatio:()=>Y,getAlphaThetaRatio:()=>X,getCoherenceScore:()=>H,getHEGRatioScore:()=>it,getLowGammaScore:()=>et,getThetaBetaRatio:()=>Z,mapCoherenceData:()=>nt,mapFFTData:()=>rt,splitFrequencyBands:()=>st});var K=class{constructor(){}static genSineWave(t=20,e=1,i=1,s=512,r=0,n=1){for(var o=[],a=[],l=1/s,h=0;h<i;h+=l){var d=Math.sin(2*Math.PI*t*h)*e;d+=Math.sin(2*Math.PI*r*h)*n,o.push(d),a.push(h)}return[a,o]}static getSineAmplitude(t=20,e=1,i=0,s=0){return Math.sin(this.TWO_PI*t*i+s)*e}static mean(t){return t.reduce(((t,e)=>e+t))/t.length}static mode(t){return t.sort(((e,i)=>t.filter((t=>t===e)).length-t.filter((t=>t===i)).length)).pop()}static std(t,e){let i=e;e||(i=this.mean(t));let s=0;for(let e=0;e<t.length;e++){let r=t[e]-i;s+=r*r}return Math.sqrt(s/t.length)}static relError(t=[],e=[],i=!0){if(t.length!==e.length)throw new Error("Input arrays of same length!");let s=t.length,r=[];for(let n=0;n<s;n++){let s=(t[n]-e[n])/t[n];i&&(s=Math.abs(s)),r.push(s)}return r}static informationEntropy(t=[]){let e=[],i=t.length;for(let s=0;s<i;s++){let i=t[s]*Math.log(t[s]);isNaN(i)&&(i=0),e.push(i)}return e}static zscore(t){let e=this.mean(t),i=this.std(t,e),s=[];for(let r=0;r<t.length;r++)s.push((t[r]-e)/i);return s}static variance(t){var e=this.mean(t);return t.reduce(((t,i)=>t+(i-e)**2),0)/t.length}static dot(t,e){for(var i=0,s=0;s<t.length;s++)i+=t[s]*e[s];return i}static cross3D(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]}static magnitude(t){var e=0;return t.forEach((t=>{e+=t*t})),Math.sqrt(e)}static distance(t,e){var i=0;return t.forEach(((t,s)=>{i+=(e[s]-t)*(e[s]-t)})),Math.sqrt(i)}static normalize(t){var e;e=this.magnitude(t);var i=[];return t.forEach(((t,s)=>{i.push(t*e)})),i}static quadraticFormula(t,e,i){let s=Math.sqrt(e*e-4*t*i);if(!isNaN(s))return["complex","complex"];let r=1/(2*t);if(0===s)return[e*r];let n=-e;return[(n+s)*r,(n-s)*r]}static newtonsMethod(t=(t=>Math.pow(t,5)+t*t-t-.2),e=0,i=1,s=.01,r=10){let n=[];for(let o=0;o<r;o++){let r=Math.random()*(i-e),o=t(r),a=t(r+s),l=(a-o)/s,h=r+s;for(;Math.abs(l)>s;){let e=h+-o/i;o=a,a=t(e);let i=(a-o)/(e-h)}let d,u=n.find(((t,e)=>{if(Math.abs(xn1-t)<s)return d=e,!0}));u?n[d]=.5*(xn1+u):n.push(xn1)}return n}static makeVec(t,e){var i=[];return t.forEach(((t,s)=>{i.push(e[s]-t)})),i}static transpose(t){return t[0].map(((e,i)=>t.map((t=>t[i]))))}static matmul(t,e){for(var i=t.length,s=t[0].length,r=(e.length,e[0].length),n=new Array(i),o=0;o<i;++o){n[o]=new Array(r);for(var a=0;a<r;++a){n[o][a]=0;for(var l=0;l<s;++l)n[o][a]+=t[o][l]*e[l][a]}}return n}static matscale(t,e){let i=[];for(var s=0;s<t.length;s++){i[s]=[];for(let r=0;r<t[0].length;r++)i[s][r]=t[s][r]*e}return i}static matadd(t,e){let i=[];for(let r=0;r<t.length;r++){i[r]=[];for(var s=0;s<t[0].length;s++)i[r][s]=t[r][s]+e[r][s]}return i}static matsub(t,e){let i=[];for(let r=0;r<t.length;r++){i[r]=[];for(var s=0;s<t[0].length;s++)i[r][s]=t[r][s]-e[r][s]}return i}static histogram(t=[],e=1,i){let s=[...t];s.sort((function(t,e){return t-e}));let r=Math.min(...s);if("number"==typeof i){let t=Math.max(...s);e=Math.abs((t-r)/(i-1))}let n=r,o=[],a=[];for(let t=0;t<s.length;t++){let i=e*n;if(s[t]>r+i){n++,i+=e;let t=r+i+.5*i;o.push(t),a.push(0)}a[a.length-1]++}return[o,a]}static normalDistribution(t=[],e=!0,i=1e-4){let s=this.mean(t),r=this.variance(t),n=t.length,o=[],a=1/(this.TWO_PI*r),l=1/r,h=0;for(let e=0;e<n;e++){let r=Math.exp(-.5*Math.pow((t[e]-s)*l,2))*a;r<i&&(r=0),o.push(r),h+=r}if(e){let t=1/h;o=o.map((e=>e*t))}return o}static expectedValue(t=[],e=this.normalDistribution(t)){return t.reduce(((t,i,s)=>t+i*e[s]))}static originMoment(t=[],e=this.normalDistribution(t),i=1){return t.reduce(((t,s,r)=>t+Math.pow(s,i)*e[r]))}static centralMoment(t=[],e=this.normalDistribution(t),i=1){let s=this.mean(t);return t.reduce(((r,n,o)=>r+Math.pow(n-s,i)*e[o]/t.length))}static linearDiscriminantAnalysis(t=[],e=[]){let i=this.mean(t),s=this.mean(e),r=this.cov1d(t,e),n=this.normalDistribution(t),o=[];for(let e=0;e<t.length;e++)o.push(x[e]*r*s-.5*i*r*s+Math.log10(n[e]));return o}static conv1D(t=[],e=[1/3,1/3,1/3],i=Math.floor(.5*e.length)){let s=[],r=1/e.length;if(i>0){let e=new Array(i).fill(0);t=[...e,...t,...e]}let n=Math.floor(.5*e.length),o=t.length-e.length+n;for(let i=n;i<o;i++){let o=0;for(let s=0;s<e.length;s++)o+=t[i-n]*e[s];s.push(o*r)}return s}static conv2D(t=[[],[],[]],e=[[],[],[]],i=0){let s,r=new Array(t.length-Math.ceil(.5*e.length)).fill([]),n=K.transpose(n);if(i>0){let e=new Array(i).fill(0);s=K.transpose(t);for(let t=0;t<s.length;t++)s[t]=[...e,...s[t],...e];t=K.transpose(s);for(let i=0;i<t.length;i++)t[i]=[...e,...t[i],...e]}let o,a=Math.floor(.5*e[0].length),l=Math.floor(.5*n[0].length),h=t[0].length-e[0].length+a,d=s[0].length-n[0].length+l,u=1/(e[0].length*n[0].length),c=h*d,f=a,p=l;for(;f<c;){let i=0;o=f%t[0].length,0===o&&p++;for(let s=0;s<e[0].length;s++){for(let r=0;r<n[0].length;s++)i+=t[p-l+r][o-a+s]*e[r][s];r[p].push(i*u)}f++}return r}static cov2d(t){var e=this.transpose(t),i=[],s=[],r=[];t.forEach(((t,e)=>{s.push(this.mean(t))})),e.forEach(((t,e)=>{r.push(this.mean(t))})),t.forEach(((e,n)=>{i.push([]);for(var o=0;o<e.length;o++)i[n].push((t[n][o]-s[n])*(t[n][o]-r[o])/(e.length-1))}));for(var n=this.transpose(i),o=i.length,a=i[0].length,l=(n.length,n[0].length),h=new Array(o),d=0;d<o;++d){h[d]=new Array(l);for(var u=0;u<l;++u){h[d][u]=0;for(var c=0;c<a;++c)h[d][u]+=i[d][c]*n[c][u]/(t[0].length-1)}}return h}static cov1d(t=[],e=[]){return this.cov2d([t,e])}static cov3d(t=[],e=[],i=[]){return[[this.cov1d(t,t),this.cov1d(t,e),this.cov1d(t,i)],[this.cov1d(e,t),this.cov1d(e,e),this.cov1d(e,i)],[this.cov1d(i,t),this.cov1d(i,e),this.cov1d(i,i)]]}static covNd(t=[]){let e=[];t.forEach(((i,s)=>{e.push([]),t.forEach(((t,r)=>{e[s].push(this.cov1d(i,t))}))}))}static eigens2x2(t=[[1,2],[3,4]]){let e=t[0][0]*t[1][1]-t[0][1]*t[1][0],i=.5*(t[0][0]+t[1][1]),s=Math.sqrt(i*i-e);return[i+s,i-s]}static eigenvectors2x2(t=[[1,2],[3,4]],e=[1,2]){let i=[-t[0][1],t[0][0]-e[0]];0===i[0]&&0===i[1]&&(i[0]=t[1][1]-e[0],i[1]=-t[1][0]);let s=[-t[0][1],t[0][0]-e[1]];return 0===s[0]&&0===s[1]&&(s[0]=t[1][1]-e[1],s[1]=-t[1][0]),[i,s]}static fastpca2d(t,e){let i=this.cov1d(t,e),s=this.eigens2x2(i);s[1]>s[0]&&s.reverse();let r=this.eigenvectors2x2(i,s);return console.log(s,r),[s,r]}static crosscorrelation(t,e){var i=[...e,...Array(e.length).fill(0)],s=this.mean(t),r=this.mean(e),n=t.reduce(((t,e)=>t+Math.pow(e-s,2)));n=Math.sqrt(n);for(var o=e.reduce(((t,e)=>t+Math.pow(e-s,2))),a=1/(n*(o=Math.sqrt(o))),l=new Array(t.length).fill(0),h=0;h<t.length;h++){var d=t.reduce(((t,e,n)=>t+(e-s)*(i[h+n]-r)));l[h]=d*a}return l}static autocorrelation(t){for(var e=[...t,...Array(t.length).fill(0)],i=this.mean(t),s=t.reduce(((t,e)=>t+Math.pow(e-i,2))),r=1/((s=Math.sqrt(s))*s),n=new Array(t.length).fill(0),o=0;o<t.length;o++){var a=t.reduce(((t,s,r)=>t+(s-i)*(e[o+r]-i)));n[o]=a*r}return n}static correlograms(t=[[],[]]){var e=[];return t.forEach(((i,s)=>{t.forEach(((t,r)=>{r>=s&&e.push(K.crosscorrelation(i,t))}))})),e}static sma(t=[],e){for(var i=[],s=0;s<t.length;s++)if(0==s)i.push(t[0]);else if(s<e){var r=t.slice(0,s+1);i.push(r.reduce(((t,e)=>e+t))/(s+1))}else{r=t.slice(s-e,s);i.push(r.reduce(((t,e)=>e+t))/e)}return i}static sum(t=[]){return t.length>0?t.reduce(((t,e)=>e+t)):0}static reduceArrByFactor(t,e=2){return t.filter(((t,i)=>i%e==0))}static makeArr(t,e,i){for(var s=[],r=(e-t)/(i-1),n=0;n<i;n++)s.push(t+r*n);return s}static interpolateArray(t,e,i=1){var s,r,n=new Array,o=new Number((t.length-1)/(e-1));n[0]=t[0];for(var a=1;a<e-1;a++){var l=a*o,h=new Number(Math.floor(l)).toFixed(),d=new Number(Math.ceil(l)).toFixed(),u=l-h;n[a]=(s=t[h],r=t[d],(s+(r-s)*u)*i)}return n[e-1]=t[t.length-1],n}static isExtrema(t,e="peak"){let i=[...t];if(i.length%2==0&&i.pop(),t.length>1){let t=!0;for(let s=0;s<i.length;s++){let r=i[s];if("peak"===e){if(s<Math.floor(.5*i.length)&&r>=i[Math.floor(.5*i.length)]){t=!1;break}if(s>Math.floor(.5*i.length)&&r>=i[Math.floor(.5*i.length)]){t=!1;break}}else if("valley"===e){if(s<Math.floor(.5*i.length)&&r<=i[Math.floor(.5*i.length)]){t=!1;break}if(s>Math.floor(.5*i.length)&&r<=i[Math.floor(.5*i.length)]){t=!1;break}}else{if(s<Math.floor(.5*i.length)&&r<=i[Math.floor(.5*i.length)]){t=!1;break}if(s>Math.floor(.5*i.length)&&r<=i[Math.floor(.5*i.length)]){t=!1;break}}}if("peak"!==e&&"valley"!==e&&!1===t){t=!0;for(let e=0;e<i.length;e++){let s=i[e];if(e<Math.floor(.5*i.length)&&s>=i[Math.floor(.5*i.length)]){t=!1;break}if(e>Math.floor(.5*i.length)&&s>=i[Math.floor(.5*i.length)]){t=!1;break}}}return t}}static isCriticalPoint(t,e="peak"){let i=[...t];if(i.length%2==0&&i.pop(),t.length>1){let t=!0;for(let s=0;s<i.length;s++){let r=i[s];if("peak"===e){if(s<.5*i.length&&r<=0){t=!1;break}if(s>.5*i.length&&r>0){t=!1;break}}else if("valley"===e){if(s<.5*i.length&&r>=0){t=!1;break}if(s>.5*i.length&&r<0){t=!1;break}}else{if(s<.5*i.length&&r>=0){t=!1;break}if(s>.5*i.length&&r<0){t=!1;break}}}if("peak"!==e&&"valley"!==e&&!1===t){t=!0;for(let e=0;e<i.length;e++){let s=i[e];if(e<.5*i.length&&s<=0){t=!1;break}if(e>.5*i.length&&s>0){t=!1;break}}}return t}}static getPeakThreshold(t,e,i){let s,r=t.filter(((t,i)=>{if(e.indexOf(i)>-1)return!0}));return s=0===i?this.mean(r):.5*(i+this.mean(r)),s}static column(t,e){let i=new Array(t.length).fill(0).map((()=>new Array(1).fill(0)));for(let s=0;s<t.length;s++)i[s][0]=t[s][e];return i}static flatten_vector(t){let e=[];for(let i=0;i<t.length;i++)e[i]=t[i][0];return e}static squared_difference(t,e){let i=0;for(let s=0;s<t.length;s++)i+=Math.pow(t[s]-e[s],2);return i}static shift_deflate(t,e,i){let s=Math.sqrt(this.matmul(this.transpose(i),i)),r=this.matscale(i,1/s),n=this.matscale(this.matmul(r,this.transpose(r)),e);return this.matsub(t,n)}static eigenvalue_of_vector(t,e){return ev=this.matmul(this.matmul(this.transpose(e),t),e),ev}static power_iteration(t,e=1e-5,i=1e3){let s=t.length,r=new Array(s).fill(0).map((()=>new Array(1).fill(Math.sqrt(s)))),n=this.eigenvalue_of_vector(t,r),o=1,a=0;for(;o>e&&a<i;){let e=JSON.parse(JSON.stringify(n)),i=this.matmul(t,r);r=this.normalize(i),n=this.eigenvalue_of_vector(t,r),o=Math.abs(n-e),a++}return[n,r]}static eigens(t,e=1e-4,i=1e3){let s=[],r=[];for(let n=0;n<t.length;n++){let o=this.power_iteration(t,e,i),a=o[0],l=o[1];s[n]=a,r[n]=this.flatten_vector(l),t=this.shift_deflate(t,a,l)}return[s,r]}static pca(t,e=1e-5){let i=t.length,s=new Array(i),r=new Array(i),n=this.transpose(t);for(s[0]=this.column(t,0);espilon>e;){r[0]=this.matmul(n,s[0]);let e=this.matmul(this.transpose(s[0]),s[0]);r[0]=this.matscale(r[0],1/e);let i=Math.sqrt(this.matmul(this.transpose(r[0]),r[0]));r[0]=this.matscale(r[0],1/i);let o=this.matmul(t,r[0]),a=this.matmul(this.transpose(r[0]),r[0]);o=this.matscale(o,1/a),this.squared_difference(s[0],o),s[0]=JSON.parse(JSON.stringify(o))}return this.matmul(this.transpose(s[0]),s[0])}static p300(t=[],e=[],i=[],s=256){let r=Math.floor(s/10),n=this.sma(e,r),o=this.peakDetect(n,"peak",r),a=this.mean(n),l=this.std(n,a),h=0,d=[];return o.length>0&&t.forEach(((t,s)=>{for(;i[o[h]]<t+200&&(h++,o[h]););let r=0,u=[];for(;i[o[h+r]]<t+600&&(u.push(h+r),r++,o[h+r]););if(u.length>1){let r=[];u.forEach((t=>{r.push(n[o[t]])}));let h=Math.max(...r),c=u[r.indexOf(h)];d.push({event_timestamp:t,event_index:s,peak_timestamp:i[[o[c]]],signal_index:[o[c]],signal_amplitude:e[[o[c]]],zscore:(n[o[c]]-a)/l})}else 1===u.length&&d.push({event_timestamp:t,event_index:s,peak_timestamp:i[o[u[0]]],signal_index:o[u[0]],signal_amplitude:e[[o[u[0]]]],zscore:(n[o[u[0]]]-a)/l})})),d}},V=K;y(V,"TWO_PI",2*Math.PI),y(V,"C",299792458),y(V,"G",66743e-15),y(V,"h",662607015e-42),y(V,"R",8314.32),y(V,"Ra",287),y(V,"H",69.3),y(V,"kbar",1054571817e-43),y(V,"kB",1380649e-29),y(V,"ke",8987551792.3),y(V,"me",91093837015e-41),y(V,"mp",167262192369e-38),y(V,"mn",167492749804e-38),y(V,"P0",101325),y(V,"T0",288.15),y(V,"p0",1.225),y(V,"Na",60220978e16),y(V,"y",1.405),y(V,"M0",28.96643),y(V,"g0",9.80665),y(V,"Re",6378100),y(V,"B",1458e-9),y(V,"S",110.4),y(V,"Sigma",3.65e-10),y(V,"imgkernels",{edgeDetection:[[-1,-1,-1],[-1,8,-1],[-1,-1,-1]],boxBlur:[[1/9,1/9,1/9],[1/9,1/9,1/9],[1/9,1/9,1/9]],sobelLeft:[[1,0,-1],[2,0,-2],[1,0,-1]],sobelRight:[[-1,0,1],[-2,0,2],[-1,0,1]],sobelTop:[[1,2,1],[0,0,0],[-1,-2,-1]],sobelBottom:[[-1,2,1],[0,0,0],[1,2,1]],identity:[[0,0,0],[0,1,0],[0,0,0]],gaussian3x3:[[1,2,1],[2,4,2],[1,2,1]],guassian7x7:[[0,0,0,5,0,0,0],[0,5,18,32,18,5,0],[0,18,64,100,64,18,0],[5,32,100,100,100,32,5],[0,18,64,100,64,18,0],[0,5,18,32,18,5,0],[0,0,0,5,0,0,0]],emboss:[[-2,-1,0],[-1,1,1],[0,1,2]],sharpen:[[0,-1,0],[-1,5,-1],[0,-1,0]]}),y(V,"integral",((t=(t=>t),e=[],i=.01)=>{let s=0;for(let r=e[0];r<e[1];r+=i)s+=t(r)*i;return s})),y(V,"dintegral",((t=((t,e)=>t+e),e=[[],[]],i=.01,s=i)=>{let r=0;for(let n=e[0][0]+i;n<e[0][1];n+=i)for(let o=e[1][0]+s;o<e[1][1];o+=s)r+=t(n,o)*i*s;return r})),y(V,"tintegral",((t=((t,e,i)=>t+e+i),e=[[],[],[]],i=.01,s=i,r=i)=>{let n=0;for(let o=e[0][0]+i;o<e[0][1];o+=i)for(let a=e[1][0]+s;a<e[1][1];a+=s)for(let l=e[2][0]+r;l<e[2][1];l+=r)n+=t(o,a,l)*i*s*r;return n})),y(V,"pintegral",((t=(t=>t),e=[],i=.01)=>{let s,r,n=0;for(let o=e[0];o<e[1];o+=i)s=r,r=t(o),s&&(n+=K.distance([0,s],[i,r]));return n})),y(V,"peakDetect",((t,e="peak",i=49)=>{let s=Math.floor(.5*i),r=[];for(let n=0;n<t.length-i;n++)K.isExtrema(t.slice(n,n+i),e)&&r.push(n+s-1);return r}));var H=(t,e="alpha1")=>{let i=[];return Array.isArray(t)||(t=[t]),t.forEach((t=>{if(t.fftCount>0){let s=t.fftCount,r=Math.min(20,s),n=t.means[e].slice(s-r);i.push(V.mean(n))}})),V.mean(i)},Y=t=>t.fftCount>0?t.means.alpha2[t.fftCount-1]/t.means.alpha1[t.fftCount-1]:0,Z=t=>t.fftCount>0?t.means.theta[t.fftCount-1]/t.means.beta[t.fftCount-1]:0,Q=t=>t.fftCount>0?.5*(t.means.alpha1[t.fftCount-1]+t.means.alpha2[t.fftCount-1])/t.means.beta[t.fftCount-1]:0,X=t=>t.fftCount>0?.5*(t.means.alpha1[t.fftCount-1]+t.means.alpha2[t.fftCount-1])/t.means.theta[t.fftCount-1]:0,tt=(t,e)=>{if(t.fftCount>0&&Array.isArray(e)){let i=t.slices.lowgamma[t.fftCount-1],s=[];return i.forEach(((t,i)=>{e.lowgamma[0][i]>38&&e.lowgamma[0][i]<42&&s.push(t)})),Math.max(...s)}return 0},et=t=>{if(t.fftCount>0){let e=t.fftCount,i=20;e<i&&(i=e);let s=t.means.lowgamma.slice(e-i);return t.means.lowgamma[e-1]-V.mean(s)}return 0},it=t=>{if(t.count>0){let e=t.count,i=40;e<i&&(i=e);let s=t.ratio.slice(e-i);return t.ratio[e-1]-V.mean(s)}return 0};function st(t=[],e={scp:[.1,1],delta:[1,4],theta:[4,8],alpha1:[8,12],alpha2:[12,16],beta:[16,30],lowgamma:[30,45],highgamma:[45,100]}){let i={};return t.forEach(((t,s)=>{for(let r in e)i[r]||(i[r]=[[],[]]),t>=e[r][0]&&t<=e[r][1]&&(i[r][0].push(t),i[r][1].push(s))})),i}var rt=(t,e,i,s)=>{let r=0;s.fftCount++,s.fftTimes.push(e),s.ffts.push(t);for(let e in i){let n=t.slice(r,r+i[e][1].length);s.slices[e].push(n),s.means[e].push(n.reduce(((t,e)=>t+e))/n.length),r+=i[e][1].length}},nt=(t,e,i,s)=>{t.forEach(((t,r)=>{s[r].fftCount++,s[r].fftTimes.push(e),s[r].ffts.push(data);let n=0;for(let t in i){let e=fft.slice(n,n+i[t][1].length);coord.slices[t].push(e),coord.means[t].push(e.reduce(((t,e)=>t+e))/e.length),n+=i[t][1].length}}))};function ot(t,e,i){let s=(e-t)/i,r=[],n=0;for(;n<e;)r.push(n),n+=s;return r}function at(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}class lt{constructor(t=!1,e=!1){at(this,"addFunc",((t=null,e=null,i=!0)=>{var s=null;return null!==e&&(null==t?this.listeners.forEach(((t,r)=>{s=t.listener.addFunc(e),0==t.listener.running&&1==i&&t.listener.start()})):this.listeners.find(((r,n)=>{r.key===t&&(s=r.listener.addFunc(e),0==r.listener.running&&1==i&&r.listener.start())}))),s})),at(this,"getFuncs",(t=>t?this.listeners.find(((e,i)=>{if(e.key===t)return!0})).onchangeFuncs:void 0)),at(this,"removeFuncs",((t=null,e=null,i=!1)=>{null==t?this.listeners.forEach(((t,i)=>{t.listener.removeFuncs(e)})):this.listeners.find(((s,r)=>{s.key===t&&(s.listener.removeFuncs(e),0!==s.listener.onchangeFuncs.length&&!0!==i||s.listener.stop())}))})),this.debug=t,this.listeners=[],this.synchronous=e,this.syncInterval="FRAMERATE",this.syncAnim=void 0,!0===e&&this.startSync()}addListener(t=null,e,i,s,r,n=this.debug,o=!0){if(void 0!==e){var a=t;null==a&&(a=Math.floor(1e5*Math.random())),!0===this.synchronous&&(o=!1);var l={key:a,listener:new ht(e,i,s,r,n,o)};this.listeners.push(l)}else console.error("You must assign an object")}getListener(t){return this.listeners.find(((e,i)=>{if(e.key===t)return!0}))}hasKey(t){var e=!1;return this.listeners.forEach(((i,s)=>{if(i.key===t)return e=!0,!0})),e}getKeyIndices(t){var e=[];return this.listeners.find(((i,s)=>{i.key===t&&e.push(s)})),e}onchange(t=null,e=null){null==t?this.listeners.forEach(((t,i)=>{t.listener.onchange=e})):this.listeners.find(((i,s)=>{i.name===t&&(i.listener.onchange=e)}))}stop(t=null){this.synchronous&&this.stopSync(),null==t?this.listeners.forEach(((t,e)=>{t.listener.stop()})):this.listeners.find(((e,i)=>{e.name===t&&e.listener.stop()}))}start(t=null){this.synchronous&&this.stopSync(),null==t?this.listeners.forEach(((t,e)=>{t.listener.start()})):this.listeners.find(((e,i)=>{e.name===t&&e.listener.start()}))}startSync(){if(!1===this.synchronous){this.synchronous=!0,this.stop();let t=()=>{!0===this.synchronous&&(this.listeners.forEach((t=>{t.listener.check()})),"FRAMERATE"===this.syncInterval?this.syncAnim=requestAnimationFrame(t):"number"==typeof this.syncInterval&&setTimeout(t,this.syncInterval))};t()}}stopSync(){this.synchronous=!1,this.syncAnim&&cancelAnimationFrame(this.syncAnim)}remove(t=null){if(null==t)this.listeners.forEach((t=>{t.listener.stop()})),this.listeners.splice(0,this.listeners.length);else{var e=[];this.listeners.forEach(((i,s)=>{i.key===t&&e.push(s)})),e.reverse().forEach((t=>{this.listeners[t].listener.stop(),this.listeners.splice(t,1)}))}}}class ht{constructor(t,e="__ANY__",i=this.onchange,s="FRAMERATE",r=!1,n=!0){at(this,"onchange",(t=>{console.log(this.propName," changed from: ",this.propOld," to: ",this.object[this.propName])})),at(this,"addFunc",((t=null)=>{let e=0;return null!==t&&(this.onchangeFuncs.push({idx:this.funcs,onchange:t}),e=this.funcs,this.funcs++),e})),at(this,"onchangeMulti",(t=>{[...this.onchangeFuncs].forEach(((e,i)=>{!0===this.debug&&console.log(e.onchange),e.onchange(t)}))})),at(this,"setListenerRef",(t=>{"__ANY__"===t||null==t?this.propOld=JSON.stringifyFast(this.object):Array.isArray(this.object[t])?this.propOld=JSON.stringifyFast(this.object[t].slice(this.object[t].length-20)):"object"==typeof this.object[t]?this.propOld=JSON.stringifyFast(this.object[t]):"function"==typeof this.object[t]?this.propOld=this.object[t].toString():this.propOld=this.object[t],!0===this.debug&&console.log("propname",t,", new assignment: ",this.propOld)})),at(this,"check",(()=>{let t=!1;if("__ANY__"===this.propName||null===this.propName||void 0===this.propName)this.propOld!==JSON.stringifyFast(this.object)&&(!0===this.debug&&console.log("onchange: ",this.onchange),this.onchange(this.object),this.onchangeFuncs.length>0&&this.onchangeMulti(this.object),this.setListenerRef(this.propName),t=!0);else if(Array.isArray(this.object[this.propName]))this.propOld!==JSON.stringifyFast(this.object[this.propName].slice(this.object[this.propName].length-20))&&(!0===this.debug&&console.log("onchange: ",this.onchange),this.onchange(this.object[this.propName]),this.onchangeFuncs.length>0&&this.onchangeMulti(this.object[this.propName]),this.setListenerRef(this.propName),t=!0);else if("object"==typeof this.object[this.propName]){let e=JSON.stringifyFast(this.object[this.propName]);this.propOld!==e&&(!0===this.debug&&console.log("onchange: ",this.onchange),this.onchange(this.object[this.propName]),this.onchangeFuncs.length>0&&this.onchangeMulti(this.object[this.propName]),this.setListenerRef(this.propName),t=!0)}else"function"==typeof this.object[this.propName]?this.propOld!==this.object[this.propName].toString()&&(!0===this.debug&&console.log("onchange: ",this.onchange),this.onchange(this.object[this.propName].toString()),this.onchangeFuncs.length>0&&this.onchangeMulti(this.object[this.propName].toString()),this.setListenerRef(this.propName),t=!0):this.object[this.propName]!==this.propOld&&(!0===this.debug&&console.log("onchange: ",this.onchange),this.onchange(this.object[this.propName]),this.onchangeFuncs.length>0&&this.onchangeMulti(this.object[this.propName]),this.setListenerRef(this.propName),t=!0);return!0===this.running&&(!0===this.debug&&console.log("checking",this.object,this.propName),"FRAMERATE"===this.interval?"undefined"==typeof window?setTimeout((()=>{this.check()}),16):this.checker=requestAnimationFrame(this.check):setTimeout((()=>{this.check()}),this.interval)),t})),this.debug=r,this.onchange=i,this.onchangeFuncs=[],this.object=t,this.propName=e,this.propOld=void 0,this.setListenerRef(e),this.running=n,this.funcs=0,this.interval,s<10?(this.interval=10,console.log("Min recommended interval set: 10ms")):this.interval=s,!0===n&&("undefined"==typeof window?setTimeout((()=>{this.check()}),60):this.checker=requestAnimationFrame(this.check))}removeFuncs(t=null){let e=0;null===t?this.onchangeFuncs=[]:void 0!==this.onchangeFuncs.find(((i,s)=>{if(i.idx===t)return e=s,!0}))&&this.onchangeFuncs.splice(e,1)}start(){this.running=!0,"undefined"==typeof window?setTimeout((()=>{this.check()}),16):this.checker=requestAnimationFrame(this.check)}stop(){this.running=!1,cancelAnimationFrame(this.checker)}}void 0===JSON.stringifyFast&&(JSON.stringifyFast=function(){const t=new Map,e=[],i=["this"];function s(s,r){let n;if(null!=r)if("object"==typeof r){let o=r.constructor.name;s&&"Object"===o&&function(t,s){var r=e.length-1;if(e[r]){var n=e[r];if("object"==typeof n)if(n[t]===s||0===r)i.push(t),e.push(s.pushed);else for(;r-- >=0;){if("object"==typeof(n=e[r])&&n[t]===s){r+=2,e.length=r,i.length=r,--r,e[r]=s,i[r]=t;break}r--}}}(s,r);let a=t.get(r);if(a)return"[Circular Reference]"+a;if(t.set(r,i.join(".")),"Array"===o)n=r.length>20?r.slice(r.length-20):r;else if(o.includes("Set"))n=Array.from(r);else if("Object"!==o&&"Number"!==o&&"String"!==o&&"Boolean"!==o)n="instanceof_"+o;else if("Object"===o){let t={};for(const e in r)if(null==r[e])t[e]=r[e];else if(Array.isArray(r[e]))r[e].length>20?t[e]=r[e].slice(r[e].length-20):t[e]=r[e];else if("Object"===r[e].constructor.name){t[e]={};for(const i in r[e])if(Array.isArray(r[e][i]))r[e][i].length>20?t[e][i]=r[e][i].slice(r[e][i].length-20):t[e][i]=r[e][i];else if(null!=r[e][i]){let s=r[e][i].constructor.name;s.includes("Set")?t[e][i]=Array.from(r[e][i]):t[e][i]="Number"!==s&&"String"!==s&&"Boolean"!==s?"instanceof_"+s:r[e][i]}else t[e][i]=r[e][i]}else{let i=r[e].constructor.name;i.includes("Set")?t[e]=Array.from(r[e]):t[e]="Number"!==i&&"String"!==i&&"Boolean"!==i?"instanceof_"+i:r[e]}n=t}else n=r}else n=r;return n}return function(r,n){e.push(r);let o=JSON.stringify(r,s,n);return t.clear(),e.length=0,i.length=1,o}}()),void 0===JSON.stringifyWithCircularRefs&&(JSON.stringifyWithCircularRefs=function(){const t=new Map,e=[],i=["this"];function s(s,r){if(null!=r&&"object"==typeof r){s&&function(t,s){var r=e.length-1,n=e[r];if(n[t]===s||0===r)i.push(t),e.push(s);else for(;r-- >=0;)if((n=e[r])[t]===s){r+=2,e.length=r,i.length=r,--r,e[r]=s,i[r]=t;break}}(s,r);let n=t.get(r);if(n)return"[Circular Reference]"+n;t.set(r,i.join("."))}return r}return function(r,n){try{return e.push(r),JSON.stringify(r,s,n)}finally{t.clear(),e.length=0,i.length=1}}}());class dt{constructor(t={},e="FRAMERATE",i=!0){at(this,"setupSynchronousUpdates",(()=>{if(!this.listener.hasKey("pushToState")){const t=()=>{if(Object.keys(this.pushToState).length>0){Object.assign(this.data,this.pushToState);for(const t of Object.getOwnPropertyNames(this.pushToState))delete this.pushToState[t]}};this.listener.addListener("pushToState",this.pushToState,"__ANY__",t,this.interval),this.addToState("pushRecord",this.pushRecord,(t=>{let e=t.pushed.length;for(let i=0;i<e;i++){let e=t.pushed[i];this.pushCallbacks.state&&this.pushCallbacks.state.forEach((t=>{t.onchange(e)}));for(const t in e)this.pushCallbacks[t]&&this.pushCallbacks[t].forEach((i=>{"object"==typeof i&&i.onchange(e[t])}))}this.pushRecord.pushed.splice(0,e)}))}})),at(this,"addSecondaryKeyResponse",((t=null,e=null,i=!1,s=this.defaultStartListenerEventLoop)=>{if(null!=e){if(this.listener.hasKey(t))return this.listener.addFunc(t,e);if(null!=t&&"state"!==t)return this.listener.addListener(t,this.data,t,(()=>{}),this.data.stateUpdateInterval,i,s),this.listener.addFunc(t,e);if(!this.listener.hasKey("state")){const t=()=>{this.prev=Object.assign({},this.data)};this.listener.addListener("state",this.data,"__ANY__",t,this.interval)}return this.listener.addFunc("state",e)}})),at(this,"removeState",this.unsubscribeAll),this.data=t,this.interval=e,this.pushToState={},this.pushRecord={pushed:[]},this.pushCallbacks={},this.triggers={},this.prev={},this.listener=new lt,this.defaultStartListenerEventLoop=i}subscribe(t,e,i=this.defaultStartListenerEventLoop){return t&&"state"!==t?void 0!==this.data[t]?this.addSecondaryKeyResponse(t,e,void 0,i):void this.addToState(t,null,e,i):this.addSecondaryKeyResponse(t,e,void 0,i)}subscribeOnce(t,e=(t=>{})){let i;i=this.subscribe(t,(s=>{e(s),this.unsubscribe(t,i)}))}unsubscribe(t,e=null){null!==e?this.removeSecondaryKeyResponse(t,e,!0):console.error("Specify a subcription function index")}unsubscribeAll(t){this.unsubscribeAllSequential(t),this.unsubscribeAllTriggers(t),this.clearAllKeyResponses(t),this.data[t]&&delete this.data[t],this.listener.hasKey("pushToState")&&this.setSequentialState({stateRemoved:t})}setInterval(t="FRAMERATE"){this.interval=t,this.listener.listeners.forEach(((t,e)=>{t.interval=this.interval}))}updateState(t,e){null==this.data[t]?this.addToState(t,e):this.data[t]=e}addToState(t,e,i=null,s=this.defaultStartListenerEventLoop,r=!1){if(!this.listener.hasKey("pushToState")&&this.defaultStartListenerEventLoop&&this.setupSynchronousUpdates(),this.data[t]=e,this.setSequentialState({stateAdded:t}),null!==i)return this.addSecondaryKeyResponse(t,i,r,s)}get(t){return this.data[t]}getState(){return JSON.parse(JSON.stringifyFast(this.data))}setState(t={},e=!1){if(!this.listener.hasKey("pushToState")&&this.defaultStartListenerEventLoop&&(this.setupSynchronousUpdates(),this.pushRecord.pushed.push(JSON.parse(JSON.stringifyWithCircularRefs(t)))),t.stateUpdateTimeStamp=Date.now(),e)for(const e in t)if(e in this.pushToState)if(Array.isArray(this.pushToState[e])&&Array.isArray(t[e]))t[e]=this.pushToState[e].push(...t[e]);else if("object"==typeof this.pushToState[e]&&"object"==typeof t[e])for(const i in t[e])if(this.pushToState[e][i])if(Array.isArray(this.pushToState[e][i])&&Array.isArray(t[e][i]))t[e][i]=this.pushToState[e][i].push(...t[e][i]);else if("object"==typeof this.pushToState[e][i]&&"object"==typeof t[e][i])for(const s in t[e][i])if(this.pushToState[e][i][s])Array.isArray(this.pushToState[e][i][s])&&Array.isArray(t[e][i][s])&&(t[e][i][s]=this.pushToState[e][i][s].push(...t[e][i][s]));else if("object"==typeof this.pushToState[e][i][s]&&"object"==typeof t[e][i][s])for(const r in t[e][i][s])this.pushToState[e][i][s][r]&&Array.isArray(this.pushToState[e][i][s][r])&&Array.isArray(t[e][i][s][r])&&(t[e][i][s][r]=this.pushToState[e][i][s][r].push(...t[e][i][s][r]));if(Object.assign(this.pushToState,t),Object.keys(this.triggers).length>0){this.triggers.state&&this.triggers.state.forEach((t=>{t.onchange(this.data)}));for(const t of Object.getOwnPropertyNames(this.triggers))t in this.pushToState&&(this.data[t]=this.pushToState[t],delete this.pushToState[t],this.triggers[t].forEach((e=>{e.onchange(this.data[t])})))}return this.pushToState}subscribeTrigger(t,e=(t=>{})){if(t){this.triggers[t]||(this.triggers[t]=[]);let i=this.triggers[t].length;return this.triggers[t].push({idx:i,onchange:e}),this.triggers[t].length-1}}subscribeTriggerOnce(t,e=(t=>{})){let i;i=this.subscribeTrigger(t,(s=>{e(s),this.unsubscribeTrigger(t,i)}))}unsubscribeTrigger(t,e=0){let i,s=this.triggers[t];if(s){s.find((t=>{if(t.idx===e)return!0}))&&s.splice(i,1)}}unsubscribeAllTriggers(t){t&&this.triggers[t]&&delete this.triggers[t]}setSequentialState(t={}){this.listener.hasKey("pushToState")||this.setupSynchronousUpdates(),t.stateUpdateTimeStamp=Date.now(),this.pushRecord.pushed.push(JSON.parse(JSON.stringify(t)))}subscribeSequential(t,e){if(t){if(void 0===this.data[t]&&"state"!==t&&this.addToState(t,null,void 0),this.pushCallbacks[t]||(this.pushCallbacks[t]=[]),e){let i=this.pushCallbacks[t].length;return this.pushCallbacks[t].push({idx:i,onchange:e}),this.pushCallbacks[t].length-1}}else;}subscribeSequentialOnce(t,e=(t=>{})){let i;i=this.subscribeSequential(t,(s=>{e(s),this.unsubscribeSequential(t,i)}))}unsubscribeSequential(t,e=0){t&&this.pushCallbacks[t]&&this.pushCallbacks[t].find(((i,s)=>{if(i.idx===e)return this.pushCallbacks[t].splice(s,1),!0}))}unsubscribeAllSequential(t){t&&this.pushCallbacks[t]&&this.pushCallbacks[t]&&delete this.pushCallbacks[t]}setPrimaryKeyResponse(t=null,e=null,i=!1,s=this.defaultStartListenerEventLoop){if(null!==e)if(this.listener.hasKey(t))this.listener.onchange(t,e);else{if(null==t||"state"===t){if(!this.listener.hasKey("state")){const t=()=>{this.prev=Object.assign({},this.data)};this.listener.addListener("state",this.data,"__ANY__",t,this.interval)}return this.listener.addFunc("state",e)}this.listener.addListener(t,this.data,t,e,this.data.stateUpdateInterval,i,s)}}removeSecondaryKeyResponse(t=null,e=null,i=!0){null!==t?this.listener.hasKey(t)?this.listener.removeFuncs(t,e,i):console.error("key does not exist"):console.error("provide key")}clearAllKeyResponses(t=null){null===t?this.listener.remove(null):this.listener.hasKey(t)&&this.listener.remove(t)}getKeySubCallbacks(t){return this.listener.getFuncs(t)}runSynchronousListeners(){this.defaultStartListenerEventLoop=!1,this.listener.startSync()}stop(t=null){this.listener.stop(t)}}function ut(t,e=!0){let i=(t=t.replace(/\/\*\*?/,"")).split("/");e&&(i=i.slice(0,i.length-1));let s=[t];return s.push(t+"/*"),s.push(t+"/**"),i.forEach(((e,r)=>{let n=i.slice(0,r+1).join("/");n!=t&&(r===i.length-1&&s.push(n+"/*"),s.push(n+"/**"))})),s}void 0===JSON.stringifyFast&&(JSON.stringifyFast=function(){const t=new Map,e=[],i=["this"];function s(s,r){let n;if(null!=r)if("object"==typeof r){let o=r.constructor.name;s&&"Object"===o&&function(t,s){var r=e.length-1;if(e[r]){var n=e[r];if("object"==typeof n)if(n[t]===s||0===r)i.push(t),e.push(s.pushed);else for(;r-- >=0;){if("object"==typeof(n=e[r])&&n[t]===s){r+=2,e.length=r,i.length=r,--r,e[r]=s,i[r]=t;break}r++}}}(s,r);let a=t.get(r);if(a)return"[Circular Reference]"+a;if(t.set(r,i.join(".")),"Array"===o)n=r.length>20?r.slice(r.length-20):r;else if(o.includes("Set"))n=Array.from(r);else if("Object"!==o&&"Number"!==o&&"String"!==o&&"Boolean"!==o)n="instanceof_"+o;else if("Object"===o){let t={};for(const e in r)if(null==r[e])t[e]=r[e];else if(Array.isArray(r[e]))r[e].length>20?t[e]=r[e].slice(r[e].length-20):t[e]=r[e];else if("Object"===r[e].constructor.name){t[e]={};for(const i in r[e])if(Array.isArray(r[e][i]))r[e][i].length>20?t[e][i]=r[e][i].slice(r[e][i].length-20):t[e][i]=r[e][i];else if(null!=r[e][i]){let s=r[e][i].constructor.name;s.includes("Set")?t[e][i]=Array.from(r[e][i]):t[e][i]="Number"!==s&&"String"!==s&&"Boolean"!==s?"instanceof_"+s:r[e][i]}else t[e][i]=r[e][i]}else{let i=r[e].constructor.name;i.includes("Set")?t[e]=Array.from(r[e]):t[e]="Number"!==i&&"String"!==i&&"Boolean"!==i?"instanceof_"+i:r[e]}n=t}else n=r}else n=r;return n}return function(r,n){e.push(r);let o=JSON.stringify(r,s,n);return t.clear(),e.length=0,i.length=1,o}}()),void 0===JSON.stringifyWithCircularRefs&&(JSON.stringifyWithCircularRefs=function(){const t=new Map,e=[],i=["this"];function s(s,r){if(null!=r&&"object"==typeof r){s&&function(t,s){var r=e.length-1,n=e[r];if("object"==typeof n)if(n[t]===s||0===r)i.push(t),e.push(s.pushed);else for(;r-- >=0;){if("object"==typeof(n=e[r])&&n[t]===s){r+=2,e.length=r,i.length=r,--r,e[r]=s,i[r]=t;break}r--}}(s,r);let n=t.get(r);if(n)return"[Circular Reference]"+n;t.set(r,i.join("."))}return r}return function(r,n){try{return e.push(r),JSON.stringify(r,s,n)}finally{t.clear(),e.length=0,i.length=1}}}());const ct=(t,e=!0)=>{t instanceof Object&&(t=Array.isArray(t)?[...t]:Object.assign({},t));for(let e in t)t[e]instanceof Function&&(t[e]=t[e].toString()),t[e]instanceof Object&&(t[e]=ct(t[e],!1));return e?JSON.stringify(t):t};var ft=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,pt=/([^\s,]+)/g;try{if("object"==typeof process){const t=require("node-fetch");"function"!=typeof globalThis.fetch&&(globalThis.fetch=t)}}catch(t){}class gt{constructor(t="https://localhost",r,n){let o,a;this.id=null,this.target=null,this.type=null,this.link=null,this.credentials={},this.connection=null,this.services={available:{},connecting:{},queue:{}},this.router=null,this.clients={},this.user=s(),this.status=!1,this.responses={},this.setCredentials=t=>{var e;t||(t={_id:s()}),this.credentials={_id:null!==(e=t._id)&&void 0!==e?e:s(),id:t.id||t._id}},this.check=()=>e(this,void 0,void 0,(function*(){var t,i,s,r,n,o;"webrtc"===this.type&&(yield this._subscribe({protocol:"webrtc",force:!0}).then((t=>{this.status=!0})).catch((t=>console.log("Link doesn't have WebRTC enabled.",t))));const a=()=>e(this,void 0,void 0,(function*(){return yield this._subscribe({protocol:"websocket",force:!0}).then((t=>(this.status=!0,t))),yield this.send("services")})),l=()=>e(this,void 0,void 0,(function*(){return yield this.send("services")}));let h;if("websocket"===this.type?yield a().then((t=>(this.status=!0,t))).catch((t=>e(this,void 0,void 0,(function*(){if("websocket"===this.type)return console.log("Falling back to http"),yield l()})))):h=yield l().then((t=>(this.status=!0,t))).catch((t=>e(this,void 0,void 0,(function*(){return console.log("Falling back to websockets"),yield a()})))),h){console.log("Connection successful!");const e=h.message[0];for(let o in e){const a=e[o].replace(/Backend|Service/,"").toLowerCase();this.services.available[a]=o,(null===(s=null===(i=null===(t=this.router)||void 0===t?void 0:t.SERVICES)||void 0===i?void 0:i[a])||void 0===s?void 0:s.status)instanceof Function&&this.router.SERVICES[a].status(o),"subscription"===(null===(r=this.clients[a])||void 0===r?void 0:r.serviceType)&&(null===(n=this.services.queue[a])||void 0===n||n.forEach((t=>t())),this.services.queue[a]=[])}null===(o=this.services.queue[void 0])||void 0===o||o.forEach((t=>t())),this.services.queue[void 0]=[]}else console.log("Connection failed!");return null==h?void 0:h.message})),this.send=(t,i={},s=(()=>{}))=>e(this,void 0,void 0,(function*(){var r,n,o,a,l,h,d,u;if("string"==typeof t)i.route=t;else{const e=this.services[t.service];i.route=e?`${e}/${t.route}`:t.route}let c;i.suppress=!!this.connection;const f={suppress:i.suppress,id:null===(r=this.link.connection)||void 0===r?void 0:r.id};if("websocket"===(null===(n=this.connection)||void 0===n?void 0:n.protocol))i.id=null===(o=this.link.credentials)||void 0===o?void 0:o.id,c=yield this.link.connection.service.send(i,f);else if("webrtc"===(null===(a=null==this?void 0:this.connection)||void 0===a?void 0:a.protocol))i.id=(null===(l=this.credentials)||void 0===l?void 0:l.id)||(null===(h=this.link.credentials)||void 0===h?void 0:h.id),c=yield this.connection.service.send(i,f);else{i.id=null===(d=this.link.credentials)||void 0===d?void 0:d.id,i.method||(i.method=(null===(u=i.message)||void 0===u?void 0:u.length)>0?"POST":"GET");const t={method:i.method.toUpperCase(),mode:"cors",headers:{"Content-Type":"application/json"}};"GET"!=t.method&&(t.body=ct(i)),c=yield fetch(function(t,e){let i=e instanceof URL?e:new URL(e);return t="/"===i.pathname?t:i.pathname+t,new URL(t,i.href).href}(i.route,this.link.target),t).then((t=>e(this,void 0,void 0,(function*(){const i=t.body.getReader(),r=t.headers.get("Content-Length");let n=0;if(globalThis.ReadableStream){const o=new ReadableStream({start(t){const o=()=>e(this,void 0,void 0,(function*(){i.read().then((({value:e,done:i})=>{i?t.close():(n+=e.length,s(n/r,r),t.enqueue(e),o())}))}));o()}});return new Response(o,{headers:t.headers})}return t})))),c=c?yield c.json().then((t=>{if(c.ok)return t;throw t.message})).catch((t=>e(this,void 0,void 0,(function*(){throw"Invalid JSON"})))):c}return c&&!(null==c?void 0:c.route)&&(c.route=i.route,c.block=!0),c})),this._subscribe=(t={})=>e(this,void 0,void 0,(function*(){let i=()=>new Promise((s=>e(this,void 0,void 0,(function*(){var r;let n=null!==(r=t.protocol)&&void 0!==r?r:this.type;(n?[this.clients[n]]:Object.values(this.clients)).forEach((i=>e(this,void 0,void 0,(function*(){var e;if(i&&t.force||!0===(null==i?void 0:i.status)&&"subscription"===(null==i?void 0:i.serviceType)){let r=`${null!==(e=this.link.services.available[null==i?void 0:i.service])&&void 0!==e?e:i.name.toLowerCase()}/subscribe`;if(i.setEndpoint(this.link),!this.connection){const t="http"===this.type||"websocket"===this.type?new URL(r,this.target):this.target,e=yield i.add(this.credentials,t.href);this.router&&i.addResponse("router",(t=>{const e="string"==typeof t?JSON.parse(t):t;Object.values(this.responses).forEach((t=>{t(e)})),this.router&&this.router.handleLocalRoute(e)})),this.connection={service:i,id:e,protocol:i.name}}return"webrtc"===this.type&&(t.routes=[this.target]),yield this.link.send(r,Object.assign({route:t.route,message:t.message,protocol:t.protocol},{message:[t.routes,this.connection.id]})),void s(this.connection)}})))),this.services.queue[n]||(this.services.queue[n]=[]),this.services.queue[n].push((()=>e(this,void 0,void 0,(function*(){let t=yield i();s(t)}))))}))));return yield i()})),this.subscribe=t=>{if(t){let e=i("response");return this.responses[e]=t,e}},this.unsubscribe=t=>{t?delete this.responses[t]:this.responses={}},"object"==typeof t?t instanceof URL?o=t:(o=t.target,a=t.type,this.link=t.link,this.setCredentials(t.credentials)):o=t,a||(a="http"),this.link||(this.link=this),"http"===a||"websocket"===a?(o=o instanceof URL?o:new URL(o),this.id=o.origin):this.id=o,this.target=o,this.type=a,this.router=n,r&&(this.clients=r)}}const vt=t=>"string"==typeof t&&24===t.length?f(t):t,yt=["user","group","authorization","discussion","chatroom","comment","data","event","notification","schedule","date"];class mt extends class{constructor(t){var s;this.id=i("service"),this.name="service",this.callbacks=new Map,this.status=!1,this.serviceType="default",this.routes=[],this.delegate=null===(s=null===globalThis||void 0===globalThis?void 0:globalThis.document)||void 0===s?void 0:s.createDocumentFragment(),this.protocols={},this.services={},this.setEndpointRoute=t=>{this.route=t},this.notify=(t,i,s)=>e(this,void 0,void 0,(function*(){let r=[];return yield Promise.all(Array.from(this.callbacks).map(((n,o)=>e(this,void 0,void 0,(function*(){const e=yield n[1](t,i,s);!e||e instanceof Error||r.push(e)}))))),null==r?void 0:r[0]})),this.setEndpoint=t=>{this.endpoint=t},this.subscribe=t=>{if(t instanceof Function){let e=i();return this.callbacks.set(e,t),e}},this.unsubscribe=t=>this.callbacks.delete(t),this.router=t}addEventListener(...t){var e;null===(e=this.delegate)||void 0===e||e.addEventListener.apply(this.delegate,t)}dispatchEvent(...t){var e;return null===(e=this.delegate)||void 0===e?void 0:e.dispatchEvent.apply(this.delegate,t)}removeEventListener(...t){var e;return null===(e=this.delegate)||void 0===e?void 0:e.removeEventListener.apply(this.delegate,t)}}{constructor(t,i={},s=!1){super(t),this.name="structs",this.collections={},this.debug=!1,this.wipeDB=()=>e(this,void 0,void 0,(function*(){return yield Promise.all(Object.values(this.collections).map((t=>t.instance.deleteMany({})))),!0})),this.db=null==i?void 0:i.db,this.debug=s,this.mode=this.db&&i.mode?i.mode:"local",i.collections||(i.collections={}),yt.forEach((t=>{i.collections[t]||(i.collections[t]=this.db?{instance:this.db.collection(t)}:{},i.collections[t].reference={})})),this.collections=i.collections,this.routes=[{route:"getUser",post:(t,i,s)=>e(this,void 0,void 0,(function*(){const e=t.USERS[s];if(this.debug&&console.log("getUser origin",s,i,"user found:",e),!e)return!1;let r;if("mongo"===this.mode)r=yield this.getMongoUser(e,i[0]);else{let t=this.getLocalData("user",{_id:i[0]});if(t){if(yield this.checkAuthorization(e,t)){r={user:t,groups:this.getLocalData("group",{ownerId:i[0]}),authorizations:this.getLocalData("authorization",{ownerId:i[0]})}}else r={user:{}}}else r={user:{}}}return this.debug&&console.log("getUser:",e,i[0],r),r}))},{route:"setUser",aliases:["addUser"],post:(t,i,s)=>e(this,void 0,void 0,(function*(){const e=t.USERS[s];if(!e)return!1;let r;if("mongo"!==this.mode){return(yield this.checkAuthorization(e,i[0],"WRITE"))&&this.setLocalData(i[0]),!0}return r=yield this.setMongoUser(e,i[0]),this.debug&&console.log("setUser",e,i[0],r),r}))},{route:"getUsersByIds",post:(t,i,s)=>e(this,void 0,void 0,(function*(){const e=t.USERS[s];if(!e)return!1;let r;if("mongo"===this.mode)r=yield this.getMongoUsersByIds(e,i[0]);else if(r=[],Array.isArray(i[0])){let t=this.getLocalData("user",{_id:i[0]});t&&r.push(t)}return this.debug&&console.log("getUserByIds:",e,i[0],r),r}))},{route:"getUsersByRoles",post:(t,i,s)=>e(this,void 0,void 0,(function*(){const e=t.USERS[s];if(!e)return!1;let r;if(this.mode.includes("mongo"))r=yield this.getMongoUsersByRoles(e,i[0]);else{let t=this.getLocalData("user");r=[],t.forEach((t=>{var e;(null===(e=t.userRoles)||void 0===e?void 0:e.includes(i[0]))&&r.push(t)}))}return this.debug&&console.log("getUserByRoles",e,i[0],r),r}))},{route:"deleteUser",aliases:["removeUser"],post:(t,i,s)=>e(this,void 0,void 0,(function*(){const e=t.USERS[s];if(!e)return!1;let r;if("mongo"===this.mode)r=yield this.deleteMongoUser(e,i[0]);else{r=!1;let t=this.getLocalData(i[0]);if(t){this.checkAuthorization(e,t,"WRITE")&&(r=this.deleteLocalData(t))}}return this.debug&&console.log("deleteUser:",e,i[0],r),r}))},{route:"setData",aliases:["setMongoData"],post:(t,i,s)=>e(this,void 0,void 0,(function*(){const r=t.USERS[s];if(!r)return!1;let n;if(!this.mode.includes("mongo")){let t=[];return n=[],yield Promise.all(i.map((i=>e(this,void 0,void 0,(function*(){let e=this.getLocalData(i);(yield this.checkAuthorization(r,e,"WRITE"))&&(this.setLocalData(e),n.push(e),"notification"!==e.structType&&t.push(e))}))))),t.length>0&&this.checkToNotify(r,t,this.mode),this.debug&&console.log("setData:",r,i,n),!0}return n=yield this.setMongoData(r,i),this.debug&&console.log("setData:",r,i,n),n}))},{route:"getData",aliases:["getMongoData","getUserData"],post:(t,i,s)=>e(this,void 0,void 0,(function*(){const r=t.USERS[s];if(!r)return!1;let n;if(this.mode.includes("mongo"))n=yield this.getMongoData(r,i[0],i[1],i[2],i[4],i[5]);else{let t;n=[],i[0]&&(t=this.getLocalData(i[0])),t&&i[1]&&(t=t.filter((t=>{if(t.ownerId===i[1])return!0}))),t&&(yield Promise.all(t.map((t=>e(this,void 0,void 0,(function*(){let e=this.getLocalData(t._id);(yield this.checkAuthorization(r,e))&&n.push(e)}))))))}return this.debug&&console.log("getData:",r,i,n),n}))},{route:"getDataByIds",aliases:["getMongoDataByIds","getUserDataByIds"],post:(t,i,s)=>e(this,void 0,void 0,(function*(){const r=t.USERS[s];if(!r)return!1;let n;if(this.mode.includes("mongo"))n=yield this.getMongoDataByIds(r,i[0],i[1],i[2]);else{let t;n=[],i[2]&&(t=this.getLocalData(i[2])),t&&i[1]&&(t=t.filter((t=>{if(t.ownerId===i[1])return!0}))),t&&(yield Promise.all(t.map((t=>e(this,void 0,void 0,(function*(){let e=this.getLocalData(t._id);(yield this.checkAuthorization(r,e))&&n.push(e)}))))))}return this.debug&&console.log("getDataByIds:",r,i,n),n}))},{route:"getAllData",post:(t,i,s)=>e(this,void 0,void 0,(function*(){const r=t.USERS[s];if(!r)return!1;let n;if(this.mode.includes("mongo"))n=yield this.getAllUserMongoData(r,i[0],i[1]);else{let t=this.getLocalData(void 0,{ownerId:i[0]});n=[],yield Promise.all(t.map((t=>e(this,void 0,void 0,(function*(){if(i[1]){if(i[1].indexOf(t.structType)<0){(yield this.checkAuthorization(r,t))&&n.push(t)}}else{(yield this.checkAuthorization(r,t))&&n.push(t)}})))))}return this.debug&&console.log("getAllData:",r,i,n),n}))},{route:"deleteData",post:(t,i,s)=>e(this,void 0,void 0,(function*(){const r=t.USERS[s];if(!r)return!1;let n;return this.mode.includes("mongo")?n=yield this.deleteMongoData(r,i):(n=!1,yield Promise.all(i.map((t=>e(this,void 0,void 0,(function*(){let e=this.getLocalData(t);(yield this.checkAuthorization(r,e,"WRITE"))&&this.deleteLocalData(e),n=!0})))))),this.debug&&console.log("deleteData:",r,i,n),n}))},{route:"getGroup",aliases:["getGroups"],post:(t,i,s)=>e(this,void 0,void 0,(function*(){const e=t.USERS[s];if(!e)return!1;let r;if(this.mode.includes("mongo"))r=yield this.getMongoGroups(e,i[0],i[1]);else if("string"==typeof i[1])r=this.getLocalData("group",{_id:i[1]});else{r=[];let t=this.getLocalData("group");i[0]?t.forEach((t=>{t.users.includes(i[0])&&r.push(t)})):t.forEach((t=>{t.users.includes(e._id)&&r.push(t)}))}return this.debug&&console.log("getGroups:",e,i,r),r}))},{route:"setGroup",post:(t,i,s)=>e(this,void 0,void 0,(function*(){const e=t.USERS[s];if(!e)return!1;let r=yield this.setGroup(e,i[0],this.mode);this.debug&&console.log("setGroup:",e,i,r)}))},{route:"deleteGroup",post:(t,i,s)=>e(this,void 0,void 0,(function*(){const e=t.USERS[s];if(!e)return!1;let r;if(this.mode.includes("mongo"))r=yield this.deleteMongoGroup(e,i[0]);else{let t=this.getLocalData("group",i[0]),s=!1;t&&(s=yield this.checkAuthorization(e,t,"WRITE")),s&&(r=!0)}return this.debug&&console.log("deleteGroup:",e,i,r),r}))},{route:"setAuth",post:(t,i,s)=>e(this,void 0,void 0,(function*(){const e=t.USERS[s];if(!e)return!1;let r=yield this.setAuthorization(e,i[0],this.mode);return this.debug&&console.log("deleteGroup:",e,i,r),r}))},{route:"getAuths",post:(t,i,s)=>e(this,void 0,void 0,(function*(){const e=t.USERS[s];if(!e)return!1;let r;if(this.mode.includes("mongo"))r=yield this.getMongoAuthorizations(e,i[0],i[1]);else if(i[1]){let t=this.getLocalData("authorization",{_id:i[1]});t&&(r=[t])}else r=this.getLocalData("authorization",{ownerId:i[0]});return this.debug&&console.log("deleteGroup:",e,i,r),r}))},{route:"deleteAuth",post:(t,i,s)=>e(this,void 0,void 0,(function*(){const e=t.USERS[s];if(!e)return!1;let r;if(this.mode.includes("mongo"))r=yield this.deleteMongoAuthorization(e,i[0]);else{r=!0;let t=this.getLocalData("authorization",{_id:i[0]});if(t){this.checkAuthorization(e,t,"WRITE")&&(r=this.deleteLocalData(t))}}return this.debug&&console.log("deleteGroup:",e,i,r),r}))}]}notificationStruct(t={}){let e="notification";return{structType:e,timestamp:Date.now(),id:i(e),note:"",ownerId:"",parentUserId:"",parent:{structType:null==t?void 0:t.structType,_id:null==t?void 0:t._id}}}checkToNotify(t,i=[],s=this.mode){return e(this,void 0,void 0,(function*(){if("string"==typeof t)for(let e in this.router.USERS){const i=this.router.USERS[e];i._id===t&&(t=i)}if("string"==typeof t||null==t)return!1;let r={},n=[];if(i.forEach((i=>e(this,void 0,void 0,(function*(){if((null==t?void 0:t._id)!==i.ownerId){let t=this.notificationStruct(i);t.id="notification_"+i._id,t.ownerId=i.ownerId,t.note=i.structType,t.parentUserId=i.ownerId,n.push(t),r[i.ownerId]=i.ownerId}if(i.users)i.users.forEach((e=>{if(e!==t._id){let t=this.notificationStruct(i);t.id="notification_"+i._id,t.ownerId=e,t.note=i.structType,t.parentUserId=i.ownerId,n.push(t),r[e]=e}}));else{let e=[];if("mongo"===s){let i=this.collections.authorizations.instance.find({$or:[{authorizedId:t._id},{authorizerId:t._id}]});(yield i.count())>0&&(yield i.forEach((t=>e.push(t))))}else e=this.getLocalData("authorization",{authorizedId:t._id}),e.push(...this.getLocalData("authorization",{authorizerId:t._id}));e.length>0&&e.forEach((t=>{if(i.authorizerId===i.ownerId&&!r[i.authorizedId]&&"OKAY"===t.status&&t.authorizations.indexOf("peer")>-1){let e=this.notificationStruct(i);e.ownerId=t.authorizedId,e.id="notification_"+i._id,e.note=i.structType,e.parentUserId=i.ownerId,n.push(e),r[e.ownerId]=e.ownerId}}))}})))),n.length>0){"mongo"===s?yield this.setMongoData(t,n):this.setLocalData(n);for(const t in r)this.router.sendMsg(t,"notifications",!0);return!0}return!1}))}setMongoData(t,i=[]){return e(this,void 0,void 0,(function*(){let s=!1;if(i.length>0){let r=!0,n="";if(yield Promise.all(i.map((i=>e(this,void 0,void 0,(function*(){if(((null==t?void 0:t._id)!==i.ownerId||t._id===i.ownerId&&t.userRoles.includes("admin_control"))&&n!==i.ownerId&&(r=yield this.checkAuthorization(t,i,"WRITE"),n=i.ownerId),r){let t=JSON.parse(JSON.stringify(i));t._id&&delete t._id,i.id?i.id.includes("defaultId")?(yield this.db.collection(i.structType).insertOne(t),s=!0):yield this.db.collection(i.structType).updateOne({id:i.id},{$set:t},{upsert:!0}):i._id&&(i._id.includes("defaultId")?(yield this.db.collection(i.structType).insertOne(t),s=!0):yield this.db.collection(i.structType).updateOne({_id:vt(i._id)},{$set:t},{upsert:!1}))}}))))),!0===s){let s=[];return yield Promise.all(i.map(((t,r)=>e(this,void 0,void 0,(function*(){let r=JSON.parse(JSON.stringify(t));if(r._id&&delete r._id,"comment"!==t.structType){let e;"notification"!==t.structType&&(e=yield this.db.collection(r.structType).findOne(r)),e&&(e._id=e._id.toString(),s.push(e))}else if("comment"===t.structType){let r=t,n=JSON.parse(JSON.stringify(r));n._id&&delete n._id;let o=yield this.db.collection("comment").findOne(n),a=r.replyTo,l=i.find((t=>{if(t._id===a)return!0}));if(l){let t,n=JSON.parse(JSON.stringify(l));if(n._id&&delete n._id,yield Promise.all(["discussion","chatroom","comment"].map((i=>e(this,void 0,void 0,(function*(){let e=yield this.db.collection(i).findOne({_id:vt(a)});e&&(t=e)}))))),t){let n,l,h=r.parent._id;if(h!==a?(n=i.find((t=>{if(t._id===h)return!0})),n&&(delete n._id,yield Promise.all(["discussion","chatroom"].map((t=>e(this,void 0,void 0,(function*(){let e=yield this.db.collection(t).findOne(n);e&&(l=e)}))))))):l=t,t){let e=t.replies.indexOf(r._id);e>-1&&(t.replies[e]=o._id.toString(),o.replyTo=t._id.toString())}if(l){let t=l.comments.indexOf(r._id);t>-1&&(l.comments[t]=o._id.toString(),o.parent._id=l._id.toString())}let d=[o,t];l._id.toString()!==t._id.toString()&&d.push(l),yield Promise.all(d.map((t=>e(this,void 0,void 0,(function*(){let e=JSON.parse(JSON.stringify(t));delete e._id,yield this.db.collection(t.structType).updateOne({_id:vt(t._id)},{$set:e},{upsert:!1})}))))),[...s].reverse().forEach(((t,e)=>{d.find((e=>{if(t._id.toString()===e._id.toString())return!0}))&&s.splice(s.length-e-1,1)})),s.push(...d)}}else o&&s.push(o)}}))))),this.checkToNotify(t,s),s}{let e=[];return i.forEach((t=>{"notification"!==t.structType&&e.push(t)})),this.checkToNotify(t,e),!0}}return!1}))}setMongoUser(t,i){return e(this,void 0,void 0,(function*(){if(i._id){if(t._id!==i.ownerId||t._id===i.ownerId&&t.userRoles.includes("admin_control")){if(!(yield this.checkAuthorization(t,i,"WRITE")))return!1}let e=JSON.parse(JSON.stringify(i));e._id&&delete e._id,this.router.DEBUG&&console.log("RETURNS PROFILE",i);const s=vt(i._id),r=s!==i._id?{_id:s}:{id:i.id};return yield this.collections.users.instance.updateOne(r,{$set:e},{upsert:!0}),t=yield this.collections.users.instance.findOne(r),this.checkToNotify(t,[i]),t}return!1}))}setGroup(t,i={},s=this.mode){return e(this,void 0,void 0,(function*(){if(i._id){let e;if(e="mongo"===s?yield this.collections.groups.instance.findOne({name:i.name}):this.getLocalData("group",{_id:i._id}),e&&(e.ownerId!==i.ownerId||i.admins.indexOf(t._id)<0))return!1;if(t._id!==i.ownerId){if(!(yield this.checkAuthorization(t,i,"WRITE")))return!1}let r=[];i.users.forEach((t=>{r.push({email:t},{id:t},{username:t})}));let n=[],o=[];if("mongo"===s){let t=this.collections.users.instance.find({$or:r});(yield t.count())>0&&(yield t.forEach((t=>{n.push(t),o.push(t._id)})))}else r.forEach((t=>{let e=this.getLocalData("user",t);e.length>0&&(n.push(e[0]),o.push(e[0]._id))}));i.users=o;let a=[],l=[],h=[];n.forEach((t=>{i.admins.find(((e,s)=>{if(e===t._id||e===t.email||e===t.username||t._id===i.ownerId)return a.indexOf(t._id<0)&&a.push(t._id),!0})),i.peers.find(((e,i)=>{if(e===t._id||e===t.email||e===t.username)return l.indexOf(t._id<0)&&l.push(t._id),!0})),i.clients.find(((e,i)=>{if(e===t._id||e===t.email||e===t.username)return h.indexOf(t._id<0)&&h.push(t._id),!0}))})),i.admins=a,i.peers=l,i.clients=h;let d=JSON.parse(JSON.stringify(i));return d._id&&delete d._id,"mongo"===s?i._id.includes("defaultId")?yield this.db.collection(i.structType).insertOne(d):yield this.collections.groups.instance.updateOne({_id:vt(i._id)},{$set:d},{upsert:!0}):this.setLocalData(i),this.checkToNotify(t,[i],this.mode),i}return!1}))}getMongoUser(t,i="",s=!1){return e(this,void 0,void 0,(function*(){return new Promise((r=>e(this,void 0,void 0,(function*(){const e=[{email:i},{id:i},{username:i}];try{e.push({_id:vt(i)})}catch(t){}let n=yield this.collections.users.instance.findOne({$or:e});if(n&&null!=n)if(!n._id&&n._id?n._id=n._id.toString():!n._id&&n._id&&(n._id=n._id),n.ownerId||(n.ownerId=n._id),n&&!1===s){if(t._id!==n._id||t._id===n._id&&t.userRoles.includes("admin_control")){(yield this.checkAuthorization(t,n))||r(void 0)}let e=[],i=this.collections.authorizations.instance.find({ownerId:n._id});(yield i.count())>0&&(yield i.forEach((t=>e.push(t))));let s=this.collections.groups.instance.find({users:{$all:[n._id]}}),o=[];(yield s.count())>0&&(yield s.forEach((t=>o.push(t)))),n.authorizations=e,n.groups=o,r(n)}else r(n);else r({})}))))}))}getMongoUsersByIds(t={},i=[]){return e(this,void 0,void 0,(function*(){let t=[];i.forEach((e=>{try{t.push({_id:vt(e)})}catch(t){}}));let e=[];if(t.length>0){let i=this.collections.users.instance.find({$or:t});(yield i.count())>0&&(yield i.forEach((t=>{e.push(t)})))}return e}))}getMongoUsersByRoles(t={},i=[]){return e(this,void 0,void 0,(function*(){let t=this.collections.users.instance.find({userRoles:{$all:i}}),e=[];return(yield t.count())>0&&(yield t.forEach((t=>{e.push(t)}))),e}))}getMongoDataByIds(t,i,s,r){return e(this,void 0,void 0,(function*(){if(i.length>0){let n=[];i.forEach((t=>{let e={_id:t};s&&(e.ownerId=s),n.push(e)}));let o=[];if(r){let i=yield this.db.collection(r).find({$or:n});if((yield i.count())>0){let s=!0,r="";yield i.forEach((i=>e(this,void 0,void 0,(function*(){(t._id!==i.ownerId||t._id===i.ownerId&&t.userRoles.includes("admincontrol"))&&r!==i.ownerId&&(s=yield this.checkAuthorization(t,i),r=i.ownerId),s&&o.push(i)}))))}}else yield Promise.all(Object.keys(this.collections).map((i=>e(this,void 0,void 0,(function*(){let s=yield this.db.collection(i).find({$or:n});if((yield s.count())>0){let i=!0,r="";yield s.forEach((s=>e(this,void 0,void 0,(function*(){(t._id!==s.ownerId||t._id===s.ownerId&&t.userRoles.includes("admincontrol"))&&r!==s.ownerId&&(i=yield this.checkAuthorization(t,s),r=s.ownerId),i&&o.push(s)}))))}})))));return o}}))}getMongoData(t,i,s,r={},n=0,o=0){return e(this,void 0,void 0,(function*(){s||(s=null==r?void 0:r.ownerId),r._id&&(r._id=vt(r._id));let a=[],l=!0,h="";if(!(i||s||r))return[];if(!i&&s&&0===Object.keys(r).length)return yield this.getAllUserMongoData(t,s);if(!r&&s){let r=this.db.collection(i).find({ownerId:s}).sort({$natural:-1}).skip(o);n>0&&r.limit(n),(yield r.count())>0&&(yield r.forEach((i=>e(this,void 0,void 0,(function*(){(t._id!==i.ownerId||t._id===i.ownerId&&t.userRoles.includes("admincontrol"))&&h!==i.ownerId&&(l=yield this.checkAuthorization(t,i),h=i.ownerId),!0===l&&a.push(i)})))))}else if(Object.keys(r).length>0&&s){let t=yield this.db.collection(i).findOne(Object.assign({ownerId:s},r));t&&a.push(t)}else Object.keys(r).length>0&&!s&&(yield Promise.all(Object.keys(this.collections).map((i=>e(this,void 0,void 0,(function*(){let e=yield this.db.collection(i).findOne(r);if(e)return(t._id!==e.ownerId||t._id===e.ownerId&&t.userRoles.includes("admincontrol"))&&h!==e.ownerId&&(l=yield this.checkAuthorization(t,e),h=e.ownerId),void a.push(e)}))))));return l?a:[]}))}getAllUserMongoData(t,i,s=[]){return e(this,void 0,void 0,(function*(){let r=[],n=!0,o="";return yield Promise.all(Object.keys(this.collections).map(((a,l)=>e(this,void 0,void 0,(function*(){if(n&&s.indexOf(a)<0){let e=this.db.collection(a).find({ownerId:i}),s=yield e.count();for(let a=0;a<s;a++){let s=yield e.next();(t._id!==i||t._id===i&&t.userRoles.includes("admincontrol"))&&o!==i&&(n=yield this.checkAuthorization(t,s),o=i),n&&r.push(s)}}}))))),n?r:[]}))}getMongoDataByRefs(t,i=[]){return e(this,void 0,void 0,(function*(){let s=[];if(s.length>0){let r="";i.forEach((i=>e(this,void 0,void 0,(function*(){if(i.structType&&i._id){let e=yield this.db.collection(i.structType).findOne({_id:vt(i._id)});e&&((t._id!==e.ownerId||t._id===e.ownerId&&t.userRoles.includes("admincontrol"))&&r!==e.ownerId&&(yield this.checkAuthorization(t,e),r=e.ownerId),s.push(e))}}))))}return s}))}getMongoAuthorizations(t,i=t._id,s=""){return e(this,void 0,void 0,(function*(){let e=[];if(0===s.length){let t=this.collections.authorizations.instance.find({ownerId:i});(yield t.count)>0&&(yield t.forEach((t=>{e.push(t)})))}else e.push(yield this.collections.authorizations.instance.findOne({_id:vt(s),ownerId:i}));if(t._id!==e[0].ownerId){if(!(yield this.checkAuthorization(t,e[0])))return}return e}))}getMongoGroups(t,i=t._id,s=""){return e(this,void 0,void 0,(function*(){let t=[];if(0===s.length){let e=this.collections.groups.instance.find({users:{$all:[i]}});(yield e.count)>0&&(yield e.forEach((e=>{t.push(e)})))}else try{t.push(yield this.collections.groups.instance.findOne({_id:vt(s),users:{$all:[i]}}))}catch(t){}return t}))}deleteMongoData(t,i=[]){return e(this,void 0,void 0,(function*(){let s=[];yield Promise.all(i.map((t=>e(this,void 0,void 0,(function*(){try{let e=vt(t._id),i=yield this.db.collection(t.structType).findOne({_id:e});if(i){s.push(i);let e=yield this.collections.notifications.instance.find({parent:{structType:t.structType,id:t._id}}),r=yield e.count();for(let t=0;t<r;t++){let t=yield e.next();t&&s.push(t)}}}catch(t){}})))));let r="";return yield Promise.all(s.map(((i,s)=>e(this,void 0,void 0,(function*(){var e;let s=!0;(i.ownerId!==t._id||t._id===i.ownerId&&(null===(e=t.userRoles)||void 0===e?void 0:e.includes("admincontrol")))&&i.ownerId!==r&&(r=i.ownerId,s=yield this.checkAuthorization(t,i,"WRITE")),s&&(yield this.db.collection(i.structType).deleteOne({_id:vt(i._id)}),i.users&&i.users.forEach((e=>{e!==t._id&&e!==i.ownerId&&this.router.sendMsg(e,"deleted",i._id)})),i.ownerId!==t._id&&this.router.sendMsg(i.ownerId,"deleted",i._id))}))))),!0}))}deleteMongoUser(t,i){return e(this,void 0,void 0,(function*(){if(t._id!==i||t._id===i&&t.userRoles.includes("admincontrol")){let e=yield this.collections.users.instance.findOne({id:i});if(!(yield this.checkAuthorization(t,e,"WRITE")))return!1}return yield this.collections.users.instance.deleteOne({id:i}),t._id!==i&&this.router.sendMsg(i,"deleted",i),!0}))}deleteMongoGroup(t,i){return e(this,void 0,void 0,(function*(){let e=yield this.collections.groups.instance.findOne({_id:vt(i)});if(e){if(t._id!==e.ownerId||t._id===e.ownerId&&t.userRoles.includes("admincontrol")){if(!(yield this.checkAuthorization(t,e,"WRITE")))return!1}return e.users&&e.users.forEach((t=>{this.router.sendMsg(e.authorizerId,"deleted",e._id)})),yield this.collections.groups.instance.deleteOne({_id:vt(i)}),!0}return!1}))}deleteMongoAuthorization(t,i){return e(this,void 0,void 0,(function*(){let e=yield this.collections.authorizations.instance.findOne({_id:vt(i)});if(e){if(t._id!==e.ownerId||t._id===e.ownerId&&t.userRoles.includes("admincontrol")){if(!(yield this.checkAuthorization(t,e,"WRITE")))return!1}return e.associatedAuthId&&(this.router.DEBUG&&console.log(e),yield this.collections.authorizations.instance.deleteOne({_id:vt(e.associatedAuthId)}),e.authorizerId!==t._id?this.router.sendMsg(e.authorizerId,"deleted",e._id):e.authorizedId!==t._id&&this.router.sendMsg(e.authorizedId,"deleted",e._id)),yield this.collections.authorizations.instance.deleteOne({_id:vt(i)}),!0}return!1}))}setAuthorization(t,i,s=this.mode){return e(this,void 0,void 0,(function*(){let r,n;if("mongo"===s?(r=yield this.getMongoUser(t,i.authorizedId,!0),n=yield this.getMongoUser(t,i.authorizerId,!0)):(r=this.getLocalData("user",{_id:i.authorizedId}),n=this.getLocalData("user",{_id:i.authorizedId})),!r||!n)return!1;if(i.authorizedId!==r._id&&(i.authorizedId=r._id),i.authorizerId!==n._id&&(i.authorizerId=n._id),i.authorizedName||(r.username?i.authorizedName=r.username:r.email&&(i.authorizedName=r.email)),i.authorizerName||(r.username?i.authorizerName=r.username:r.email&&(i.authorizerName=r.email)),(t._id!==i.ownerId||t._id===i.ownerId&&t.userRoles.includes("admincontrol"))&&t._id!==i.authorizedId&&t._id!==i.authorizerId){if(!(yield this.checkAuthorization(t,i,"WRITE")))return!1}let o,a=[];if("mongo"===s){let t=this.collections.authorizations.instance.find({$and:[{authorizedId:i.authorizedId},{authorizerId:i.authorizerId}]});(yield t.count())>0&&(yield t.forEach((t=>a.push(t))))}else{let t=this.getLocalData("authorization",{authorizedId:i.authorizedId});Array.isArray(t)&&t.forEach((t=>{t.authorizerId===i.authorizerId&&a.push(t)}))}Array.isArray(a)&&a.forEach((s=>e(this,void 0,void 0,(function*(){if(s.ownerId===t._id);else{i.authorizerId===t._id?(s.authorizations=i.authorizations,s.structIds=i.structIds,s.excluded=i.excluded,s.expires=i.expires,s.status="OKAY",i.status="OKAY"):(i.authorizations=s.authorizations,i.structIds=s.structIds,i.excluded=s.excluded,i.expires=s.expires,s.status="OKAY",i.status="OKAY"),i.associatedAuthId=s._id.toString(),s.associatedAuthId=i._id.toString(),o=s;let e=JSON.parse(JSON.stringify(s));this.mode.includes("mongo")?(delete e._id,yield this.collections.authorizations.instance.updateOne({$and:[{authorizedId:i.authorizedId},{authorizerId:i.authorizerId},{ownerId:s.ownerId}]},{$set:e},{upsert:!0})):this.setLocalData(e)}}))));let l=JSON.parse(JSON.stringify(i));if("mongo"===s?(delete l._id,yield this.collections.authorizations.instance.updateOne({$and:[{authorizedId:i.authorizedId},{authorizerId:i.authorizerId},{ownerId:i.ownerId}]},{$set:l},{upsert:!0})):this.setLocalData(l),i._id.includes("defaultId")&&"mongo"===s){let e=yield this.collections.authorizations.instance.findOne(l);if(e&&(i._id=e._id.toString(),o)){let e=yield this.collections.authorizations.instance.findOne({$and:[{authorizedId:o.authorizedId},{authorizerId:o.authorizerId},{ownerId:o.ownerId}]});e&&(e.associatedAuthId=i._id,delete e._id,yield this.collections.authorizations.instance.updateOne({$and:[{authorizedId:e.authorizedId},{authorizerId:e.authorizerId},{ownerId:e.ownerId}]},{$set:e},{upsert:!0}),this.checkToNotify(t,[e]))}}return i}))}checkAuthorization(t,i,s="READ",r=this.mode){var n,o,a;return e(this,void 0,void 0,(function*(){if(!t||!i)return!1;if("object"==typeof t){if(i.ownerId===t._id&&!(null===(n=t.userRoles)||void 0===n?void 0:n.includes("admin_control")))return!0}else if("string"==typeof t){if(i.ownerId===t)return!0;t={_id:t}}let e,l;if("mongo"===r?(e=yield this.collections.authorizations.instance.findOne({$or:[{authorizedId:t._id,authorizerId:i.ownerId,ownerId:t._id},{authorizedId:i.ownerId,authorizerId:t._id,ownerId:t._id}]}),l=yield this.collections.authorizations.instance.findOne({$or:[{authorizedId:t._id,authorizerId:i.ownerId,ownerId:i.ownerId},{authorizedId:i.ownerId,authorizerId:t._id,ownerId:i.ownerId}]})):(e=this.getLocalData("authorization",{ownerId:t._id}).find((e=>{if(e.authorizedId===t._id&&e.authorizerId===i.ownerId)return!0})),l=this.getLocalData("authorization",{ownerId:i.ownerId}).find((e=>{if(e.authorizedId===t._id&&e.authorizerId===i.ownerId)return!0}))),!e||!l)return!1;let h=!1;return"OKAY"===e.status&&"OKAY"===l.status&&("group"===i.structType?h=e.authorizations.indexOf(i.name+"_admin")>-1&&l.authorizations.indexOf(i.name+"_admin")>-1:e.authorizations.indexOf("provider")>-1&&l.authorizations.indexOf("provider")>-1||e.authorizations.indexOf("peer")>-1&&l.authorizations.indexOf("peer")>-1||e.authorizations.indexOf("control")>-1&&l.authorizations.indexOf("control")>-1||(null===(o=e.structIds)||void 0===o?void 0:o.indexOf(i._id))>-1&&(null===(a=l.structIds)||void 0===a?void 0:a.indexOf(i._id))>-1?h=!0:e.excluded.indexOf(i.structType)>-1&&i.ownerId===t._id&&"WRITE"===s&&(h=!1)),h}))}overwriteLocalData(t){if(Array.isArray(t))t.forEach((t=>{let e=this.getLocalData(t.structType,{ownerId:t.ownerId,_id:t._id});e&&0!==(null==e?void 0:e.length)?Object.assign(e,t):this.setLocalData(t)}));else{let e=this.getLocalData(t.structType,{ownerId:t.ownerId,_id:t._id});e&&0!==(null==e?void 0:e.length)?Object.assign(e,t):this.setLocalData(t)}}setLocalData(t){let e=t=>{let e=t.structType,i=this.collections[e].reference;i||(i={},this.collections[e].reference=i),i[t._id]=t};Array.isArray(t)?t.forEach((t=>{e(t)})):e(t)}getLocalData(t,e){let i,s,r;if("object"==typeof e){i=e.ownerId;const t=Object.keys(e).filter((t=>"ownerId"!=t));s=t[0],r=e[s]}else r=e;if(!(t||i||s||r))return[];let n=[];if(!t&&(i||s))return Object.values(this.collections).forEach((t=>{if(t=t.reference,"_id"!==s&&"id"!==s||!r)Object.values(t).forEach((t=>{s&&r?t[s]===r&&t.ownerId===i&&n.push(t):t.ownerId===i&&n.push(t)}));else{let e=t[r];e&&n.push(e)}})),n;{let e=this.collections[t].reference;if(!e)return n;if(!s&&!i)return Object.values(e).forEach((t=>{n.push(t)})),n;if(("_id"===s||"id"===s)&&r)return e[r];Object.keys(e).forEach((t=>{const o=e[t];s&&r&&!i?o[s]===r&&n.push(o):i&&!s?o.ownerId===i&&n.push(o):i&&s&&r&&o.ownerId===i&&o[s]&&o[s]===r&&n.push(o)}))}return n}deleteLocalData(t){if(!t)throw new Error("Struct not supplied");return!(!t.structType||!t._id)&&(this.collections[t.structType]&&delete this.collections[t.structType].reference[t._id],!0)}}t.StructRouter=class extends class{constructor(t={debug:!1}){this.id=i(),this.USERS={},this.CONNECTIONS=new Map,this.SUBSCRIPTIONS=[],this.ENDPOINTS={},this.SERVICES={},this.ROUTES={},this.INTERVAL=10,this.DEFAULTROUTES=[{route:"ping",post:()=>"pong"},{route:"services/**",get:{object:this.SERVICES,transform:(t,...e)=>{let i={};return(e.length>0?[e[0]]:Object.keys(t)).forEach((e=>{const s=t[e];"default"===(null==s?void 0:s.serviceType)&&(i[e]=s.name)})),e.forEach(((t,e)=>i=i[t])),i}}},{route:"/",aliases:["routes/**"],get:{object:this.ROUTES,transform:(t,...e)=>{let i={};return(e.length>0?[e[0]]:Object.keys(t)).forEach((e=>{e&&(i[e]={route:t[e].route.split("/").filter((t=>!t.match(/\*\*?/))).join("/"),args:t[e].args,wildcard:e.includes("*")})})),e.forEach(((t,e)=>i=i[t])),i}}},{route:"sendMessage",aliases:["message","sendMsg"],post:(t,e)=>t.sendMsg(e[0],e[1],e[2])},{route:"setUserServerDetails",post:(t,e,i)=>{let s=t.USERS[i];if(!s)return!1;e[0]&&(s.username=e[0]),e[1]&&(s.password=e[1]),e[2]&&(s.props=e[2]),e[3]&&(s._id=e[3],s.id=e[3])}},{route:"setProps",post:(t,e,i)=>{let s=t.USERS[i];if(!s)return!1;if("object"==typeof e&&!Array.isArray(e))return Object.assign(s.props,e),!0;if(Array.isArray(e)&&"object"==typeof e[1]){let i=t.USERS[e[0]];return i&&Object.assign(i.props,e[1]),!0}return!1}},{route:"getProps",post:(t,e,i)=>{let s=t.USERS[i];if(!s)return!1;if(!e[0])return s.props;{let i=t.USERS[e[0]];if(i)return i.props}}},{route:"blockUser",post:(t,e,i)=>{let s=t.USERS[i];return!!s&&this.blockUser(s,e[0])}},{route:"users/**",get:{object:this.USERS,transform:(t,...e)=>{let i={};return(e.length>0?[e[0]]:Object.keys(t)).forEach((e=>{const s=t[e];i[e]={_id:s._id,username:s.username,origin:s.origin,props:s.props,updatedPropNames:s.updatedPropNames,lastUpdate:s.lastUpdate,lastTransmit:s.lastTransmit,latency:s.latency}})),e.forEach(((t,e)=>i=i[t])),i}}},{route:"getUser",post:(t,e,i)=>{let s=t.USERS[i];if(!s)return!1;if(!e[0])return{_id:s._id,username:s.username,origin:s.origin,props:s.props,updatedPropNames:s.updatedPropNames,lastUpdate:s.lastUpdate,lastTransmit:s.lastTransmit,latency:s.latency};{let t=this.USERS[e[0]];if(t)return{_id:t._id,username:t.username,origin:t.origin,props:t.props,updatedPropNames:t.updatedPropNames,lastUpdate:t.lastUpdate,lastTransmit:t.lastTransmit,latency:t.latency}}}},{route:"login",aliases:["addUser","startSession"],post:(t,i,s)=>e(this,void 0,void 0,(function*(){let e=yield t.addUser(...i);return{message:!!e,id:e.id}}))},{route:"logout",aliases:["removeUser","endSession"],post:(t,e,i)=>{let s=t.USERS[i];if(!s)return!1;e[0]?t.removeUser(...e):t.removeUser(s)}}],this.protocols={},this.connect=(t,e)=>{let i=new gt(t,this.SERVICES,this);return this.ENDPOINTS[i.id]=i,i.check().then((t=>{t&&(e&&e(i),this.login(i))})),i},this.disconnect=t=>e(this,void 0,void 0,(function*(){this.logout(this.ENDPOINTS[t]),delete this.ENDPOINTS[t]})),this._loadBackend=(t,i=t.name)=>{var s;this.SERVICES[i]=t,this.SERVICES[i].status=!0,null===(s=t.routes)||void 0===s||s.forEach((t=>this.addRoute(Object.assign({service:i},t)))),t.subscribe&&t.subscribe(((i,s,r)=>e(this,void 0,void 0,(function*(){let e=yield this.handleMessage(i,s);if(null==r?void 0:r.includes("worker")){if(null===e||!t[r])return e;t[r].postMessage({route:"worker/workerPost",message:e,origin:t.id,callbackId:i.callbackId})}return e})))),"subscription"===(null==t?void 0:t.serviceType)&&this.SUBSCRIPTIONS.push(t.updateSubscribers)},this._loadService=(t,i=(null==t?void 0:t.name))=>e(this,void 0,void 0,(function*(){return this._loadBackend(t,i),yield this._loadClient(t,i,!0)})),this._loadClient=(t,i,s=!1)=>new Promise((i=>{const r=t.name;if(t.subscribe&&t.subscribe(((i,s)=>e(this,void 0,void 0,(function*(){var e;const n=this.SERVICES[r],o=!0===n.status;let a;return"local"===s?a=yield this.handleLocalRoute(i):o&&(a=yield this.send({route:`${n.route}/${i.route}`,endpoint:null==t?void 0:t.endpoint},...null!==(e=i.message)&&void 0!==e?e:[])),a})))),s)i(t);else{this.SERVICES[r]=t;const e=e=>{this.SERVICES[r].status=!0,t.setEndpointRoute instanceof Function&&t.setEndpointRoute(e),t.routes.forEach((t=>{this.ROUTES[`${e}/${t.route}`]=t})),i(t)};!0===this.SERVICES[r].status?e(this.SERVICES[r]):this.SERVICES[r].status=e}})),this.get=(t,...e)=>this._send(t,"GET",...e),this.delete=(t,...e)=>this._send(t,"DELETE",...e),this.post=(t,...e)=>this._send(t,"POST",...e),this.send=this.post,this._send=(t,i,...s)=>e(this,void 0,void 0,(function*(){let e,r;if(e="string"==typeof t||null==(null==t?void 0:t.endpoint)?Object.values(this.ENDPOINTS)[0]:t.endpoint,e)return r=yield e.send(t,{message:s,method:i}),r&&this.handleLocalRoute(r,e),null==r?void 0:r.message})),this.handleLocalRoute=(t,i,s)=>e(this,void 0,void 0,(function*(){var e,r,n;if(i&&s&&!t.suppress&&i.connection&&(null===(n=null===(r=null===(e=i.connection)||void 0===e?void 0:e.service)||void 0===r?void 0:r.responses)||void 0===n||n.forEach((e=>e(Object.assign({route:s},t))))),!t.block){let e=this.ROUTES[null==t?void 0:t.route];if((null==e?void 0:e.post)instanceof Function)return e.post(this,t.message,t.id)}})),this.subscribe=(t,i={})=>e(this,void 0,void 0,(function*(){if(Object.keys(this.ENDPOINTS).length>0||(null==i?void 0:i.endpoint)){i.endpoint||(i.endpoint=Object.values(this.ENDPOINTS)[0]);return yield i.endpoint._subscribe(i).then((e=>i.endpoint.subscribe(t)))}throw"Remote is not specified"})),this.handleMessage=(t,i)=>e(this,void 0,void 0,(function*(){var e;let i={};if(Array.isArray(t))i.route=t[0],i.message=t.slice(1),i.callbackId=void 0;else if("string"==typeof t){let e=t.split(" ");i.route=e[0],i.message=e.slice(1),i.callbackId=void 0}else"object"==typeof t&&Object.assign(i,t);if("object"==typeof i&&!Array.isArray(i)&&null!=i.route){let t=this.USERS[null==i?void 0:i.id];console.log("runRoute",i.route);const s=yield this.runRoute(i.route,i.method,i.message,null!==(e=null==t?void 0:t.id)&&void 0!==e?e:i.id,i.callbackId);return s&&i.suppress&&(s.suppress=i.suppress),s}return null})),t.interval&&(this.INTERVAL=t.interval),this.STATE=new dt({},this.INTERVAL,void 0),this.DEBUG=null==t?void 0:t.debug,"onbeforeunload"in globalThis&&(globalThis.onbeforeunload=()=>{Object.values(this.ENDPOINTS).forEach((t=>{"webrtc"!=t.type&&this.logout(t)}))}),this.load({routes:this.DEFAULTROUTES}),this.DEBUG&&this.runCallback("routes",[!0]),(null==t?void 0:t.endpoints)&&t.endpoints.forEach((t=>this.connect(t)))}login(t,i){return e(this,void 0,void 0,(function*(){yield this.logout(t);const s=Object.values(t?{endpoint:t}:this.ENDPOINTS);let r=yield Promise.all(s.map((t=>e(this,void 0,void 0,(function*(){let e=yield this.send({route:"login",endpoint:t},i);return t.setCredentials(e),e})))));return 1===r.reduce(((t,e)=>t*e[0]),!0)}))}logout(t){return e(this,void 0,void 0,(function*(){return 1===(yield Promise.all(Object.values(t?{endpoint:t}:this.ENDPOINTS).map((t=>e(this,void 0,void 0,(function*(){return yield this.send({route:"logout",endpoint:t},t.credentials)})))))).reduce(((t,e)=>t*e[0]),!0)}))}load(t,i=t.name){return e(this,void 0,void 0,(function*(){let e="client"===t.constructor.type,s=!t.constructor.type||"service"===t.constructor.type,r="backend"===t.constructor.type;return s&&(yield this._loadService(t,i)),r&&(yield this._loadBackend(t,i)),e&&(yield this._loadClient(t)),t}))}format(t,e={}){return void 0!==t&&(t&&"object"==typeof t&&("message"in t||"route"in t)||(t={message:t}),Array.isArray(t.message)||(t.message=[t.message]),e.service&&(null==t?void 0:t.route)&&(t.route=`${e.service}/${t.route}`),e.headers&&(t.headers=e.headers)),(null==t?void 0:t.route)&&(t.route=t.route.replace(/\/\*\*?/,"")),t}runRoute(t,i,s=[],r,n){return e(this,void 0,void 0,(function*(){try{if(null==t)return;return!i&&Array.isArray(s)&&(i=s.length>0?"POST":"GET"),this.DEBUG&&console.log("route",t),yield this.runCallback(t,s,r,i).then((t=>{if(this.DEBUG&&console.log("Result:",t),void 0!==t&&((t=this.format(t)).callbackId=n,this.ROUTES[t.route]&&(t.block=!0),"DONOTSEND"!==t.message))return t})).catch(console.error)}catch(t){return new Error("Route failed...")}}))}addUser(t){if(t&&(t.id||t._id)){t._id||(t._id=s()),t.id||(t.id=t._id);const e=this.USERS[t._id];let i=null!=e?e:{id:t.id,_id:t._id,username:t.id,origin:t.id,props:{},updatedPropNames:[],sessions:[],blocked:[],lastUpdate:Date.now(),lastTransmit:0,latency:0,routes:new Map};Object.assign(i,t),this.DEBUG&&console.log("Adding User, Id:",t._id),this.USERS[t.id]=i;for(let e in this.SERVICES){const s=this.SERVICES[e];if(!0===s.status){ut(s.name+"/users").forEach((e=>{this.ROUTES[e]&&this.runRoute(e,"POST",[i],t._id)}))}}return i}return!1}removeUser(t){let e="string"==typeof t?this.USERS[t]:t;return!!e&&(Object.values(this.SERVICES).forEach((t=>{if(!0===t.status){const i=t.name+"/users";this.ROUTES[i]&&this.runRoute(i,"DELETE",[e],e.id)}})),delete e.id,!0)}blockUser(t,e=""){return!(!this.USERS[e]||t.blocked.includes(e)||t.id===e)&&(t.blocked.push(e),!0)}sendMsg(t="",e="",i){let s=i?Object.assign(i,{message:e}):{message:e};if("string"==typeof t){let e=this.USERS[t];e&&e.send(s)}else if("object"==typeof t)return t.send(s),!0;return!1}addRoute(t){const e=[(t=Object.assign({},t)).route,...t.aliases?t.aliases:[]];return delete t.aliases,e.forEach((e=>{var i,s;if(!e||!t.post&&!t.get)return!1;e=t.route=""+(t.service?`${t.service}/`:"")+e,this.removeRoute(e),"/"===e[0]&&(e=e.slice(1)),t.args=function(t){if(t instanceof Function){var e=t.toString().replace(ft,""),i=e.slice(e.indexOf("(")+1,e.indexOf(")")).match(pt);return null===i&&(i=[]),i}}(t.post),this.ROUTES[e]=Object.assign(t,{route:e}),t.get&&(this.STATE.setState({[e]:null!==(s=null===(i=t.get)||void 0===i?void 0:i.object)&&void 0!==s?s:t.get}),this.STATE.subscribe(e,(i=>{var s;const r=(null===(s=t.get)||void 0===s?void 0:s.transform)?t.get.transform(i):i;this.SUBSCRIPTIONS.forEach((t=>t(this,{route:e,message:r})))})))})),!0}removeRoute(t){return delete this.ROUTES[t]}runCallback(t,i=[],s,r=(i.length>0?"POST":"GET")){return new Promise((n=>e(this,void 0,void 0,(function*(){let o=ut(t),a={route:t,block:!0,message:{html:'<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="utf-8">\n<title>Error</title>\n</head>\n<body>\n<pre>404 Not Found</pre>\n</body>\n</html>'},headers:{"Content-Type":"text/html"}};Promise.all(o.map((o=>e(this,void 0,void 0,(function*(){var e;let l=this.ROUTES[o];if(l){this.DEBUG&&console.log("routeInfo",l);try{let o;if((null==l?void 0:l.delete)&&"DELETE"===r.toUpperCase())o=yield l.delete(this,i,s);else if("GET"!==r.toUpperCase()&&(null==l?void 0:l.post))o=(null==l?void 0:l.post)?yield null==l?void 0:l.post(this,i,s):a;else{const i=this.STATE.data[l.route];if(i){const s=t.replace(l.route.split("/").filter((t=>"*"!=t&&"**"!=t)).join("/"),"").split("/").filter((t=>!!t));o={message:(null===(e=l.get)||void 0===e?void 0:e.transform)?yield l.get.transform(i,...s):i}}else o=a}n(this.format(o,l))}catch(t){console.log("Callback Failed: ",t)}}}))))).then((t=>n(a)))}))))}checkRoutes(t){var i,s;return e(this,void 0,void 0,(function*(){if(!t.data)return;let e=null!==(s=null!==(i=this.ROUTES[t.data.foo])&&void 0!==i?i:this.ROUTES[t.data.route])&&void 0!==s?s:this.ROUTES[t.data.functionName];return e||(e=this.ROUTES[t.data.foo]),!!e&&(t.data.message?yield e.post(this,t.data.message,t.data.origin):void 0)}))}}{constructor(t={},s){super(s),this.tablet=new class{constructor(t={},e=!1,i){this.DS=m,this.collections=new Map,this.data={byTime:{},notes:{},events:{},sleep:{},food:{},hr:{},ppg:{},hrv:{},ecg:{},emg:{},eeg:{},fnirs:{}},this.rolloverLimit=5e4,this.dataSorts=new Map,this.watches={},this.onCollectionSet=(t,e)=>{},this.ontrigger=t=>{},this.threaded=e,i?this.workers=i:typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&(this.threaded=!0),Object.assign(this.data,t),this.dataSorts=new Map,this.watches={},this.setSort("event",(t=>(this.data.events[t.timestamp]?this.data.events[t.timestamp].push(t):this.data.events[t.timestamp]=[t],"sleep"===t.event&&(this.data.sleep[t.timestamp]?this.data.sleep[t.timestamp].push(t):this.data.sleep[t.timestamp]=[t]),t))),this.setSort(["notes","note","link"],(t=>(this.data.notes[t.timestamp]?this.data.notes[t.timestamp].push(t):this.data.notes[t.timestamp]=[t],this.data.byTime[t.timestamp]?this.data.byTime[t.timestamp].push(t):this.data.byTime[t.timestamp]=[t],t))),this.id=this.randomId("dataTablet")}randomId(t=""){return`${t+Math.floor(Math.random()+Math.random()*Math.random()*1e16)}`}setLocalData(t){let e=t=>{let e=t.structType,i=this.collections.get(e);i||(i=new Map,this.collections.set(e,i)),i.set(t._id,t),this.onCollectionSet(e,i)};Array.isArray(t)?t.forEach((t=>{e(t)})):e(t)}getLocalData(t,e){let i="",s="",r="";if("object"==typeof e?(i=e.ownerId,s=Object.keys(e).filter((t=>"ownerId"!=t))[0],r=e[s]):r=e,!(t||i||s||r))return[];let n=[];if(!t&&(i||s))return this.collections.forEach((t=>{if("_id"!==s&&"id"!==s||!r)t.forEach((t=>{s&&r?t[s]===r&&t.ownerId===i&&n.push(t):t.ownerId===i&&n.push(t)}));else{let e=t.get(r);e&&n.push(e)}})),n;{let e=this.collections.get(t);if(!e)return n;if(!s&&!i)return e.forEach((t=>{n.push(t)})),n;if(("_id"===s||"id"===s)&&r)return e.get(r);e.forEach(((t,e)=>{s&&r&&!i?t[s]===r&&n.push(t):i&&!s?t.ownerId===i&&n.push(t):i&&s&&r&&t.ownerId===i&&t[s]&&t[s]===r&&n.push(t)}))}return n}runSort(t,e={},i=[],s=this){let r;if(!1===this.threaded){let n=this.getSort(t);if(!n)return!1;r=n(e,i,s)}else if(!0===this.threaded)return this.workers.runWorkerFunction("runSort",[t,e,i],this.workerId,this.id);return r}setSort(t,e=((t,e=[],i=this)=>{})){if(!1===this.threaded)Array.isArray(t)?t.forEach((t=>{this.dataSorts.set(t,e)})):this.dataSorts.set(t,e);else if(!0===this.threaded)return this.workers.runWorkerFunction("setSort",[t,e.toString()],this.workerId,this.id)}getSort(t){return!1===this.threaded?this.dataSorts.get(t):!0===this.threaded?this.workers.runWorkerFunction("getSort",[t],this.workerId,this.id):void 0}checkWatches(t={}){for(let e in this.watches)this.watches[e].ondata(t,this.watches[e].accum,this.watches[e]),this.watches[e].triggered&&(this.ontrigger(this.watches[e].accum),this.watches[e].triggered=!1)}setWatch(t,e=((t,e,i)=>{}),i=(t=>{})){this.watches[t]={triggered:!1,accum:this.DS.Struct("alert"),ondata:e,ontrigger:i}}getWatch(t){return this.watches[t]}async sortStructsIntoTable(t=[]){t.sort((function(t,e){return t.timestamp-e.timestamp}));let e=[];for(let i=0;i<t.length;i++){let s=t[i];if(!s.timestamp)continue;let r=s.timestamp;if(this.data.byTime[r]?this.data.byTime[r].push(s):this.data.byTime[r]=[s],"data"===s.structType&&s.data)s.data.forEach((async t=>{if("object"==typeof t&&!Array.isArray(t)){let i=t.dataType;if(t.ownerId=s.ownerId,t.timestamp||(t.timestamp=r),i){let s=this.runSort(i,t,e,this);s?"Promise"!==s.constructor?.name&&(this.checkWatches(s),this.onUpdate(r,s),e.push(s)):(this.data[i]||(this.data[i]={}),t.timestamp=r,this.data[i][r]?this.data[i][r].push(t):this.data[i][r]=[t],this.data.byTime[r]?this.data.byTime[r].push(t):this.data.byTime[r]=[t],this.checkWatches(t),this.onUpdate(r,t),e.push(t))}}}));else{let t=this.runSort(s.structType,s,e,this);if(t)this.checkWatches(t),this.onUpdate(r,t),e.push(t);else{let t=s.structType;this.data[t]||(this.data[t]={}),this.data[t][r]?this.data[t][r].push(s):this.data[t][r]=[s],this.checkWatches(s),this.onUpdate(r,s),e.push(s)}}}for(let t in this.data)this.data[t]=this.sortObjectByPropName(this.data[t]);this.onSorted(e)}onUpdate(t,e,i=this.data){}onSorted(t=[]){}getDataByTimestamp(t,e){if(!0===this.threaded)return this.workers.runWorkerFunction("getDataByTimestamp",[t,e],this.workerId,this.id);let i=this.data.byTime[t];return e&&i&&(i=i.filter((t=>!e||e===t.ownerId))),i}getDataByTimeRange(t,e,i,s){if(!0===this.threaded)return this.workers.runWorkerFunction("getDataByTimeRange",[t,e,i,s],this.workerId,this.id);let r={};if(i){for(let s in this.data[i]){let n=parseInt(s);n>t&&n<e&&(r[s]=[...this.data[i][s]])}"sleep"===i&&(r=this.filterSleepResults(r))}else for(let i in this.data.byTime){let s=parseInt(i);s>t&&s<e&&(r[i]=[...this.data.byTime[i]])}if(s&&r)for(let t in r){let e=[];r[t]=r[t],r[t].forEach(((t,i)=>{t.ownerId!==s&&e.push(i)})),e.reverse().forEach((e=>{r[t].splice(e,1)})),0===r[t].length&&delete r[t]}return r}getDataByType(t,e,i){if(!this.data[t])return;let s={...this.data[t]};if(e&&(s=[...s[e]]),i&&s)for(let t in s){let e=[];s[t]=[...s[t]],s[t].forEach(((t,s)=>{t.ownerId!==i&&e.push(s)})),e.reverse().forEach((e=>{s[t].splice(e,1)})),0===s[t].length&&delete s[t]}return"sleep"===t&&(s=this.filterSleepResults(s)),s}filterSleepResults(t={}){let e=[];for(let i in t)t[i]=[...t[i]],e.push(...t[i].filter((t=>"event"===t.structType)));return e.forEach((e=>{let i;for(let s in t)t[s].forEach(((t,s)=>!!("fitbitsleep"===t.structType&&e.startTime&&e.endTime&&Math.abs(t.startTime-e.startTime)<432e5&&Math.abs(t.endTime-e.endTime)<432e5&&e.endTime-e.startTime>72e5)&&(i=s,!0))),i&&t[s].splice(i,1)})),t}sortObjectByPropName(t){return Object.keys(t).sort().reduce(((e,i)=>(e[i]=t[i],e)),{})}checkRollover(t,e=this.rolloverLimit){if(!t)return!1;let i=this.collections.get(t);return!!i&&(i.forEach((t=>{for(let i in t)Array.isArray(t[i])?t[i].length>e&&(t[i].slice(t[i].length-e),"ffts"===i?t.fftCount=t[i].length:"times"===i&&(t.count=t[i].length)):"object"==typeof t[i]&&this.checkRollover(t[i])})),!0)}},this.collections=this.tablet.collections,this.id=i(),this.baseServerCallback=t=>{let e=t;if("object"==typeof t&&(null==t?void 0:t.structType)&&(e=[t]),Array.isArray(t)){let t=e.filter((t=>{if("notification"!==t.structType)return!0}));this.tablet&&this.tablet.sortStructsIntoTable(t),e.forEach((t=>{var e;if(t.structType&&"USER"!==t.structType||(t.email?t.structType="user":t.structType="uncategorized"),"user"===t.structType||"authorization"===t.structType||"group"===t.structType)"user"===t.structType&&(t._id=t.id),this.setLocalData(t);else if("notification"===t.structType){this.getLocalData("notification",{ownerId:t.ownerId,_id:t.parent._id})?this.setLocalData(t):this.getLocalData(t.structType,{_id:t.parent._id})||this.overwriteLocalData(t),t.ownerId!==(null===(e=this.currentUser)||void 0===e?void 0:e._id)||"user"!==t.parent.structType&&"data"!==t.parent.structType&&"schedule"!==t.parent.structType&&"authorization"!==t.parent.structType||this.resolveNotifications([t],!0)}else this.overwriteLocalData(t)}))}"notifications"===(null==t?void 0:t.message)&&this.checkForNotifications(),"deleted"===(null==t?void 0:t.message)&&this.deleteLocalData(t.id),this.onResult(t)},this.resolveNotifications=(t=[],i=!0,s=this.currentUser)=>e(this,void 0,void 0,(function*(){if(!s||0===t.length)return;let e=[],r=[],n=[];return 0===t.length&&(t=this.getLocalData("notification",{ownerId:s._id})),t.forEach((t=>{t.parent.structType,n.push(t.parent.structType),e.push(t.parent._id),r.push(t._id),this.deleteLocalData(t)})),this.deleteData(r),!(i&&(n.reverse().forEach(((t,i)=>{"user"===t&&(this.getUser(r[i]),e.splice(e.length-i-1,1))})),e.length>0))||(yield this.getDataByIds(e,s._id,"notification"))})),this.getLocalUserPeerIds=(t=this.currentUser)=>{if(!t)return[];let e=[];return this.getLocalData("authorization",t._id).forEach((i=>{i.authorizations.indexOf("peer")>-1&&i.authorizerId===t._id&&e.push(i.authorizedId)})),e},this.authorizeUser=(t,i="",s="",r="",n="",o=[],a=[],l=[],h=[],d=!1)=>e(this,void 0,void 0,(function*(){if(!t)return;let e=this.createStruct("authorization",void 0,t,void 0);return e.authorizedId=r,e.authorizedName=n,e.authorizerId=i,e.authorizerName=s,e.authorizations=o,e.structs=a,e.excluded=l,e.groups=h,e.expires=d,e.status="PENDING",e.associatedAuthId="",e.ownerId=t._id,e=yield this.setAuthorization(e),e})),this.addGroup=(t,i="",s="",r=[],n=[],o=[],a=!0)=>e(this,void 0,void 0,(function*(){if(!t)return;let e=this.createStruct("group",void 0,t);return e.name=i,e.details=s,e.admins=r,e.peers=n,e.clients=o,e.users=[...r,...n,...o],e.ownerId=t._id,a&&(e=yield this.setGroup(e)),e})),this.addData=(t,i="",s="",r="",n=[],o=!1,a=!0)=>e(this,void 0,void 0,(function*(){if(!t)return;let e=this.createStruct("data",void 0,t);return e.author=i,e.title=s,e.type=r,e.data=n,e.expires=o,e.ownerId=t._id,a&&(e=yield this.updateServerData([e])[0]),e})),this.addEvent=(t,i="",s="",r="",n=0,o=0,a=0,l=[],h=[],d=!0)=>e(this,void 0,void 0,(function*(){if(!t)return;0===h.length&&(h=this.getLocalUserPeerIds(t));let e=this.createStruct("event",void 0,t);return e.author=i,e.event=s,e.notes=r,e.startTime=n,e.endTime=o,e.grade=a,e.attachments=l,e.users=h,e.ownerId=t._id,d&&(e=yield this.updateServerData([e])[0]),e})),this.addDiscussion=(t,i="",s="",r="",n="",o=[],a=[],l=!0)=>e(this,void 0,void 0,(function*(){if(!t)return;0===a.length&&(a=this.getLocalUserPeerIds(t));let e=this.createStruct("discussion",void 0,t);e.topic=s,e.category=r,e.message=n,e.attachments=o,e.authorId=i,e.users=a,e.comments=[],e.replies=[],e.ownerId=t._id;let h=[e];return l&&(e=yield this.updateServerData(h)[0]),e})),this.addChatroom=(t,i="",s="",r=[],n=[],o=!0)=>e(this,void 0,void 0,(function*(){if(!t)return;0===n.length&&(n=this.getLocalUserPeerIds(t));let e=this.createStruct("chatroom",void 0,t);e.message=s,e.attachments=r,e.authorId=i,e.users=n,e.replies=[],e.comments=[],e.ownerId=t._id;let a=[e];return o&&(e=yield this.updateServerData(a)[0]),e})),this.addComment=(t,i,s,r="",n="",o=[],a=!0)=>e(this,void 0,void 0,(function*(){if(!t)return;let e=this.createStruct("comment",void 0,t,i);e.authorId=r,e.replyTo=null==s?void 0:s._id,e.message=n,e.attachments=o,e.users=null==i?void 0:i.users,e.replies=[],e.ownerId=t._id,a?null==s||s.replies.push(e._id):null==s||s.replies.push(e),a?null==i||i.comments.push(e._id):null==i||i.comments.push(e);let l=[e,i];return s._id!==i._id&&l.push(s),a&&(e=yield this.updateServerData(l)[0]),e})),t instanceof Object&&Object.keys(t).length>0&&this.setupUser(t),this.load(new mt(this))}setupUser(t,i=(t=>{})){return e(this,void 0,void 0,(function*(){if(!t)return console.error('must provide an info object! e.g. {_id:"abc123"}'),void i(void 0);let e=!1;t.id&&(t._id=t.id),console.log("Generating/Getting User: ",t._id);let s,r=yield this.getUser(t._id),n=!1;if(null==r?void 0:r._id){s=r.user;for(const i in t){let r=this.userStruct();if(s[i]&&"_id"!==i)if(Array.isArray(t[i])){for(let r=0;r<s[i].length;r++)if(t[i].indexOf(s[i][r])<0){s[i]=t[i],e=!0;break}if(!e)for(let r=0;r<t[i].length;r++)if(s[i].indexOf(t[i][r])<0){s[i]=t[i],e=!0;break}}else s[i]!==t[i]&&(s[i]=t[i],e=!0);else s[i]!==t[i]&&"string"==typeof r[i]&&"_id"!==i&&(s[i]=t[i],e=!0)}(null==r?void 0:r.authorizations)&&Array.isArray(r.authorizations)&&this.setLocalData(r.authorizations),(null==r?void 0:r.groups)&&Array.isArray(r.groups)&&this.setLocalData(r.groups)}else{s=this.userStruct(t,!0),n=!0,yield this.setUser(s);let e=this.getLocalData(void 0,{ownerId:s._id});(null==e?void 0:e.length)>0&&this.updateServerData(e,(t=>{console.log("setData",t)})),this.setAuthorizationsByGroup(s)}if(n)this.currentUser=s,this.setLocalData(s);else{let t=yield this.getAllUserData(s._id,void 0);if(console.log("getServerData",t),t&&0!==t.length){this.setLocalData(t);let i=t.filter((t=>{if("notification"===t.structType){if(this.getLocalData("authorization",t.parent._id))return!0;if("user"===t.parent.structType||"authorization"===t.parent.structType)return!0;if(!this.getLocalData(t.parent.structType,t.parent._id))return!0}})),s=t.filter((t=>{if("comment"===t.structType)return!0})),r=[];s.forEach((t=>{this.getLocalData("comment",{_id:t._id})||r.push(t._id)})),r.length>0&&this.deleteData(r),i.length>0&&(this.resolveNotifications(i,!1,void 0),e=!0);let n=t.filter((t=>{if("notification"!==t.structType)return!0}));this.tablet&&this.tablet.sortStructsIntoTable(n)}else;this.setLocalData(s),console.log("currentUser",s),this.currentUser=s,console.log("collections",this.tablet.collections)}return i(this.currentUser),this.currentUser}))}onResult(t){}randomId(t=""){return`${t+Math.floor(Math.random()+Math.random()*Math.random()*1e16)}`}addStruct(t="struct",i={},s,r,n=!0){return e(this,void 0,void 0,(function*(){let e=m.Struct(t,i,s,r);return n&&(e=yield this.updateServerData([e])[0]),e}))}ping(t=(t=>{console.log(t)})){var i;return e(this,void 0,void 0,(function*(){let e=null===(i=yield this.send("ping"))||void 0===i?void 0:i[0];return t(e),e}))}sendMessage(t="",i="",s,r=(t=>{console.log(t)})){var n;return e(this,void 0,void 0,(function*(){let e=[t,i];s&&(e[2]=s);let o=null===(n=yield this.send("sendMessage",...e))||void 0===n?void 0:n[0];return r(o),o}))}getUser(t="",i=this.baseServerCallback){var s;return e(this,void 0,void 0,(function*(){let e=null===(s=yield this.send("structs/getUser",t))||void 0===s?void 0:s[0];return i(e),e}))}getUsers(t=[],i=this.baseServerCallback){var s;return e(this,void 0,void 0,(function*(){let e=null===(s=yield this.send("structs/getUsers",...t))||void 0===s?void 0:s[0];return i(e),e}))}getUsersByRoles(t=[],i=this.baseServerCallback){var s;return e(this,void 0,void 0,(function*(){let e=null===(s=yield this.send("structs/getUsersByRoles",t))||void 0===s?void 0:s[0];return i(e),e}))}getAllUserData(t,i=[],s=this.baseServerCallback){var r;return e(this,void 0,void 0,(function*(){let e=null===(r=yield this.send("structs/getAllData",t,i))||void 0===r?void 0:r[0];return s(e),e}))}getData(t,i,s,r=0,n=0,o=this.baseServerCallback){var a;return e(this,void 0,void 0,(function*(){let e=null===(a=yield this.send("structs/getData",t,i,s,r,n))||void 0===a?void 0:a[0];return o(e),e}))}getDataByIds(t=[],i,s,r=this.baseServerCallback){var n;return e(this,void 0,void 0,(function*(){let e=null===(n=yield this.send("structs/getDataByIdss",t,i,s))||void 0===n?void 0:n[0];return r(e),e}))}getStructParentData(t,i=this.baseServerCallback){var s,r,n;return e(this,void 0,void 0,(function*(){if(!t.parent)return;let e=[null===(s=t.parent)||void 0===s?void 0:s.structType,"_id",null===(r=t.parent)||void 0===r?void 0:r._id],o=null===(n=yield this.send("structs/getData",...e))||void 0===n?void 0:n[0];return i(o),o}))}setUser(t={},i=this.baseServerCallback){var s;return e(this,void 0,void 0,(function*(){let e=null===(s=yield this.send("structs/setUser",this.stripStruct(t)))||void 0===s?void 0:s[0];return i(e),e}))}checkUserToken(t,i=this.currentUser,s=this.baseServerCallback){return e(this,void 0,void 0,(function*(){if(!t)return!1;let e=!1;for(const s in t){let r=this.userStruct();if(i[s]&&"_id"!==s)if(Array.isArray(t[s])){for(let r=0;r<i[s].length;r++)if(t[s].indexOf(i[s][r])<0){i[s]=t[s],e=!0;break}if(!e)for(let r=0;r<t[s].length;r++)if(i[s].indexOf(t[s][r])<0){i[s]=t[s],e=!0;break}}else i[s]!==t[s]&&(i[s]=t[s],e=!0);else!i[s]&&r[s]&&(i[s]=t[s],e=!0)}return e?yield this.setUser(i,s):e}))}updateServerData(t=[],i=this.baseServerCallback){var s;return e(this,void 0,void 0,(function*(){const e=new Array;t.forEach((t=>{e.push(this.stripStruct(t))}));let r=null===(s=yield this.send("structs/setData",...e))||void 0===s?void 0:s[0];return i(r),r}))}deleteData(t=[],i=this.baseServerCallback){var s;return e(this,void 0,void 0,(function*(){let e=[];t.forEach((t=>{(null==t?void 0:t.structType)&&(null==t?void 0:t._id)&&(e.push({structType:t.structType,_id:t._id}),this.deleteLocalData(t))})),console.log("deleting",e);let r=null===(s=yield this.send("structs/deleteData",...e))||void 0===s?void 0:s[0];return i(r),r}))}deleteUser(t,i=this.baseServerCallback){var s;return e(this,void 0,void 0,(function*(){if(!t)return;let e=null===(s=yield this.send("structs/deleteUser",t))||void 0===s?void 0:s[0];return i(e),e}))}setGroup(t={},i=this.baseServerCallback){var s;return e(this,void 0,void 0,(function*(){let e=null===(s=yield this.send("structs/setGroup",this.stripStruct(t)))||void 0===s?void 0:s[0];return i(e),e}))}getGroups(t=this.currentUser._id,i="",s=this.baseServerCallback){var r;return e(this,void 0,void 0,(function*(){let e=null===(r=yield this.send("structs/getGroups",t,i))||void 0===r?void 0:r[0];return s(e),e}))}deleteGroup(t,i=this.baseServerCallback){var s;return e(this,void 0,void 0,(function*(){if(!t)return;this.deleteLocalData(t);let e=null===(s=yield this.send("structs/deleteGroup",t))||void 0===s?void 0:s[0];return i(e),e}))}setAuthorization(t={},i=this.baseServerCallback){var s;return e(this,void 0,void 0,(function*(){let e=null===(s=yield this.send("structs/setAuth",this.stripStruct(t)))||void 0===s?void 0:s[0];return i(e),e}))}getAuthorizations(t,i,s){var r,n;return void 0===t&&(t=null===(r=this.currentUser)||void 0===r?void 0:r._id),void 0===i&&(i=""),void 0===s&&(s=this.baseServerCallback),e(this,void 0,void 0,(function*(){if(void 0===t)return;let e=null===(n=yield this.send("structs/getAuths",t,i))||void 0===n?void 0:n[0];return s(e),e}))}deleteAuthorization(t,i=this.baseServerCallback){var s;return e(this,void 0,void 0,(function*(){if(!t)return;this.deleteLocalData(t);let e=null===(s=yield this.send("structs/deleteAuth",t))||void 0===s?void 0:s[0];return i(e),e}))}checkForNotifications(t){var i;return void 0===t&&(t=null===(i=this.currentUser)||void 0===i?void 0:i._id),e(this,void 0,void 0,(function*(){return yield this.getData("notification",t)}))}setAuthorizationsByGroup(t=this.currentUser){return e(this,void 0,void 0,(function*(){let e=this.getLocalData("authorization",{ownerId:t._id});t.userRoles.forEach((i=>{let s,r=i.split("_")[0];i.includes("client")?s=r+"_peer":i.includes("peer")?s=r+"_client":i.includes("admin")&&(s=r+"_owner"),s&&this.getUsersByRoles([s],(s=>{null==s||s.forEach((s=>{let r=s.username;r||(r=s.email),r||(r=s.id);let n=t.username;if(n||(n=t.email),n||(n=t.id),r!==n)if(i.includes("client")){e.find((e=>{if(e.authorizerId===s.id&&e.authorizedId===t.id)return!0}))||this.authorizeUser(m.ProfileStruct("user",t,t),s.id,r,t.id,n,["peer"],void 0,[i])}else if(i.includes("peer")){e.find((e=>{if(e.authorizedId===s.id&&e.authorizerId===t.id)return!0}))||this.authorizeUser(m.ProfileStruct("user",t,t),t.id,n,s.id,r,["peer"],void 0,[i])}}))}))}))}))}deleteRoom(t){var i;return e(this,void 0,void 0,(function*(){if(!t)return!1;let e=[t];return null===(i=t.comments)||void 0===i||i.forEach((t=>{let i=this.getLocalData("comment",{_id:t});e.push(i)})),!!t&&(yield this.deleteData(e))}))}deleteComment(t){var i,s,r;return e(this,void 0,void 0,(function*(){let e=[t],n=(i=t)=>{(null==i?void 0:i.replies)&&i.replies.forEach((t=>{let i=this.getLocalData("comment",{_id:t});i&&(i.replies.length>0&&i.replies.forEach((t=>{n(t)})),e.push(i))}))};n(t);let o=this.getLocalData(null===(i=t.parent)||void 0===i?void 0:i.structType,{_id:null===(s=t.parent)||void 0===s?void 0:s._id}),a=[];o&&(a=[o],e.forEach((t=>{var e,i;let s=null===(e=o.replies)||void 0===e?void 0:e.indexOf(t._id);s>-1&&o.replies.splice(s,1);let r=null===(i=o.comments)||void 0===i?void 0:i.indexOf(t._id);r>-1&&o.comments.splice(r,1)})));let l=this.getLocalData("comment",{_id:t.replyTo});if((null==l?void 0:l._id)!==(null==o?void 0:o._id)){let t=null===(r=l.replies)||void 0===r?void 0:r.indexOf(o._id);t>-1&&l.replies.splice(t,1),a.push(l)}return a.length>0&&(yield this.updateServerData(a)),yield this.deleteData(e)}))}getUserDataByAuthorization(t,i,s,r=0,n=0,o=this.baseServerCallback){return e(this,void 0,void 0,(function*(){let a=t.authorizerId;return a?new Promise((t=>e(this,void 0,void 0,(function*(){this.getUser(a,(l=>e(this,void 0,void 0,(function*(){i?yield this.getData(i,a,s,r,n,o):yield this.getAllUserData(a,["notification"],o),t(l),o(l)}))))})))):void 0}))}getUserDataByAuthorizationGroup(t="",i,s,r=0,n=0,o=this.baseServerCallback){return e(this,void 0,void 0,(function*(){let a=this.getLocalData("authorization"),l=[];return yield Promise.all(a.map((a=>e(this,void 0,void 0,(function*(){var e;if(null===(e=a.groups)||void 0===e?void 0:e.includes(t)){let t=a.authorizerId;if(t){let e,a=yield this.getUser(t,o);a&&l.push(a),e=i?yield this.getData(i,t,s,r,n,o):yield this.getAllUserData(t,["notification"],o),e&&l.push(e)}return!0}}))))),l}))}overwriteLocalData(t){if(Array.isArray(t))t.forEach((t=>{let e=this.getLocalData(t.structType,{ownerId:t.ownerId,_id:t._id});e&&0!==(null==e?void 0:e.length)?Object.assign(e,t):this.setLocalData(t)}));else{let e=this.getLocalData(t.structType,{ownerId:t.ownerId,_id:t._id});e&&0!==(null==e?void 0:e.length)?Object.assign(e,t):this.setLocalData(t)}}setLocalData(t){this.tablet.setLocalData(t)}getLocalData(t,e){return this.tablet.getLocalData(t,e)}getLocalReplies(t){let e=[];return t.replies?t.replies.reduce(((t,e)=>t*("object"==typeof e?1:0)),1)?t.replies:(e=this.getLocalData("comment",{replyTo:t._id}),e):e}hasLocalAuthorization(t,e=this.currentUser._id){let i=this.getLocalData("authorization",{ownerId:e}).find((i=>i.authorizedId===e&&i.authorizerId===t||(i.authorizerId===e&&i.authorizedId===t||void 0)));return i||!1}deleteLocalData(t){return Array.isArray(t)?t.forEach((t=>this.deleteStruct(t))):this.deleteStruct(t),!0}deleteStruct(t){if("string"==typeof t&&(t=this.getLocalData(t)),!t)throw new Error("Struct not supplied");return!(!t.structType||!t._id)&&(this.tablet.collections.get(t.structType).delete(t._id),!0)}stripStruct(t={}){const e=Object.assign({},t);for(const t in e)void 0!==e[t]&&"Map"!==e[t].constructor.name||delete e[t];return e}createStruct(t,e,i=this.currentUser,s){return m.Struct(t,e,i,s)}userStruct(t={},e=!1){let i=m.ProfileStruct(void 0,t,t);t._id?i.id=t._id:t.id?i.id=t.id:i.id="user"+Math.floor(1e10*Math.random()),i._id=i.id,i.ownerId=i.id;for(const e in t)Object.keys(m.ProfileStruct()).indexOf(e)<0&&delete i[e];return e&&(this.currentUser=i),i}dataObject(t,e="any",i=Date.now()){return{type:e,data:t,timestamp:i}}},t.StructService=mt,Object.defineProperty(t,"__esModule",{value:!0})}));
