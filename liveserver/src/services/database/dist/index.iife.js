(()=>{var Ke=Object.create;var G=Object.defineProperty;var Ye=Object.getOwnPropertyDescriptor;var Ze=Object.getOwnPropertyNames,re=Object.getOwnPropertySymbols,Qe=Object.getPrototypeOf,ae=Object.prototype.hasOwnProperty,Xe=Object.prototype.propertyIsEnumerable;var ne=(n,e,t)=>e in n?G(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,oe=(n,e)=>{for(var t in e||(e={}))ae.call(e,t)&&ne(n,t,e[t]);if(re)for(var t of re(e))Xe.call(e,t)&&ne(n,t,e[t]);return n};var et=n=>G(n,"__esModule",{value:!0});var le=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports);var tt=(n,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Ze(e))!ae.call(n,s)&&(t||s!=="default")&&G(n,s,{get:()=>e[s],enumerable:!(i=Ye(e,s))||i.enumerable});return n},he=(n,e)=>tt(et(G(n!=null?Ke(Qe(n)):{},"default",!e&&n&&n.__esModule?{get:()=>n.default,enumerable:!0}:{value:n,enumerable:!0})),n);var p=(n,e,t)=>new Promise((i,s)=>{var r=l=>{try{o(t.next(l))}catch(h){s(h)}},a=l=>{try{o(t.throw(l))}catch(h){s(h)}},o=l=>l.done?i(l.value):Promise.resolve(l.value).then(r,a);o((t=t.apply(n,e)).next())});var H=le((Ut,ge)=>{var V=Math.floor(Math.random()*16777215),ue=_.index=parseInt(Math.random()*16777215,10),de=(typeof process>"u"||typeof process.pid!="number"?Math.floor(Math.random()*1e5):process.pid)%65535,W=function(n){return!!(n!=null&&n.constructor&&typeof n.constructor.isBuffer=="function"&&n.constructor.isBuffer(n))},pe=[];for(I=0;I<256;I++)pe[I]=(I<=15?"0":"")+I.toString(16);var I,fe=new RegExp("^[0-9a-fA-F]{24}$"),L=[];I=0;for(;I<10;)L[48+I]=I++;for(;I<16;)L[65-10+I]=L[97-10+I]=I++;function _(n){if(!(this instanceof _))return new _(n);if(n&&(n instanceof _||n._bsontype==="ObjectID"))return n;if(this._bsontype="ObjectID",n==null||typeof n=="number"){this.id=this.generate(n);return}var e=_.isValid(n);if(!e&&n!=null)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");if(e&&typeof n=="string"&&n.length===24)return _.createFromHexString(n);if(n!=null&&n.length===12)this.id=n;else{if(n!=null&&typeof n.toHexString=="function")return n;throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters")}}ge.exports=_;_.default=_;_.createFromTime=function(n){return n=parseInt(n,10)%4294967295,new _(st(8,n)+"0000000000000000")};_.createFromHexString=function(n){if(typeof n>"u"||n!=null&&n.length!==24)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");for(var e="",t=0;t<24;)e+=String.fromCharCode(L[n.charCodeAt(t++)]<<4|L[n.charCodeAt(t++)]);return new _(e)};_.isValid=function(n){return n==null?!1:typeof n=="number"?!0:typeof n=="string"?n.length===12||n.length===24&&fe.test(n):n instanceof _||W(n)?!0:typeof n.toHexString=="function"&&(n.id instanceof _Buffer||typeof n.id=="string")?n.id.length===12||n.id.length===24&&fe.test(n.id):!1};_.prototype={constructor:_,toHexString:function(){if(!this.id||!this.id.length)throw new Error("invalid ObjectId, ObjectId.id must be either a string or a Buffer, but is ["+JSON.stringify(this.id)+"]");if(this.id.length===24)return this.id;if(W(this.id))return this.id.toString("hex");for(var n="",e=0;e<this.id.length;e++)n+=pe[this.id.charCodeAt(e)];return n},equals:function(n){return n instanceof _?this.toString()===n.toString():typeof n=="string"&&_.isValid(n)&&n.length===12&&W(this.id)?n===this.id.toString("binary"):typeof n=="string"&&_.isValid(n)&&n.length===24?n.toLowerCase()===this.toHexString():typeof n=="string"&&_.isValid(n)&&n.length===12?n===this.id:n!=null&&(n instanceof _||n.toHexString)?n.toHexString()===this.toHexString():!1},getTimestamp:function(){var n=new Date,e;return W(this.id)?e=this.id[3]|this.id[2]<<8|this.id[1]<<16|this.id[0]<<24:e=this.id.charCodeAt(3)|this.id.charCodeAt(2)<<8|this.id.charCodeAt(1)<<16|this.id.charCodeAt(0)<<24,n.setTime(Math.floor(e)*1e3),n},generate:function(n){typeof n!="number"&&(n=~~(Date.now()/1e3)),n=parseInt(n,10)%4294967295;var e=it();return String.fromCharCode(n>>24&255,n>>16&255,n>>8&255,n&255,V>>16&255,V>>8&255,V&255,de>>8&255,de&255,e>>16&255,e>>8&255,e&255)}};function it(){return ue=(ue+1)%16777215}function st(n,e){return e=e.toString(16),e.length===n?e:"00000000".substring(e.length,n)+e}var rt=Symbol&&Symbol.for&&Symbol.for("nodejs.util.inspect.custom")||"inspect";_.prototype[rt]=function(){return"ObjectID("+this+")"};_.prototype.toJSON=_.prototype.toHexString;_.prototype.toString=_.prototype.toHexString});var We=le((P,Je)=>{"use strict";var At=function(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof F<"u")return F;throw new Error("unable to locate global object")},F=At();Je.exports=P=F.fetch;F.fetch&&(P.default=F.fetch.bind(F));P.Headers=F.Headers;P.Request=F.Request;P.Response=F.Response});var R=n=>(n?`${n}_`:"")+Math.floor(1e5*Math.random()),N=(n=Math,e=Date,t=16,i=s=>n.floor(s).toString(t))=>i(e.now()/1e3)+" ".repeat(t).replace(/./g,()=>i(n.random()*t));var ce,J=class{constructor(e){this.id=R("service");this.name="service";this.callbacks=new Map;this.status=!1;this.serviceType="default";this.routes=[];this.delegate=(ce=globalThis==null?void 0:globalThis.document)==null?void 0:ce.createDocumentFragment();this.protocols={};this.services={};this.setEndpointRoute=e=>{this.route=e};this.notify=(e,t,i)=>p(this,null,function*(){let s=[];return yield Promise.all(Array.from(this.callbacks).map((r,a)=>p(this,null,function*(){let o=yield r[1](e,t,i);o&&!(o instanceof Error)&&s.push(o)}))),s==null?void 0:s[0]});this.setEndpoint=e=>{this.endpoint=e};this.subscribe=e=>{if(e instanceof Function){let t=R();return this.callbacks.set(t,e),t}else return};this.unsubscribe=e=>this.callbacks.delete(e);this.router=e}addEventListener(...e){var t;(t=this.delegate)==null||t.addEventListener.apply(this.delegate,e)}dispatchEvent(...e){var t;return(t=this.delegate)==null?void 0:t.dispatchEvent.apply(this.delegate,e)}removeEventListener(...e){var t;return(t=this.delegate)==null?void 0:t.removeEventListener.apply(this.delegate,e)}};var nt=he(H());var me=Object.defineProperty,ot=(n,e,t)=>e in n?me(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,ye=(n,e)=>{for(var t in e)me(n,t,{get:e[t],enumerable:!0})},w=(n,e,t)=>(ot(n,typeof e!="symbol"?e+"":e,t),t),k={};ye(k,{AuthorizationStruct:()=>Ie,ChatroomStruct:()=>ve,CoherenceMap:()=>Y,CoherenceStruct:()=>K,CommentStruct:()=>ke,DataStruct:()=>Re,DateStruct:()=>Ce,ECGStruct:()=>Q,EDAStruct:()=>Se,EEGCoordinates:()=>lt,EEGStruct:()=>C,EMGStruct:()=>Te,EventStruct:()=>De,EyeTrackerStruct:()=>we,FNIRSStruct:()=>Z,FrequencyBandsStruct:()=>q,GroupStruct:()=>Ae,HRVStruct:()=>Ee,IMUStruct:()=>be,NotificationStruct:()=>Fe,PPGStruct:()=>_e,ProfileStruct:()=>Oe,ScheduleStruct:()=>je,Struct:()=>T,eegCoordinates:()=>U,setCoordinate:()=>$,structRegistry:()=>ht});function T(n="struct",e={},t={_id:""},i={structType:"struct",_id:""}){function s(a=""){return`${a+Math.floor(Math.random()+Math.random()*Math.random()*1e16)}`}let r={_id:s(n+"defaultId"),structType:n,ownerId:t?._id,timestamp:Date.now(),parent:{structType:i?.structType,_id:i?._id}};return r.ownerId||delete r.ownerId,r?.parent?._id||delete r.parent,Object.keys(e).length>0&&Object.assign(r,e),r}var U={FP1:[-21.2,66.9,12.1],FPZ:[1.4,65.1,11.3],FP2:[24.3,66.3,12.5],AF7:[-41.7,52.8,11.3],AF3:[-32.7,48.4,32.8],AFZ:[1.8,54.8,37.9],AF4:[35.1,50.1,31.1],AF8:[43.9,52.7,9.3],F5:[-51.4,26.7,24.7],F3:[-39.7,25.3,44.7],F1:[-22.1,26.8,54.9],FZ:[0,26.8,60.6],F2:[23.6,28.2,55.6],F4:[41.9,27.5,43.9],F6:[52.9,28.7,25.2],F7:[-52.1,28.6,3.8],F8:[53.2,28.4,3.1],FC5:[-59.1,3,26.1],FC3:[-45.5,2.4,51.3],FC1:[-24.7,.3,66.4],FCZ:[1,1,72.8],FC2:[26.1,3.2,66],FC4:[47.5,4.6,49.7],FC6:[60.5,4.9,25.5],FT9:[-53.8,-2.1,-29.1],FT7:[-59.2,3.4,-2.1],FT8:[60.2,4.7,-2.8],FT10:[55,-3.6,-31],T7:[-65.8,-17.8,-2.9],T5:[-61.5,-65.3,1.1],T3:[-70.2,-21.3,-10.7],T4:[71.9,-25.2,-8.2],T6:[59.3,-67.6,3.8],T8:[67.4,-18.5,-3.4],C5:[-63.6,-18.9,25.8],C3:[-49.1,-20.7,53.2],C1:[-25.1,-22.5,70.1],CZ:[.8,-21.9,77.4],C2:[26.7,-20.9,69.5],C4:[50.3,-18.8,53],C6:[65.2,-18,26.4],CP5:[-61.8,-46.2,22.5],CP3:[-46.9,-47.7,49.7],CP1:[-24,-49.1,66.1],CPZ:[.7,-47.9,72.6],CP2:[25.8,-47.1,66],CP4:[49.5,-45.5,50.7],CP6:[62.9,-44.6,24.4],TP9:[-73.6,-46.7,-4],TP7:[-63.6,-44.7,-4],TP8:[64.6,-45.4,-3.7],TP10:[74.6,-47.4,-3.7],P9:[-50.8,-51.3,-37.7],P7:[-55.9,-64.8,0],P5:[-52.7,-67.1,19.9],P3:[-41.4,-67.8,42.4],P1:[-21.6,-71.3,52.6],PZ:[.7,-69.3,56.9],P2:[24.4,-69.9,53.5],P4:[44.2,-65.8,42.7],P6:[54.4,-65.3,20.2],P8:[56.4,-64.4,.1],P10:[51,-53.9,-36.5],PO7:[-44,-81.7,1.6],PO3:[-33.3,-84.3,26.5],POZ:[0,-87.9,33.5],PO4:[35.2,-82.6,26.1],PO8:[43.3,-82,.7],O1:[-25.8,-93.3,7.7],OZ:[.3,-97.1,8.7],O2:[25,-95.2,6.2]};function $(n,e={}){if(!U[n.tag]&&n.position&&(U[n.tag]=[n.position.x,n.position.y,n.position.z]),U[n.tag]){let t={channel:"",position:{x:U[n.tag][0],y:U[n.tag][1],z:U[n.tag][2]}};return Object.assign(e,t)}else return Object.assign(e,n)}function lt(n=[],e=!0){let t=[];for(let i of n){let s=C(i);t.push(s)}return e&&t.push(...Y({channelDicts:n})),t}function q(n=[],e={}){let t={scp:[],delta:[],theta:[],alpha1:[],alpha2:[],beta:[],lowgamma:[],highgamma:[]};return n.forEach(i=>t[i]=[]),Object.assign(e,t)}function C(n="",e={},t={_id:""},i={structType:"struct",_id:""}){let s=q(),r={tag:n,position:{x:0,y:0,z:0},count:0,times:[],raw:[],filtered:[],fftCount:0,fftTimes:[],ffts:[],slices:JSON.parse(JSON.stringify(s)),means:JSON.parse(JSON.stringify(s)),startTime:Date.now()},a=T("eeg",r,t,i);return n&&$(r,a),Object.assign(a,e)}function K(n={0:C("FP1"),1:C("FP2")},e={},t={_id:""},i={structType:"struct",_id:""}){let s=q(),r={tag:n[0]?.tag+"::"+n[1]?.tag,x0:n[0]?.position?.x,y0:n[0]?.position?.y,z0:n[0]?.position?.z,x1:n[1]?.position?.x,y1:n[1]?.position?.y,z1:n[1]?.position?.z,fftCount:0,fftTimes:[],ffts:[],slices:JSON.parse(JSON.stringify(s)),means:JSON.parse(JSON.stringify(s)),startTime:Date.now()},a=T("coherence",r,t,i);return Object.assign(a,e)}function Y(n={channelDicts:[{ch:0,tag:"FP1",analyze:!1},{ch:1,tag:"FP2",analyze:!1}],taggedOnly:!0},e={},t={_id:""},i={structType:"struct",_id:""}){for(var s=[],r=1,a=0,o=0;o<n.channelDicts.length*(n.channelDicts.length+1)/2-n.channelDicts.length;o++){if(n.taggedOnly===!1||n.taggedOnly===!0&&n.channelDicts[a].tag!==null&&n.channelDicts[a+r].tag!==null&&n.channelDicts[a].tag!=="other"&&n.channelDicts[a+r].tag!=="other"&&n.channelDicts[a].analyze===!0&&n.channelDicts[a+r].analyze===!0){var l=C(n.channelDicts[a].tag),h=C(n.channelDicts[a+r].tag);s.push(K({0:l,1:h},{},t,i))}r++,r+a===n.channelDicts.length&&(a++,r=1)}return s}function Z(n="",e={},t={_id:""},i={structType:"struct",_id:""}){let s={tag:n,position:{x:0,y:0,z:0},count:0,times:[],red:[],ir:[],ir2:[],ambient:[],ratio:[],temp:[],beat_detect:{beats:[],breaths:[],rir:[],rir2:[],drir_dt:[],localmins:[],localmaxs:[],val_dists:[],peak_dists:[],localmins2:[],localmaxs2:[],val_dists2:[],peak_dists2:[]},startTime:Date.now()},r=T("fnirs",s,t,i);return n&&$(s,r),Object.assign(r,e)}function be(n="",e={},t={_id:""},i={structType:"struct",_id:""}){let s={tag:n,Ax:[],Ay:[],Az:[],Gx:[],Gy:[],Gz:[],startTime:Date.now()},r=T("imu",s,t,i);return n&&$(s,r),Object.assign(r,e)}function we(n="",e={},t={_id:""},i={structType:"struct",_id:""}){let s={tag:n,count:0,times:[],x:[],y:[],smax:[],smay:[],startTime:Date.now()},r=T("eyetracker",s,t,i);return Object.assign(r,e)}function Q(n="",e={},t={_id:""},i={structType:"struct",_id:""}){let s={tag:n,count:0,times:[],raw:[],filtered:[],bpm:[],hrv:[],startTime:Date.now()},r=T("ecg",s,t,i);return Object.assign(r,e)}function Se(n="",e={},t={_id:""},i={structType:"struct",_id:""}){}function _e(n="",e={},t={_id:""},i={structType:"struct",_id:""}){let s=Z(n,t,i,e);return s.structType="ppg",s}function Ee(n="",e={},t={_id:""},i={structType:"struct",_id:""}){let s=Q(n,t,i,e);return s.structType="hrv",s}function Te(n="",e={},t={_id:""},i={structType:"struct",_id:""}){let s=C(n,t,i,e);return s.structType="emg",s}function Oe(n="",e={},t={_id:""},i={structType:"struct",_id:""}){let s=T("profile",{tag:n,name:"",username:"",firstName:"",lastName:"",email:"",sex:"",birthday:"",type:"",userRoles:[],id:""},t,i);return Object.assign(s,e)}function Ie(n="",e={},t={_id:""},i={structType:"struct",_id:""}){let s={tag:n,authorizedId:"",authorizedName:"",authorizerId:"",authorizerName:"",authorizations:new Array,structs:new Array,excluded:new Array,groups:new Array,status:"PENDING",expires:!1,associatedAuthId:""},r=T("authorization",s,t,i);return Object.assign(r,e)}function Ae(n="",e={},t={_id:""},i={structType:"struct",_id:""}){let s={tag:n,name:"",details:"",admins:new Array,peers:new Array,clients:new Array,users:new Array},r=T("group",s,t,i);return Object.assign(r,e)}function Re(n="",e={},t={_id:""},i={structType:"struct",_id:""}){let s={tag:n,title:"",author:"",expires:!1,type:"",data:new Array},r=T("dataInstance",s,t,i);return Object.assign(r,e)}function De(n="",e={},t={_id:""},i={structType:"struct",_id:""}){let s={tag:n,event:"",author:"",startTime:"",endTime:"",grade:0,notes:"",attachments:new Array,users:new Array},r=T("event",s,t,i);return Object.assign(r,e)}function ve(n="",e={},t={_id:""},i={structType:"struct",_id:""}){let s={tag:n,message:"",topic:"",author:"",attachments:new Array,comments:new Array,replies:new Array,users:new Array,audioChatActive:!1,videoChatActive:!1},r=T("chatroom",s,t,i);return Object.assign(r,e)}function ke(n="",e={},t={_id:""},i={structType:"struct",_id:""}){let s={tag:n,author:"",replyTo:"",message:"",rating:0,replies:new Array,users:new Array,attachments:new Array},r=T("comment",s,t,i);return Object.assign(r,e)}function Fe(n="",e={},t={_id:""},i={structType:"struct",_id:""}){let s=T("notification",{tag:n,note:"",parentUserId:""},t,i);return Object.assign(s,e)}function je(n="",e={},t={_id:""},i={structType:"struct",_id:""}){let s={tag:n,title:"",author:"",attachments:new Array,dates:new Array},r=T("schedule",s,t,i);return Object.assign(r,e)}function Ce(n="",e={},t={_id:""},i={structType:"struct",_id:""}){let s={tag:n,timeSet:"",notes:"",recurs:"NEVER",attachments:new Array},r=T("date",s,t,i);return Object.assign(r,e)}var ht={Struct:T,EEGStruct:C,FNIRSStruct:Z,CoherenceStruct:K,CoherenceMap:Y,FrequencyBandsStruct:q,IMUStruct:be,EyeTrackerStruct:we,ECGStruct:Q,EDAStruct:Se,PPGStruct:_e,HRVStruct:Ee,EMGStruct:Te,ProfileStruct:Oe,AuthorizationStruct:Ie,GroupStruct:Ae,DataStruct:Re,EventStruct:De,ChatroomStruct:ve,CommentStruct:ke,NotificationStruct:Fe,ScheduleStruct:je,DateStruct:Ce},ct={};ye(ct,{bandpassWindow:()=>Et,get40HzGamma:()=>mt,getAlphaBetaRatio:()=>pt,getAlphaRatio:()=>dt,getAlphaThetaRatio:()=>gt,getCoherenceScore:()=>ut,getHEGRatioScore:()=>bt,getLowGammaScore:()=>yt,getThetaBetaRatio:()=>ft,mapCoherenceData:()=>_t,mapFFTData:()=>St,splitFrequencyBands:()=>wt});var M=class{constructor(){}static genSineWave(n=20,e=1,t=1,i=512,s=0,r=1){for(var a=[],o=[],l=1/i,h=0;h<t;h+=l){var c=Math.sin(2*Math.PI*n*h)*e;c+=Math.sin(2*Math.PI*s*h)*r,a.push(c),o.push(h)}return[o,a]}static getSineAmplitude(n=20,e=1,t=0,i=0){return Math.sin(this.TWO_PI*n*t+i)*e}static mean(n){var e=n.reduce((t,i)=>i+=t);return e/n.length}static mode(n){return n.sort((e,t)=>n.filter(i=>i===e).length-n.filter(i=>i===t).length).pop()}static std(n,e=void 0){let t=e;e||(t=this.mean(n));let i=0;for(let s=0;s<n.length;s++){let r=n[s]-t;i+=r*r}return Math.sqrt(i/n.length)}static relError(n=[],e=[],t=!0){if(n.length!==e.length)throw new Error("Input arrays of same length!");let i=n.length,s=[];for(let r=0;r<i;r++){let a=(n[r]-e[r])/n[r];t&&(a=Math.abs(a)),s.push(a)}return s}static informationEntropy(n=[]){let e=[],t=n.length;for(let i=0;i<t;i++){let s=n[i]*Math.log(n[i]);isNaN(s)&&(s=0),e.push(s)}return e}static zscore(n){let e=this.mean(n),t=this.std(n,e),i=[];for(let s=0;s<n.length;s++)i.push((n[s]-e)/t);return i}static variance(n){var e=this.mean(n);return n.reduce((t,i)=>t+(i-e)**2,0)/n.length}static dot(n,e){for(var t=0,i=0;i<n.length;i++)t+=n[i]*e[i];return t}static cross3D(n,e){return[n[1]*e[2]-n[2]*e[1],n[2]*e[0]-n[0]*e[2],n[0]*e[1]-n[1]*e[0]]}static magnitude(n){var e=0;return n.forEach(t=>{e+=t*t}),Math.sqrt(e)}static distance(n,e){var t=0;return n.forEach((i,s)=>{t+=(e[s]-i)*(e[s]-i)}),Math.sqrt(t)}static normalize(n){var e=0;e=this.magnitude(n);var t=[];return n.forEach((i,s)=>{t.push(i*e)}),t}static quadraticFormula(n,e,t){let i=Math.sqrt(e*e-4*n*t);if(!isNaN(i))return["complex","complex"];let s=1/(2*n);if(i===0)return[e*s];let r=-e;return[(r+i)*s,(r-i)*s]}static newtonsMethod(n=r=>Math.pow(r,5)+r*r-r-.2,e=0,t=1,i=.01,s=10){let r=[];for(let a=0;a<s;a++){let o=Math.random()*(t-e),l=n(o),h=n(o+i),c=(h-l)/i,d=o+i;for(;Math.abs(c)>i;){let g=-l/m,y=d+g;l=h,h=n(y);let m=(h-l)/(y-d)}let u,f=r.find((g,y)=>{if(Math.abs(xn1-g)<i)return u=y,!0});f?r[u]=(xn1+f)*.5:r.push(xn1)}return r}static makeVec(n,e){var t=[];return n.forEach((i,s)=>{t.push(e[s]-i)}),t}static transpose(n){return n[0].map((e,t)=>n.map(i=>i[t]))}static matmul(n,e){for(var t=n.length,i=n[0].length,s=e.length,r=e[0].length,a=new Array(t),o=0;o<t;++o){a[o]=new Array(r);for(var l=0;l<r;++l){a[o][l]=0;for(var h=0;h<i;++h)a[o][l]+=n[o][h]*e[h][l]}}return a}static matscale(n,e){let t=[];for(var i=0;i<n.length;i++){t[i]=[];for(let s=0;s<n[0].length;s++)t[i][s]=n[i][s]*e}return t}static matadd(n,e){let t=[];for(let s=0;s<n.length;s++){t[s]=[];for(var i=0;i<n[0].length;i++)t[s][i]=n[s][i]+e[s][i]}return t}static matsub(n,e){let t=[];for(let s=0;s<n.length;s++){t[s]=[];for(var i=0;i<n[0].length;i++)t[s][i]=n[s][i]-e[s][i]}return t}static histogram(n=[],e=1,t=void 0){let i=[...n];i.sort(function(l,h){return l-h});let s=Math.min(...i);if(typeof t=="number"){let l=Math.max(...i);e=Math.abs((l-s)/(t-1))}let r=s,a=[],o=[];for(let l=0;l<i.length;l++){let h=e*r;if(i[l]>s+h){r++,h+=e;let c=s+h+h*.5;a.push(c),o.push(0)}o[o.length-1]++}return[a,o]}static normalDistribution(n=[],e=!0,t=1e-4){let i=this.mean(n),s=this.variance(n),r=n.length,a=[],o=1/(this.TWO_PI*s),l=1/s,h=0;for(let c=0;c<r;c++){let d=Math.exp(-.5*Math.pow((n[c]-i)*l,2))*o;d<t&&(d=0),a.push(d),h+=d}if(e){let c=1/h;a=a.map(d=>d*c)}return a}static expectedValue(n=[],e=this.normalDistribution(n)){return n.reduce((t,i,s)=>t+i*e[s])}static originMoment(n=[],e=this.normalDistribution(n),t=1){return n.reduce((i,s,r)=>i+Math.pow(s,t)*e[r])}static centralMoment(n=[],e=this.normalDistribution(n),t=1){let i=this.mean(n);return n.reduce((s,r,a)=>s+Math.pow(r-i,t)*e[a]/n.length)}static linearDiscriminantAnalysis(n=[],e=[]){let t=this.mean(n),i=this.mean(e),s=this.cov1d(n,e),r=this.normalDistribution(n),a=[];for(let o=0;o<n.length;o++)a.push(x[o]*s*i-.5*t*s*i+Math.log10(r[o]));return a}static conv1D(n=[],e=[1/3,1/3,1/3],t=Math.floor(e.length*.5)){let i=[],s=1/e.length;if(t>0){let o=new Array(t).fill(0);n=[...o,...n,...o]}let r=Math.floor(e.length*.5),a=n.length-e.length+r;for(let o=r;o<a;o++){let l=0;for(let h=0;h<e.length;h++)l+=n[o-r]*e[h];i.push(l*s)}return i}static conv2D(n=[[],[],[]],e=[[],[],[]],t=0){let i=new Array(n.length-Math.ceil(e.length*.5)).fill([]),s,r=M.transpose(r);if(t>0){let y=new Array(t).fill(0);s=M.transpose(n);for(let m=0;m<s.length;m++)s[m]=[...y,...s[m],...y];n=M.transpose(s);for(let m=0;m<n.length;m++)n[m]=[...y,...n[m],...y]}let a=Math.floor(e[0].length*.5),o=Math.floor(r[0].length*.5),l=n[0].length-e[0].length+a,h=s[0].length-r[0].length+o,c=1/(e[0].length*r[0].length),d=l*h,u=a,f,g=o;for(;u<d;){let y=0;f=u%n[0].length,f===0&&g++;for(let m=0;m<e[0].length;m++){for(let S=0;S<r[0].length;m++)y+=n[g-o+S][f-a+m]*e[S][m];i[g].push(y*c)}u++}return i}static cov2d(n){var e=this.transpose(n),t=[],i=[],s=[];n.forEach((g,y)=>{i.push(this.mean(g))}),e.forEach((g,y)=>{s.push(this.mean(g))}),n.forEach((g,y)=>{t.push([]);for(var m=0;m<g.length;m++)t[y].push((n[y][m]-i[y])*(n[y][m]-s[m])/(g.length-1))});for(var r=this.transpose(t),a=t.length,o=t[0].length,l=r.length,h=r[0].length,c=new Array(a),d=0;d<a;++d){c[d]=new Array(h);for(var u=0;u<h;++u){c[d][u]=0;for(var f=0;f<o;++f)c[d][u]+=t[d][f]*r[f][u]/(n[0].length-1)}}return c}static cov1d(n=[],e=[]){return this.cov2d([n,e])}static cov3d(n=[],e=[],t=[]){return[[this.cov1d(n,n),this.cov1d(n,e),this.cov1d(n,t)],[this.cov1d(e,n),this.cov1d(e,e),this.cov1d(e,t)],[this.cov1d(t,n),this.cov1d(t,e),this.cov1d(t,t)]]}static covNd(n=[]){let e=[];n.forEach((t,i)=>{e.push([]),n.forEach((s,r)=>{e[i].push(this.cov1d(t,s))})})}static eigens2x2(n=[[1,2],[3,4]]){let e=n[0][0]*n[1][1]-n[0][1]*n[1][0],t=(n[0][0]+n[1][1])*.5,i=Math.sqrt(t*t-e),s=t+i,r=t-i;return[s,r]}static eigenvectors2x2(n=[[1,2],[3,4]],e=[1,2]){let t=[-n[0][1],n[0][0]-e[0]];t[0]===0&&t[1]===0&&(t[0]=n[1][1]-e[0],t[1]=-n[1][0]);let i=[-n[0][1],n[0][0]-e[1]];return i[0]===0&&i[1]===0&&(i[0]=n[1][1]-e[1],i[1]=-n[1][0]),[t,i]}static fastpca2d(n,e){let t=this.cov1d(n,e),i=this.eigens2x2(t);i[1]>i[0]&&i.reverse();let s=this.eigenvectors2x2(t,i);return console.log(i,s),[i,s]}static crosscorrelation(n,e){var t=[...e,...Array(e.length).fill(0)],i=this.mean(n),s=this.mean(e),r=n.reduce((d,u)=>d+=Math.pow(u-i,2));r=Math.sqrt(r);var a=e.reduce((d,u)=>d+=Math.pow(u-i,2));a=Math.sqrt(a);for(var o=1/(r*a),l=new Array(n.length).fill(0),h=0;h<n.length;h++){var c=n.reduce((d,u,f)=>d+=(u-i)*(t[h+f]-s));l[h]=c*o}return l}static autocorrelation(n){var e=[...n,...Array(n.length).fill(0)],t=this.mean(n),i=n.reduce((l,h)=>l+=Math.pow(h-t,2));i=Math.sqrt(i);for(var s=1/(i*i),r=new Array(n.length).fill(0),a=0;a<n.length;a++){var o=n.reduce((l,h,c)=>l+=(h-t)*(e[a+c]-t));r[a]=o*s}return r}static correlograms(n=[[],[]]){var e=[];return n.forEach((t,i)=>{n.forEach((s,r)=>{r>=i&&e.push(M.crosscorrelation(t,s))})}),e}static sma(n=[],e){for(var t=[],i=0;i<n.length;i++)if(i==0)t.push(n[0]);else if(i<e){var s=n.slice(0,i+1);t.push(s.reduce((r,a)=>a+=r)/(i+1))}else{var s=n.slice(i-e,i);t.push(s.reduce((a,o)=>o+=a)/e)}return t}static sum(n=[]){if(n.length>0){var e=n.reduce((t,i)=>i+=t);return e}else return 0}static reduceArrByFactor(n,e=2){return n.filter((t,i)=>i%e===0)}static makeArr(n,e,t){for(var i=[],s=(e-n)/(t-1),r=0;r<t;r++)i.push(n+s*r);return i}static interpolateArray(n,e,t=1){var i=function(d,u,f){return(d+(u-d)*f)*t},s=new Array,r=new Number((n.length-1)/(e-1));s[0]=n[0];for(var a=1;a<e-1;a++){var o=a*r,l=new Number(Math.floor(o)).toFixed(),h=new Number(Math.ceil(o)).toFixed(),c=o-l;s[a]=i(n[l],n[h],c)}return s[e-1]=n[n.length-1],s}static isExtrema(n,e="peak"){let t=[...n];if(t.length%2===0&&t.pop(),n.length>1){let i=!0;for(let s=0;s<t.length;s++){let r=t[s];if(e==="peak"){if(s<Math.floor(t.length*.5)&&r>=t[Math.floor(t.length*.5)]){i=!1;break}else if(s>Math.floor(t.length*.5)&&r>=t[Math.floor(t.length*.5)]){i=!1;break}}else if(e==="valley"){if(s<Math.floor(t.length*.5)&&r<=t[Math.floor(t.length*.5)]){i=!1;break}else if(s>Math.floor(t.length*.5)&&r<=t[Math.floor(t.length*.5)]){i=!1;break}}else if(s<Math.floor(t.length*.5)&&r<=t[Math.floor(t.length*.5)]){i=!1;break}else if(s>Math.floor(t.length*.5)&&r<=t[Math.floor(t.length*.5)]){i=!1;break}}if(e!=="peak"&&e!=="valley"&&i===!1){i=!0;for(let s=0;s<t.length;s++){let r=t[s];if(s<Math.floor(t.length*.5)&&r>=t[Math.floor(t.length*.5)]){i=!1;break}else if(s>Math.floor(t.length*.5)&&r>=t[Math.floor(t.length*.5)]){i=!1;break}}}return i}else return}static isCriticalPoint(n,e="peak"){let t=[...n];if(t.length%2===0&&t.pop(),n.length>1){let i=!0;for(let s=0;s<t.length;s++){let r=t[s];if(e==="peak"){if(s<t.length*.5&&r<=0){i=!1;break}else if(s>t.length*.5&&r>0){i=!1;break}}else if(e==="valley"){if(s<t.length*.5&&r>=0){i=!1;break}else if(s>t.length*.5&&r<0){i=!1;break}}else if(s<t.length*.5&&r>=0){i=!1;break}else if(s>t.length*.5&&r<0){i=!1;break}}if(e!=="peak"&&e!=="valley"&&i===!1){i=!0;for(let s=0;s<t.length;s++){let r=t[s];if(s<t.length*.5&&r<=0){i=!1;break}else if(s>t.length*.5&&r>0){i=!1;break}}}return i}else return}static getPeakThreshold(n,e,t){let i,s=n.filter((r,a)=>{if(e.indexOf(a)>-1)return!0});return t===0?i=this.mean(s):i=(t+this.mean(s))*.5,i}static column(n,e){let t=new Array(n.length).fill(0).map(()=>new Array(1).fill(0));for(let i=0;i<n.length;i++)t[i][0]=n[i][e];return t}static flatten_vector(n){let e=[];for(let t=0;t<n.length;t++)e[t]=n[t][0];return e}static squared_difference(n,e){let t=0;for(let i=0;i<n.length;i++)t=t+Math.pow(n[i]-e[i],2);return t}static shift_deflate(n,e,t){let i=Math.sqrt(this.matmul(this.transpose(t),t)),s=this.matscale(t,1/i),r=this.matscale(this.matmul(s,this.transpose(s)),e);return this.matsub(n,r)}static eigenvalue_of_vector(n,e){return ev=this.matmul(this.matmul(this.transpose(e),n),e),ev}static power_iteration(n,e=1e-5,t=1e3){let i=n.length,s=new Array(i).fill(0).map(()=>new Array(1).fill(Math.sqrt(i))),r=this.eigenvalue_of_vector(n,s),a=1,o=0;for(;a>e&&o<t;){let l=JSON.parse(JSON.stringify(r)),h=this.matmul(n,s);s=this.normalize(h),r=this.eigenvalue_of_vector(n,s),a=Math.abs(r-l),o++}return[r,s]}static eigens(n,e=1e-4,t=1e3){let i=[],s=[];for(let r=0;r<n.length;r++){let a=this.power_iteration(n,e,t),o=a[0],l=a[1];i[r]=o,s[r]=this.flatten_vector(l),n=this.shift_deflate(n,o,l)}return[i,s]}static pca(n,e=1e-5){let t=n.length,i=new Array(t),s=new Array(t),r=this.transpose(n);i[0]=this.column(n,0);let a=1,o=0;for(;espilon>e;){o++,s[0]=this.matmul(r,i[0]);let l=this.matmul(this.transpose(i[0]),i[0]);s[0]=this.matscale(s[0],1/l);let h=Math.sqrt(this.matmul(this.transpose(s[0]),s[0]));s[0]=this.matscale(s[0],1/h);let c=this.matmul(n,s[0]),d=this.matmul(this.transpose(s[0]),s[0]);c=this.matscale(c,1/d),a=this.squared_difference(i[0],c),i[0]=JSON.parse(JSON.stringify(c))}return this.matmul(this.transpose(i[0]),i[0])}static p300(n=[],e=[],t=[],i=256){let s=Math.floor(i/10),r=this.sma(e,s),a=this.peakDetect(r,"peak",s),o=this.mean(r),l=this.std(r,o),h=0,c=[];return a.length>0&&n.forEach((d,u)=>{for(;t[a[h]]<d+200&&(h++,!!a[h]););let f=0,g=[];for(;t[a[h+f]]<d+600&&(g.push(h+f),f++,!!a[h+f]););if(g.length>1){let y=[];g.forEach(j=>{y.push(r[a[j]])});let m=Math.max(...y),S=g[y.indexOf(m)];c.push({event_timestamp:d,event_index:u,peak_timestamp:t[[a[S]]],signal_index:[a[S]],signal_amplitude:e[[a[S]]],zscore:(r[a[S]]-o)/l})}else g.length===1&&c.push({event_timestamp:d,event_index:u,peak_timestamp:t[a[g[0]]],signal_index:a[g[0]],signal_amplitude:e[[a[g[0]]]],zscore:(r[a[g[0]]]-o)/l})}),c}},b=M;w(b,"TWO_PI",Math.PI*2),w(b,"C",299792458),w(b,"G",66743e-15),w(b,"h",662607015e-42),w(b,"R",8314.32),w(b,"Ra",287),w(b,"H",69.3),w(b,"kbar",1054571817e-43),w(b,"kB",1380649e-29),w(b,"ke",89875517923e-1),w(b,"me",91093837015e-41),w(b,"mp",167262192369e-38),w(b,"mn",167492749804e-38),w(b,"P0",101325),w(b,"T0",288.15),w(b,"p0",1.225),w(b,"Na",60220978e16),w(b,"y",1.405),w(b,"M0",28.96643),w(b,"g0",9.80665),w(b,"Re",6378100),w(b,"B",1458e-9),w(b,"S",110.4),w(b,"Sigma",365e-12),w(b,"imgkernels",{edgeDetection:[[-1,-1,-1],[-1,8,-1],[-1,-1,-1]],boxBlur:[[1/9,1/9,1/9],[1/9,1/9,1/9],[1/9,1/9,1/9]],sobelLeft:[[1,0,-1],[2,0,-2],[1,0,-1]],sobelRight:[[-1,0,1],[-2,0,2],[-1,0,1]],sobelTop:[[1,2,1],[0,0,0],[-1,-2,-1]],sobelBottom:[[-1,2,1],[0,0,0],[1,2,1]],identity:[[0,0,0],[0,1,0],[0,0,0]],gaussian3x3:[[1,2,1],[2,4,2],[1,2,1]],guassian7x7:[[0,0,0,5,0,0,0],[0,5,18,32,18,5,0],[0,18,64,100,64,18,0],[5,32,100,100,100,32,5],[0,18,64,100,64,18,0],[0,5,18,32,18,5,0],[0,0,0,5,0,0,0]],emboss:[[-2,-1,0],[-1,1,1],[0,1,2]],sharpen:[[0,-1,0],[-1,5,-1],[0,-1,0]]}),w(b,"integral",(n=i=>i,e=[],t=.01)=>{let i=0;for(let s=e[0];s<e[1];s+=t)i+=n(s)*t;return i}),w(b,"dintegral",(n=(s,r)=>s+r,e=[[],[]],t=.01,i=t)=>{let s=0;for(let r=e[0][0]+t;r<e[0][1];r+=t)for(let a=e[1][0]+i;a<e[1][1];a+=i)s+=n(r,a)*t*i;return s}),w(b,"tintegral",(n=(r,a,o)=>r+a+o,e=[[],[],[]],t=.01,i=t,s=t)=>{let r=0;for(let a=e[0][0]+t;a<e[0][1];a+=t)for(let o=e[1][0]+i;o<e[1][1];o+=i)for(let l=e[2][0]+s;l<e[2][1];l+=s)r+=n(a,o,l)*t*i*s;return r}),w(b,"pintegral",(n=i=>i,e=[],t=.01)=>{let i=0,s,r;for(let a=e[0];a<e[1];a+=t)s=r,r=n(a),s&&(i+=M.distance([0,s],[t,r]));return i}),w(b,"peakDetect",(n,e="peak",t=49)=>{let i=Math.floor(t*.5),s=[];for(let r=0;r<n.length-t;r++)M.isExtrema(n.slice(r,r+t),e)&&s.push(r+i-1);return s});var ut=(n,e="alpha1")=>{let t=[];return Array.isArray(n)||(n=[n]),n.forEach(i=>{if(i.fftCount>0){let s=i.fftCount,r=Math.min(20,s),a=i.means[e].slice(s-r);t.push(b.mean(a))}}),b.mean(t)},dt=n=>n.fftCount>0?n.means.alpha2[n.fftCount-1]/n.means.alpha1[n.fftCount-1]:0,ft=n=>n.fftCount>0?n.means.theta[n.fftCount-1]/n.means.beta[n.fftCount-1]:0,pt=n=>n.fftCount>0?(n.means.alpha1[n.fftCount-1]+n.means.alpha2[n.fftCount-1])*.5/n.means.beta[n.fftCount-1]:0,gt=n=>n.fftCount>0?(n.means.alpha1[n.fftCount-1]+n.means.alpha2[n.fftCount-1])*.5/n.means.theta[n.fftCount-1]:0,mt=(n,e)=>{if(n.fftCount>0&&Array.isArray(e)){let t=n.slices.lowgamma[n.fftCount-1],i=[];return t.forEach((s,r)=>{e.lowgamma[0][r]>38&&e.lowgamma[0][r]<42&&i.push(s)}),Math.max(...i)}else return 0},yt=n=>{if(n.fftCount>0){let e=n.fftCount,t=20;e<t&&(t=e);let i=n.means.lowgamma.slice(e-t);return n.means.lowgamma[e-1]-b.mean(i)}else return 0},bt=n=>{if(n.count>0){let e=n.count,t=40;e<t&&(t=e);let i=n.ratio.slice(e-t);return n.ratio[e-1]-b.mean(i)}else return 0};function wt(n=[],e={scp:[.1,1],delta:[1,4],theta:[4,8],alpha1:[8,12],alpha2:[12,16],beta:[16,30],lowgamma:[30,45],highgamma:[45,100]}){let t={};return n.forEach((i,s)=>{for(let r in e)t[r]||(t[r]=[[],[]]),i>=e[r][0]&&i<=e[r][1]&&(t[r][0].push(i),t[r][1].push(s))}),t}var St=(n,e,t,i)=>{let s=0;i.fftCount++,i.fftTimes.push(e),i.ffts.push(n);for(let r in t){let a=n.slice(s,s+t[r][1].length);i.slices[r].push(a),i.means[r].push(a.reduce((o,l)=>o+l)/a.length),s+=t[r][1].length}},_t=(n,e,t,i)=>{n.forEach((s,r)=>{i[r].fftCount++,i[r].fftTimes.push(e),i[r].ffts.push(data);let a=0;for(let o in t){let l=fft.slice(a,a+t[o][1].length);coord.slices[o].push(l),coord.means[o].push(l.reduce((h,c)=>h+c)/l.length),a+=t[o][1].length}})};function Et(n,e,t){let i=(e-n)/t,s=[],r=0;for(;r<e;)s.push(r),r+=i;return s}var Ue=class{constructor(n={},e=!1,t=void 0){this.DS=k,this.collections=new Map,this.data={byTime:{},notes:{},events:{},sleep:{},food:{},hr:{},ppg:{},hrv:{},ecg:{},emg:{},eeg:{},fnirs:{}},this.rolloverLimit=5e4,this.dataSorts=new Map,this.watches={},this.onCollectionSet=(i,s)=>{},this.ontrigger=i=>{},this.threaded=e,t?this.workers=t:typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&(this.threaded=!0),Object.assign(this.data,n),this.dataSorts=new Map,this.watches={},this.setSort("event",i=>(this.data.events[i.timestamp]?this.data.events[i.timestamp].push(i):this.data.events[i.timestamp]=[i],i.event==="sleep"&&(this.data.sleep[i.timestamp]?this.data.sleep[i.timestamp].push(i):this.data.sleep[i.timestamp]=[i]),i)),this.setSort(["notes","note","link"],i=>(this.data.notes[i.timestamp]?this.data.notes[i.timestamp].push(i):this.data.notes[i.timestamp]=[i],this.data.byTime[i.timestamp]?this.data.byTime[i.timestamp].push(i):this.data.byTime[i.timestamp]=[i],i)),this.id=this.randomId("dataTablet")}randomId(n=""){return`${n+Math.floor(Math.random()+Math.random()*Math.random()*1e16)}`}setLocalData(n){let e=t=>{let i=t.structType,s=this.collections.get(i);s||(s=new Map,this.collections.set(i,s)),s.set(t._id,t),this.onCollectionSet(i,s)};Array.isArray(n)?n.forEach(t=>{e(t)}):e(n)}getLocalData(n,e){let t="",i="",s="";if(typeof e=="object"?(t=e.ownerId,i=Object.keys(e).filter(a=>a!="ownerId")[0],s=e[i]):s=e,!n&&!t&&!i&&!s)return[];let r=[];if(!n&&(t||i))return this.collections.forEach(a=>{if((i==="_id"||i==="id")&&s){let o=a.get(s);o&&r.push(o)}else a.forEach(o=>{i&&s?o[i]===s&&o.ownerId===t&&r.push(o):o.ownerId===t&&r.push(o)})}),r;{let a=this.collections.get(n);if(!a)return r;if(!i&&!t)return a.forEach(o=>{r.push(o)}),r;if((i==="_id"||i==="id")&&s)return a.get(s);a.forEach((o,l)=>{i&&s&&!t?o[i]===s&&r.push(o):t&&!i?o.ownerId===t&&r.push(o):t&&i&&s&&o.ownerId===t&&o[i]&&o[i]===s&&r.push(o)})}return r}runSort(n,e={},t=[],i=this){let s;if(this.threaded===!1){let r=this.getSort(n);if(r)s=r(e,t,i);else return!1}else if(this.threaded===!0)return this.workers.runWorkerFunction("runSort",[n,e,t],this.workerId,this.id);return s}setSort(n,e=(t,i=[],s=this)=>{}){if(this.threaded===!1)Array.isArray(n)?n.forEach(t=>{this.dataSorts.set(t,e)}):this.dataSorts.set(n,e);else if(this.threaded===!0)return this.workers.runWorkerFunction("setSort",[n,e.toString()],this.workerId,this.id)}getSort(n){if(this.threaded===!1)return this.dataSorts.get(n);if(this.threaded===!0)return this.workers.runWorkerFunction("getSort",[n],this.workerId,this.id)}checkWatches(n={}){for(let e in this.watches)this.watches[e].ondata(n,this.watches[e].accum,this.watches[e]),this.watches[e].triggered&&(this.ontrigger(this.watches[e].accum),this.watches[e].triggered=!1)}setWatch(n,e=(i,s,r)=>{},t=i=>{}){this.watches[n]={triggered:!1,accum:this.DS.Struct("alert"),ondata:e,ontrigger:t}}getWatch(n){return this.watches[n]}async sortStructsIntoTable(n=[]){let e=function(i,s){return i.timestamp-s.timestamp};n.sort(e);let t=[];for(let i=0;i<n.length;i++){let s=n[i];if(!s.timestamp)continue;let r=s.timestamp;if(this.data.byTime[r]?this.data.byTime[r].push(s):this.data.byTime[r]=[s],s.structType==="dataInstance"&&s.data)s.data.forEach(async a=>{if(typeof a=="object"&&!Array.isArray(a)){let o=a.dataType;if(a.ownerId=s.ownerId,a.timestamp||(a.timestamp=r),o){let l=this.runSort(o,a,t,this);l?l.constructor?.name!=="Promise"&&(this.checkWatches(l),this.onUpdate(r,l),t.push(l)):(this.data[o]||(this.data[o]={}),a.timestamp=r,this.data[o][r]?this.data[o][r].push(a):this.data[o][r]=[a],this.data.byTime[r]?this.data.byTime[r].push(a):this.data.byTime[r]=[a],this.checkWatches(a),this.onUpdate(r,a),t.push(a))}}});else{let a=this.runSort(s.structType,s,t,this);if(a)this.checkWatches(a),this.onUpdate(r,a),t.push(a);else{let o=s.structType;this.data[o]||(this.data[o]={}),this.data[o][r]?this.data[o][r].push(s):this.data[o][r]=[s],this.checkWatches(s),this.onUpdate(r,s),t.push(s)}}}for(let i in this.data)this.data[i]=this.sortObjectByPropName(this.data[i]);this.onSorted(t)}onUpdate(n,e,t=this.data){}onSorted(n=[]){}getDataByTimestamp(n,e){if(this.threaded===!0)return this.workers.runWorkerFunction("getDataByTimestamp",[n,e],this.workerId,this.id);let t=this.data.byTime[n];return e&&t&&(t=t.filter(i=>e?e===i.ownerId:!0)),t}getDataByTimeRange(n,e,t,i){if(this.threaded===!0)return this.workers.runWorkerFunction("getDataByTimeRange",[n,e,t,i],this.workerId,this.id);let s={};if(t){for(let r in this.data[t]){let a=parseInt(r);a>n&&a<e&&(s[r]=[...this.data[t][r]])}t==="sleep"&&(s=this.filterSleepResults(s))}else for(let r in this.data.byTime){let a=parseInt(r);a>n&&a<e&&(s[r]=[...this.data.byTime[r]])}if(i&&s)for(let r in s){let a=[];s[r]=s[r],s[r].forEach((o,l)=>{o.ownerId!==i&&a.push(l)}),a.reverse().forEach(o=>{s[r].splice(o,1)}),s[r].length===0&&delete s[r]}return s}getDataByType(n,e,t){if(!this.data[n])return;let i={...this.data[n]};if(e&&(i=[...i[e]]),t&&i)for(let s in i){let r=[];i[s]=[...i[s]],i[s].forEach((a,o)=>{a.ownerId!==t&&r.push(o)}),r.reverse().forEach(a=>{i[s].splice(a,1)}),i[s].length===0&&delete i[s]}return n==="sleep"&&(i=this.filterSleepResults(i)),i}filterSleepResults(n={}){let e=[];for(let t in n)n[t]=[...n[t]],e.push(...n[t].filter(i=>i.structType==="event"));return e.forEach(t=>{let i;for(let s in n)n[s].forEach((r,a)=>r.structType==="fitbitsleep"&&t.startTime&&t.endTime&&Math.abs(r.startTime-t.startTime)<1e3*12*3600&&Math.abs(r.endTime-t.endTime)<1e3*12*3600&&t.endTime-t.startTime>1e3*2*3600?(i=a,!0):!1),i&&n[s].splice(i,1)}),n}sortObjectByPropName(n){return Object.keys(n).sort().reduce((e,t)=>(e[t]=n[t],e),{})}checkRollover(n,e=this.rolloverLimit){if(!n)return!1;let t=this.collections.get(n);return t?(t.forEach(i=>{for(let s in i)Array.isArray(i[s])?i[s].length>e&&(i[s].slice(i[s].length-e),s==="ffts"?i.fftCount=i[s].length:s==="times"&&(i.count=i[s].length)):typeof i[s]=="object"&&this.checkRollover(i[s])}),!0):!1}};var Me=class{constructor(e=!1,t=!1){this.debug=e,this.listeners=[],this.synchronous=t,this.syncInterval="FRAMERATE",this.syncAnim=void 0,t===!0&&this.startSync()}addListener(e=null,t,i=void 0,s=void 0,r=void 0,a=this.debug,o=!0){if(t===void 0){console.error("You must assign an object");return}var l=e;l==null&&(l=Math.floor(Math.random()*1e5)),this.synchronous===!0&&(o=!1);var h={key:l,listener:new ze(t,i,s,r,a,o)};this.listeners.push(h)}getListener(e){return this.listeners.find((i,s)=>{if(i.key===e)return!0})}hasKey(e){var t=!1;return this.listeners.forEach((i,s)=>{if(i.key===e)return t=!0,!0}),t}getKeyIndices(e){var t=[];return this.listeners.find((i,s)=>{i.key===e&&t.push(s)}),t}onchange(e=null,t=null){if(e==null)this.listeners.forEach((s,r)=>{s.listener.onchange=t});else var i=this.listeners.find((s,r)=>{s.name===e&&(s.listener.onchange=t)})}addFunc=(e=null,t=null,i=!0)=>{var s=null;if(t!==null)if(e==null)this.listeners.forEach((a,o)=>{s=a.listener.addFunc(t),a.listener.running==!1&&i==!0&&a.listener.start()});else var r=this.listeners.find((a,o)=>{a.key===e&&(s=a.listener.addFunc(t),a.listener.running==!1&&i==!0&&a.listener.start())});return s};getFuncs=(e=void 0)=>{if(e){var t=this.listeners.find((i,s)=>{if(i.key===e)return!0});return t.onchangeFuncs}else return};removeFuncs=(e=null,t=null,i=!1)=>{if(e==null)this.listeners.forEach((r,a)=>{r.listener.removeFuncs(t)});else var s=this.listeners.find((r,a)=>{r.key===e&&(r.listener.removeFuncs(t),(r.listener.onchangeFuncs.length===0||i===!0)&&r.listener.stop())})};stop(e=null){if(this.synchronous&&this.stopSync(),e==null)this.listeners.forEach((i,s)=>{i.listener.stop()});else var t=this.listeners.find((i,s)=>{i.name===e&&i.listener.stop()})}start(e=null){if(this.synchronous&&this.stopSync(),e==null)this.listeners.forEach((i,s)=>{i.listener.start()});else var t=this.listeners.find((i,s)=>{i.name===e&&i.listener.start()})}startSync(){if(this.synchronous===!1){this.synchronous=!0,this.stop();let e=()=>{this.synchronous===!0&&(this.listeners.forEach(t=>{t.listener.check()}),this.syncInterval==="FRAMERATE"?this.syncAnim=requestAnimationFrame(e):typeof this.syncInterval=="number"&&setTimeout(e,this.syncInterval))};e()}}stopSync(){this.synchronous=!1,this.syncAnim&&cancelAnimationFrame(this.syncAnim)}remove(e=null){if(e==null)this.listeners.forEach(s=>{s.listener.stop()}),this.listeners.splice(0,this.listeners.length);else{var t=[],i=this.listeners.forEach((s,r)=>{s.key===e&&t.push(r)});t.reverse().forEach(s=>{this.listeners[s].listener.stop(),this.listeners.splice(s,1)})}}},ze=class{constructor(e,t="__ANY__",i=this.onchange,s="FRAMERATE",r=!1,a=!0){this.debug=r,this.onchange=i,this.onchangeFuncs=[],this.object=e,this.propName=t,this.propOld=void 0,this.setListenerRef(t),this.running=a,this.funcs=0,this.interval,s<10?(this.interval=10,console.log("Min recommended interval set: 10ms")):this.interval=s,a===!0&&(typeof window>"u"?setTimeout(()=>{this.check()},60):this.checker=requestAnimationFrame(this.check))}onchange=e=>{console.log(this.propName," changed from: ",this.propOld," to: ",this.object[this.propName])};addFunc=(e=null)=>{let t=0;return e!==null&&(this.onchangeFuncs.push({idx:this.funcs,onchange:e}),t=this.funcs,this.funcs++),t};removeFuncs(e=null){let t=0;e===null?this.onchangeFuncs=[]:this.onchangeFuncs.find((i,s)=>{if(i.idx===e)return t=s,!0})!==void 0&&this.onchangeFuncs.splice(t,1)}onchangeMulti=e=>{[...this.onchangeFuncs].forEach((i,s)=>{this.debug===!0&&console.log(i.onchange),i.onchange(e)})};setListenerRef=e=>{e==="__ANY__"||e===null||e===void 0?this.propOld=JSON.stringifyFast(this.object):Array.isArray(this.object[e])?this.propOld=JSON.stringifyFast(this.object[e].slice(this.object[e].length-20)):typeof this.object[e]=="object"?this.propOld=JSON.stringifyFast(this.object[e]):typeof this.object[e]=="function"?this.propOld=this.object[e].toString():this.propOld=this.object[e],this.debug===!0&&console.log("propname",e,", new assignment: ",this.propOld)};check=()=>{let e=!1;if(this.propName==="__ANY__"||this.propName===null||this.propName===void 0)this.propOld!==JSON.stringifyFast(this.object)&&(this.debug===!0&&console.log("onchange: ",this.onchange),this.onchange(this.object),this.onchangeFuncs.length>0&&this.onchangeMulti(this.object),this.setListenerRef(this.propName),e=!0);else if(Array.isArray(this.object[this.propName]))this.propOld!==JSON.stringifyFast(this.object[this.propName].slice(this.object[this.propName].length-20))&&(this.debug===!0&&console.log("onchange: ",this.onchange),this.onchange(this.object[this.propName]),this.onchangeFuncs.length>0&&this.onchangeMulti(this.object[this.propName]),this.setListenerRef(this.propName),e=!0);else if(typeof this.object[this.propName]=="object"){let t=JSON.stringifyFast(this.object[this.propName]);this.propOld!==t&&(this.debug===!0&&console.log("onchange: ",this.onchange),this.onchange(this.object[this.propName]),this.onchangeFuncs.length>0&&this.onchangeMulti(this.object[this.propName]),this.setListenerRef(this.propName),e=!0)}else typeof this.object[this.propName]=="function"?this.propOld!==this.object[this.propName].toString()&&(this.debug===!0&&console.log("onchange: ",this.onchange),this.onchange(this.object[this.propName].toString()),this.onchangeFuncs.length>0&&this.onchangeMulti(this.object[this.propName].toString()),this.setListenerRef(this.propName),e=!0):this.object[this.propName]!==this.propOld&&(this.debug===!0&&console.log("onchange: ",this.onchange),this.onchange(this.object[this.propName]),this.onchangeFuncs.length>0&&this.onchangeMulti(this.object[this.propName]),this.setListenerRef(this.propName),e=!0);return this.running===!0&&(this.debug===!0&&console.log("checking",this.object,this.propName),this.interval==="FRAMERATE"?typeof window>"u"?setTimeout(()=>{this.check()},16):this.checker=requestAnimationFrame(this.check):setTimeout(()=>{this.check()},this.interval)),e};start(){this.running=!0,typeof window>"u"?setTimeout(()=>{this.check()},16):this.checker=requestAnimationFrame(this.check)}stop(){this.running=!1,cancelAnimationFrame(this.checker)}};JSON.stringifyFast===void 0&&(JSON.stringifyFast=function(){let n=new Map,e=[],t=["this"];function i(){n.clear(),e.length=0,t.length=1}function s(a,o){var l=e.length-1;if(e[l]){var h=e[l];if(typeof h=="object")if(h[a]===o||l===0)t.push(a),e.push(o.pushed);else for(;l-->=0;){if(h=e[l],typeof h=="object"&&h[a]===o){l+=2,e.length=l,t.length=l,--l,e[l]=o,t[l]=a;break}l--}}}function r(a,o){let l;if(o!=null)if(typeof o=="object"){let h=o.constructor.name;a&&h==="Object"&&s(a,o);let c=n.get(o);if(c)return"[Circular Reference]"+c;if(n.set(o,t.join(".")),h==="Array")o.length>20?l=o.slice(o.length-20):l=o;else if(h.includes("Set"))l=Array.from(o);else if(h!=="Object"&&h!=="Number"&&h!=="String"&&h!=="Boolean")l="instanceof_"+h;else if(h==="Object"){let d={};for(let u in o)if(o[u]==null)d[u]=o[u];else if(Array.isArray(o[u]))o[u].length>20?d[u]=o[u].slice(o[u].length-20):d[u]=o[u];else if(o[u].constructor.name==="Object"){d[u]={};for(let f in o[u])if(Array.isArray(o[u][f]))o[u][f].length>20?d[u][f]=o[u][f].slice(o[u][f].length-20):d[u][f]=o[u][f];else if(o[u][f]!=null){let g=o[u][f].constructor.name;g.includes("Set")?d[u][f]=Array.from(o[u][f]):g!=="Number"&&g!=="String"&&g!=="Boolean"?d[u][f]="instanceof_"+g:d[u][f]=o[u][f]}else d[u][f]=o[u][f]}else{let f=o[u].constructor.name;f.includes("Set")?d[u]=Array.from(o[u]):f!=="Number"&&f!=="String"&&f!=="Boolean"?d[u]="instanceof_"+f:d[u]=o[u]}l=d}else l=o}else l=o;return l}return function(o,l){e.push(o);let h=JSON.stringify(o,r,l);return i(),h}}());JSON.stringifyWithCircularRefs===void 0&&(JSON.stringifyWithCircularRefs=function(){let n=new Map,e=[],t=["this"];function i(){n.clear(),e.length=0,t.length=1}function s(a,o){var l=e.length-1,h=e[l];if(h[a]===o||l===0)t.push(a),e.push(o);else for(;l-->=0;)if(h=e[l],h[a]===o){l+=2,e.length=l,t.length=l,--l,e[l]=o,t[l]=a;break}}function r(a,o){if(o!=null&&typeof o=="object"){a&&s(a,o);let l=n.get(o);if(l)return"[Circular Reference]"+l;n.set(o,t.join("."))}return o}return function(o,l){try{return e.push(o),JSON.stringify(o,r,l)}finally{i()}}}());var xe=Me;var Ne=class{constructor(e={},t="FRAMERATE",i=!0){this.data=e,this.interval=t,this.pushToState={},this.pushRecord={pushed:[]},this.pushCallbacks={},this.triggers={},this.prev={},this.listener=new xe,this.defaultStartListenerEventLoop=i}subscribe(e,t,i=this.defaultStartListenerEventLoop){if(e&&e!=="state")if(this.data[e]===void 0)this.addToState(e,null,t,i);else return this.addSecondaryKeyResponse(e,t,void 0,i);else return this.addSecondaryKeyResponse(e,t,void 0,i)}subscribeOnce(e=void 0,t=i=>{}){let i,s=r=>{t(r),this.unsubscribe(e,i)};i=this.subscribe(e,s)}unsubscribe(e,t=null){t!==null?this.removeSecondaryKeyResponse(e,t,!0):console.error("Specify a subcription function index")}unsubscribeAll(e){this.unsubscribeAllSequential(e),this.unsubscribeAllTriggers(e),this.clearAllKeyResponses(e),this.data[e]&&delete this.data[e],this.listener.hasKey("pushToState")&&this.setSequentialState({stateRemoved:e})}setInterval(e="FRAMERATE"){this.interval=e,this.listener.listeners.forEach((t,i)=>{t.interval=this.interval})}updateState(e,t){this.data[e]==null?this.addToState(e,t):this.data[e]=t}setupSynchronousUpdates=()=>{if(!this.listener.hasKey("pushToState")){let e=()=>{if(Object.keys(this.pushToState).length>0){Object.assign(this.data,this.pushToState);for(let t of Object.getOwnPropertyNames(this.pushToState))delete this.pushToState[t]}};this.listener.addListener("pushToState",this.pushToState,"__ANY__",e,this.interval),this.addToState("pushRecord",this.pushRecord,t=>{let i=t.pushed.length;for(let s=0;s<i;s++){let r=t.pushed[s];this.pushCallbacks.state&&this.pushCallbacks.state.forEach(a=>{a.onchange(r)});for(let a in r)this.pushCallbacks[a]&&this.pushCallbacks[a].forEach(o=>{typeof o=="object"&&o.onchange(r[a])})}this.pushRecord.pushed.splice(0,i)})}};addToState(e,t,i=null,s=this.defaultStartListenerEventLoop,r=!1){if(!this.listener.hasKey("pushToState")&&this.defaultStartListenerEventLoop&&this.setupSynchronousUpdates(),this.data[e]=t,this.setSequentialState({stateAdded:e}),i!==null)return this.addSecondaryKeyResponse(e,i,r,s)}get(e){return this.data[e]}getState(){return JSON.parse(JSON.stringifyFast(this.data))}setState(e={},t=!1){if(!this.listener.hasKey("pushToState")&&this.defaultStartListenerEventLoop&&(this.setupSynchronousUpdates(),this.pushRecord.pushed.push(JSON.parse(JSON.stringifyWithCircularRefs(e)))),e.stateUpdateTimeStamp=Date.now(),t){for(let i in e)if(i in this.pushToState){if(Array.isArray(this.pushToState[i])&&Array.isArray(e[i]))e[i]=this.pushToState[i].push(...e[i]);else if(typeof this.pushToState[i]=="object"&&typeof e[i]=="object"){for(let s in e[i])if(this.pushToState[i][s]){if(Array.isArray(this.pushToState[i][s])&&Array.isArray(e[i][s]))e[i][s]=this.pushToState[i][s].push(...e[i][s]);else if(typeof this.pushToState[i][s]=="object"&&typeof e[i][s]=="object"){for(let r in e[i][s])if(this.pushToState[i][s][r])Array.isArray(this.pushToState[i][s][r])&&Array.isArray(e[i][s][r])&&(e[i][s][r]=this.pushToState[i][s][r].push(...e[i][s][r]));else if(typeof this.pushToState[i][s][r]=="object"&&typeof e[i][s][r]=="object")for(let a in e[i][s][r])this.pushToState[i][s][r][a]&&Array.isArray(this.pushToState[i][s][r][a])&&Array.isArray(e[i][s][r][a])&&(e[i][s][r][a]=this.pushToState[i][s][r][a].push(...e[i][s][r][a]))}}}}}if(Object.assign(this.pushToState,e),Object.keys(this.triggers).length>0){this.triggers.state&&this.triggers.state.forEach(i=>{i.onchange(this.data)});for(let i of Object.getOwnPropertyNames(this.triggers))i in this.pushToState&&(this.data[i]=this.pushToState[i],delete this.pushToState[i],this.triggers[i].forEach(s=>{s.onchange(this.data[i])}))}return this.pushToState}subscribeTrigger(e=void 0,t=i=>{}){if(e){this.triggers[e]||(this.triggers[e]=[]);let i=this.triggers[e].length;return this.triggers[e].push({idx:i,onchange:t}),this.triggers[e].length-1}else return}subscribeTriggerOnce(e=void 0,t=i=>{}){let i,s=r=>{t(r),this.unsubscribeTrigger(e,i)};i=this.subscribeTrigger(e,s)}unsubscribeTrigger(e=void 0,t=0){let i,s=this.triggers[e];s&&s.find(a=>{if(a.idx===t)return!0})&&s.splice(i,1)}unsubscribeAllTriggers(e){e&&this.triggers[e]&&delete this.triggers[e]}setSequentialState(e={}){this.listener.hasKey("pushToState")||this.setupSynchronousUpdates(),e.stateUpdateTimeStamp=Date.now(),this.pushRecord.pushed.push(JSON.parse(JSON.stringify(e)))}subscribeSequential(e=void 0,t=void 0){if(e)if(this.data[e]===void 0&&e!=="state"&&this.addToState(e,null,void 0),this.pushCallbacks[e]||(this.pushCallbacks[e]=[]),t){let i=this.pushCallbacks[e].length;return this.pushCallbacks[e].push({idx:i,onchange:t}),this.pushCallbacks[e].length-1}else return;else return}subscribeSequentialOnce(e=void 0,t=i=>{}){let i,s=r=>{t(r),this.unsubscribeSequential(e,i)};i=this.subscribeSequential(e,s)}unsubscribeSequential(e=void 0,t=0){e&&this.pushCallbacks[e]&&this.pushCallbacks[e].find((i,s)=>{if(i.idx===t)return this.pushCallbacks[e].splice(s,1),!0})}unsubscribeAllSequential(e){e&&this.pushCallbacks[e]&&this.pushCallbacks[e]&&delete this.pushCallbacks[e]}setPrimaryKeyResponse(e=null,t=null,i=!1,s=this.defaultStartListenerEventLoop){if(t!==null)if(this.listener.hasKey(e))this.listener.onchange(e,t);else if(e!=null&&e!=="state")this.listener.addListener(e,this.data,e,t,this.data.stateUpdateInterval,i,s);else{if(!this.listener.hasKey("state")){let r=()=>{this.prev=Object.assign({},this.data)};this.listener.addListener("state",this.data,"__ANY__",r,this.interval)}return this.listener.addFunc("state",t)}}addSecondaryKeyResponse=(e=null,t=null,i=!1,s=this.defaultStartListenerEventLoop)=>{if(t!=null){if(this.listener.hasKey(e))return this.listener.addFunc(e,t);if(e!=null&&e!=="state")return this.listener.addListener(e,this.data,e,()=>{},this.data.stateUpdateInterval,i,s),this.listener.addFunc(e,t);if(!this.listener.hasKey("state")){let r=()=>{this.prev=Object.assign({},this.data)};this.listener.addListener("state",this.data,"__ANY__",r,this.interval)}return this.listener.addFunc("state",t)}};removeSecondaryKeyResponse(e=null,t=null,i=!0){e!==null?this.listener.hasKey(e)?this.listener.removeFuncs(e,t,i):console.error("key does not exist"):console.error("provide key")}clearAllKeyResponses(e=null){e===null?this.listener.remove(null):this.listener.hasKey(e)&&this.listener.remove(e)}getKeySubCallbacks(e){return this.listener.getFuncs(e)}removeState=this.unsubscribeAll;runSynchronousListeners(){this.defaultStartListenerEventLoop=!1,this.listener.startSync()}stop(e=null){this.listener.stop(e)}};JSON.stringifyFast===void 0&&(JSON.stringifyFast=function(){let n=new Map,e=[],t=["this"];function i(){n.clear(),e.length=0,t.length=1}function s(a,o){var l=e.length-1;if(e[l]){var h=e[l];if(typeof h=="object")if(h[a]===o||l===0)t.push(a),e.push(o.pushed);else for(;l-->=0;){if(h=e[l],typeof h=="object"&&h[a]===o){l+=2,e.length=l,t.length=l,--l,e[l]=o,t[l]=a;break}l++}}}function r(a,o){let l;if(o!=null)if(typeof o=="object"){let h=o.constructor.name;a&&h==="Object"&&s(a,o);let c=n.get(o);if(c)return"[Circular Reference]"+c;if(n.set(o,t.join(".")),h==="Array")o.length>20?l=o.slice(o.length-20):l=o;else if(h.includes("Set"))l=Array.from(o);else if(h!=="Object"&&h!=="Number"&&h!=="String"&&h!=="Boolean")l="instanceof_"+h;else if(h==="Object"){let d={};for(let u in o)if(o[u]==null)d[u]=o[u];else if(Array.isArray(o[u]))o[u].length>20?d[u]=o[u].slice(o[u].length-20):d[u]=o[u];else if(o[u].constructor.name==="Object"){d[u]={};for(let f in o[u])if(Array.isArray(o[u][f]))o[u][f].length>20?d[u][f]=o[u][f].slice(o[u][f].length-20):d[u][f]=o[u][f];else if(o[u][f]!=null){let g=o[u][f].constructor.name;g.includes("Set")?d[u][f]=Array.from(o[u][f]):g!=="Number"&&g!=="String"&&g!=="Boolean"?d[u][f]="instanceof_"+g:d[u][f]=o[u][f]}else d[u][f]=o[u][f]}else{let f=o[u].constructor.name;f.includes("Set")?d[u]=Array.from(o[u]):f!=="Number"&&f!=="String"&&f!=="Boolean"?d[u]="instanceof_"+f:d[u]=o[u]}l=d}else l=o}else l=o;return l}return function(o,l){e.push(o);let h=JSON.stringify(o,r,l);return i(),h}}());JSON.stringifyWithCircularRefs===void 0&&(JSON.stringifyWithCircularRefs=function(){let n=new Map,e=[],t=["this"];function i(){n.clear(),e.length=0,t.length=1}function s(a,o){var l=e.length-1,h=e[l];if(typeof h=="object")if(h[a]===o||l===0)t.push(a),e.push(o.pushed);else for(;l-->=0;){if(h=e[l],typeof h=="object"&&h[a]===o){l+=2,e.length=l,t.length=l,--l,e[l]=o,t[l]=a;break}l--}}function r(a,o){if(o!=null&&typeof o=="object"){a&&s(a,o);let l=n.get(o);if(l)return"[Circular Reference]"+l;n.set(o,t.join("."))}return o}return function(o,l){try{return e.push(o),JSON.stringify(o,r,l)}finally{i()}}}());var Pe=Ne;function Le(n,e){let t=e instanceof URL?e:new URL(e);return n=t.pathname==="/"?n:t.pathname+n,new URL(n,t.href).href}function X(n,e=!0){n=n.replace(/\/\*\*?/,"");let t=n.split("/");e&&(t=t.slice(0,t.length-1));let i=[n];return i.push(n+"/*"),i.push(n+"/**"),t.forEach((s,r)=>{let a=t.slice(0,r+1).join("/");a!=n&&(r===t.length-1&&i.push(a+"/*"),i.push(a+"/**"))}),i}var Tt=input=>{if(typeof input=="string"&&(input=JSON.parse(input)),typeof input=="object"){for(let key in input){let value=input[key],regex=new RegExp("(|[a-zA-Z]w*|([a-zA-Z]w*(,s*[a-zA-Z]w*)*))s*=>"),func=typeof value=="string"?value.substring(0,8)=="function":!1,arrow=typeof value=="string"?regex.test(value):!1;try{input[key]=func||arrow?eval("("+value+")"):value}catch(n){console.error(n,value),input[key]=value}typeof input[key]=="object"&&Tt(input[key])}return input}else return{}},ee=(n,e=!0)=>{n instanceof Object&&(n=Array.isArray(n)?[...n]:Object.assign({},n));for(let t in n)n[t]instanceof Function&&(n[t]=n[t].toString()),n[t]instanceof Object&&(n[t]=ee(n[t],!1));return e?JSON.stringify(n):n},Ot=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/mg,It=/([^\s,]+)/g;function Be(n){if(n instanceof Function){var e=n.toString().replace(Ot,""),t=e.slice(e.indexOf("(")+1,e.indexOf(")")).match(It);return t===null&&(t=[]),t}else return}function qt(method=""){let getFunctionBody=n=>n.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4"),getFunctionHead=n=>{let e=n.indexOf(")");return n.slice(0,n.indexOf("{",e)+1)},newFuncHead=getFunctionHead(method),newFuncBody=getFunctionBody(method),newFunc;if(newFuncHead.includes("function ")){let n=newFuncHead.split("(")[1].split(")")[0];newFunc=new Function(n,newFuncBody)}else if(newFuncHead.substring(0,6)===newFuncBody.substring(0,6)){let n=newFuncHead.split("(")[1].split(")")[0];newFunc=new Function(n,newFuncBody.substring(newFuncBody.indexOf("{")+1,newFuncBody.length-1))}else newFunc=eval(newFuncHead+newFuncBody+"}");return newFunc}var Ge=`<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Error</title>
</head>
<body>
<pre>404 Not Found</pre>
</body>
</html>`;try{if(typeof process=="object"){let n=We();typeof globalThis.fetch!="function"&&(globalThis.fetch=n)}}catch(n){}var te=class{constructor(e="https://localhost",t,i){this.id=null;this.target=null;this.type=null;this.link=null;this.credentials={};this.connection=null;this.services={available:{},connecting:{},queue:{}};this.router=null;this.clients={};this.user=N();this.status=!1;this.responses={};this.setCredentials=e=>{var t;this.credentials={_id:(t=e._id)!=null?t:N(),id:e.id||e._id}};this.check=()=>p(this,null,function*(){var s,r,a,o,l,h;this.type==="webrtc"&&(yield this._subscribe({protocol:"webrtc",force:!0}).then(c=>{this.status=!0}).catch(c=>console.log("Link doesn't have WebRTC enabled.",c)));let e=()=>p(this,null,function*(){return yield this._subscribe({protocol:"websocket",force:!0}).then(c=>(this.status=!0,c)),yield this.send("services")}),t=()=>p(this,null,function*(){return yield this.send("services")}),i;if(this.type==="websocket"){let c=yield e().then(d=>(this.status=!0,d)).catch(d=>p(this,null,function*(){if(this.type==="websocket")return console.log("Falling back to http"),yield t()}))}else i=yield t().then(c=>(this.status=!0,c)).catch(c=>p(this,null,function*(){return console.log("Falling back to websockets"),yield e()}));if(i){console.log("Connection successful!");let c=i.message[0],d=[];for(let u in c){let g=c[u].replace(/Backend|Service/,"").toLowerCase();this.services.available[g]=u,d.push(g),((a=(r=(s=this.router)==null?void 0:s.SERVICES)==null?void 0:r[g])==null?void 0:a.status)instanceof Function&&this.router.SERVICES[g].status(u),((o=this.clients[g])==null?void 0:o.serviceType)==="subscription"&&((l=this.services.queue[g])==null||l.forEach(y=>y()),this.services.queue[g]=[])}(h=this.services.queue.undefined)==null||h.forEach(u=>u()),this.services.queue.undefined=[]}else console.log("Connection failed!");return i==null?void 0:i.message});this.send=(s,...r)=>p(this,[s,...r],function*(e,t={},i=()=>{}){var l,h,c,d,u,f,g,y;if(typeof e=="string")t.route=e;else{let m=this.services[e.service];t.route=m?`${m}/${e.route}`:e.route}t.suppress=!!this.connection;let a,o={suppress:t.suppress,id:(l=this.link.connection)==null?void 0:l.id};if(((h=this.connection)==null?void 0:h.protocol)==="websocket")t.id=(c=this.link.credentials)==null?void 0:c.id,a=yield this.link.connection.service.send(t,o);else if(((d=this==null?void 0:this.connection)==null?void 0:d.protocol)==="webrtc")t.id=((u=this.credentials)==null?void 0:u.id)||((f=this.link.credentials)==null?void 0:f.id),a=yield this.connection.service.send(t,o);else{t.id=(g=this.link.credentials)==null?void 0:g.id,t.method||(t.method=((y=t.message)==null?void 0:y.length)>0?"POST":"GET");let m={method:t.method.toUpperCase(),mode:"cors",headers:{"Content-Type":"application/json"}};m.method!="GET"&&(m.body=ee(t)),a=yield fetch(Le(t.route,this.link.target),m).then(S=>p(this,null,function*(){let j=S.body.getReader(),D=S.headers.get("Content-Length"),A=0;if(globalThis.ReadableStream){let z=new ReadableStream({start(E){let v=()=>p(this,null,function*(){j.read().then(({value:B,done:He})=>{if(He){E.close();return}A+=B.length,i(A/D,D),E.enqueue(B),v()})});v()}});return new Response(z,{headers:S.headers})}else return S})),a=a&&(yield a.json().then(S=>{if(a.ok)return S;throw S.message}).catch(S=>p(this,null,function*(){throw"Invalid JSON"})))}return a&&!(a==null?void 0:a.route)&&(a.route=t.route,a.block=!0),a});this._subscribe=(...t)=>p(this,[...t],function*(e={}){let i=()=>new Promise(s=>p(this,null,function*(){var o;let r=(o=e.protocol)!=null?o:this.type;(r?[this.clients[r]]:Object.values(this.clients)).forEach(l=>p(this,null,function*(){var h;if(l&&e.force||(l==null?void 0:l.status)===!0&&(l==null?void 0:l.serviceType)==="subscription"){let c=`${(h=this.link.services.available[l==null?void 0:l.service])!=null?h:l.name.toLowerCase()}/subscribe`;if(l.setEndpoint(this.link),!this.connection){let u=this.type==="http"||this.type==="websocket"?new URL(c,this.target):this.target,f=yield l.add(this.credentials,u.href);this.router&&l.addResponse("router",g=>{let y=typeof g=="string"?JSON.parse(g):g;Object.values(this.responses).forEach(m=>{m(y)}),this.router&&this.router.handleLocalRoute(y)}),this.connection={service:l,id:f,protocol:l.name}}this.type==="webrtc"&&(e.routes=[this.target]);let d=yield this.link.send(c,Object.assign({route:e.route,message:e.message,protocol:e.protocol},{message:[e.routes,this.connection.id]}));s(this.connection);return}})),this.services.queue[r]||(this.services.queue[r]=[]),this.services.queue[r].push(()=>p(this,null,function*(){let l=yield i();s(l)}))}));return yield i()});this.subscribe=e=>{if(e){let t=R("response");return this.responses[t]=e,t}};this.unsubscribe=e=>{e?delete this.responses[e]:this.responses={}};let s,r;typeof e=="object"?e instanceof URL?s=e:(s=e.target,r=e.type,this.link=e.link,this.setCredentials(e.credentials)):s=e,r||(r="http"),this.link||(this.link=this),r==="http"||r==="websocket"?(s=s instanceof URL?s:new URL(s),this.id=s.origin):this.id=s,this.target=s,this.type=r,this.router=i,t&&(this.clients=t)}};var Rt="DONOTSEND",ie=class{constructor(e={debug:!1}){this.id=R();this.USERS={};this.CONNECTIONS=new Map;this.SUBSCRIPTIONS=[];this.ENDPOINTS={};this.SERVICES={};this.ROUTES={};this.INTERVAL=10;this.DEFAULTROUTES=[{route:"ping",post:()=>"pong"},{route:"services/**",get:{object:this.SERVICES,transform:(e,...t)=>{let i={};return(t.length>0?[t[0]]:Object.keys(e)).forEach(r=>{let a=e[r];(a==null?void 0:a.serviceType)==="default"&&(i[r]=a.name)}),t.forEach((r,a)=>i=i[r]),i}}},{route:"/",aliases:["routes/**"],get:{object:this.ROUTES,transform:(e,...t)=>{let i={};return(t.length>0?[t[0]]:Object.keys(e)).forEach(r=>{r&&(i[r]={route:e[r].route.split("/").filter(a=>!a.match(/\*\*?/)).join("/"),args:e[r].args,wildcard:r.includes("*")})}),t.forEach((r,a)=>i=i[r]),i}}},{route:"sendMessage",aliases:["message","sendMsg"],post:(e,t)=>e.sendMsg(t[0],t[1],t[2])},{route:"setUserServerDetails",post:(e,t,i)=>{let s=e.USERS[i];if(!s)return!1;t[0]&&(s.username=t[0]),t[1]&&(s.password=t[1]),t[2]&&(s.props=t[2]),t[3]&&(s._id=t[3],s.id=t[3])}},{route:"setProps",post:(e,t,i)=>{let s=e.USERS[i];if(!s)return!1;if(typeof t=="object"&&!Array.isArray(t))return Object.assign(s.props,t),!0;if(Array.isArray(t)&&typeof t[1]=="object"){let r=e.USERS[t[0]];return r&&Object.assign(r.props,t[1]),!0}return!1}},{route:"getProps",post:(e,t,i)=>{let s=e.USERS[i];if(!s)return!1;if(t[0]){let r=e.USERS[t[0]];if(r)return r.props}else return s.props}},{route:"blockUser",post:(e,t,i)=>{let s=e.USERS[i];return s?this.blockUser(s,t[0]):!1}},{route:"users/**",get:{object:this.USERS,transform:(e,...t)=>{let i={};return(t.length>0?[t[0]]:Object.keys(e)).forEach(r=>{let a=e[r];i[r]={_id:a._id,username:a.username,origin:a.origin,props:a.props,updatedPropNames:a.updatedPropNames,lastUpdate:a.lastUpdate,lastTransmit:a.lastTransmit,latency:a.latency}}),t.forEach((r,a)=>i=i[r]),i}}},{route:"getUser",post:(e,t,i)=>{let s=e.USERS[i];if(!s)return!1;if(t[0]){let r=this.USERS[t[0]];if(r)return{_id:r._id,username:r.username,origin:r.origin,props:r.props,updatedPropNames:r.updatedPropNames,lastUpdate:r.lastUpdate,lastTransmit:r.lastTransmit,latency:r.latency}}else return{_id:s._id,username:s.username,origin:s.origin,props:s.props,updatedPropNames:s.updatedPropNames,lastUpdate:s.lastUpdate,lastTransmit:s.lastTransmit,latency:s.latency}}},{route:"login",aliases:["addUser","startSession"],post:(e,t,i)=>p(this,null,function*(){let s=yield e.addUser(...t);return{message:!!s,id:s.id}})},{route:"logout",aliases:["removeUser","endSession"],post:(e,t,i)=>{let s=e.USERS[i];if(!s)return!1;t[0]?e.removeUser(...t):e.removeUser(s)}}];this.protocols={};this.connect=(e,t)=>{let i=new te(e,this.SERVICES,this);return this.ENDPOINTS[i.id]=i,i.check().then(s=>{s&&(t&&t(i),this.login(i))}),i};this.disconnect=e=>p(this,null,function*(){this.logout(this.ENDPOINTS[e]),delete this.ENDPOINTS[e]});this._loadBackend=(e,t=e.name)=>{var i;this.SERVICES[t]=e,this.SERVICES[t].status=!0,(i=e.routes)==null||i.forEach(s=>this.addRoute(Object.assign({service:t},s))),e.subscribe&&e.subscribe((s,r,a)=>p(this,null,function*(){let o=yield this.handleMessage(s,r);if(a==null?void 0:a.includes("worker"))if(o!==null&&e[a])e[a].postMessage({route:"worker/workerPost",message:o,origin:e.id,callbackId:s.callbackId});else return o;return o})),(e==null?void 0:e.serviceType)==="subscription"&&this.SUBSCRIPTIONS.push(e.updateSubscribers)};this._loadService=(i,...s)=>p(this,[i,...s],function*(e,t=e==null?void 0:e.name){return this._loadBackend(e,t),yield this._loadClient(e,t,!0)});this._loadClient=(e,t,i=!1)=>new Promise(s=>{let r=e.name;if(e.subscribe&&e.subscribe((a,o)=>p(this,null,function*(){var d;let l=this.SERVICES[r],h=l.status===!0,c;return o==="local"?c=yield this.handleLocalRoute(a):h&&(c=yield this.send({route:`${l.route}/${a.route}`,endpoint:e==null?void 0:e.endpoint},...(d=a.message)!=null?d:[])),c})),i)s(e);else{this.SERVICES[r]=e;let a=o=>{this.SERVICES[r].status=!0,e.setEndpointRoute instanceof Function&&e.setEndpointRoute(o),e.routes.forEach(l=>{this.ROUTES[`${o}/${l.route}`]=l}),s(e)};this.SERVICES[r].status===!0?a(this.SERVICES[r]):this.SERVICES[r].status=a}});this.get=(e,...t)=>this._send(e,"GET",...t);this.delete=(e,...t)=>this._send(e,"DELETE",...t);this.post=(e,...t)=>this._send(e,"POST",...t);this.send=this.post;this._send=(e,t,...i)=>p(this,null,function*(){let s;if(typeof e=="string"||(e==null?void 0:e.endpoint)==null?s=Object.values(this.ENDPOINTS)[0]:s=e.endpoint,!s)return;let r;return r=yield s.send(e,{message:i,method:t}),r&&this.handleLocalRoute(r,s),r==null?void 0:r.message});this.handleLocalRoute=(e,t,i)=>p(this,null,function*(){var s,r,a;if(t&&i&&!e.suppress&&t.connection&&((a=(r=(s=t.connection)==null?void 0:s.service)==null?void 0:r.responses)==null||a.forEach(o=>o(Object.assign({route:i},e)))),!e.block){let o=this.ROUTES[e==null?void 0:e.route];if((o==null?void 0:o.post)instanceof Function)return o.post(this,e.message,e.id)}});this.subscribe=(i,...s)=>p(this,[i,...s],function*(e,t={}){if(Object.keys(this.ENDPOINTS).length>0||(t==null?void 0:t.endpoint))return t.endpoint||(t.endpoint=Object.values(this.ENDPOINTS)[0]),yield t.endpoint._subscribe(t).then(a=>t.endpoint.subscribe(e));throw"Remote is not specified"});this.handleMessage=(e,t)=>p(this,null,function*(){var s;let i={};if(Array.isArray(e))i.route=e[0],i.message=e.slice(1),i.callbackId=void 0;else if(typeof e=="string"){let r=e.split(" ");i.route=r[0],i.message=r.slice(1),i.callbackId=void 0}else typeof e=="object"&&Object.assign(i,e);if(typeof i=="object"&&!Array.isArray(i)&&i.route!=null){let r=this.USERS[i==null?void 0:i.id];console.log("runRoute",i.route);let a=yield this.runRoute(i.route,i.method,i.message,(s=r==null?void 0:r.id)!=null?s:i.id,i.callbackId);return a&&i.suppress&&(a.suppress=i.suppress),a}return null});e.interval&&(this.INTERVAL=e.interval),this.STATE=new Pe({},this.INTERVAL,void 0),this.DEBUG=e==null?void 0:e.debug,"onbeforeunload"in globalThis&&(globalThis.onbeforeunload=()=>{Object.values(this.ENDPOINTS).forEach(t=>{t.type!="webrtc"&&this.logout(t)})}),this.load({routes:this.DEFAULTROUTES}),this.DEBUG&&this.runCallback("routes",[!0]),(e==null?void 0:e.endpoints)&&e.endpoints.forEach(t=>this.connect(t))}login(e,t){return p(this,null,function*(){yield this.logout(e);let i=Object.values(e?{endpoint:e}:this.ENDPOINTS);return(yield Promise.all(i.map(r=>p(this,null,function*(){let a=yield this.send({route:"login",endpoint:r},t)[0];return r.setCredentials(a),a})))).reduce((r,a)=>r*a[0],!0)===1})}logout(e){return p(this,null,function*(){return(yield Promise.all(Object.values(e?{endpoint:e}:this.ENDPOINTS).map(i=>p(this,null,function*(){return yield this.send({route:"logout",endpoint:i},i.credentials)})))).reduce((i,s)=>i*s[0],!0)===1})}load(i){return p(this,arguments,function*(e,t=e.name){let s=e.constructor.type==="client",r=!e.constructor.type||e.constructor.type==="service",a=e.constructor.type==="backend";return r&&(yield this._loadService(e,t)),a&&(yield this._loadBackend(e,t)),s&&(yield this._loadClient(e)),e})}format(e,t={}){return e!==void 0&&((!e||typeof e!="object"||!("message"in e)&&!("route"in e))&&(e={message:e}),Array.isArray(e.message)||(e.message=[e.message]),t.service&&(e==null?void 0:e.route)&&(e.route=`${t.service}/${e.route}`),t.headers&&(e.headers=t.headers)),(e==null?void 0:e.route)&&(e.route=e.route.replace(/\/\*\*?/,"")),e}runRoute(a,o){return p(this,arguments,function*(e,t,i=[],s,r){try{return e==null?void 0:(!t&&Array.isArray(i)&&(t=i.length>0?"POST":"GET"),this.DEBUG&&console.log("route",e),yield this.runCallback(e,i,s,t).then(l=>{if(this.DEBUG&&console.log("Result:",l),l!==void 0)return l=this.format(l),l.callbackId=r,this.ROUTES[l.route]&&(l.block=!0),l.message===Rt?void 0:l}).catch(console.error))}catch(l){return new Error("Route failed...")}})}addUser(e){if(e&&(e.id||e._id)){e._id||(e._id=N()),e.id||(e.id=e._id);let t=this.USERS[e._id],i=t!=null?t:{id:e.id,_id:e._id,username:e.id,origin:e.id,props:{},updatedPropNames:[],sessions:[],blocked:[],lastUpdate:Date.now(),lastTransmit:0,latency:0,routes:new Map};Object.assign(i,e),this.DEBUG&&console.log("Adding User, Id:",e._id),this.USERS[e.id]=i;for(let s in this.SERVICES){let r=this.SERVICES[s];if(r.status===!0){let a=r.name+"/users";X(a).forEach(l=>{this.ROUTES[l]&&this.runRoute(l,"POST",[i],e._id)})}}return i}else return!1}removeUser(e){let t=typeof e=="string"?this.USERS[e]:e;return t?(Object.values(this.SERVICES).forEach(i=>{if(i.status===!0){let s=i.name+"/users";this.ROUTES[s]&&this.runRoute(s,"DELETE",[t],t.id)}}),delete t.id,!0):!1}blockUser(e,t=""){return this.USERS[t]&&!e.blocked.includes(t)&&e.id!==t?(e.blocked.push(t),!0):!1}sendMsg(e="",t="",i=void 0){let s=i?Object.assign(i,{message:t}):{message:t};if(typeof e=="string"){let r=this.USERS[e];r&&r.send(s)}else if(typeof e=="object")return e.send(s),!0;return!1}addRoute(e){e=Object.assign({},e);let t=[e.route,...e.aliases?e.aliases:[]];return delete e.aliases,t.forEach(i=>{var s,r;if(!i||!e.post&&!e.get)return!1;i=e.route=`${e.service?`${e.service}/`:""}`+i,this.removeRoute(i),i[0]==="/"&&(i=i.slice(1)),e.args=Be(e.post),this.ROUTES[i]=Object.assign(e,{route:i}),e.get&&(this.STATE.setState({[i]:(r=(s=e.get)==null?void 0:s.object)!=null?r:e.get}),this.STATE.subscribe(i,a=>{var l;let o=((l=e.get)==null?void 0:l.transform)?e.get.transform(a):a;this.SUBSCRIPTIONS.forEach(h=>h(this,{route:i,message:o}))}))}),!0}removeRoute(e){return delete this.ROUTES[e]}runCallback(e,t=[],i,s=t.length>0?"POST":"GET"){return new Promise(r=>p(this,null,function*(){let a=X(e),o={route:e,block:!0,message:{html:Ge},headers:{"Content-Type":"text/html"}};Promise.all(a.map(l=>p(this,null,function*(){var c;let h=this.ROUTES[l];if(h){this.DEBUG&&console.log("routeInfo",h);try{let d;if((h==null?void 0:h.delete)&&s.toUpperCase()==="DELETE")d=yield h.delete(this,t,i);else if(s.toUpperCase()==="GET"||!(h==null?void 0:h.post)){let u=this.STATE.data[h.route];if(u){let f=e.replace(h.route.split("/").filter(g=>g!="*"&&g!="**").join("/"),"").split("/").filter(g=>!!g);d={message:((c=h.get)==null?void 0:c.transform)?yield h.get.transform(u,...f):u}}else d=o}else(h==null?void 0:h.post)?d=yield h==null?void 0:h.post(this,t,i):d=o;r(this.format(d,h))}catch(d){console.log("Callback Failed: ",d)}}}))).then(l=>r(o))}))}checkRoutes(e){return p(this,null,function*(){var i,s;if(!e.data)return;let t=(s=(i=this.ROUTES[e.data.foo])!=null?i:this.ROUTES[e.data.route])!=null?s:this.ROUTES[e.data.functionName];return t||(t=this.ROUTES[e.data.foo]),t?e.data.message?yield t.post(this,e.data.message,e.data.origin):void 0:!1})}};var $e=he(H());var O=n=>typeof n=="string"&&n.length===24?(0,$e.default)(n):n,Dt=["user","group","authorization","discussion","chatroom","comment","dataInstance","event","notification","schedule","date"],qe=class extends J{constructor(e,t={},i=!1){super(e);this.name="structs";this.collections={};this.debug=!1;this.wipeDB=()=>p(this,null,function*(){return yield Promise.all(Object.values(this.collections).map(e=>e.instance.deleteMany({}))),!0});this.db=t==null?void 0:t.db,this.debug=i,this.mode=this.db&&t.mode?t.mode:"local",t.collections||(t.collections={}),Dt.forEach(s=>{t.collections[s]||(t.collections[s]=this.db?{instance:this.db.collection(s)}:{},t.collections[s].reference={})}),this.collections=t.collections,this.routes=[{route:"getUser",post:(s,r,a)=>p(this,null,function*(){let o=s.USERS[a];if(this.debug&&console.log("getUser origin",a,r,"users:",s.USERS),!o)return!1;let l;if(this.mode==="mongo")l=yield this.getMongoUser(o,r[0]);else{let h=this.getLocalData("user",{_id:r[0]});if(!h)l={user:{}};else if(yield this.checkAuthorization(o,h)){let d=this.getLocalData("group",{ownerId:r[0]}),u=this.getLocalData("authorization",{ownerId:r[0]});l={user:h,groups:d,authorizations:u}}else l={user:{}}}return this.debug&&console.log("getUser:",o,r[0],l),l})},{route:"setUser",aliases:["addUser"],post:(s,r,a)=>p(this,null,function*(){let o=s.USERS[a];if(!o)return!1;let l;if(this.mode==="mongo")l=yield this.setMongoUser(o,r[0]);else return(yield this.checkAuthorization(o,r[0],"WRITE"))&&this.setLocalData(r[0]),!0;return this.debug&&console.log("setUser",o,r[0],l),l})},{route:"getUsersByIds",post:(s,r,a)=>p(this,null,function*(){let o=s.USERS[a];if(!o)return!1;let l;if(this.mode==="mongo")l=yield this.getMongoUsersByIds(o,r[0]);else if(l=[],Array.isArray(r[0])){let h=this.getLocalData("user",{_id:r[0]});h&&l.push(h)}return this.debug&&console.log("getUserByIds:",o,r[0],l),l})},{route:"getUsersByRoles",post:(s,r,a)=>p(this,null,function*(){let o=s.USERS[a];if(!o)return!1;let l;if(this.mode.includes("mongo"))l=yield this.getMongoUsersByRoles(o,r[0]);else{let h=this.getLocalData("user");l=[],h.forEach(c=>{var d;((d=c.userRoles)==null?void 0:d.includes(r[0]))&&l.push(c)})}return this.debug&&console.log("getUserByRoles",o,r[0],l),l})},{route:"deleteUser",aliases:["removeUser"],post:(s,r,a)=>p(this,null,function*(){let o=s.USERS[a];if(!o)return!1;let l;if(this.mode==="mongo")l=yield this.deleteMongoUser(o,r[0]);else{l=!1;let h=this.getLocalData(r[0]);h&&this.checkAuthorization(o,h,"WRITE")&&(l=this.deleteLocalData(h))}return this.debug&&console.log("deleteUser:",o,r[0],l),l})},{route:"setData",aliases:["setMongoData"],post:(s,r,a)=>p(this,null,function*(){let o=s.USERS[a];if(!o)return!1;let l;if(this.mode.includes("mongo"))l=yield this.setMongoData(o,r);else{let h=[];return l=[],yield Promise.all(r.map(c=>p(this,null,function*(){let d=this.getLocalData(c);(yield this.checkAuthorization(o,d,"WRITE"))&&(this.setLocalData(d),l.push(d),d.structType!=="notification"&&h.push(d))}))),h.length>0&&this.checkToNotify(o,h,this.mode),this.debug&&console.log("setData:",o,r,l),!0}return this.debug&&console.log("setData:",o,r,l),l})},{route:"getData",aliases:["getMongoData","getUserData"],post:(s,r,a)=>p(this,null,function*(){let o=s.USERS[a];if(!o)return!1;let l;if(this.mode.includes("mongo"))l=yield this.getMongoData(o,r[0],r[1],r[2],r[4],r[5]);else{l=[];let h;r[0]&&(h=this.getLocalData(r[0])),h&&r[1]&&(h=h.filter(c=>{if(c.ownerId===r[1])return!0})),h&&(yield Promise.all(h.map(c=>p(this,null,function*(){let d=this.getLocalData(c._id);(yield this.checkAuthorization(o,d))&&l.push(d)}))))}return this.debug&&console.log("getData:",o,r,l),l})},{route:"getDataByIds",aliases:["getMongoDataByIds","getUserDataByIds"],post:(s,r,a)=>p(this,null,function*(){let o=s.USERS[a];if(!o)return!1;let l;if(this.mode.includes("mongo"))l=yield this.getMongoDataByIds(o,r[0],r[1],r[2]);else{l=[];let h;r[2]&&(h=this.getLocalData(r[2])),h&&r[1]&&(h=h.filter(c=>{if(c.ownerId===r[1])return!0})),h&&(yield Promise.all(h.map(c=>p(this,null,function*(){let d=this.getLocalData(c._id);(yield this.checkAuthorization(o,d))&&l.push(d)}))))}return this.debug&&console.log("getDataByIds:",o,r,l),l})},{route:"getAllData",post:(s,r,a)=>p(this,null,function*(){let o=s.USERS[a];if(!o)return!1;let l;if(this.mode.includes("mongo"))l=yield this.getAllUserMongoData(o,r[0],r[1]);else{let h=this.getLocalData(void 0,{ownerId:r[0]});l=[],yield Promise.all(h.map(c=>p(this,null,function*(){r[1]?r[1].indexOf(c.structType)<0&&(yield this.checkAuthorization(o,c))&&l.push(c):(yield this.checkAuthorization(o,c))&&l.push(c)})))}return this.debug&&console.log("getAllData:",o,r,l),l})},{route:"deleteData",post:(s,r,a)=>p(this,null,function*(){let o=s.USERS[a];if(!o)return!1;let l;return this.mode.includes("mongo")?l=yield this.deleteMongoData(o,r):(l=!1,yield Promise.all(r.map(h=>p(this,null,function*(){let c=this.getLocalData(h);(yield this.checkAuthorization(o,c,"WRITE"))&&this.deleteLocalData(c),l=!0})))),this.debug&&console.log("deleteData:",o,r,l),l})},{route:"getGroup",aliases:["getGroups"],post:(s,r,a)=>p(this,null,function*(){let o=s.USERS[a];if(!o)return!1;let l;if(this.mode.includes("mongo"))l=yield this.getMongoGroups(o,r[0],r[1]);else if(typeof r[1]=="string")l=this.getLocalData("group",{_id:r[1]});else{l=[];let h=this.getLocalData("group");r[0]?h.forEach(c=>{c.users.includes(r[0])&&l.push(c)}):h.forEach(c=>{c.users.includes(o._id)&&l.push(c)})}return this.debug&&console.log("getGroups:",o,r,l),l})},{route:"setGroup",post:(s,r,a)=>p(this,null,function*(){let o=s.USERS[a];if(!o)return!1;let l=yield this.setGroup(o,r[0],this.mode);this.debug&&console.log("setGroup:",o,r,l)})},{route:"deleteGroup",post:(s,r,a)=>p(this,null,function*(){let o=s.USERS[a];if(!o)return!1;let l;if(this.mode.includes("mongo"))l=yield this.deleteMongoGroup(o,r[0]);else{let h=this.getLocalData("group",r[0]),c=!1;h&&(c=yield this.checkAuthorization(o,h,"WRITE")),c&&(l=!0)}return this.debug&&console.log("deleteGroup:",o,r,l),l})},{route:"setAuth",post:(s,r,a)=>p(this,null,function*(){let o=s.USERS[a];if(!o)return!1;let l=yield this.setAuthorization(o,r[0],this.mode);return this.debug&&console.log("deleteGroup:",o,r,l),l})},{route:"getAuths",post:(s,r,a)=>p(this,null,function*(){let o=s.USERS[a];if(!o)return!1;let l;if(this.mode.includes("mongo"))l=yield this.getMongoAuthorizations(o,r[0],r[1]);else if(r[1]){let h=this.getLocalData("authorization",{_id:r[1]});h&&(l=[h])}else l=this.getLocalData("authorization",{ownerId:r[0]});return this.debug&&console.log("deleteGroup:",o,r,l),l})},{route:"deleteAuth",post:(s,r,a)=>p(this,null,function*(){let o=s.USERS[a];if(!o)return!1;let l;if(this.mode.includes("mongo"))l=yield this.deleteMongoAuthorization(o,r[0]);else{l=!0;let h=this.getLocalData("authorization",{_id:r[0]});h&&this.checkAuthorization(o,h,"WRITE")&&(l=this.deleteLocalData(h))}return this.debug&&console.log("deleteGroup:",o,r,l),l})}]}notificationStruct(e={}){let t="notification";return{structType:t,timestamp:Date.now(),id:R(t),note:"",ownerId:"",parentUserId:"",parent:{structType:e==null?void 0:e.structType,_id:e==null?void 0:e._id}}}checkToNotify(s){return p(this,arguments,function*(e,t=[],i=this.mode){if(typeof e=="string")for(let o in this.router.USERS){let l=this.router.USERS[o];l._id===e&&(e=l)}if(typeof e=="string"||e==null)return!1;let r={},a=[];if(t.forEach(o=>p(this,null,function*(){if((e==null?void 0:e._id)!==o.ownerId){let l=this.notificationStruct(o);l.id="notification_"+o._id,l.ownerId=o.ownerId,l.note=o.structType,l.parentUserId=o.ownerId,a.push(l),r[o.ownerId]=o.ownerId}if(o.users)o.users.forEach(l=>{if(l!==e._id){let h=this.notificationStruct(o);h.id="notification_"+o._id,h.ownerId=l,h.note=o.structType,h.parentUserId=o.ownerId,a.push(h),r[l]=l}});else{let l=[];if(i==="mongo"){let h=this.collections.authorizations.instance.find({$or:[{authorizedId:e._id},{authorizerId:e._id}]});(yield h.count())>0&&(yield h.forEach(c=>l.push(c)))}else l=this.getLocalData("authorization",{authorizedId:e._id}),l.push(...this.getLocalData("authorization",{authorizerId:e._id}));l.length>0&&l.forEach(h=>{if(o.authorizerId===o.ownerId&&!r[o.authorizedId]&&h.status==="OKAY"&&h.authorizations.indexOf("peer")>-1){let c=this.notificationStruct(o);c.ownerId=h.authorizedId,c.id="notification_"+o._id,c.note=o.structType,c.parentUserId=o.ownerId,a.push(c),r[c.ownerId]=c.ownerId}})}})),a.length>0){i==="mongo"?yield this.setMongoData(e,a):this.setLocalData(a);for(let o in r)this.router.sendMsg(o,"notifications",!0);return!0}else return!1})}setMongoData(i){return p(this,arguments,function*(e,t=[]){let s=!1;if(t.length>0){let r=!0,a="";if(yield Promise.all(t.map(o=>p(this,null,function*(){if(((e==null?void 0:e._id)!==o.ownerId||e._id===o.ownerId&&e.userRoles.includes("admin_control"))&&a!==o.ownerId&&(r=yield this.checkAuthorization(e,o,"WRITE"),a=o.ownerId),r){let l=JSON.parse(JSON.stringify(o));l._id&&delete l._id,o.id?o.id.includes("defaultId")?(yield this.db.collection(o.structType).insertOne(l),s=!0):yield this.db.collection(o.structType).updateOne({id:o.id},{$set:l},{upsert:!0}):o._id&&(o._id.includes("defaultId")?(yield this.db.collection(o.structType).insertOne(l),s=!0):yield this.db.collection(o.structType).updateOne({_id:O(o._id)},{$set:l},{upsert:!1}))}}))),s===!0){let o=[];return yield Promise.all(t.map((l,h)=>p(this,null,function*(){let c=JSON.parse(JSON.stringify(l));if(c._id&&delete c._id,l.structType!=="comment"){let d;l.structType!=="notification"&&(d=yield this.db.collection(c.structType).findOne(c)),d&&(d._id=d._id.toString(),o.push(d))}else if(l.structType==="comment"){let d=l,u=JSON.parse(JSON.stringify(d));u._id&&delete u._id;let f=yield this.db.collection("comment").findOne(u),g=d.replyTo,y=t.find(m=>{if(m._id===g)return!0});if(y){let m=JSON.parse(JSON.stringify(y));m._id&&delete m._id;let S;if(yield Promise.all(["discussion","chatroom","comment"].map(j=>p(this,null,function*(){let D=yield this.db.collection(j).findOne({_id:O(g)});D&&(S=D)}))),S){let j=d.parent._id,D,A;if(j!==g?(D=t.find(E=>{if(E._id===j)return!0}),D&&(delete D._id,yield Promise.all(["discussion","chatroom"].map(E=>p(this,null,function*(){let v=yield this.db.collection(E).findOne(D);v&&(A=v)}))))):A=S,S){let E=S.replies.indexOf(d._id);E>-1&&(S.replies[E]=f._id.toString(),f.replyTo=S._id.toString())}if(A){let E=A.comments.indexOf(d._id);E>-1&&(A.comments[E]=f._id.toString(),f.parent._id=A._id.toString())}let z=[f,S];A._id.toString()!==S._id.toString()&&z.push(A),yield Promise.all(z.map(E=>p(this,null,function*(){let v=JSON.parse(JSON.stringify(E));delete v._id,yield this.db.collection(E.structType).updateOne({_id:O(E._id)},{$set:v},{upsert:!1})}))),[...o].reverse().forEach((E,v)=>{z.find(B=>{if(E._id.toString()===B._id.toString())return!0})&&o.splice(o.length-v-1,1)}),o.push(...z)}}else f&&o.push(f)}}))),this.checkToNotify(e,o),o}else{let o=[];return t.forEach(l=>{l.structType!=="notification"&&o.push(l)}),this.checkToNotify(e,o),!0}}else return!1})}setMongoUser(e,t){return p(this,null,function*(){if(t._id){if((e._id!==t.ownerId||e._id===t.ownerId&&e.userRoles.includes("admin_control"))&&!(yield this.checkAuthorization(e,t,"WRITE")))return!1;let i=JSON.parse(JSON.stringify(t));i._id&&delete i._id,this.router.DEBUG&&console.log("RETURNS PROFILE",t);let s=O(t._id),r=s!==t._id?{_id:s}:{id:t.id};return yield this.collections.users.instance.updateOne(r,{$set:i},{upsert:!0}),e=yield this.collections.users.instance.findOne(r),this.checkToNotify(e,[t]),e}else return!1})}setGroup(s){return p(this,arguments,function*(e,t={},i=this.mode){if(t._id){let r;if(i==="mongo"?r=yield this.collections.groups.instance.findOne({name:t.name}):r=this.getLocalData("group",{_id:t._id}),r&&(r.ownerId!==t.ownerId||t.admins.indexOf(e._id)<0)||e._id!==t.ownerId&&!(yield this.checkAuthorization(e,t,"WRITE")))return!1;let a=[];t.users.forEach(f=>{a.push({email:f},{id:f},{username:f})});let o=[],l=[];if(i==="mongo"){let f=this.collections.users.instance.find({$or:a});(yield f.count())>0&&(yield f.forEach(g=>{o.push(g),l.push(g._id)}))}else a.forEach(f=>{let g=this.getLocalData("user",f);g.length>0&&(o.push(g[0]),l.push(g[0]._id))});t.users=l;let h=[],c=[],d=[];o.forEach(f=>{t.admins.find((g,y)=>{if(g===f._id||g===f.email||g===f.username||f._id===t.ownerId)return h.indexOf(f._id<0)&&h.push(f._id),!0}),t.peers.find((g,y)=>{if(g===f._id||g===f.email||g===f.username)return c.indexOf(f._id<0)&&c.push(f._id),!0}),t.clients.find((g,y)=>{if(g===f._id||g===f.email||g===f.username)return d.indexOf(f._id<0)&&d.push(f._id),!0})}),t.admins=h,t.peers=c,t.clients=d;let u=JSON.parse(JSON.stringify(t));return u._id&&delete u._id,i==="mongo"?t._id.includes("defaultId")?yield this.db.collection(t.structType).insertOne(u):yield this.collections.groups.instance.updateOne({_id:O(t._id)},{$set:u},{upsert:!0}):this.setLocalData(t),this.checkToNotify(e,[t],this.mode),t}else return!1})}getMongoUser(e,t="",i=!1){return p(this,null,function*(){return new Promise(s=>p(this,null,function*(){let r=[{email:t},{id:t},{username:t}];try{r.push({_id:O(t)})}catch(o){}let a=yield this.collections.users.instance.findOne({$or:r});if(!a||a==null)s({});else if(!a._id&&a._id?a._id=a._id.toString():!a._id&&a._id&&(a._id=a._id),a.ownerId||(a.ownerId=a._id),a&&i===!1){(e._id!==a._id||e._id===a._id&&e.userRoles.includes("admin_control"))&&((yield this.checkAuthorization(e,a))||s(void 0));let o=[],l=this.collections.authorizations.instance.find({ownerId:a._id});(yield l.count())>0&&(yield l.forEach(d=>o.push(d)));let h=this.collections.groups.instance.find({users:{$all:[a._id]}}),c=[];(yield h.count())>0&&(yield h.forEach(d=>c.push(d))),a.authorizations=o,a.groups=c,s(a)}else s(a)}))})}getMongoUsersByIds(){return p(this,arguments,function*(e={},t=[]){let i=[];t.forEach(r=>{try{i.push({_id:O(r)})}catch(a){}});let s=[];if(i.length>0){let r=this.collections.users.instance.find({$or:i});(yield r.count())>0&&(yield r.forEach(a=>{s.push(a)}))}return s})}getMongoUsersByRoles(){return p(this,arguments,function*(e={},t=[]){let i=this.collections.users.instance.find({userRoles:{$all:t}}),s=[];return(yield i.count())>0&&(yield i.forEach(r=>{s.push(r)})),s})}getMongoDataByIds(e,t,i,s){return p(this,null,function*(){if(t.length>0){let r=[];t.forEach(o=>{let l={_id:o};i&&(l.ownerId=i),r.push(l)});let a=[];if(!s)yield Promise.all(Object.keys(this.collections).map(o=>p(this,null,function*(){let l=yield this.db.collection(o).find({$or:r});if((yield l.count())>0){let h=!0,c="";yield l.forEach(d=>p(this,null,function*(){(e._id!==d.ownerId||e._id===d.ownerId&&e.userRoles.includes("admincontrol"))&&c!==d.ownerId&&(h=yield this.checkAuthorization(e,d),c=d.ownerId),h&&a.push(d)}))}})));else{let o=yield this.db.collection(s).find({$or:r});if((yield o.count())>0){let l=!0,h="";yield o.forEach(c=>p(this,null,function*(){(e._id!==c.ownerId||e._id===c.ownerId&&e.userRoles.includes("admincontrol"))&&h!==c.ownerId&&(l=yield this.checkAuthorization(e,c),h=c.ownerId),l&&a.push(c)}))}}return a}})}getMongoData(o,l,h){return p(this,arguments,function*(e,t,i,s={},r=0,a=0){i||(i=s==null?void 0:s.ownerId),s._id&&(s._id=O(s._id));let c=[],d=!0,u="";if(!t&&!i&&!s)return[];if(!t&&i&&Object.keys(s).length===0)return yield this.getAllUserMongoData(e,i);if(!s&&i){let f=this.db.collection(t).find({ownerId:i}).sort({$natural:-1}).skip(a);r>0&&f.limit(r),(yield f.count())>0&&(yield f.forEach(g=>p(this,null,function*(){(e._id!==g.ownerId||e._id===g.ownerId&&e.userRoles.includes("admincontrol"))&&u!==g.ownerId&&(d=yield this.checkAuthorization(e,g),u=g.ownerId),d===!0&&c.push(g)})))}else if(Object.keys(s).length>0&&i){let f=yield this.db.collection(t).findOne(oe({ownerId:i},s));f&&c.push(f)}else Object.keys(s).length>0&&!i&&(yield Promise.all(Object.keys(this.collections).map(f=>p(this,null,function*(){let g=yield this.db.collection(f).findOne(s);if(g){(e._id!==g.ownerId||e._id===g.ownerId&&e.userRoles.includes("admincontrol"))&&u!==g.ownerId&&(d=yield this.checkAuthorization(e,g),u=g.ownerId),c.push(g);return}}))));return d?c:[]})}getAllUserMongoData(s,r){return p(this,arguments,function*(e,t,i=[]){let a=[],o=!0,l="";return yield Promise.all(Object.keys(this.collections).map((h,c)=>p(this,null,function*(){if(o&&i.indexOf(h)<0){let d=this.db.collection(h).find({ownerId:t}),u=yield d.count();for(let f=0;f<u;f++){let g=yield d.next();(e._id!==t||e._id===t&&e.userRoles.includes("admincontrol"))&&l!==t&&(o=yield this.checkAuthorization(e,g),l=t),o&&a.push(g)}}}))),o?a:[]})}getMongoDataByRefs(i){return p(this,arguments,function*(e,t=[]){let s=[];if(s.length>0){let r="";t.forEach(a=>p(this,null,function*(){if(a.structType&&a._id){let o=yield this.db.collection(a.structType).findOne({_id:O(a._id)});if(o){let l=!0;if((e._id!==o.ownerId||e._id===o.ownerId&&e.userRoles.includes("admincontrol"))&&r!==o.ownerId){let h=yield this.checkAuthorization(e,o);r=o.ownerId}l===!0&&s.push(o)}}}))}return s})}getMongoAuthorizations(s){return p(this,arguments,function*(e,t=e._id,i=""){let r=[];if(i.length===0){let a=this.collections.authorizations.instance.find({ownerId:t});(yield a.count)>0&&(yield a.forEach(o=>{r.push(o)}))}else r.push(yield this.collections.authorizations.instance.findOne({_id:O(i),ownerId:t}));if(!(e._id!==r[0].ownerId&&!(yield this.checkAuthorization(e,r[0]))))return r})}getMongoGroups(s){return p(this,arguments,function*(e,t=e._id,i=""){let r=[];if(i.length===0){let a=this.collections.groups.instance.find({users:{$all:[t]}});(yield a.count)>0&&(yield a.forEach(o=>{r.push(o)}))}else try{r.push(yield this.collections.groups.instance.findOne({_id:O(i),users:{$all:[t]}}))}catch(a){}return r})}deleteMongoData(i){return p(this,arguments,function*(e,t=[]){let s=[];yield Promise.all(t.map(a=>p(this,null,function*(){try{let o=O(a._id),l=yield this.db.collection(a.structType).findOne({_id:o});if(l){s.push(l);let h=yield this.collections.notifications.instance.find({parent:{structType:a.structType,id:a._id}}),c=yield h.count();for(let d=0;d<c;d++){let u=yield h.next();u&&s.push(u)}}}catch(o){}})));let r="";return yield Promise.all(s.map((a,o)=>p(this,null,function*(){var h;let l=!0;(a.ownerId!==e._id||e._id===a.ownerId&&((h=e.userRoles)==null?void 0:h.includes("admincontrol")))&&a.ownerId!==r&&(r=a.ownerId,l=yield this.checkAuthorization(e,a,"WRITE")),l&&(yield this.db.collection(a.structType).deleteOne({_id:O(a._id)}),a.users&&a.users.forEach(c=>{c!==e._id&&c!==a.ownerId&&this.router.sendMsg(c,"deleted",a._id)}),a.ownerId!==e._id&&this.router.sendMsg(a.ownerId,"deleted",a._id))}))),!0})}deleteMongoUser(e,t){return p(this,null,function*(){if(e._id!==t||e._id===t&&e.userRoles.includes("admincontrol")){let i=yield this.collections.users.instance.findOne({id:t});if(!(yield this.checkAuthorization(e,i,"WRITE")))return!1}return yield this.collections.users.instance.deleteOne({id:t}),e._id!==t&&this.router.sendMsg(t,"deleted",t),!0})}deleteMongoGroup(e,t){return p(this,null,function*(){let i=yield this.collections.groups.instance.findOne({_id:O(t)});return i?(e._id!==i.ownerId||e._id===i.ownerId&&e.userRoles.includes("admincontrol"))&&!(yield this.checkAuthorization(e,i,"WRITE"))?!1:(i.users&&i.users.forEach(s=>{this.router.sendMsg(i.authorizerId,"deleted",i._id)}),yield this.collections.groups.instance.deleteOne({_id:O(t)}),!0):!1})}deleteMongoAuthorization(e,t){return p(this,null,function*(){let i=yield this.collections.authorizations.instance.findOne({_id:O(t)});return i?(e._id!==i.ownerId||e._id===i.ownerId&&e.userRoles.includes("admincontrol"))&&!(yield this.checkAuthorization(e,i,"WRITE"))?!1:(i.associatedAuthId&&(this.router.DEBUG&&console.log(i),yield this.collections.authorizations.instance.deleteOne({_id:O(i.associatedAuthId)}),i.authorizerId!==e._id?this.router.sendMsg(i.authorizerId,"deleted",i._id):i.authorizedId!==e._id&&this.router.sendMsg(i.authorizedId,"deleted",i._id)),yield this.collections.authorizations.instance.deleteOne({_id:O(t)}),!0):!1})}setAuthorization(s,r){return p(this,arguments,function*(e,t,i=this.mode){let a,o;if(i==="mongo"?(a=yield this.getMongoUser(e,t.authorizedId,!0),o=yield this.getMongoUser(e,t.authorizerId,!0)):(a=this.getLocalData("user",{_id:t.authorizedId}),o=this.getLocalData("user",{_id:t.authorizedId})),!a||!o||(t.authorizedId!==a._id&&(t.authorizedId=a._id),t.authorizerId!==o._id&&(t.authorizerId=o._id),t.authorizedName||(a.username?t.authorizedName=a.username:a.email&&(t.authorizedName=a.email)),t.authorizerName||(a.username?t.authorizerName=a.username:a.email&&(t.authorizerName=a.email)),(e._id!==t.ownerId||e._id===t.ownerId&&e.userRoles.includes("admincontrol"))&&e._id!==t.authorizedId&&e._id!==t.authorizerId&&!(yield this.checkAuthorization(e,t,"WRITE"))))return!1;let l=[];if(i==="mongo"){let d=this.collections.authorizations.instance.find({$and:[{authorizedId:t.authorizedId},{authorizerId:t.authorizerId}]});(yield d.count())>0&&(yield d.forEach(u=>l.push(u)))}else{let d=this.getLocalData("authorization",{authorizedId:t.authorizedId});Array.isArray(d)&&d.forEach(u=>{u.authorizerId===t.authorizerId&&l.push(u)})}let h;Array.isArray(l)&&l.forEach(d=>p(this,null,function*(){if(d.ownerId!==e._id){t.authorizerId===e._id?(d.authorizations=t.authorizations,d.structIds=t.structIds,d.excluded=t.excluded,d.expires=t.expires,d.status="OKAY",t.status="OKAY"):(t.authorizations=d.authorizations,t.structIds=d.structIds,t.excluded=d.excluded,t.expires=d.expires,d.status="OKAY",t.status="OKAY"),t.associatedAuthId=d._id.toString(),d.associatedAuthId=t._id.toString(),h=d;let u=JSON.parse(JSON.stringify(d));this.mode.includes("mongo")?(delete u._id,yield this.collections.authorizations.instance.updateOne({$and:[{authorizedId:t.authorizedId},{authorizerId:t.authorizerId},{ownerId:d.ownerId}]},{$set:u},{upsert:!0})):this.setLocalData(u)}}));let c=JSON.parse(JSON.stringify(t));if(i==="mongo"?(delete c._id,yield this.collections.authorizations.instance.updateOne({$and:[{authorizedId:t.authorizedId},{authorizerId:t.authorizerId},{ownerId:t.ownerId}]},{$set:c},{upsert:!0})):this.setLocalData(c),t._id.includes("defaultId")&&i==="mongo"){let d=yield this.collections.authorizations.instance.findOne(c);if(d&&(t._id=d._id.toString(),h)){let u=yield this.collections.authorizations.instance.findOne({$and:[{authorizedId:h.authorizedId},{authorizerId:h.authorizerId},{ownerId:h.ownerId}]});u&&(u.associatedAuthId=t._id,delete u._id,yield this.collections.authorizations.instance.updateOne({$and:[{authorizedId:u.authorizedId},{authorizerId:u.authorizerId},{ownerId:u.ownerId}]},{$set:u},{upsert:!0}),this.checkToNotify(e,[u]))}}return t})}checkAuthorization(r,a){return p(this,arguments,function*(e,t,i="READ",s=this.mode){var c,d,u;if(!e||!t)return!1;if(typeof e=="object"){if(t.ownerId===e._id&&!((c=e.userRoles)==null?void 0:c.includes("admin_control")))return!0}else if(typeof e=="string"){if(t.ownerId===e)return!0;e={_id:e}}let o,l;if(s==="mongo"?(o=yield this.collections.authorizations.instance.findOne({$or:[{authorizedId:e._id,authorizerId:t.ownerId,ownerId:e._id},{authorizedId:t.ownerId,authorizerId:e._id,ownerId:e._id}]}),l=yield this.collections.authorizations.instance.findOne({$or:[{authorizedId:e._id,authorizerId:t.ownerId,ownerId:t.ownerId},{authorizedId:t.ownerId,authorizerId:e._id,ownerId:t.ownerId}]})):(o=this.getLocalData("authorization",{ownerId:e._id}).find(f=>{if(f.authorizedId===e._id&&f.authorizerId===t.ownerId)return!0}),l=this.getLocalData("authorization",{ownerId:t.ownerId}).find(f=>{if(f.authorizedId===e._id&&f.authorizerId===t.ownerId)return!0})),!o||!l)return!1;let h=!1;return o.status==="OKAY"&&l.status==="OKAY"&&(t.structType==="group"?o.authorizations.indexOf(t.name+"_admin")>-1&&l.authorizations.indexOf(t.name+"_admin")>-1?h=!0:h=!1:o.authorizations.indexOf("provider")>-1&&l.authorizations.indexOf("provider")>-1||o.authorizations.indexOf("peer")>-1&&l.authorizations.indexOf("peer")>-1||o.authorizations.indexOf("control")>-1&&l.authorizations.indexOf("control")>-1||((d=o.structIds)==null?void 0:d.indexOf(t._id))>-1&&((u=l.structIds)==null?void 0:u.indexOf(t._id))>-1?h=!0:o.excluded.indexOf(t.structType)>-1&&t.ownerId===e._id&&i==="WRITE"&&(h=!1)),h})}overwriteLocalData(e){if(Array.isArray(e))e.forEach(t=>{let i=this.getLocalData(t.structType,{ownerId:t.ownerId,_id:t._id});!i||(i==null?void 0:i.length)===0?this.setLocalData(t):Object.assign(i,t)});else{let t=this.getLocalData(e.structType,{ownerId:e.ownerId,_id:e._id});!t||(t==null?void 0:t.length)===0?this.setLocalData(e):Object.assign(t,e)}}setLocalData(e){let t=i=>{let s=i.structType,r=this.collections[s].reference;r||(r={},this.collections[s].reference=r),r[i._id]=i};Array.isArray(e)?e.forEach(i=>{t(i)}):t(e)}getLocalData(e,t){let i,s,r;if(typeof t=="object"?(i=t.ownerId,s=Object.keys(t).filter(l=>l!="ownerId")[0],r=t[s]):r=t,!e&&!i&&!s&&!r)return[];let a=[];if(!e&&(i||s))return Object.values(this.collections).forEach(o=>{if(o=o.reference,(s==="_id"||s==="id")&&r){let l=o[r];l&&a.push(l)}else Object.values(o).forEach(l=>{s&&r?l[s]===r&&l.ownerId===i&&a.push(l):l.ownerId===i&&a.push(l)})}),a;{let o=this.collections[e].reference;if(!o)return a;if(!s&&!i)return Object.values(o).forEach(l=>{a.push(l)}),a;if((s==="_id"||s==="id")&&r)return o[r];Object.keys(o).forEach(l=>{let h=o[l];s&&r&&!i?h[s]===r&&a.push(h):i&&!s?h.ownerId===i&&a.push(h):i&&s&&r&&h.ownerId===i&&h[s]&&h[s]===r&&a.push(h)})}return a}deleteLocalData(e){if(!e)throw new Error("Struct not supplied");return!e.structType||!e._id?!1:(this.collections[e.structType]&&delete this.collections[e.structType].reference[e._id],!0)}},se=qe;var Ve=class extends ie{constructor(e={},t){super(t);this.tablet=new Ue;this.collections=this.tablet.collections;this.id=R();this.baseServerCallback=e=>{let t=e;if(typeof e=="object"&&(e==null?void 0:e.structType)&&(t=[e]),Array.isArray(e)){let i=t.filter(s=>{if(s.structType!=="notification")return!0});this.tablet&&this.tablet.sortStructsIntoTable(i),t.forEach(s=>{var r;(!s.structType||s.structType==="USER")&&(s.email?s.structType="user":s.structType="uncategorized"),s.structType==="user"||s.structType==="authorization"||s.structType==="group"?(s.structType==="user"&&(s._id=s.id),this.setLocalData(s)):s.structType==="notification"?(this.getLocalData("notification",{ownerId:s.ownerId,_id:s.parent._id})?this.setLocalData(s):this.getLocalData(s.structType,{_id:s.parent._id})||this.overwriteLocalData(s),s.ownerId===((r=this.currentUser)==null?void 0:r._id)&&(s.parent.structType==="user"||s.parent.structType==="dataInstance"||s.parent.structType==="schedule"||s.parent.structType==="authorization")&&this.resolveNotifications([s],!0)):this.overwriteLocalData(s)})}(e==null?void 0:e.message)==="notifications"&&this.checkForNotifications(),(e==null?void 0:e.message)==="deleted"&&this.deleteLocalData(e.id),this.onResult(e)};this.resolveNotifications=(...s)=>p(this,[...s],function*(e=[],t=!0,i=this.currentUser){if(!i||e.length===0)return;let r=[],a=[],o=[],l=!1;return e.length===0&&(e=this.getLocalData("notification",{ownerId:i._id})),e.forEach(h=>{h.parent.structType==="user"&&(l=!0),o.push(h.parent.structType),r.push(h.parent._id),a.push(h._id),this.deleteLocalData(h)}),this.deleteData(a),t&&(o.reverse().forEach((h,c)=>{h==="user"&&(this.getUser(a[c]),r.splice(r.length-c-1,1))}),r.length>0)?yield this.getDataByIds(r,i._id,"notification"):!0});this.getLocalUserPeerIds=(e=this.currentUser)=>{if(!e)return[];let t=[];return this.getLocalData("authorization",e._id).forEach(s=>{s.authorizations.indexOf("peer")>-1&&s.authorizerId===e._id&&t.push(s.authorizedId)}),t};this.authorizeUser=(d,...u)=>p(this,[d,...u],function*(e,t="",i="",s="",r="",a=[],o=[],l=[],h=[],c=!1){if(!e)return;let f=this.createStruct("authorization",void 0,e,void 0);return f.authorizedId=s,f.authorizedName=r,f.authorizerId=t,f.authorizerName=i,f.authorizations=a,f.structs=o,f.excluded=l,f.groups=h,f.expires=c,f.status="PENDING",f.associatedAuthId="",f.ownerId=e._id,f=yield this.setAuthorization(f),f});this.addGroup=(l,...h)=>p(this,[l,...h],function*(e,t="",i="",s=[],r=[],a=[],o=!0){if(!e)return;let c=this.createStruct("group",void 0,e);return c.name=t,c.details=i,c.admins=s,c.peers=r,c.clients=a,c.users=[...s,...r,...a],c.ownerId=e._id,o&&(c=yield this.setGroup(c)),c});this.addData=(l,...h)=>p(this,[l,...h],function*(e,t="",i="",s="",r=[],a=!1,o=!0){if(!e)return;let c=this.createStruct("dataInstance",void 0,e);return c.author=t,c.title=i,c.type=s,c.data=r,c.expires=a,c.ownerId=e._id,o&&(c=yield this.updateServerData([c])[0]),c});this.addEvent=(d,...u)=>p(this,[d,...u],function*(e,t="",i="",s="",r=0,a=0,o=0,l=[],h=[],c=!0){if(!e)return;h.length===0&&(h=this.getLocalUserPeerIds(e));let f=this.createStruct("event",void 0,e);return f.author=t,f.event=i,f.notes=s,f.startTime=r,f.endTime=a,f.grade=o,f.attachments=l,f.users=h,f.ownerId=e._id,c&&(f=yield this.updateServerData([f])[0]),f});this.addDiscussion=(h,...c)=>p(this,[h,...c],function*(e,t="",i="",s="",r="",a=[],o=[],l=!0){if(!e)return;o.length===0&&(o=this.getLocalUserPeerIds(e));let d=this.createStruct("discussion",void 0,e);d.topic=i,d.category=s,d.message=r,d.attachments=a,d.authorId=t,d.users=o,d.comments=[],d.replies=[],d.ownerId=e._id;let u=[d];return l&&(d=yield this.updateServerData(u)[0]),d});this.addChatroom=(o,...l)=>p(this,[o,...l],function*(e,t="",i="",s=[],r=[],a=!0){if(!e)return;r.length===0&&(r=this.getLocalUserPeerIds(e));let h=this.createStruct("chatroom",void 0,e);h.message=i,h.attachments=s,h.authorId=t,h.users=r,h.replies=[],h.comments=[],h.ownerId=e._id;let c=[h];return a&&(h=yield this.updateServerData(c)[0]),h});this.addComment=(l,h,c,...d)=>p(this,[l,h,c,...d],function*(e,t,i,s="",r="",a=[],o=!0){if(!e)return;let u=this.createStruct("comment",void 0,e,t);u.authorId=s,u.replyTo=i==null?void 0:i._id,u.message=r,u.attachments=a,u.users=t==null?void 0:t.users,u.replies=[],u.ownerId=e._id,o?i==null||i.replies.push(u._id):i==null||i.replies.push(u),o?t==null||t.comments.push(u._id):t==null||t.comments.push(u);let f=[u,t];return i._id!==t._id&&f.push(i),o&&(u=yield this.updateServerData(f)[0]),u});e instanceof Object&&Object.keys(e).length>0&&this.setupUser(e),this.load(new se(this))}setupUser(e,t=i=>{}){return p(this,null,function*(){if(!e){console.error('must provide an info object! e.g. {_id:"abc123"}'),t(void 0);return}let i=!1;e.id&&(e._id=e.id),console.log("Generating/Getting User: ",e._id);let s=yield this.getUser(e._id),r,a=!1;if(s==null?void 0:s._id){r=s.user;for(let o in e){let l=this.userStruct();if(r[o]&&o!=="_id")if(Array.isArray(e[o])){for(let h=0;h<r[o].length;h++)if(e[o].indexOf(r[o][h])<0){r[o]=e[o],i=!0;break}if(!i){for(let h=0;h<e[o].length;h++)if(r[o].indexOf(e[o][h])<0){r[o]=e[o],i=!0;break}}}else r[o]!==e[o]&&(r[o]=e[o],i=!0);else r[o]!==e[o]&&typeof l[o]=="string"&&o!=="_id"&&(r[o]=e[o],i=!0)}(s==null?void 0:s.authorizations)&&Array.isArray(s.authorizations)&&this.setLocalData(s.authorizations),(s==null?void 0:s.groups)&&Array.isArray(s.groups)&&this.setLocalData(s.groups)}else{r=this.userStruct(e,!0),a=!0;let o=yield this.setUser(r),l=this.getLocalData(void 0,{ownerId:r._id});(l==null?void 0:l.length)>0&&this.updateServerData(l,h=>{console.log("setData",h)}),this.setAuthorizationsByGroup(r)}if(a)this.currentUser=r,this.setLocalData(r);else{let o=yield this.getAllUserData(r._id,void 0);if(console.log("getServerData",o),!(!o||o.length===0)){this.setLocalData(o);let l=o.filter(u=>{if(u.structType==="notification"&&(this.getLocalData("authorization",u.parent._id)||u.parent.structType==="user"||u.parent.structType==="authorization"||!this.getLocalData(u.parent.structType,u.parent._id)))return!0}),h=o.filter(u=>{if(u.structType==="comment")return!0}),c=[];h.forEach(u=>{this.getLocalData("comment",{_id:u._id})||c.push(u._id)}),c.length>0&&this.deleteData(c),l.length>0&&(this.resolveNotifications(l,!1,void 0),i=!0);let d=o.filter(u=>{if(u.structType!=="notification")return!0});this.tablet&&this.tablet.sortStructsIntoTable(d)}this.setLocalData(r),console.log("currentUser",r),this.currentUser=r,console.log("collections",this.tablet.collections)}return t(this.currentUser),this.currentUser})}onResult(e){}randomId(e=""){return`${e+Math.floor(Math.random()+Math.random()*Math.random()*1e16)}`}addStruct(){return p(this,arguments,function*(e="struct",t={},i=void 0,s=void 0,r=!0){let a=k.Struct(e,t,i,s);return r&&(a=yield this.updateServerData([a])[0]),a})}ping(e=t=>{console.log(t)}){return p(this,null,function*(){var i;let t=(i=yield this.send("ping"))==null?void 0:i[0];return e(t),t})}sendMessage(e="",t="",i=void 0,s=r=>{console.log(r)}){return p(this,null,function*(){var o;let r=[e,t];i&&(r[2]=i);let a=(o=yield this.send("sendMessage",...r))==null?void 0:o[0];return s(a),a})}getUser(){return p(this,arguments,function*(e="",t=this.baseServerCallback){var s;let i=(s=yield this.send("structs/getUser",e))==null?void 0:s[0];return t(i),i})}getUsers(){return p(this,arguments,function*(e=[],t=this.baseServerCallback){var s;let i=(s=yield this.send("structs/getUsers",...e))==null?void 0:s[0];return t(i),i})}getUsersByRoles(){return p(this,arguments,function*(e=[],t=this.baseServerCallback){var s;let i=(s=yield this.send("structs/getUsersByRoles",e))==null?void 0:s[0];return t(i),i})}getAllUserData(s){return p(this,arguments,function*(e,t=[],i=this.baseServerCallback){var a;let r=(a=yield this.send("structs/getAllData",e,t))==null?void 0:a[0];return i(r),r})}getData(o,l,h){return p(this,arguments,function*(e,t,i,s=0,r=0,a=this.baseServerCallback){var d;let c=(d=yield this.send("structs/getData",e,t,i,s,r))==null?void 0:d[0];return a(c),c})}getDataByIds(){return p(this,arguments,function*(e=[],t,i,s=this.baseServerCallback){var a;let r=(a=yield this.send("structs/getDataByIdss",e,t,i))==null?void 0:a[0];return s(r),r})}getStructParentData(i){return p(this,arguments,function*(e,t=this.baseServerCallback){var a,o,l;if(!e.parent)return;let s=[(a=e.parent)==null?void 0:a.structType,"_id",(o=e.parent)==null?void 0:o._id],r=(l=yield this.send("structs/getData",...s))==null?void 0:l[0];return t(r),r})}setUser(){return p(this,arguments,function*(e={},t=this.baseServerCallback){var s;let i=(s=yield this.send("structs/setUser",this.stripStruct(e)))==null?void 0:s[0];return t(i),i})}checkUserToken(s){return p(this,arguments,function*(e,t=this.currentUser,i=this.baseServerCallback){if(!e)return!1;let r=!1;for(let a in e){let o=this.userStruct();if(t[a]&&a!=="_id")if(Array.isArray(e[a])){for(let l=0;l<t[a].length;l++)if(e[a].indexOf(t[a][l])<0){t[a]=e[a],r=!0;break}if(!r){for(let l=0;l<e[a].length;l++)if(t[a].indexOf(e[a][l])<0){t[a]=e[a],r=!0;break}}}else t[a]!==e[a]&&(t[a]=e[a],r=!0);else!t[a]&&o[a]&&(t[a]=e[a],r=!0)}return r&&(yield this.setUser(t,i))})}updateServerData(){return p(this,arguments,function*(e=[],t=this.baseServerCallback){var r;let i=new Array;e.forEach(a=>{i.push(this.stripStruct(a))});let s=(r=yield this.send("structs/setData",...i))==null?void 0:r[0];return t(s),s})}deleteData(){return p(this,arguments,function*(e=[],t=this.baseServerCallback){var r;let i=[];e.forEach(a=>{(a==null?void 0:a.structType)&&(a==null?void 0:a._id)&&(i.push({structType:a.structType,_id:a._id}),this.deleteLocalData(a))}),console.log("deleting",i);let s=(r=yield this.send("structs/deleteData",...i))==null?void 0:r[0];return t(s),s})}deleteUser(i){return p(this,arguments,function*(e,t=this.baseServerCallback){var r;if(!e)return;let s=(r=yield this.send("structs/deleteUser",e))==null?void 0:r[0];return t(s),s})}setGroup(){return p(this,arguments,function*(e={},t=this.baseServerCallback){var s;let i=(s=yield this.send("structs/setGroup",this.stripStruct(e)))==null?void 0:s[0];return t(i),i})}getGroups(){return p(this,arguments,function*(e=this.currentUser._id,t="",i=this.baseServerCallback){var r;let s=(r=yield this.send("structs/getGroups",e,t))==null?void 0:r[0];return i(s),s})}deleteGroup(i){return p(this,arguments,function*(e,t=this.baseServerCallback){var r;if(!e)return;this.deleteLocalData(e);let s=(r=yield this.send("structs/deleteGroup",e))==null?void 0:r[0];return t(s),s})}setAuthorization(){return p(this,arguments,function*(e={},t=this.baseServerCallback){var s;let i=(s=yield this.send("structs/setAuth",this.stripStruct(e)))==null?void 0:s[0];return t(i),i})}getAuthorizations(){return p(this,arguments,function*(e=(s=>(s=this.currentUser)==null?void 0:s._id)(),t="",i=this.baseServerCallback){var a;if(e===void 0)return;let r=(a=yield this.send("structs/getAuths",e,t))==null?void 0:a[0];return i(r),r})}deleteAuthorization(i){return p(this,arguments,function*(e,t=this.baseServerCallback){var r;if(!e)return;this.deleteLocalData(e);let s=(r=yield this.send("structs/deleteAuth",e))==null?void 0:r[0];return t(s),s})}checkForNotifications(){return p(this,arguments,function*(e=(t=>(t=this.currentUser)==null?void 0:t._id)()){return yield this.getData("notification",e)})}setAuthorizationsByGroup(){return p(this,arguments,function*(e=this.currentUser){let t=this.getLocalData("authorization",{ownerId:e._id});e.userRoles.forEach(i=>{let r=i.split("_")[0],a;i.includes("client")?a=r+"_peer":i.includes("peer")?a=r+"_client":i.includes("admin")&&(a=r+"_owner"),a&&this.getUsersByRoles([a],o=>{o==null||o.forEach(l=>{let h=l.username;h||(h=l.email),h||(h=l.id);let c=e.username;c||(c=e.email),c||(c=e.id),h!==c&&(i.includes("client")?t.find(u=>{if(u.authorizerId===l.id&&u.authorizedId===e.id)return!0})||this.authorizeUser(k.ProfileStruct("user",e,e),l.id,h,e.id,c,["peer"],void 0,[i]):i.includes("peer")&&(t.find(u=>{if(u.authorizedId===l.id&&u.authorizerId===e.id)return!0})||this.authorizeUser(k.ProfileStruct("user",e,e),e.id,c,l.id,h,["peer"],void 0,[i])))})})})})}deleteRoom(e){return p(this,null,function*(){var i;if(!e)return!1;let t=[e];return(i=e.comments)==null||i.forEach(s=>{let r=this.getLocalData("comment",{_id:s});t.push(r)}),e?yield this.deleteData(t):!1})}deleteComment(e){return p(this,null,function*(){var o,l,h;let t=[e],i=(c=e)=>{(c==null?void 0:c.replies)&&c.replies.forEach(d=>{let u=this.getLocalData("comment",{_id:d});u&&(u.replies.length>0&&u.replies.forEach(f=>{i(f)}),t.push(u))})};i(e);let s=this.getLocalData((o=e.parent)==null?void 0:o.structType,{_id:(l=e.parent)==null?void 0:l._id}),r=[];s&&(r=[s],t.forEach(c=>{var f,g;let d=(f=s.replies)==null?void 0:f.indexOf(c._id);d>-1&&s.replies.splice(d,1);let u=(g=s.comments)==null?void 0:g.indexOf(c._id);u>-1&&s.comments.splice(u,1)}));let a=this.getLocalData("comment",{_id:e.replyTo});if((a==null?void 0:a._id)!==(s==null?void 0:s._id)){let c=(h=a.replies)==null?void 0:h.indexOf(s._id);c>-1&&a.replies.splice(c,1),r.push(a)}return r.length>0&&(yield this.updateServerData(r)),yield this.deleteData(t)})}getUserDataByAuthorization(o,l,h){return p(this,arguments,function*(e,t,i,s=0,r=0,a=this.baseServerCallback){let c=e.authorizerId;if(c)return new Promise(d=>p(this,null,function*(){this.getUser(c,u=>p(this,null,function*(){t?yield this.getData(t,c,i,s,r,a):yield this.getAllUserData(c,["notification"],a),d(u),a(u)}))}))})}getUserDataByAuthorizationGroup(){return p(this,arguments,function*(e="",t,i,s=0,r=0,a=this.baseServerCallback){let o=this.getLocalData("authorization"),l=[];return yield Promise.all(o.map(h=>p(this,null,function*(){var c;if((c=h.groups)==null?void 0:c.includes(e)){let d=h.authorizerId;if(d){let u,f=yield this.getUser(d,a);f&&l.push(f),t?u=yield this.getData(t,d,i,s,r,a):u=yield this.getAllUserData(d,["notification"],a),u&&l.push(u)}return!0}}))),l})}overwriteLocalData(e){if(Array.isArray(e))e.forEach(t=>{let i=this.getLocalData(t.structType,{ownerId:t.ownerId,_id:t._id});!i||(i==null?void 0:i.length)===0?this.setLocalData(t):Object.assign(i,t)});else{let t=this.getLocalData(e.structType,{ownerId:e.ownerId,_id:e._id});!t||(t==null?void 0:t.length)===0?this.setLocalData(e):Object.assign(t,e)}}setLocalData(e){this.tablet.setLocalData(e)}getLocalData(e,t){return this.tablet.getLocalData(e,t)}getLocalReplies(e){let t=[];if(e.replies){if(e.replies.reduce((i,s)=>i*(typeof s=="object"?1:0),1))return e.replies}else return t;return t=this.getLocalData("comment",{replyTo:e._id}),t}hasLocalAuthorization(e,t=this.currentUser._id){let s=this.getLocalData("authorization",{ownerId:t}).find(r=>{if(r.authorizedId===t&&r.authorizerId===e||r.authorizerId===t&&r.authorizedId===e)return!0});return s||!1}deleteLocalData(e){return Array.isArray(e)?e.forEach(t=>this.deleteStruct(t)):this.deleteStruct(e),!0}deleteStruct(e){if(typeof e=="string"&&(e=this.getLocalData(e)),!e)throw new Error("Struct not supplied");return!e.structType||!e._id?!1:(this.tablet.collections.get(e.structType).delete(e._id),!0)}stripStruct(e={}){let t=Object.assign({},e);for(let i in t)(t[i]===void 0||t[i].constructor.name==="Map")&&delete t[i];return t}createStruct(e,t,i=this.currentUser,s){return k.Struct(e,t,i,s)}userStruct(e={},t=!1){let i=k.ProfileStruct(void 0,e,e);e._id?i.id=e._id:e.id?i.id=e.id:i.id="user"+Math.floor(Math.random()*1e10),i._id=i.id,i.ownerId=i.id;for(let s in e)Object.keys(k.ProfileStruct()).indexOf(s)<0&&delete i[s];return t&&(this.currentUser=i),i}dataObject(e=void 0,t="any",i=Date.now()){return{type:t,data:e,timestamp:i}}},vt=Ve;})();
