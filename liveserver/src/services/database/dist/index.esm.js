/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};function e(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var n=function(){return n=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},n.apply(this,arguments)};function r(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{c(r.next(t))}catch(t){s(t)}}function a(t){try{c(r.throw(t))}catch(t){s(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}c((r=r.apply(t,e||[])).next())}))}function i(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}}function s(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,s=n.call(t),o=[];try{for(;(void 0===e||e-- >0)&&!(r=s.next()).done;)o.push(r.value)}catch(t){i={error:t}}finally{try{r&&!r.done&&(n=s.return)&&n.call(s)}finally{if(i)throw i.error}}return o}function o(t,e,n){if(n||2===arguments.length)for(var r,i=0,s=e.length;i<s;i++)!r&&i in e||(r||(r=Array.prototype.slice.call(e,0,i)),r[i]=e[i]);return t.concat(r||Array.prototype.slice.call(e))}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function a(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{c(r.next(t))}catch(t){s(t)}}function a(t){try{c(r.throw(t))}catch(t){s(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}c((r=r.apply(t,e||[])).next())}))}function c(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}}function u(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,s=n.call(t),o=[];try{for(;(void 0===e||e-- >0)&&!(r=s.next()).done;)o.push(r.value)}catch(t){i={error:t}}finally{try{r&&!r.done&&(n=s.return)&&n.call(s)}finally{if(i)throw i.error}}return o}function l(t,e,n){if(n||2===arguments.length)for(var r,i=0,s=e.length;i<s;i++)!r&&i in e||(r||(r=Array.prototype.slice.call(e,0,i)),r[i]=e[i]);return t.concat(r||Array.prototype.slice.call(e))}for(var h=function(t){return(t?"".concat(t,"_"):"")+Math.floor(1e5*Math.random())},d=function(t,e,n,r){return void 0===t&&(t=Math),void 0===e&&(e=Date),void 0===n&&(n=16),void 0===r&&(r=function(e){return t.floor(e).toString(n)}),r(e.now()/1e3)+" ".repeat(n).replace(/./g,(function(){return r(t.random()*n)}))},f=function(){function t(t){var e,n=this;this.id=h("service"),this.name="service",this.callbacks=new Map,this.status=!1,this.serviceType="default",this.routes=[],this.delegate=null===(e=null===globalThis||void 0===globalThis?void 0:globalThis.document)||void 0===e?void 0:e.createDocumentFragment(),this.protocols={},this.services={},this.setEndpointRoute=function(t){n.route=t},this.notify=function(t,e,r){return a(n,void 0,void 0,(function(){var n,i=this;return c(this,(function(s){switch(s.label){case 0:return n=[],[4,Promise.all(Array.from(this.callbacks).map((function(s,o){return a(i,void 0,void 0,(function(){var i;return c(this,(function(o){switch(o.label){case 0:return[4,s[1](t,e,r)];case 1:return!(i=o.sent())||i instanceof Error||n.push(i),[2]}}))}))})))];case 1:return s.sent(),[2,null==n?void 0:n[0]]}}))}))},this.setEndpoint=function(t){n.endpoint=t},this.subscribe=function(t){if(t instanceof Function){var e=h();return n.callbacks.set(e,t),e}},this.unsubscribe=function(t){return n.callbacks.delete(t)},this.router=t}return t.prototype.addEventListener=function(){for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];null===(t=this.delegate)||void 0===t||t.addEventListener.apply(this.delegate,e)},t.prototype.dispatchEvent=function(){for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return null===(t=this.delegate)||void 0===t?void 0:t.dispatchEvent.apply(this.delegate,e)},t.prototype.removeEventListener=function(){for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return null===(t=this.delegate)||void 0===t?void 0:t.removeEventListener.apply(this.delegate,e)},t}(),p=Math.floor(16777215*Math.random()),v=_.index=parseInt(16777215*Math.random(),10),g=("undefined"==typeof process||"number"!=typeof process.pid?Math.floor(1e5*Math.random()):process.pid)%65535,b=function(t){return!(null==t||!t.constructor||"function"!=typeof t.constructor.isBuffer||!t.constructor.isBuffer(t))},m=[],y=0;y<256;y++)m[y]=(y<=15?"0":"")+y.toString(16);var S=new RegExp("^[0-9a-fA-F]{24}$"),w=[];for(y=0;y<10;)w[48+y]=y++;for(;y<16;)w[55+y]=w[87+y]=y++;function _(t){if(!(this instanceof _))return new _(t);if(t&&(t instanceof _||"ObjectID"===t._bsontype))return t;if(this._bsontype="ObjectID",null!=t&&"number"!=typeof t){var e=_.isValid(t);if(!e&&null!=t)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");if(e&&"string"==typeof t&&24===t.length)return _.createFromHexString(t);if(null==t||12!==t.length){if(null!=t&&"function"==typeof t.toHexString)return t;throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters")}this.id=t}else this.id=this.generate(t)}var I=_;_.default=_,_.createFromTime=function(t){return new _(function(t,e){return(e=e.toString(16)).length===t?e:"00000000".substring(e.length,t)+e}(8,t=parseInt(t,10)%4294967295)+"0000000000000000")},_.createFromHexString=function(t){if(void 0===t||null!=t&&24!==t.length)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");for(var e="",n=0;n<24;)e+=String.fromCharCode(w[t.charCodeAt(n++)]<<4|w[t.charCodeAt(n++)]);return new _(e)},_.isValid=function(t){return null!=t&&("number"==typeof t||("string"==typeof t?12===t.length||24===t.length&&S.test(t):t instanceof _||(!!b(t)||"function"==typeof t.toHexString&&(t.id instanceof _Buffer||"string"==typeof t.id)&&(12===t.id.length||24===t.id.length&&S.test(t.id)))))},_.prototype={constructor:_,toHexString:function(){if(!this.id||!this.id.length)throw new Error("invalid ObjectId, ObjectId.id must be either a string or a Buffer, but is ["+JSON.stringify(this.id)+"]");if(24===this.id.length)return this.id;if(b(this.id))return this.id.toString("hex");for(var t="",e=0;e<this.id.length;e++)t+=m[this.id.charCodeAt(e)];return t},equals:function(t){return t instanceof _?this.toString()===t.toString():"string"==typeof t&&_.isValid(t)&&12===t.length&&b(this.id)?t===this.id.toString("binary"):"string"==typeof t&&_.isValid(t)&&24===t.length?t.toLowerCase()===this.toHexString():"string"==typeof t&&_.isValid(t)&&12===t.length?t===this.id:!(null==t||!(t instanceof _||t.toHexString))&&t.toHexString()===this.toHexString()},getTimestamp:function(){var t,e=new Date;return t=b(this.id)?this.id[3]|this.id[2]<<8|this.id[1]<<16|this.id[0]<<24:this.id.charCodeAt(3)|this.id.charCodeAt(2)<<8|this.id.charCodeAt(1)<<16|this.id.charCodeAt(0)<<24,e.setTime(1e3*Math.floor(t)),e},generate:function(t){"number"!=typeof t&&(t=~~(Date.now()/1e3)),t=parseInt(t,10)%4294967295;var e=v=(v+1)%16777215;return String.fromCharCode(t>>24&255,t>>16&255,t>>8&255,255&t,p>>16&255,p>>8&255,255&p,g>>8&255,255&g,e>>16&255,e>>8&255,255&e)}};var T=Symbol&&Symbol.for&&Symbol.for("nodejs.util.inspect.custom")||"inspect";_.prototype[T]=function(){return"ObjectID("+this+")"},_.prototype.toJSON=_.prototype.toHexString,_.prototype.toString=_.prototype.toHexString;var E=function(t){return"string"==typeof t&&24===t.length?I(t):d()},O=function(t,e,n,s){return void 0===n&&(n=[]),r(void 0,void 0,void 0,(function(){var t;return i(this,(function(r){switch(r.label){case 0:return n.push({_id:E(s)}),e?void 0===Object.values(n[0])[0]?[3,2]:[4,e.findOne({$or:n}).exec()]:[3,5];case 1:return t=r.sent(),[3,4];case 2:return[4,e.find({}).exec()];case 3:t=r.sent(),r.label=4;case 4:return[2,t];case 5:throw"Model not defined"}}))}))},A=function(t,e,n){return r(void 0,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return e?[4,e.deleteOne({id:n.id})]:[3,2];case 1:return t.sent(),[3,3];case 2:throw"Model not defined";case 3:return[2]}}))}))},k=function(t,e,n){return r(void 0,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return e?[4,Promise.all(n.map((function(t){return r(void 0,void 0,void 0,(function(){var n,r,s;return i(this,(function(i){switch(i.label){case 0:return(n=JSON.parse(JSON.stringify(t)))._id&&delete n._id,r=E(t._id),s=r!==t._id?{_id:r}:{id:t.id},[4,e.updateOne(s,{$set:n},{upsert:!0})];case 1:return i.sent(),[2,!0]}}))}))})))]:[3,2];case 1:return t.sent(),[3,3];case 2:throw"Model not defined";case 3:return[2]}}))}))};function D(t="struct",e={},n={_id:""},r={structType:"struct",_id:""}){let i={_id:function(t=""){return`${t+Math.floor(Math.random()+Math.random()*Math.random()*1e16)}`}(t+"defaultId"),structType:t,ownerId:n?._id,timestamp:Date.now(),parent:{structType:r?.structType,_id:r?._id}};return i.ownerId||delete i.ownerId,i?.parent?._id||delete i.parent,Object.keys(e).length>0&&Object.assign(i,e),i}!function(t){function n(e,n,a){void 0===n&&(n={});var c=t.call(this,e)||this;c.name="database",c.collections={},n.collections||(n.collections={}),Object.values(n.collections).forEach((function(t){return t.reference={}})),c.collections=n.collections;var u=function(t){l.collections[t].filters||(l.collections[t].filters={}),l.collections[t].filters.get||(l.collections[t].filters.get=function(){return!0}),l.collections[t].filters.post||(l.collections[t].filters.post=function(){return!0}),l.collections[t].filters.delete||(l.collections[t].filters.delete=function(){return!0});var e=l.collections[t].reference,n=function(){for(var n=[],s=0;s<arguments.length;s++)n[s]=arguments[s];return r(c,void 0,void 0,(function(){var s,o,a,c,u,l=this;return i(this,(function(h){switch(h.label){case 0:return s=[],n=n.filter((function(t){return"string"==typeof t})).map((function(t){var e=t.split(",");return e.length>0?e:[t]})),o=n.length,a=null!==(u=n.shift())&&void 0!==u?u:[void 0],[4,Promise.all(a.map((function(n){return r(l,void 0,void 0,(function(){var r,a,c;return i(this,(function(i){switch(i.label){case 0:return r=[],this.collections[t].match&&this.collections[t].match.forEach((function(t){var e;return r.push(((e={})[t]=n,e))})),this.collections[t].model?(c=(a=s).push,[4,O(0,this.collections[t].model,r,n)]):[3,2];case 1:return c.apply(a,[i.sent()]),[3,3];case 2:s.push(o>0?Object.values(e).find((function(t){r.forEach((function(e){var n=Object.keys(e)[0];return t[n]===e[n]}))})):e),i.label=3;case 3:return[2]}}))}))})))];case 1:h.sent();try{n.forEach((function(t){return s=s[t[0]]}))}catch(t){}return"object"!=typeof s||null==s?[3,3]:[4,Object.values(s).filter((function(e){return l.collections[t].filters.get(e,l.collections)}))];case 2:return c=h.sent(),[3,4];case 3:c=this.collections[t].filters.get(s,this.collections)?s:null,h.label=4;case 4:return[2,c]}}))}))};l.routes.push({route:"".concat(t,"/**"),get:{object:e,transform:n},delete:function(e,a,u){return r(c,void 0,void 0,(function(){var r,c,l,h,d,f;return i(this,(function(i){switch(i.label){case 0:return(r=e.USERS[u])?(null===(f=null===(d=this.collections[t])||void 0===d?void 0:d.filters)||void 0===f?void 0:f.delete)?[4,this.collections[t].filters.delete(r,a,this.collections)]:[3,2]:[2,null];case 1:return c=i.sent(),[3,3];case 2:c=!0,i.label=3;case 3:return c?this.collections[t].model?[4,n.apply(void 0,o([],s(a),!1))]:[3,8]:[3,9];case 4:return i.sent()?[4,A(0,this.collections[t].model,a[0])]:[3,6];case 5:return i.sent(),[2,!0];case 6:return[2,!1];case 7:return[3,9];case 8:if(l=this.collections[t].reference[a[0]._id])return h=this.collections[t].reference[l._id],delete this.collections[t].reference[l._id],h?[2,!0]:[2,!1];i.label=9;case 9:return[2,null]}}))}))},post:function(e,a,u){return r(c,void 0,void 0,(function(){var r,c,l,h,d,f=this;return i(this,(function(i){switch(i.label){case 0:return(r=e.USERS[u])?0===a.length?[2,n.apply(void 0,o([],s(a),!1))]:(null===(d=null===(h=this.collections[t])||void 0===h?void 0:h.filters)||void 0===d?void 0:d.post)?[4,this.collections[t].filters.post(r,a,this.collections)]:[3,2]:[2,null];case 1:return l=i.sent(),[3,3];case 2:l=!0,i.label=3;case 3:return l?this.collections[t].model?[4,k(0,this.collections[t].model,a)]:[3,5]:[3,7];case 4:return c=i.sent(),[3,6];case 5:a.forEach((function(e){return f.collections[t].reference[e._id]=e})),i.label=6;case 6:return[3,8];case 7:return[2,null];case 8:return[2,!!c]}}))}))}})},l=this;for(var h in c.collections)u(h);return c}e(n,t)}(f);const R={FP1:[-21.2,66.9,12.1],FPZ:[1.4,65.1,11.3],FP2:[24.3,66.3,12.5],AF7:[-41.7,52.8,11.3],AF3:[-32.7,48.4,32.8],AFZ:[1.8,54.8,37.9],AF4:[35.1,50.1,31.1],AF8:[43.9,52.7,9.3],F5:[-51.4,26.7,24.7],F3:[-39.7,25.3,44.7],F1:[-22.1,26.8,54.9],FZ:[0,26.8,60.6],F2:[23.6,28.2,55.6],F4:[41.9,27.5,43.9],F6:[52.9,28.7,25.2],F7:[-52.1,28.6,3.8],F8:[53.2,28.4,3.1],FC5:[-59.1,3,26.1],FC3:[-45.5,2.4,51.3],FC1:[-24.7,.3,66.4],FCZ:[1,1,72.8],FC2:[26.1,3.2,66],FC4:[47.5,4.6,49.7],FC6:[60.5,4.9,25.5],FT9:[-53.8,-2.1,-29.1],FT7:[-59.2,3.4,-2.1],FT8:[60.2,4.7,-2.8],FT10:[55,-3.6,-31],T7:[-65.8,-17.8,-2.9],T5:[-61.5,-65.3,1.1],T3:[-70.2,-21.3,-10.7],T4:[71.9,-25.2,-8.2],T6:[59.3,-67.6,3.8],T8:[67.4,-18.5,-3.4],C5:[-63.6,-18.9,25.8],C3:[-49.1,-20.7,53.2],C1:[-25.1,-22.5,70.1],CZ:[.8,-21.9,77.4],C2:[26.7,-20.9,69.5],C4:[50.3,-18.8,53],C6:[65.2,-18,26.4],CP5:[-61.8,-46.2,22.5],CP3:[-46.9,-47.7,49.7],CP1:[-24,-49.1,66.1],CPZ:[.7,-47.9,72.6],CP2:[25.8,-47.1,66],CP4:[49.5,-45.5,50.7],CP6:[62.9,-44.6,24.4],TP9:[-73.6,-46.7,-4],TP7:[-63.6,-44.7,-4],TP8:[64.6,-45.4,-3.7],TP10:[74.6,-47.4,-3.7],P9:[-50.8,-51.3,-37.7],P7:[-55.9,-64.8,0],P5:[-52.7,-67.1,19.9],P3:[-41.4,-67.8,42.4],P1:[-21.6,-71.3,52.6],PZ:[.7,-69.3,56.9],P2:[24.4,-69.9,53.5],P4:[44.2,-65.8,42.7],P6:[54.4,-65.3,20.2],P8:[56.4,-64.4,.1],P10:[51,-53.9,-36.5],PO7:[-44,-81.7,1.6],PO3:[-33.3,-84.3,26.5],POZ:[0,-87.9,33.5],PO4:[35.2,-82.6,26.1],PO8:[43.3,-82,.7],O1:[-25.8,-93.3,7.7],OZ:[.3,-97.1,8.7],O2:[25,-95.2,6.2]};function z(t,e={}){if(!R[t.tag]&&t.position&&(R[t.tag]=[t.position.x,t.position.y,t.position.z]),R[t.tag]){let n={channel:"",position:{x:R[t.tag][0],y:R[t.tag][1],z:R[t.tag][2]}};return Object.assign(e,n)}return Object.assign(e,t)}function U(t=[],e={}){let n={scp:[],delta:[],theta:[],alpha1:[],alpha2:[],beta:[],lowgamma:[],highgamma:[]};return t.forEach((t=>n[t]=[])),Object.assign(e,n)}function N(t="",e={},n={_id:""},r={structType:"struct",_id:""}){let i=U(),s={tag:t,position:{x:0,y:0,z:0},count:0,times:[],raw:[],filtered:[],fftCount:0,fftTimes:[],ffts:[],slices:JSON.parse(JSON.stringify(i)),means:JSON.parse(JSON.stringify(i)),startTime:Date.now()},o=D("eeg",s,n,r);return t&&z(s,o),Object.assign(o,e)}function j(t={0:N("FP1"),1:N("FP2")},e={},n={_id:""},r={structType:"struct",_id:""}){let i=U(),s=D("coherence",{tag:t[0]?.tag+"::"+t[1]?.tag,x0:t[0]?.position?.x,y0:t[0]?.position?.y,z0:t[0]?.position?.z,x1:t[1]?.position?.x,y1:t[1]?.position?.y,z1:t[1]?.position?.z,fftCount:0,fftTimes:[],ffts:[],slices:JSON.parse(JSON.stringify(i)),means:JSON.parse(JSON.stringify(i)),startTime:Date.now()},n,r);return Object.assign(s,e)}function M(t={channelDicts:[{ch:0,tag:"FP1",analyze:!1},{ch:1,tag:"FP2",analyze:!1}],taggedOnly:!0},e={},n={_id:""},r={structType:"struct",_id:""}){for(var i=[],s=1,o=0,a=0;a<t.channelDicts.length*(t.channelDicts.length+1)/2-t.channelDicts.length;a++){if(!1===t.taggedOnly||!0===t.taggedOnly&&null!==t.channelDicts[o].tag&&null!==t.channelDicts[o+s].tag&&"other"!==t.channelDicts[o].tag&&"other"!==t.channelDicts[o+s].tag&&!0===t.channelDicts[o].analyze&&!0===t.channelDicts[o+s].analyze){var c=N(t.channelDicts[o].tag),u=N(t.channelDicts[o+s].tag);i.push(j({0:c,1:u},{},n,r))}++s+o===t.channelDicts.length&&(o++,s=1)}return i}function C(t="",e={},n={_id:""},r={structType:"struct",_id:""}){let i={tag:t,position:{x:0,y:0,z:0},count:0,times:[],red:[],ir:[],ir2:[],ambient:[],ratio:[],temp:[],beat_detect:{beats:[],breaths:[],rir:[],rir2:[],drir_dt:[],localmins:[],localmaxs:[],val_dists:[],peak_dists:[],localmins2:[],localmaxs2:[],val_dists2:[],peak_dists2:[]},startTime:Date.now()},s=D("fnirs",i,n,r);return t&&z(i,s),Object.assign(s,e)}function L(t="",e={},n={_id:""},r={structType:"struct",_id:""}){let i={tag:t,Ax:[],Ay:[],Az:[],Gx:[],Gy:[],Gz:[],startTime:Date.now()},s=D("imu",i,n,r);return t&&z(i,s),Object.assign(s,e)}function P(t="",e={},n={_id:""},r={structType:"struct",_id:""}){let i=D("eyetracker",{tag:t,count:0,times:[],x:[],y:[],smax:[],smay:[],startTime:Date.now()},n,r);return Object.assign(i,e)}function F(t="",e={},n={_id:""},r={structType:"struct",_id:""}){let i=D("ecg",{tag:t,count:0,times:[],raw:[],filtered:[],bpm:[],hrv:[],startTime:Date.now()},n,r);return Object.assign(i,e)}function B(t="",e={},n={_id:""},r={structType:"struct",_id:""}){}function G(t="",e={},n={_id:""},r={structType:"struct",_id:""}){let i=C(t,n,r,e);return i.structType="ppg",i}function J(t="",e={},n={_id:""},r={structType:"struct",_id:""}){let i=F(t,n,r,e);return i.structType="hrv",i}function q(t="",e={},n={_id:""},r={structType:"struct",_id:""}){let i=N(t,n,r,e);return i.structType="emg",i}function W(t="",e={},n={_id:""},r={structType:"struct",_id:""}){let i=D("profile",{tag:t,name:"",username:"",firstName:"",lastName:"",email:"",sex:"",birthday:"",type:"",userRoles:[],id:""},n,r);return Object.assign(i,e)}function $(t="",e={},n={_id:""},r={structType:"struct",_id:""}){let i=D("authorization",{tag:t,authorizedId:"",authorizedName:"",authorizerId:"",authorizerName:"",authorizations:new Array,structs:new Array,excluded:new Array,groups:new Array,status:"PENDING",expires:!1,associatedAuthId:""},n,r);return Object.assign(i,e)}function K(t="",e={},n={_id:""},r={structType:"struct",_id:""}){let i=D("group",{tag:t,name:"",details:"",admins:new Array,peers:new Array,clients:new Array,users:new Array},n,r);return Object.assign(i,e)}function V(t="",e={},n={_id:""},r={structType:"struct",_id:""}){let i=D("dataInstance",{tag:t,title:"",author:"",expires:!1,type:"",data:new Array},n,r);return Object.assign(i,e)}function H(t="",e={},n={_id:""},r={structType:"struct",_id:""}){let i=D("event",{tag:t,event:"",author:"",startTime:"",endTime:"",grade:0,notes:"",attachments:new Array,users:new Array},n,r);return Object.assign(i,e)}function Y(t="",e={},n={_id:""},r={structType:"struct",_id:""}){let i=D("chatroom",{tag:t,message:"",topic:"",author:"",attachments:new Array,comments:new Array,replies:new Array,users:new Array,audioChatActive:!1,videoChatActive:!1},n,r);return Object.assign(i,e)}function Z(t="",e={},n={_id:""},r={structType:"struct",_id:""}){let i=D("comment",{tag:t,author:"",replyTo:"",message:"",rating:0,replies:new Array,users:new Array,attachments:new Array},n,r);return Object.assign(i,e)}function Q(t="",e={},n={_id:""},r={structType:"struct",_id:""}){let i=D("notification",{tag:t,note:"",parentUserId:""},n,r);return Object.assign(i,e)}function X(t="",e={},n={_id:""},r={structType:"struct",_id:""}){let i=D("schedule",{tag:t,title:"",author:"",attachments:new Array,dates:new Array},n,r);return Object.assign(i,e)}function tt(t="",e={},n={_id:""},r={structType:"struct",_id:""}){let i=D("date",{tag:t,timeSet:"",notes:"",recurs:"NEVER",attachments:new Array},n,r);return Object.assign(i,e)}const et={Struct:D,EEGStruct:N,FNIRSStruct:C,CoherenceStruct:j,CoherenceMap:M,FrequencyBandsStruct:U,IMUStruct:L,EyeTrackerStruct:P,ECGStruct:F,EDAStruct:B,PPGStruct:G,HRVStruct:J,EMGStruct:q,ProfileStruct:W,AuthorizationStruct:$,GroupStruct:K,DataStruct:V,EventStruct:H,ChatroomStruct:Y,CommentStruct:Z,NotificationStruct:Q,ScheduleStruct:X,DateStruct:tt};var nt=Object.freeze({__proto__:null,Struct:D,eegCoordinates:R,setCoordinate:z,EEGCoordinates:function(t=[],e=!0){let n=[];for(let e of t){let t=N(e);n.push(t)}return e&&n.push(...M({channelDicts:t})),n},FrequencyBandsStruct:U,EEGStruct:N,CoherenceStruct:j,CoherenceMap:M,FNIRSStruct:C,IMUStruct:L,EyeTrackerStruct:P,ECGStruct:F,EDAStruct:B,PPGStruct:G,HRVStruct:J,EMGStruct:q,ProfileStruct:W,AuthorizationStruct:$,GroupStruct:K,DataStruct:V,EventStruct:H,ChatroomStruct:Y,CommentStruct:Z,NotificationStruct:Q,ScheduleStruct:X,DateStruct:tt,structRegistry:et});function rt(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}class it{constructor(){}static genSineWave(t=20,e=1,n=1,r=512,i=0,s=1){for(var o=[],a=[],c=1/r,u=0;u<n;u+=c){var l=Math.sin(2*Math.PI*t*u)*e;l+=Math.sin(2*Math.PI*i*u)*s,o.push(l),a.push(u)}return[a,o]}static getSineAmplitude(t=20,e=1,n=0,r=0){return Math.sin(this.TWO_PI*t*n+r)*e}static mean(t){return t.reduce(((t,e)=>e+t))/t.length}static mode(t){return t.sort(((e,n)=>t.filter((t=>t===e)).length-t.filter((t=>t===n)).length)).pop()}static std(t,e){let n=e;e||(n=this.mean(t));let r=0;for(let e=0;e<t.length;e++){let i=t[e]-n;r+=i*i}return Math.sqrt(r/t.length)}static relError(t=[],e=[],n=!0){if(t.length!==e.length)throw new Error("Input arrays of same length!");let r=t.length,i=[];for(let s=0;s<r;s++){let r=(t[s]-e[s])/t[s];n&&(r=Math.abs(r)),i.push(r)}return i}static informationEntropy(t=[]){let e=[],n=t.length;for(let r=0;r<n;r++){let n=t[r]*Math.log(t[r]);isNaN(n)&&(n=0),e.push(n)}return e}static zscore(t){let e=this.mean(t),n=this.std(t,e),r=[];for(let i=0;i<t.length;i++)r.push((t[i]-e)/n);return r}static variance(t){var e=this.mean(t);return t.reduce(((t,n)=>t+(n-e)**2),0)/t.length}static dot(t,e){for(var n=0,r=0;r<t.length;r++)n+=t[r]*e[r];return n}static cross3D(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]}static magnitude(t){var e=0;return t.forEach((t=>{e+=t*t})),Math.sqrt(e)}static distance(t,e){var n=0;return t.forEach(((t,r)=>{n+=(e[r]-t)*(e[r]-t)})),Math.sqrt(n)}static normalize(t){var e;e=this.magnitude(t);var n=[];return t.forEach(((t,r)=>{n.push(t*e)})),n}static quadraticFormula(t,e,n){let r=Math.sqrt(e*e-4*t*n);if(!isNaN(r))return["complex","complex"];let i=1/(2*t);if(0===r)return[e*i];let s=-e;return[(s+r)*i,(s-r)*i]}static newtonsMethod(t=(t=>Math.pow(t,5)+t*t-t-.2),e=0,n=1,r=.01,i=10){let s=[];for(let o=0;o<i;o++){let i,o=Math.random()*(n-e),a=t(o),c=t(o+r),u=(c-a)/r,l=o+r;for(;Math.abs(u)>r;){let e=l+-a/n;a=c,c=t(e);let n=(c-a)/(e-l)}let h=s.find(((t,e)=>{if(Math.abs(xn1-t)<r)return i=e,!0}));h?s[i]=.5*(xn1+h):s.push(xn1)}return s}static makeVec(t,e){var n=[];return t.forEach(((t,r)=>{n.push(e[r]-t)})),n}static transpose(t){return t[0].map(((e,n)=>t.map((t=>t[n]))))}static matmul(t,e){var n=t.length,r=t[0].length;e.length;for(var i=e[0].length,s=new Array(n),o=0;o<n;++o){s[o]=new Array(i);for(var a=0;a<i;++a){s[o][a]=0;for(var c=0;c<r;++c)s[o][a]+=t[o][c]*e[c][a]}}return s}static matscale(t,e){let n=[];for(var r=0;r<t.length;r++){n[r]=[];for(let i=0;i<t[0].length;i++)n[r][i]=t[r][i]*e}return n}static matadd(t,e){let n=[];for(let i=0;i<t.length;i++){n[i]=[];for(var r=0;r<t[0].length;r++)n[i][r]=t[i][r]+e[i][r]}return n}static matsub(t,e){let n=[];for(let i=0;i<t.length;i++){n[i]=[];for(var r=0;r<t[0].length;r++)n[i][r]=t[i][r]-e[i][r]}return n}static histogram(t=[],e=1,n){let r=[...t];r.sort((function(t,e){return t-e}));let i=Math.min(...r);if("number"==typeof n){let t=Math.max(...r);e=Math.abs((t-i)/(n-1))}let s=i,o=[],a=[];for(let t=0;t<r.length;t++){let n=e*s;if(r[t]>i+n){s++,n+=e;let t=i+n+.5*n;o.push(t),a.push(0)}a[a.length-1]++}return[o,a]}static normalDistribution(t=[],e=!0,n=1e-4){let r=this.mean(t),i=this.variance(t),s=t.length,o=[],a=1/(this.TWO_PI*i),c=1/i,u=0;for(let e=0;e<s;e++){let i=Math.exp(-.5*Math.pow((t[e]-r)*c,2))*a;i<n&&(i=0),o.push(i),u+=i}if(e){let t=1/u;o=o.map((e=>e*t))}return o}static expectedValue(t=[],e=this.normalDistribution(t)){return t.reduce(((t,n,r)=>t+n*e[r]))}static originMoment(t=[],e=this.normalDistribution(t),n=1){return t.reduce(((t,r,i)=>t+Math.pow(r,n)*e[i]))}static centralMoment(t=[],e=this.normalDistribution(t),n=1){let r=this.mean(t);return t.reduce(((i,s,o)=>i+Math.pow(s-r,n)*e[o]/t.length))}static linearDiscriminantAnalysis(t=[],e=[]){let n=this.mean(t),r=this.mean(e),i=this.cov1d(t,e),s=this.normalDistribution(t),o=[];for(let e=0;e<t.length;e++)o.push(x[e]*i*r-.5*n*i*r+Math.log10(s[e]));return o}static conv1D(t=[],e=[1/3,1/3,1/3],n=Math.floor(.5*e.length)){let r=[],i=1/e.length;if(n>0){let e=new Array(n).fill(0);t=[...e,...t,...e]}let s=Math.floor(.5*e.length),o=t.length-e.length+s;for(let n=s;n<o;n++){let o=0;for(let r=0;r<e.length;r++)o+=t[n-s]*e[r];r.push(o*i)}return r}static conv2D(t=[[],[],[]],e=[[],[],[]],n=0){let r,i=new Array(t.length-Math.ceil(.5*e.length)).fill([]),s=it.transpose(s);if(n>0){let e=new Array(n).fill(0);r=it.transpose(t);for(let t=0;t<r.length;t++)r[t]=[...e,...r[t],...e];t=it.transpose(r);for(let n=0;n<t.length;n++)t[n]=[...e,...t[n],...e]}let o,a=Math.floor(.5*e[0].length),c=Math.floor(.5*s[0].length),u=t[0].length-e[0].length+a,l=r[0].length-s[0].length+c,h=1/(e[0].length*s[0].length),d=u*l,f=a,p=c;for(;f<d;){let n=0;o=f%t[0].length,0===o&&p++;for(let r=0;r<e[0].length;r++){for(let i=0;i<s[0].length;r++)n+=t[p-c+i][o-a+r]*e[i][r];i[p].push(n*h)}f++}return i}static cov2d(t){var e=this.transpose(t),n=[],r=[],i=[];t.forEach(((t,e)=>{r.push(this.mean(t))})),e.forEach(((t,e)=>{i.push(this.mean(t))})),t.forEach(((e,s)=>{n.push([]);for(var o=0;o<e.length;o++)n[s].push((t[s][o]-r[s])*(t[s][o]-i[o])/(e.length-1))}));var s=this.transpose(n),o=n.length,a=n[0].length;s.length;for(var c=s[0].length,u=new Array(o),l=0;l<o;++l){u[l]=new Array(c);for(var h=0;h<c;++h){u[l][h]=0;for(var d=0;d<a;++d)u[l][h]+=n[l][d]*s[d][h]/(t[0].length-1)}}return u}static cov1d(t=[],e=[]){return this.cov2d([t,e])}static cov3d(t=[],e=[],n=[]){return[[this.cov1d(t,t),this.cov1d(t,e),this.cov1d(t,n)],[this.cov1d(e,t),this.cov1d(e,e),this.cov1d(e,n)],[this.cov1d(n,t),this.cov1d(n,e),this.cov1d(n,n)]]}static covNd(t=[]){let e=[];t.forEach(((n,r)=>{e.push([]),t.forEach(((t,i)=>{e[r].push(this.cov1d(n,t))}))}))}static eigens2x2(t=[[1,2],[3,4]]){let e=t[0][0]*t[1][1]-t[0][1]*t[1][0],n=.5*(t[0][0]+t[1][1]),r=Math.sqrt(n*n-e);return[n+r,n-r]}static eigenvectors2x2(t=[[1,2],[3,4]],e=[1,2]){let n=[-t[0][1],t[0][0]-e[0]];0===n[0]&&0===n[1]&&(n[0]=t[1][1]-e[0],n[1]=-t[1][0]);let r=[-t[0][1],t[0][0]-e[1]];return 0===r[0]&&0===r[1]&&(r[0]=t[1][1]-e[1],r[1]=-t[1][0]),[n,r]}static fastpca2d(t,e){let n=this.cov1d(t,e),r=this.eigens2x2(n);r[1]>r[0]&&r.reverse();let i=this.eigenvectors2x2(n,r);return console.log(r,i),[r,i]}static crosscorrelation(t,e){var n=[...e,...Array(e.length).fill(0)],r=this.mean(t),i=this.mean(e),s=t.reduce(((t,e)=>t+Math.pow(e-r,2)));s=Math.sqrt(s);for(var o=e.reduce(((t,e)=>t+Math.pow(e-r,2))),a=1/(s*(o=Math.sqrt(o))),c=new Array(t.length).fill(0),u=0;u<t.length;u++){var l=t.reduce(((t,e,s)=>t+(e-r)*(n[u+s]-i)));c[u]=l*a}return c}static autocorrelation(t){for(var e=[...t,...Array(t.length).fill(0)],n=this.mean(t),r=t.reduce(((t,e)=>t+Math.pow(e-n,2))),i=1/((r=Math.sqrt(r))*r),s=new Array(t.length).fill(0),o=0;o<t.length;o++){var a=t.reduce(((t,r,i)=>t+(r-n)*(e[o+i]-n)));s[o]=a*i}return s}static correlograms(t=[[],[]]){var e=[];return t.forEach(((n,r)=>{t.forEach(((t,i)=>{i>=r&&e.push(it.crosscorrelation(n,t))}))})),e}static sma(t=[],e){for(var n=[],r=0;r<t.length;r++)if(0==r)n.push(t[0]);else if(r<e){var i=t.slice(0,r+1);n.push(i.reduce(((t,e)=>e+t))/(r+1))}else i=t.slice(r-e,r),n.push(i.reduce(((t,e)=>e+t))/e);return n}static sum(t=[]){return t.length>0?t.reduce(((t,e)=>e+t)):0}static reduceArrByFactor(t,e=2){return t.filter(((t,n)=>n%e==0))}static makeArr(t,e,n){for(var r=[],i=(e-t)/(n-1),s=0;s<n;s++)r.push(t+i*s);return r}static interpolateArray(t,e,n=1){var r=function(t,e,r){return(t+(e-t)*r)*n},i=new Array,s=new Number((t.length-1)/(e-1));i[0]=t[0];for(var o=1;o<e-1;o++){var a=o*s,c=new Number(Math.floor(a)).toFixed(),u=new Number(Math.ceil(a)).toFixed(),l=a-c;i[o]=r(t[c],t[u],l)}return i[e-1]=t[t.length-1],i}static isExtrema(t,e="peak"){let n=[...t];if(n.length%2==0&&n.pop(),t.length>1){let t=!0;for(let r=0;r<n.length;r++){let i=n[r];if("peak"===e){if(r<Math.floor(.5*n.length)&&i>=n[Math.floor(.5*n.length)]){t=!1;break}if(r>Math.floor(.5*n.length)&&i>=n[Math.floor(.5*n.length)]){t=!1;break}}else if("valley"===e){if(r<Math.floor(.5*n.length)&&i<=n[Math.floor(.5*n.length)]){t=!1;break}if(r>Math.floor(.5*n.length)&&i<=n[Math.floor(.5*n.length)]){t=!1;break}}else{if(r<Math.floor(.5*n.length)&&i<=n[Math.floor(.5*n.length)]){t=!1;break}if(r>Math.floor(.5*n.length)&&i<=n[Math.floor(.5*n.length)]){t=!1;break}}}if("peak"!==e&&"valley"!==e&&!1===t){t=!0;for(let e=0;e<n.length;e++){let r=n[e];if(e<Math.floor(.5*n.length)&&r>=n[Math.floor(.5*n.length)]){t=!1;break}if(e>Math.floor(.5*n.length)&&r>=n[Math.floor(.5*n.length)]){t=!1;break}}}return t}}static isCriticalPoint(t,e="peak"){let n=[...t];if(n.length%2==0&&n.pop(),t.length>1){let t=!0;for(let r=0;r<n.length;r++){let i=n[r];if("peak"===e){if(r<.5*n.length&&i<=0){t=!1;break}if(r>.5*n.length&&i>0){t=!1;break}}else if("valley"===e){if(r<.5*n.length&&i>=0){t=!1;break}if(r>.5*n.length&&i<0){t=!1;break}}else{if(r<.5*n.length&&i>=0){t=!1;break}if(r>.5*n.length&&i<0){t=!1;break}}}if("peak"!==e&&"valley"!==e&&!1===t){t=!0;for(let e=0;e<n.length;e++){let r=n[e];if(e<.5*n.length&&r<=0){t=!1;break}if(e>.5*n.length&&r>0){t=!1;break}}}return t}}static getPeakThreshold(t,e,n){let r,i=t.filter(((t,n)=>{if(e.indexOf(n)>-1)return!0}));return r=0===n?this.mean(i):.5*(n+this.mean(i)),r}static column(t,e){let n=new Array(t.length).fill(0).map((()=>new Array(1).fill(0)));for(let r=0;r<t.length;r++)n[r][0]=t[r][e];return n}static flatten_vector(t){let e=[];for(let n=0;n<t.length;n++)e[n]=t[n][0];return e}static squared_difference(t,e){let n=0;for(let r=0;r<t.length;r++)n+=Math.pow(t[r]-e[r],2);return n}static shift_deflate(t,e,n){let r=Math.sqrt(this.matmul(this.transpose(n),n)),i=this.matscale(n,1/r),s=this.matscale(this.matmul(i,this.transpose(i)),e);return this.matsub(t,s)}static eigenvalue_of_vector(t,e){return ev=this.matmul(this.matmul(this.transpose(e),t),e),ev}static power_iteration(t,e=1e-5,n=1e3){let r=t.length,i=new Array(r).fill(0).map((()=>new Array(1).fill(Math.sqrt(r)))),s=this.eigenvalue_of_vector(t,i),o=1,a=0;for(;o>e&&a<n;){let e=JSON.parse(JSON.stringify(s)),n=this.matmul(t,i);i=this.normalize(n),s=this.eigenvalue_of_vector(t,i),o=Math.abs(s-e),a++}return[s,i]}static eigens(t,e=1e-4,n=1e3){let r=[],i=[];for(let s=0;s<t.length;s++){let o=this.power_iteration(t,e,n),a=o[0],c=o[1];r[s]=a,i[s]=this.flatten_vector(c),t=this.shift_deflate(t,a,c)}return[r,i]}static pca(t,e=1e-5){let n=t.length,r=new Array(n),i=new Array(n),s=this.transpose(t);for(r[0]=this.column(t,0);espilon>e;){i[0]=this.matmul(s,r[0]);let e=this.matmul(this.transpose(r[0]),r[0]);i[0]=this.matscale(i[0],1/e);let n=Math.sqrt(this.matmul(this.transpose(i[0]),i[0]));i[0]=this.matscale(i[0],1/n);let o=this.matmul(t,i[0]),a=this.matmul(this.transpose(i[0]),i[0]);o=this.matscale(o,1/a),this.squared_difference(r[0],o),r[0]=JSON.parse(JSON.stringify(o))}return this.matmul(this.transpose(r[0]),r[0])}static p300(t=[],e=[],n=[],r=256){let i=Math.floor(r/10),s=this.sma(e,i),o=this.peakDetect(s,"peak",i),a=this.mean(s),c=this.std(s,a),u=0,l=[];return o.length>0&&t.forEach(((t,r)=>{for(;n[o[u]]<t+200&&(u++,o[u]););let i=0,h=[];for(;n[o[u+i]]<t+600&&(h.push(u+i),i++,o[u+i]););if(h.length>1){let i=[];h.forEach((t=>{i.push(s[o[t]])}));let u=Math.max(...i),d=h[i.indexOf(u)];l.push({event_timestamp:t,event_index:r,peak_timestamp:n[[o[d]]],signal_index:[o[d]],signal_amplitude:e[[o[d]]],zscore:(s[o[d]]-a)/c})}else 1===h.length&&l.push({event_timestamp:t,event_index:r,peak_timestamp:n[o[h[0]]],signal_index:o[h[0]],signal_amplitude:e[[o[h[0]]]],zscore:(s[o[h[0]]]-a)/c})})),l}}rt(it,"TWO_PI",2*Math.PI),rt(it,"C",299792458),rt(it,"G",66743e-15),rt(it,"h",662607015e-42),rt(it,"R",8314.32),rt(it,"Ra",287),rt(it,"H",69.3),rt(it,"kbar",1054571817e-43),rt(it,"kB",1380649e-29),rt(it,"ke",8987551792.3),rt(it,"me",91093837015e-41),rt(it,"mp",167262192369e-38),rt(it,"mn",167492749804e-38),rt(it,"P0",101325),rt(it,"T0",288.15),rt(it,"p0",1.225),rt(it,"Na",60220978e16),rt(it,"y",1.405),rt(it,"M0",28.96643),rt(it,"g0",9.80665),rt(it,"Re",6378100),rt(it,"B",1458e-9),rt(it,"S",110.4),rt(it,"Sigma",3.65e-10),rt(it,"imgkernels",{edgeDetection:[[-1,-1,-1],[-1,8,-1],[-1,-1,-1]],boxBlur:[[1/9,1/9,1/9],[1/9,1/9,1/9],[1/9,1/9,1/9]],sobelLeft:[[1,0,-1],[2,0,-2],[1,0,-1]],sobelRight:[[-1,0,1],[-2,0,2],[-1,0,1]],sobelTop:[[1,2,1],[0,0,0],[-1,-2,-1]],sobelBottom:[[-1,2,1],[0,0,0],[1,2,1]],identity:[[0,0,0],[0,1,0],[0,0,0]],gaussian3x3:[[1,2,1],[2,4,2],[1,2,1]],guassian7x7:[[0,0,0,5,0,0,0],[0,5,18,32,18,5,0],[0,18,64,100,64,18,0],[5,32,100,100,100,32,5],[0,18,64,100,64,18,0],[0,5,18,32,18,5,0],[0,0,0,5,0,0,0]],emboss:[[-2,-1,0],[-1,1,1],[0,1,2]],sharpen:[[0,-1,0],[-1,5,-1],[0,-1,0]]}),rt(it,"integral",((t=(t=>t),e=[],n=.01)=>{let r=0;for(let i=e[0];i<e[1];i+=n)r+=t(i)*n;return r})),rt(it,"dintegral",((t=((t,e)=>t+e),e=[[],[]],n=.01,r=n)=>{let i=0;for(let s=e[0][0]+n;s<e[0][1];s+=n)for(let o=e[1][0]+r;o<e[1][1];o+=r)i+=t(s,o)*n*r;return i})),rt(it,"tintegral",((t=((t,e,n)=>t+e+n),e=[[],[],[]],n=.01,r=n,i=n)=>{let s=0;for(let o=e[0][0]+n;o<e[0][1];o+=n)for(let a=e[1][0]+r;a<e[1][1];a+=r)for(let c=e[2][0]+i;c<e[2][1];c+=i)s+=t(o,a,c)*n*r*i;return s})),rt(it,"pintegral",((t=(t=>t),e=[],n=.01)=>{let r,i,s=0;for(let o=e[0];o<e[1];o+=n)r=i,i=t(o),r&&(s+=it.distance([0,r],[n,i]));return s})),rt(it,"peakDetect",((t,e="peak",n=49)=>{let r=Math.floor(.5*n),i=[];for(let s=0;s<t.length-n;s++)it.isExtrema(t.slice(s,s+n),e)&&i.push(s+r-1);return i})),Object.freeze({__proto__:null,getCoherenceScore:(t,e="alpha1")=>{let n=[];return Array.isArray(t)||(t=[t]),t.forEach((t=>{if(t.fftCount>0){let r=t.fftCount,i=Math.min(20,r),s=t.means[e].slice(r-i);n.push(it.mean(s))}})),it.mean(n)},getAlphaRatio:t=>t.fftCount>0?t.means.alpha2[t.fftCount-1]/t.means.alpha1[t.fftCount-1]:0,getThetaBetaRatio:t=>t.fftCount>0?t.means.theta[t.fftCount-1]/t.means.beta[t.fftCount-1]:0,getAlphaBetaRatio:t=>t.fftCount>0?.5*(t.means.alpha1[t.fftCount-1]+t.means.alpha2[t.fftCount-1])/t.means.beta[t.fftCount-1]:0,getAlphaThetaRatio:t=>t.fftCount>0?.5*(t.means.alpha1[t.fftCount-1]+t.means.alpha2[t.fftCount-1])/t.means.theta[t.fftCount-1]:0,get40HzGamma:(t,e)=>{if(t.fftCount>0&&Array.isArray(e)){let n=t.slices.lowgamma[t.fftCount-1],r=[];return n.forEach(((t,n)=>{e.lowgamma[0][n]>38&&e.lowgamma[0][n]<42&&r.push(t)})),Math.max(...r)}return 0},getLowGammaScore:t=>{if(t.fftCount>0){let e=t.fftCount,n=20;e<n&&(n=e);let r=t.means.lowgamma.slice(e-n);return t.means.lowgamma[e-1]-it.mean(r)}return 0},getHEGRatioScore:t=>{if(t.count>0){let e=t.count,n=40;e<n&&(n=e);let r=t.ratio.slice(e-n);return t.ratio[e-1]-it.mean(r)}return 0},splitFrequencyBands:function(t=[],e={scp:[.1,1],delta:[1,4],theta:[4,8],alpha1:[8,12],alpha2:[12,16],beta:[16,30],lowgamma:[30,45],highgamma:[45,100]}){let n={};return t.forEach(((t,r)=>{for(const i in e)n[i]||(n[i]=[[],[]]),t>=e[i][0]&&t<=e[i][1]&&(n[i][0].push(t),n[i][1].push(r))})),n},mapFFTData:(t,e,n,r)=>{let i=0;r.fftCount++,r.fftTimes.push(e),r.ffts.push(t);for(const e in n){let s=t.slice(i,i+n[e][1].length);r.slices[e].push(s),r.means[e].push(s.reduce(((t,e)=>t+e))/s.length),i+=n[e][1].length}},mapCoherenceData:(t,e,n,r)=>{t.forEach(((t,i)=>{r[i].fftCount++,r[i].fftTimes.push(e),r[i].ffts.push(data);let s=0;for(const t in n){let e=fft.slice(s,s+n[t][1].length);coord.slices[t].push(e),coord.means[t].push(e.reduce(((t,e)=>t+e))/e.length),s+=n[t][1].length}}))},bandpassWindow:function(t,e,n){let r=(e-t)/n,i=[],s=0;for(;s<e;)i.push(s),s+=r;return i}});class st{constructor(t={},e=!1,n){this.DS=nt,this.collections=new Map,this.data={byTime:{},notes:{},events:{},sleep:{},food:{},hr:{},ppg:{},hrv:{},ecg:{},emg:{},eeg:{},fnirs:{}},this.rolloverLimit=5e4,this.dataSorts=new Map,this.watches={},this.onCollectionSet=(t,e)=>{},this.ontrigger=t=>{},this.threaded=e,n?this.workers=n:"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&(this.threaded=!0),Object.assign(this.data,t),this.dataSorts=new Map,this.watches={},this.setSort("event",(t=>(this.data.events[t.timestamp]?this.data.events[t.timestamp].push(t):this.data.events[t.timestamp]=[t],"sleep"===t.event&&(this.data.sleep[t.timestamp]?this.data.sleep[t.timestamp].push(t):this.data.sleep[t.timestamp]=[t]),t))),this.setSort(["notes","note","link"],(t=>(this.data.notes[t.timestamp]?this.data.notes[t.timestamp].push(t):this.data.notes[t.timestamp]=[t],this.data.byTime[t.timestamp]?this.data.byTime[t.timestamp].push(t):this.data.byTime[t.timestamp]=[t],t))),this.id=this.randomId("dataTablet")}randomId(t=""){return`${t+Math.floor(Math.random()+Math.random()*Math.random()*1e16)}`}setLocalData(t){let e=t=>{let e=t.structType,n=this.collections.get(e);n||(n=new Map,this.collections.set(e,n)),n.set(t._id,t),this.onCollectionSet(e,n)};Array.isArray(t)?t.forEach((t=>{e(t)})):e(t)}getLocalData(t,e){let n="",r="",i="";if("object"==typeof e){n=e.ownerId;const t=Object.keys(e).filter((t=>"ownerId"!=t));r=t[0],i=e[r]}else i=e;if(!(t||n||r||i))return[];let s=[];if(!t&&(n||r))return this.collections.forEach((t=>{if("_id"!==r&&"id"!==r||!i)t.forEach((t=>{r&&i?t[r]===i&&t.ownerId===n&&s.push(t):t.ownerId===n&&s.push(t)}));else{let e=t.get(i);e&&s.push(e)}})),s;{let e=this.collections.get(t);if(!e)return s;if(!r&&!n)return e.forEach((t=>{s.push(t)})),s;if(("_id"===r||"id"===r)&&i)return e.get(i);e.forEach(((t,e)=>{r&&i&&!n?t[r]===i&&s.push(t):n&&!r?t.ownerId===n&&s.push(t):n&&r&&i&&t.ownerId===n&&t[r]&&t[r]===i&&s.push(t)}))}return s}runSort(t,e={},n=[],r=this){let i;if(!1===this.threaded){let s=this.getSort(t);if(!s)return!1;i=s(e,n,r)}else if(!0===this.threaded)return this.workers.runWorkerFunction("runSort",[t,e,n],this.workerId,this.id);return i}setSort(t,e=((t,e=[],n=this)=>{})){if(!1===this.threaded)Array.isArray(t)?t.forEach((t=>{this.dataSorts.set(t,e)})):this.dataSorts.set(t,e);else if(!0===this.threaded)return this.workers.runWorkerFunction("setSort",[t,e.toString()],this.workerId,this.id)}getSort(t){return!1===this.threaded?this.dataSorts.get(t):!0===this.threaded?this.workers.runWorkerFunction("getSort",[t],this.workerId,this.id):void 0}checkWatches(t={}){for(const e in this.watches)this.watches[e].ondata(t,this.watches[e].accum,this.watches[e]),this.watches[e].triggered&&(this.ontrigger(this.watches[e].accum),this.watches[e].triggered=!1)}setWatch(t,e=((t,e,n)=>{}),n=(t=>{})){this.watches[t]={triggered:!1,accum:this.DS.Struct("alert"),ondata:e,ontrigger:n}}getWatch(t){return this.watches[t]}async sortStructsIntoTable(t=[]){t.sort((function(t,e){return t.timestamp-e.timestamp}));let e=[];for(let n=0;n<t.length;n++){let r=t[n];if(!r.timestamp)continue;let i=r.timestamp;if(this.data.byTime[i]?this.data.byTime[i].push(r):this.data.byTime[i]=[r],"dataInstance"===r.structType&&r.data)r.data.forEach((async t=>{if("object"==typeof t&&!Array.isArray(t)){let n=t.dataType;if(t.ownerId=r.ownerId,t.timestamp||(t.timestamp=i),n){let r=this.runSort(n,t,e,this);r?"Promise"!==r.constructor?.name&&(this.checkWatches(r),this.onUpdate(i,r),e.push(r)):(this.data[n]||(this.data[n]={}),t.timestamp=i,this.data[n][i]?this.data[n][i].push(t):this.data[n][i]=[t],this.data.byTime[i]?this.data.byTime[i].push(t):this.data.byTime[i]=[t],this.checkWatches(t),this.onUpdate(i,t),e.push(t))}}}));else{let t=this.runSort(r.structType,r,e,this);if(t)this.checkWatches(t),this.onUpdate(i,t),e.push(t);else{let t=r.structType;this.data[t]||(this.data[t]={}),this.data[t][i]?this.data[t][i].push(r):this.data[t][i]=[r],this.checkWatches(r),this.onUpdate(i,r),e.push(r)}}}for(const t in this.data)this.data[t]=this.sortObjectByPropName(this.data[t]);this.onSorted(e)}onUpdate(t,e,n=this.data){}onSorted(t=[]){}getDataByTimestamp(t,e){if(!0===this.threaded)return this.workers.runWorkerFunction("getDataByTimestamp",[t,e],this.workerId,this.id);let n=this.data.byTime[t];return e&&n&&(n=n.filter((t=>!e||e===t.ownerId))),n}getDataByTimeRange(t,e,n,r){if(!0===this.threaded)return this.workers.runWorkerFunction("getDataByTimeRange",[t,e,n,r],this.workerId,this.id);let i={};if(n){for(const r in this.data[n]){let s=parseInt(r);s>t&&s<e&&(i[r]=[...this.data[n][r]])}"sleep"===n&&(i=this.filterSleepResults(i))}else for(const n in this.data.byTime){let r=parseInt(n);r>t&&r<e&&(i[n]=[...this.data.byTime[n]])}if(r&&i)for(const t in i){let e=[];i[t]=i[t],i[t].forEach(((t,n)=>{t.ownerId!==r&&e.push(n)})),e.reverse().forEach((e=>{i[t].splice(e,1)})),0===i[t].length&&delete i[t]}return i}getDataByType(t,e,n){if(!this.data[t])return;let r={...this.data[t]};if(e&&(r=[...r[e]]),n&&r)for(const t in r){let e=[];r[t]=[...r[t]],r[t].forEach(((t,r)=>{t.ownerId!==n&&e.push(r)})),e.reverse().forEach((e=>{r[t].splice(e,1)})),0===r[t].length&&delete r[t]}return"sleep"===t&&(r=this.filterSleepResults(r)),r}filterSleepResults(t={}){let e=[];for(const n in t)t[n]=[...t[n]],e.push(...t[n].filter((t=>"event"===t.structType)));return e.forEach((e=>{let n;for(const r in t)t[r].forEach(((t,r)=>!("fitbitsleep"!==t.structType||!e.startTime||!e.endTime)&&Math.abs(t.startTime-e.startTime)<432e5&&Math.abs(t.endTime-e.endTime)<432e5&&e.endTime-e.startTime>72e5&&(n=r,!0))),n&&t[r].splice(n,1)})),t}sortObjectByPropName(t){return Object.keys(t).sort().reduce(((e,n)=>(e[n]=t[n],e)),{})}checkRollover(t,e=this.rolloverLimit){if(!t)return!1;let n=this.collections.get(t);return!!n&&(n.forEach((t=>{for(const n in t)Array.isArray(t[n])?t[n].length>e&&(t[n].slice(t[n].length-e),"ffts"===n?t.fftCount=t[n].length:"times"===n&&(t.count=t[n].length)):"object"==typeof t[n]&&this.checkRollover(t[n])})),!0)}}function ot(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}class at{constructor(t=!1,e=!1){ot(this,"addFunc",((t=null,e=null,n=!0)=>{var r=null;return null!==e&&(null==t?this.listeners.forEach(((t,i)=>{r=t.listener.addFunc(e),0==t.listener.running&&1==n&&t.listener.start()})):this.listeners.find(((i,s)=>{i.key===t&&(r=i.listener.addFunc(e),0==i.listener.running&&1==n&&i.listener.start())}))),r})),ot(this,"getFuncs",(t=>{if(t){var e=this.listeners.find(((e,n)=>{if(e.key===t)return!0}));return e.onchangeFuncs}})),ot(this,"removeFuncs",((t=null,e=null,n=!1)=>{null==t?this.listeners.forEach(((t,n)=>{t.listener.removeFuncs(e)})):this.listeners.find(((r,i)=>{r.key===t&&(r.listener.removeFuncs(e),0!==r.listener.onchangeFuncs.length&&!0!==n||r.listener.stop())}))})),this.debug=t,this.listeners=[],this.synchronous=e,this.syncInterval="FRAMERATE",this.syncAnim=void 0,!0===e&&this.startSync()}addListener(t=null,e,n,r,i,s=this.debug,o=!0){if(void 0!==e){var a=t;null==a&&(a=Math.floor(1e5*Math.random())),!0===this.synchronous&&(o=!1);var c={key:a,listener:new ct(e,n,r,i,s,o)};this.listeners.push(c)}else console.error("You must assign an object")}getListener(t){return this.listeners.find(((e,n)=>{if(e.key===t)return!0}))}hasKey(t){var e=!1;return this.listeners.forEach(((n,r)=>{if(n.key===t)return e=!0,!0})),e}getKeyIndices(t){var e=[];return this.listeners.find(((n,r)=>{n.key===t&&e.push(r)})),e}onchange(t=null,e=null){null==t?this.listeners.forEach(((t,n)=>{t.listener.onchange=e})):this.listeners.find(((n,r)=>{n.name===t&&(n.listener.onchange=e)}))}stop(t=null){this.synchronous&&this.stopSync(),null==t?this.listeners.forEach(((t,e)=>{t.listener.stop()})):this.listeners.find(((e,n)=>{e.name===t&&e.listener.stop()}))}start(t=null){this.synchronous&&this.stopSync(),null==t?this.listeners.forEach(((t,e)=>{t.listener.start()})):this.listeners.find(((e,n)=>{e.name===t&&e.listener.start()}))}startSync(){if(!1===this.synchronous){this.synchronous=!0,this.stop();let t=()=>{!0===this.synchronous&&(this.listeners.forEach((t=>{t.listener.check()})),"FRAMERATE"===this.syncInterval?this.syncAnim=requestAnimationFrame(t):"number"==typeof this.syncInterval&&setTimeout(t,this.syncInterval))};t()}}stopSync(){this.synchronous=!1,this.syncAnim&&cancelAnimationFrame(this.syncAnim)}remove(t=null){if(null==t)this.listeners.forEach((t=>{t.listener.stop()})),this.listeners.splice(0,this.listeners.length);else{var e=[];this.listeners.forEach(((n,r)=>{n.key===t&&e.push(r)})),e.reverse().forEach((t=>{this.listeners[t].listener.stop(),this.listeners.splice(t,1)}))}}}class ct{constructor(t,e="__ANY__",n=this.onchange,r="FRAMERATE",i=!1,s=!0){ot(this,"onchange",(t=>{console.log(this.propName," changed from: ",this.propOld," to: ",this.object[this.propName])})),ot(this,"addFunc",((t=null)=>{let e=0;return null!==t&&(this.onchangeFuncs.push({idx:this.funcs,onchange:t}),e=this.funcs,this.funcs++),e})),ot(this,"onchangeMulti",(t=>{[...this.onchangeFuncs].forEach(((e,n)=>{!0===this.debug&&console.log(e.onchange),e.onchange(t)}))})),ot(this,"setListenerRef",(t=>{"__ANY__"===t||null==t?this.propOld=JSON.stringifyFast(this.object):Array.isArray(this.object[t])?this.propOld=JSON.stringifyFast(this.object[t].slice(this.object[t].length-20)):"object"==typeof this.object[t]?this.propOld=JSON.stringifyFast(this.object[t]):"function"==typeof this.object[t]?this.propOld=this.object[t].toString():this.propOld=this.object[t],!0===this.debug&&console.log("propname",t,", new assignment: ",this.propOld)})),ot(this,"check",(()=>{let t=!1;if("__ANY__"===this.propName||null===this.propName||void 0===this.propName)this.propOld!==JSON.stringifyFast(this.object)&&(!0===this.debug&&console.log("onchange: ",this.onchange),this.onchange(this.object),this.onchangeFuncs.length>0&&this.onchangeMulti(this.object),this.setListenerRef(this.propName),t=!0);else if(Array.isArray(this.object[this.propName]))this.propOld!==JSON.stringifyFast(this.object[this.propName].slice(this.object[this.propName].length-20))&&(!0===this.debug&&console.log("onchange: ",this.onchange),this.onchange(this.object[this.propName]),this.onchangeFuncs.length>0&&this.onchangeMulti(this.object[this.propName]),this.setListenerRef(this.propName),t=!0);else if("object"==typeof this.object[this.propName]){let e=JSON.stringifyFast(this.object[this.propName]);this.propOld!==e&&(!0===this.debug&&console.log("onchange: ",this.onchange),this.onchange(this.object[this.propName]),this.onchangeFuncs.length>0&&this.onchangeMulti(this.object[this.propName]),this.setListenerRef(this.propName),t=!0)}else"function"==typeof this.object[this.propName]?this.propOld!==this.object[this.propName].toString()&&(!0===this.debug&&console.log("onchange: ",this.onchange),this.onchange(this.object[this.propName].toString()),this.onchangeFuncs.length>0&&this.onchangeMulti(this.object[this.propName].toString()),this.setListenerRef(this.propName),t=!0):this.object[this.propName]!==this.propOld&&(!0===this.debug&&console.log("onchange: ",this.onchange),this.onchange(this.object[this.propName]),this.onchangeFuncs.length>0&&this.onchangeMulti(this.object[this.propName]),this.setListenerRef(this.propName),t=!0);return!0===this.running&&(!0===this.debug&&console.log("checking",this.object,this.propName),"FRAMERATE"===this.interval?"undefined"==typeof window?setTimeout((()=>{this.check()}),16):this.checker=requestAnimationFrame(this.check):setTimeout((()=>{this.check()}),this.interval)),t})),this.debug=i,this.onchange=n,this.onchangeFuncs=[],this.object=t,this.propName=e,this.propOld=void 0,this.setListenerRef(e),this.running=s,this.funcs=0,this.interval,r<10?(this.interval=10,console.log("Min recommended interval set: 10ms")):this.interval=r,!0===s&&("undefined"==typeof window?setTimeout((()=>{this.check()}),60):this.checker=requestAnimationFrame(this.check))}removeFuncs(t=null){let e=0;null===t?this.onchangeFuncs=[]:void 0!==this.onchangeFuncs.find(((n,r)=>{if(n.idx===t)return e=r,!0}))&&this.onchangeFuncs.splice(e,1)}start(){this.running=!0,"undefined"==typeof window?setTimeout((()=>{this.check()}),16):this.checker=requestAnimationFrame(this.check)}stop(){this.running=!1,cancelAnimationFrame(this.checker)}}void 0===JSON.stringifyFast&&(JSON.stringifyFast=function(){const t=new Map,e=[],n=["this"];function r(r,i){let s;if(null!=i)if("object"==typeof i){let o=i.constructor.name;r&&"Object"===o&&function(t,r){var i=e.length-1;if(e[i]){var s=e[i];if(s[t]===r||0===i)n.push(t),e.push(r.pushed);else for(;i-- >=0;)if((s=e[i])[t]===r){i+=2,e.length=i,n.length=i,--i,e[i]=r,n[i]=t;break}}}(r,i);let a=t.get(i);if(a)return"[Circular Reference]"+a;if(t.set(i,n.join(".")),"Array"===o)s=i.length>20?i.slice(i.length-20):i;else if(o.includes("Set"))s=Array.from(i);else if("Object"!==o&&"Number"!==o&&"String"!==o&&"Boolean"!==o)s="instanceof_"+o;else if("Object"===o){let t={};for(const e in i)if(null==i[e])t[e]=i[e];else if(Array.isArray(i[e]))i[e].length>20?t[e]=i[e].slice(i[e].length-20):t[e]=i[e];else if("Object"===i[e].constructor.name){t[e]={};for(const n in i[e])if(Array.isArray(i[e][n]))i[e][n].length>20?t[e][n]=i[e][n].slice(i[e][n].length-20):t[e][n]=i[e][n];else if(null!=i[e][n]){let r=i[e][n].constructor.name;r.includes("Set")?t[e][n]=Array.from(i[e][n]):t[e][n]="Number"!==r&&"String"!==r&&"Boolean"!==r?"instanceof_"+r:i[e][n]}else t[e][n]=i[e][n]}else{let n=i[e].constructor.name;n.includes("Set")?t[e]=Array.from(i[e]):t[e]="Number"!==n&&"String"!==n&&"Boolean"!==n?"instanceof_"+n:i[e]}s=t}else s=i}else s=i;return s}return function(i,s){try{return e.push(i),JSON.stringify(i,r,s)}catch(t){console.error(i,t)}finally{t.clear(),e.length=0,n.length=1}}}()),void 0===JSON.stringifyWithCircularRefs&&(JSON.stringifyWithCircularRefs=function(){const t=new Map,e=[],n=["this"];function r(r,i){if(null!=i&&"object"==typeof i){r&&function(t,r){var i=e.length-1,s=e[i];if(s[t]===r||0===i)n.push(t),e.push(r);else for(;i-- >=0;)if((s=e[i])[t]===r){i+=2,e.length=i,n.length=i,--i,e[i]=r,n[i]=t;break}}(r,i);let s=t.get(i);if(s)return"[Circular Reference]"+s;t.set(i,n.join("."))}return i}return function(i,s){try{return e.push(i),JSON.stringify(i,r,s)}finally{t.clear(),e.length=0,n.length=1}}}());class ut{constructor(t={},e="FRAMERATE",n=!0){ot(this,"setupSynchronousUpdates",(()=>{if(!this.listener.hasKey("pushToState")){const t=()=>{if(Object.keys(this.pushToState).length>0){Object.assign(this.data,this.pushToState);for(const t of Object.getOwnPropertyNames(this.pushToState))delete this.pushToState[t]}};this.listener.addListener("pushToState",this.pushToState,"__ANY__",t,this.interval),this.addToState("pushRecord",this.pushRecord,(t=>{let e=t.pushed.length;for(let n=0;n<e;n++){let e=t.pushed[n];this.pushCallbacks.state&&this.pushCallbacks.state.onchange(e);for(const t in e)this.pushCallbacks[t]&&this.pushCallbacks[t].forEach((n=>{n.onchange(e[t])}))}this.pushRecord.pushed.splice(0,e)})),this.data.pushCallbacks=this.pushCallbacks}})),ot(this,"addSecondaryKeyResponse",((t=null,e=null,n=!1,r=this.defaultStartListenerEventLoop)=>{if(null!=e){if(this.listener.hasKey(t))return this.listener.addFunc(t,e);if(null!=t&&"state"!==t)return this.listener.addListener(t,this.data,t,(()=>{}),this.data.stateUpdateInterval,n,r),this.listener.addFunc(t,e);if(!this.listener.hasKey("state")){const t=()=>{this.prev=Object.assign({},this.data)};this.listener.addListener("state",this.data,"__ANY__",t,this.interval)}return this.listener.addFunc("state",e)}})),ot(this,"removeState",this.unsubscribeAll),this.data=t,this.interval=e,this.pushToState={},this.pushRecord={pushed:[]},this.pushCallbacks={},this.triggers={},this.prev={},this.listener=new at,this.defaultStartListenerEventLoop=n}subscribe(t,e,n=this.defaultStartListenerEventLoop){if(!t||"state"===t)return this.addSecondaryKeyResponse(t,e,void 0,n);void 0===this.data[t]&&this.addToState(t,null,e,n)}subscribeOnce(t,e=(t=>{})){let n;n=this.subscribe(t,(r=>{e(r),this.unsubscribe(t,n)}))}unsubscribe(t,e=null){null!==e?this.removeSecondaryKeyResponse(t,e,!0):console.error("Specify a subcription function index")}unsubscribeAll(t){this.unsubscribeAllSequential(t),this.unsubscribeAllTriggers(t),this.clearAllKeyResponses(t),this.data[t]&&delete this.data[t],this.listener.hasKey("pushToState")&&this.setSequentialState({stateRemoved:t})}setInterval(t="FRAMERATE"){this.interval=t,this.listener.listeners.forEach(((t,e)=>{t.interval=this.interval}))}updateState(t,e){null==this.data[t]?this.addToState(t,e):this.data[t]=e}addToState(t,e,n=null,r=this.defaultStartListenerEventLoop,i=!1){if(!this.listener.hasKey("pushToState")&&this.defaultStartListenerEventLoop&&this.setupSynchronousUpdates(),this.data[t]=e,this.setSequentialState({stateAdded:t}),null!==n)return this.addSecondaryKeyResponse(t,n,i,r)}get(t){return this.data[t]}getState(){return JSON.parse(JSON.stringifyFast(this.data))}setState(t={},e=!1){if(!this.listener.hasKey("pushToState")&&this.defaultStartListenerEventLoop&&(this.setupSynchronousUpdates(),this.pushRecord.pushed.push(JSON.parse(JSON.stringifyWithCircularRefs(t)))),t.stateUpdateTimeStamp=Date.now(),e)for(const e in t)if(this.pushToState[e])if(Array.isArray(this.pushToState[e])&&Array.isArray(t[e]))t[e]=this.pushToState[e].push(...t[e]);else if("object"==typeof this.pushToState[e]&&"object"==typeof t[e])for(const n in t[e])if(this.pushToState[e][n])if(Array.isArray(this.pushToState[e][n])&&Array.isArray(t[e][n]))t[e][n]=this.pushToState[e][n].push(...t[e][n]);else if("object"==typeof this.pushToState[e][n]&&"object"==typeof t[e][n])for(const r in t[e][n])if(this.pushToState[e][n][r])Array.isArray(this.pushToState[e][n][r])&&Array.isArray(t[e][n][r])&&(t[e][n][r]=this.pushToState[e][n][r].push(...t[e][n][r]));else if("object"==typeof this.pushToState[e][n][r]&&"object"==typeof t[e][n][r])for(const i in t[e][n][r])this.pushToState[e][n][r][i]&&Array.isArray(this.pushToState[e][n][r][i])&&Array.isArray(t[e][n][r][i])&&(t[e][n][r][i]=this.pushToState[e][n][r][i].push(...t[e][n][r][i]));if(Object.assign(this.pushToState,t),Object.keys(this.triggers).length>0){this.triggers.state&&this.triggers.state.onchange(this.data);for(const t of Object.getOwnPropertyNames(this.triggers))this.pushToState[t]&&(this.data[t]=this.pushToState[t],delete this.pushToState[t],this.triggers[t].forEach((e=>{e.onchange(this.data[t])})))}return this.pushToState}subscribeTrigger(t,e=(t=>{})){if(t){this.triggers[t]||(this.triggers[t]=[]);let n=this.triggers[t].length;return this.triggers[t].push({idx:n,onchange:e}),this.triggers[t].length-1}}subscribeTriggerOnce(t,e=(t=>{})){let n;n=this.subscribeTrigger(t,(r=>{e(r),this.unsubscribeTrigger(t,n)}))}unsubscribeTrigger(t,e=0){let n,r=this.triggers[t];if(r){let t=r.find((t=>{if(t.idx===e)return!0}));t&&r.splice(n,1)}}unsubscribeAllTriggers(t){t&&this.triggers[t]&&delete this.triggers[t]}setSequentialState(t={}){this.listener.hasKey("pushToState")||this.setupSynchronousUpdates(),t.stateUpdateTimeStamp=Date.now(),this.pushRecord.pushed.push(JSON.parse(JSON.stringify(t)))}subscribeSequential(t,e){if(t){if(void 0===this.data[t]&&"state"!==t&&this.addToState(t,null,void 0),this.pushCallbacks[t]||(this.pushCallbacks[t]=[]),e){let n=this.pushCallbacks[t].length;return this.pushCallbacks[t].push({idx:n,onchange:e}),this.pushCallbacks[t].length-1}}else;}subscribeSequentialOnce(t,e=(t=>{})){let n;n=this.subscribeSequential(t,(r=>{e(r),this.unsubscribeSequential(t,n)}))}unsubscribeSequential(t,e=0){t&&this.pushCallbacks[t]&&this.pushCallbacks[t].find(((n,r)=>{if(n.idx===e)return this.pushCallbacks[t].splice(r,1),!0}))}unsubscribeAllSequential(t){t&&this.pushCallbacks[t]&&this.pushCallbacks[t]&&delete this.pushCallbacks[t]}setPrimaryKeyResponse(t=null,e=null,n=!1,r=this.defaultStartListenerEventLoop){if(null!==e)if(this.listener.hasKey(t))this.listener.onchange(t,e);else{if(null==t||"state"===t){if(!this.listener.hasKey("state")){const t=()=>{this.prev=Object.assign({},this.data)};this.listener.addListener("state",this.data,"__ANY__",t,this.interval)}return this.listener.addFunc("state",e)}this.listener.addListener(t,this.data,t,e,this.data.stateUpdateInterval,n,r)}}removeSecondaryKeyResponse(t=null,e=null,n=!0){null!==t?this.listener.hasKey(t)?this.listener.removeFuncs(t,e,n):console.error("key does not exist"):console.error("provide key")}clearAllKeyResponses(t=null){null===t?this.listener.remove(null):this.listener.hasKey(t)&&this.listener.remove(t)}getKeySubCallbacks(t){return this.listener.getFuncs(t)}runSynchronousListeners(){this.defaultStartListenerEventLoop=!1,this.listener.startSync()}stop(t=null){this.listener.stop(t)}}function lt(t,e){void 0===e&&(e=!0);var n=(t=t.replace(/\/\*\*?/,"")).split("/");e&&(n=n.slice(0,n.length-1));var r=[t];return r.push(t+"/*"),r.push(t+"/**"),n.forEach((function(e,i){var s=n.slice(0,i+1).join("/");s!=t&&(i===n.length-1&&r.push(s+"/*"),r.push(s+"/**"))})),r}void 0===JSON.stringifyFast&&(JSON.stringifyFast=function(){const t=new Map,e=[],n=["this"];function r(r,i){let s;if(null!=i)if("object"==typeof i){let o=i.constructor.name;r&&"Object"===o&&function(t,r){var i=e.length-1;if(e[i]){var s=e[i];if(s[t]===r||0===i)n.push(t),e.push(r.pushed);else for(;i-- >=0;)if((s=e[i])[t]===r){i+=2,e.length=i,n.length=i,--i,e[i]=r,n[i]=t;break}}}(r,i);let a=t.get(i);if(a)return"[Circular Reference]"+a;if(t.set(i,n.join(".")),"Array"===o)s=i.length>20?i.slice(i.length-20):i;else if(o.includes("Set"))s=Array.from(i);else if("Object"!==o&&"Number"!==o&&"String"!==o&&"Boolean"!==o)s="instanceof_"+o;else if("Object"===o){let t={};for(const e in i)if(null==i[e])t[e]=i[e];else if(Array.isArray(i[e]))i[e].length>20?t[e]=i[e].slice(i[e].length-20):t[e]=i[e];else if("Object"===i[e].constructor.name){t[e]={};for(const n in i[e])if(Array.isArray(i[e][n]))i[e][n].length>20?t[e][n]=i[e][n].slice(i[e][n].length-20):t[e][n]=i[e][n];else if(null!=i[e][n]){let r=i[e][n].constructor.name;r.includes("Set")?t[e][n]=Array.from(i[e][n]):t[e][n]="Number"!==r&&"String"!==r&&"Boolean"!==r?"instanceof_"+r:i[e][n]}else t[e][n]=i[e][n]}else{let n=i[e].constructor.name;n.includes("Set")?t[e]=Array.from(i[e]):t[e]="Number"!==n&&"String"!==n&&"Boolean"!==n?"instanceof_"+n:i[e]}s=t}else s=i}else s=i;return s}return function(i,s){try{return e.push(i),JSON.stringify(i,r,s)}catch(t){console.error(i,t)}finally{t.clear(),e.length=0,n.length=1}}}()),void 0===JSON.stringifyWithCircularRefs&&(JSON.stringifyWithCircularRefs=function(){const t=new Map,e=[],n=["this"];function r(r,i){if(null!=i&&"object"==typeof i){r&&function(t,r){var i=e.length-1,s=e[i];if(s[t]===r||0===i)n.push(t),e.push(r);else for(;i-- >=0;)if((s=e[i])[t]===r){i+=2,e.length=i,n.length=i,--i,e[i]=r,n[i]=t;break}}(r,i);let s=t.get(i);if(s)return"[Circular Reference]"+s;t.set(i,n.join("."))}return i}return function(i,s){try{return e.push(i),JSON.stringify(i,r,s)}finally{t.clear(),e.length=0,n.length=1}}}());var ht=function(t,e){for(var n in void 0===e&&(e=!0),t instanceof Object&&(t=Array.isArray(t)?l([],u(t),!1):Object.assign({},t)),t)t[n]instanceof Function&&(t[n]=t[n].toString()),t[n]instanceof Object&&(t[n]=ht(t[n],!1));return e?JSON.stringify(t):t},dt=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,ft=/([^\s,]+)/g;try{if("object"==typeof process){var pt=require("node-fetch");"function"!=typeof globalThis.fetch&&(globalThis.fetch=pt)}}catch(t){}var vt=function(t,e,n){var r,i,s=this;void 0===t&&(t="https://localhost"),this.id=null,this.target=null,this.type=null,this.link=null,this.credentials={},this.connection=null,this.services={available:{},connecting:{},queue:{}},this.router=null,this.clients={},this.user=d(),this.status=!1,this.responses={},this.setCredentials=function(t){var e;t&&(t._id||t.id)&&(s.credentials={_id:null!==(e=t._id)&&void 0!==e?e:d(),id:t.id||t._id})},this.check=function(){return a(s,void 0,void 0,(function(){var t,e,n,r,i,s,o,u,l,h,d,f,p,v,g=this;return c(this,(function(b){switch(b.label){case 0:return"webrtc"!==this.type?[3,2]:[4,this._subscribe({protocol:"webrtc",force:!0}).then((function(t){g.status=!0})).catch((function(t){return console.log("Link doesn't have WebRTC enabled.",t)}))];case 1:b.sent(),b.label=2;case 2:return t=function(){return a(g,void 0,void 0,(function(){var t=this;return c(this,(function(e){switch(e.label){case 0:return[4,this._subscribe({protocol:"websocket",force:!0}).then((function(e){return t.status=!0,e}))];case 1:return e.sent(),[4,this.send("services")];case 2:return[2,e.sent()]}}))}))},e=function(){return a(g,void 0,void 0,(function(){return c(this,(function(t){switch(t.label){case 0:return[4,this.send("services")];case 1:return[2,t.sent()]}}))}))},"websocket"!==this.type?[3,4]:[4,t().then((function(t){return g.status=!0,t})).catch((function(t){return a(g,void 0,void 0,(function(){return c(this,(function(t){switch(t.label){case 0:return"websocket"!==this.type?[3,2]:(console.log("Falling back to http"),[4,e()]);case 1:return[2,t.sent()];case 2:return[2]}}))}))}))];case 3:return b.sent(),[3,6];case 4:return[4,e().then((function(t){return g.status=!0,t})).catch((function(e){return a(g,void 0,void 0,(function(){return c(this,(function(e){switch(e.label){case 0:return console.log("Falling back to websockets"),[4,t()];case 1:return[2,e.sent()]}}))}))}))];case 5:n=b.sent(),b.label=6;case 6:if(n){for(s in console.log("Connection successful!"),r=n.message[0],i=[],r)o=r[s],u=o.replace(/Backend|Service/,"").toLowerCase(),this.services.available[u]=s,i.push(u),(null===(d=null===(h=null===(l=this.router)||void 0===l?void 0:l.SERVICES)||void 0===h?void 0:h[u])||void 0===d?void 0:d.status)instanceof Function&&this.router.SERVICES[u].status(s),"subscription"===(null===(f=this.clients[u])||void 0===f?void 0:f.serviceType)&&(null===(p=this.services.queue[u])||void 0===p||p.forEach((function(t){return t()})),this.services.queue[u]=[]);null===(v=this.services.queue[void 0])||void 0===v||v.forEach((function(t){return t()})),this.services.queue[void 0]=[]}else console.log("Connection failed!");return[2,null==n?void 0:n.message]}}))}))},this.send=function(t,e,n){return void 0===e&&(e={}),void 0===n&&(n=function(){}),a(s,void 0,void 0,(function(){var r,i,s,o,u,l,h,d,f,p,v,g,b,m=this;return c(this,(function(y){switch(y.label){case 0:return"string"==typeof t?e.route=t:(r=this.services[t.service],e.route=r?"".concat(r,"/").concat(t.route):t.route),e.suppress=!!this.connection,s={suppress:e.suppress,id:null===(l=this.link.connection)||void 0===l?void 0:l.id},"websocket"!==(null===(h=this.connection)||void 0===h?void 0:h.protocol)?[3,2]:(e.id=null===(d=this.link.credentials)||void 0===d?void 0:d.id,[4,this.link.connection.service.send(e,s)]);case 1:return i=y.sent(),[3,9];case 2:return"webrtc"!==(null===(f=null==this?void 0:this.connection)||void 0===f?void 0:f.protocol)?[3,4]:(e.id=(null===(p=this.credentials)||void 0===p?void 0:p.id)||(null===(v=this.link.credentials)||void 0===v?void 0:v.id),[4,this.connection.service.send(e,s)]);case 3:return i=y.sent(),[3,9];case 4:return e.id=null===(g=this.link.credentials)||void 0===g?void 0:g.id,e.method||(e.method=(null===(b=e.message)||void 0===b?void 0:b.length)>0?"POST":"GET"),"GET"!=(o={method:e.method.toUpperCase(),mode:"cors",headers:{"Content-Type":"application/json"}}).method&&(o.body=ht(e)),[4,fetch((S=e.route,w=this.link.target,_=w instanceof URL?w:new URL(w),S="/"===_.pathname?S:_.pathname+S,new URL(S,_.href).href),o).then((function(t){return a(m,void 0,void 0,(function(){var e,r,i,s;return c(this,(function(o){return e=t.body.getReader(),r=t.headers.get("Content-Length"),i=0,globalThis.ReadableStream?(s=new ReadableStream({start:function(t){var s=this,o=function(){return a(s,void 0,void 0,(function(){return c(this,(function(s){return e.read().then((function(e){var s=e.value;e.done?t.close():(i+=s.length,n(i/r,r),t.enqueue(s),o())})),[2]}))}))};o()}}),[2,new Response(s,{headers:t.headers})]):[2,t]}))}))}))];case 5:return(i=y.sent())?[4,i.json().then((function(t){if(i.ok)return t;throw t.message})).catch((function(t){return a(m,void 0,void 0,(function(){return c(this,(function(t){throw"Invalid JSON"}))}))}))]:[3,7];case 6:return u=y.sent(),[3,8];case 7:u=i,y.label=8;case 8:i=u,y.label=9;case 9:return i&&!(null==i?void 0:i.route)&&(i.route=e.route,i.block=!0),[2,i]}var S,w,_}))}))},this._subscribe=function(t){return void 0===t&&(t={}),a(s,void 0,void 0,(function(){var e,n=this;return c(this,(function(r){switch(r.label){case 0:return e=function(){return new Promise((function(r){return a(n,void 0,void 0,(function(){var n,i,s=this;return c(this,(function(o){return((n=null!==(i=t.protocol)&&void 0!==i?i:this.type)?[this.clients[n]]:Object.values(this.clients)).forEach((function(e){return a(s,void 0,void 0,(function(){var n,i,s,o,a=this;return c(this,(function(c){switch(c.label){case 0:return e&&t.force||!0===(null==e?void 0:e.status)&&"subscription"===(null==e?void 0:e.serviceType)?(n="".concat(null!==(o=this.link.services.available[null==e?void 0:e.service])&&void 0!==o?o:e.name.toLowerCase(),"/subscribe"),e.setEndpoint(this.link),this.connection?[3,2]:(i="http"===this.type||"websocket"===this.type?new URL(n,this.target):this.target,[4,e.add(this.credentials,i.href)])):[3,4];case 1:s=c.sent(),this.router&&e.addResponse("router",(function(t){var e="string"==typeof t?JSON.parse(t):t;Object.values(a.responses).forEach((function(t){t(e)})),a.router&&a.router.handleLocalRoute(e)})),this.connection={service:e,id:s,protocol:e.name},c.label=2;case 2:return"webrtc"===this.type&&(t.routes=[this.target]),[4,this.link.send(n,Object.assign({route:t.route,message:t.message,protocol:t.protocol},{message:[t.routes,this.connection.id]}))];case 3:return c.sent(),r(this.connection),[2];case 4:return[2]}}))}))})),this.services.queue[n]||(this.services.queue[n]=[]),this.services.queue[n].push((function(){return a(s,void 0,void 0,(function(){var t;return c(this,(function(n){switch(n.label){case 0:return[4,e()];case 1:return t=n.sent(),r(t),[2]}}))}))})),[2]}))}))}))},[4,e()];case 1:return[2,r.sent()]}}))}))},this.subscribe=function(t){if(t){var e=h("response");return s.responses[e]=t,e}},this.unsubscribe=function(t){t?delete s.responses[t]:s.responses={}},"object"==typeof t?t instanceof URL?r=t:(r=t.target,i=t.type,this.link=t.link,this.setCredentials(t.credentials)):r=t,i||(i="http"),this.link||(this.link=this),"http"===i||"websocket"===i?(r=r instanceof URL?r:new URL(r),this.id=r.origin):this.id=r,this.target=r,this.type=i,this.router=n,e&&(this.clients=e)},gt=function(){function t(t){var e=this;void 0===t&&(t={debug:!1}),this.id=h(),this.USERS={},this.CONNECTIONS=new Map,this.SUBSCRIPTIONS=[],this.ENDPOINTS={},this.SERVICES={},this.ROUTES={},this.INTERVAL=10,this.DEFAULTROUTES=[{route:"ping",post:function(){return"pong"}},{route:"services/**",get:{object:this.SERVICES,transform:function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];var r={},i=e.length>0?[e[0]]:Object.keys(t);return i.forEach((function(e){var n=t[e];"default"===(null==n?void 0:n.serviceType)&&(r[e]=n.name)})),e.forEach((function(t,e){return r=r[t]})),r}}},{route:"/",aliases:["routes/**"],get:{object:this.ROUTES,transform:function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];var r={},i=e.length>0?[e[0]]:Object.keys(t);return i.forEach((function(e){e&&(r[e]={route:t[e].route.split("/").filter((function(t){return!t.match(/\*\*?/)})).join("/"),args:t[e].args,wildcard:e.includes("*")})})),e.forEach((function(t,e){return r=r[t]})),r}}},{route:"sendMessage",aliases:["message","sendMsg"],post:function(t,e){return t.sendMsg(e[0],e[1],e[2])}},{route:"setUserServerDetails",post:function(t,e,n){var r=t.USERS[n];if(!r)return!1;e[0]&&(r.username=e[0]),e[1]&&(r.password=e[1]),e[2]&&(r.props=e[2]),e[3]&&(r._id=e[3],r.id=e[3])}},{route:"setProps",post:function(t,e,n){var r=t.USERS[n];if(!r)return!1;if("object"==typeof e&&!Array.isArray(e))return Object.assign(r.props,e),!0;if(Array.isArray(e)&&"object"==typeof e[1]){var i=t.USERS[e[0]];return i&&Object.assign(i.props,e[1]),!0}return!1}},{route:"getProps",post:function(t,e,n){var r=t.USERS[n];if(!r)return!1;if(!e[0])return r.props;var i=t.USERS[e[0]];return i?i.props:void 0}},{route:"blockUser",post:function(t,n,r){var i=t.USERS[r];return!!i&&e.blockUser(i,n[0])}},{route:"users/**",get:{object:this.USERS,transform:function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];var r={},i=e.length>0?[e[0]]:Object.keys(t);return i.forEach((function(e){var n=t[e];r[e]={_id:n._id,username:n.username,origin:n.origin,props:n.props,updatedPropNames:n.updatedPropNames,lastUpdate:n.lastUpdate,lastTransmit:n.lastTransmit,latency:n.latency}})),e.forEach((function(t,e){return r=r[t]})),r}}},{route:"getUser",post:function(t,n,r){var i=t.USERS[r];if(!i)return!1;if(!n[0])return{_id:i._id,username:i.username,origin:i.origin,props:i.props,updatedPropNames:i.updatedPropNames,lastUpdate:i.lastUpdate,lastTransmit:i.lastTransmit,latency:i.latency};var s=e.USERS[n[0]];return s?{_id:s._id,username:s.username,origin:s.origin,props:s.props,updatedPropNames:s.updatedPropNames,lastUpdate:s.lastUpdate,lastTransmit:s.lastTransmit,latency:s.latency}:void 0}},{route:"login",aliases:["addUser","startSession"],post:function(t,n,r){return a(e,void 0,void 0,(function(){var e;return c(this,(function(r){switch(r.label){case 0:return[4,t.addUser.apply(t,l([],u(n),!1))];case 1:return[2,{message:!!(e=r.sent()),id:e.id}]}}))}))}},{route:"logout",aliases:["removeUser","endSession"],post:function(t,e,n){var r=t.USERS[n];if(!r)return!1;e[0]?t.removeUser.apply(t,l([],u(e),!1)):t.removeUser(r)}}],this.protocols={},this.connect=function(t,n){var r=new vt(t,e.SERVICES,e);return e.ENDPOINTS[r.id]=r,r.check().then((function(t){t&&(n&&n(r),e.login(r))})),r},this.disconnect=function(t){return a(e,void 0,void 0,(function(){return c(this,(function(e){return this.logout(this.ENDPOINTS[t]),delete this.ENDPOINTS[t],[2]}))}))},this._loadBackend=function(t,n){var r;void 0===n&&(n=t.name),e.SERVICES[n]=t,e.SERVICES[n].status=!0,null===(r=t.routes)||void 0===r||r.forEach((function(t){return e.addRoute(Object.assign({service:n},t))})),t.subscribe&&t.subscribe((function(n,r,i){return a(e,void 0,void 0,(function(){var e;return c(this,(function(s){switch(s.label){case 0:return[4,this.handleMessage(n,r)];case 1:if(e=s.sent(),null==i?void 0:i.includes("worker")){if(null===e||!t[i])return[2,e];t[i].postMessage({route:"worker/workerPost",message:e,origin:t.id,callbackId:n.callbackId})}return[2,e]}}))}))})),"subscription"===(null==t?void 0:t.serviceType)&&e.SUBSCRIPTIONS.push(t.updateSubscribers)},this._loadService=function(t,n){return void 0===n&&(n=null==t?void 0:t.name),a(e,void 0,void 0,(function(){return c(this,(function(e){switch(e.label){case 0:return this._loadBackend(t,n),[4,this._loadClient(t,n,!0)];case 1:return[2,e.sent()]}}))}))},this._loadClient=function(t,n,r){return void 0===r&&(r=!1),new Promise((function(n){var i=t.name;if(t.subscribe&&t.subscribe((function(n,r){return a(e,void 0,void 0,(function(){var e,s,o,a;return c(this,(function(c){switch(c.label){case 0:return e=this.SERVICES[i],s=!0===e.status,"local"!==r?[3,2]:[4,this.handleLocalRoute(n)];case 1:return o=c.sent(),[3,4];case 2:return s?[4,this.send.apply(this,l([{route:"".concat(e.route,"/").concat(n.route),endpoint:null==t?void 0:t.endpoint}],u(null!==(a=n.message)&&void 0!==a?a:[]),!1))]:[3,4];case 3:o=c.sent(),c.label=4;case 4:return[2,o]}}))}))})),r)n(t);else{e.SERVICES[i]=t;var s=function(r){e.SERVICES[i].status=!0,t.setEndpointRoute instanceof Function&&t.setEndpointRoute(r),t.routes.forEach((function(t){e.ROUTES["".concat(r,"/").concat(t.route)]=t})),n(t)};!0===e.SERVICES[i].status?s(e.SERVICES[i]):e.SERVICES[i].status=s}}))},this.get=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];return e._send.apply(e,l([t,"GET"],u(n),!1))},this.delete=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];return e._send.apply(e,l([t,"DELETE"],u(n),!1))},this.post=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];return e._send.apply(e,l([t,"POST"],u(n),!1))},this.send=this.post,this._send=function(t,n){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return a(e,void 0,void 0,(function(){var e,i;return c(this,(function(s){switch(s.label){case 0:return(e="string"==typeof t||null==(null==t?void 0:t.endpoint)?Object.values(this.ENDPOINTS)[0]:t.endpoint)?[4,e.send(t,{message:r,method:n})]:[2];case 1:return(i=s.sent())&&this.handleLocalRoute(i,e),[2,null==i?void 0:i.message]}}))}))},this.handleLocalRoute=function(t,n,r){return a(e,void 0,void 0,(function(){var e,i,s,o;return c(this,(function(a){return n&&r&&!t.suppress&&n.connection&&(null===(o=null===(s=null===(i=n.connection)||void 0===i?void 0:i.service)||void 0===s?void 0:s.responses)||void 0===o||o.forEach((function(e){return e(Object.assign({route:r},t))}))),!t.block&&(null==(e=this.ROUTES[null==t?void 0:t.route])?void 0:e.post)instanceof Function?[2,e.post(this,t.message,t.id)]:[2]}))}))},this.subscribe=function(t,n){return void 0===n&&(n={}),a(e,void 0,void 0,(function(){return c(this,(function(e){switch(e.label){case 0:return Object.keys(this.ENDPOINTS).length>0||(null==n?void 0:n.endpoint)?(n.endpoint||(n.endpoint=Object.values(this.ENDPOINTS)[0]),[4,n.endpoint._subscribe(n).then((function(e){return n.endpoint.subscribe(t)}))]):[3,2];case 1:return[2,e.sent()];case 2:throw"Remote is not specified"}}))}))},this.handleMessage=function(t,n){return a(e,void 0,void 0,(function(){var e,n,r,i,s;return c(this,(function(o){switch(o.label){case 0:return e={},Array.isArray(t)?(e.route=t[0],e.message=t.slice(1),e.callbackId=void 0):"string"==typeof t?(n=t.split(" "),e.route=n[0],e.message=n.slice(1),e.callbackId=void 0):"object"==typeof t&&Object.assign(e,t),"object"!=typeof e||Array.isArray(e)?[3,2]:null==e.route?[3,2]:(r=this.USERS[null==e?void 0:e.id],console.log("runRoute",e.route),[4,this.runRoute(e.route,e.method,e.message,null!==(s=null==r?void 0:r.id)&&void 0!==s?s:e.id,e.callbackId)]);case 1:return(i=o.sent())&&e.suppress&&(i.suppress=e.suppress),[2,i];case 2:return[2,null]}}))}))},t.interval&&(this.INTERVAL=t.interval),this.STATE=new ut({},this.INTERVAL,void 0),this.DEBUG=null==t?void 0:t.debug,"onbeforeunload"in globalThis&&(globalThis.onbeforeunload=function(){Object.values(e.ENDPOINTS).forEach((function(t){"webrtc"!=t.type&&e.logout(t)}))}),this.load({routes:this.DEFAULTROUTES}),this.DEBUG&&this.runCallback("routes",[!0]),(null==t?void 0:t.endpoints)&&t.endpoints.forEach((function(t){return e.connect(t)}))}return t.prototype.login=function(t,e){return a(this,void 0,void 0,(function(){var n,r=this;return c(this,(function(i){switch(i.label){case 0:return[4,this.logout(t)];case 1:return i.sent(),n=Object.values(t?{endpoint:t}:this.ENDPOINTS),[4,Promise.all(n.map((function(t){return a(r,void 0,void 0,(function(){return c(this,(function(n){switch(n.label){case 0:return e&&t.setCredentials(e),[4,this.send({route:"login",endpoint:t},t.credentials)];case 1:return[2,n.sent()]}}))}))})))];case 2:return[2,1===i.sent().reduce((function(t,e){return t*e[0]}),!0)]}}))}))},t.prototype.logout=function(t){return a(this,void 0,void 0,(function(){var e=this;return c(this,(function(n){switch(n.label){case 0:return[4,Promise.all(Object.values(t?{endpoint:t}:this.ENDPOINTS).map((function(t){return a(e,void 0,void 0,(function(){return c(this,(function(e){switch(e.label){case 0:return[4,this.send({route:"logout",endpoint:t},t.credentials)];case 1:return[2,e.sent()]}}))}))})))];case 1:return[2,1===n.sent().reduce((function(t,e){return t*e[0]}),!0)]}}))}))},t.prototype.load=function(t,e){return void 0===e&&(e=t.name),a(this,void 0,void 0,(function(){var n,r,i;return c(this,(function(s){switch(s.label){case 0:return n="client"===t.constructor.type,r=!t.constructor.type||"service"===t.constructor.type,i="backend"===t.constructor.type,r?[4,this._loadService(t,e)]:[3,2];case 1:s.sent(),s.label=2;case 2:return i?[4,this._loadBackend(t,e)]:[3,4];case 3:s.sent(),s.label=4;case 4:return n?[4,this._loadClient(t)]:[3,6];case 5:s.sent(),s.label=6;case 6:return[2,t]}}))}))},t.prototype.format=function(t,e){return void 0===e&&(e={}),void 0!==t&&(t&&"object"==typeof t&&("message"in t||"route"in t)||(t={message:t}),Array.isArray(t.message)||(t.message=[t.message]),e.service&&(null==t?void 0:t.route)&&(t.route="".concat(e.service,"/").concat(t.route)),e.headers&&(t.headers=e.headers)),(null==t?void 0:t.route)&&(t.route=t.route.replace(/\/\*\*?/,"")),t},t.prototype.runRoute=function(t,e,n,r,i){return void 0===n&&(n=[]),a(this,void 0,void 0,(function(){var s=this;return c(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),null==t?[2]:(!e&&Array.isArray(n)&&(e=n.length>0?"POST":"GET"),this.DEBUG&&console.log("route",t),[4,this.runCallback(t,n,r,e).then((function(t){if(s.DEBUG&&console.log("Result:",t),void 0!==t&&((t=s.format(t)).callbackId=i,s.ROUTES[t.route]&&(t.block=!0),"DONOTSEND"!==t.message))return t})).catch(console.error)]);case 1:return[2,o.sent()];case 2:return o.sent(),[2,new Error("Route failed...")];case 3:return[2]}}))}))},t.prototype.addUser=function(t){var e=this;if(t&&(t.id||t._id)){t._id||(t._id=d()),t.id||(t.id=t._id);var n=this.USERS[t.id],r=null!=n?n:{id:t.id,_id:t._id,username:t.id,origin:t.id,props:{},updatedPropNames:[],sessions:[],blocked:[],lastUpdate:Date.now(),lastTransmit:0,latency:0,routes:new Map};for(var i in Object.assign(r,t),this.DEBUG&&console.log("Adding User, Id:",t._id),this.USERS[t.id]=r,this.SERVICES){var s=this.SERVICES[i];if(!0===s.status)lt(s.name+"/users").forEach((function(n){e.ROUTES[n]&&e.runRoute(n,"POST",[r],t.id)}))}return r}return!1},t.prototype.removeUser=function(t){var e=this,n="string"==typeof t?this.USERS[t]:t;return!!n&&(Object.values(this.SERVICES).forEach((function(t){if(!0===t.status){var r=t.name+"/users";e.ROUTES[r]&&e.runRoute(r,"DELETE",[n],n.id)}})),delete n.id,!0)},t.prototype.blockUser=function(t,e){return void 0===e&&(e=""),!(!this.USERS[e]||t.blocked.includes(e)||t.id===e)&&(t.blocked.push(e),!0)},t.prototype.sendMsg=function(t,e,n){void 0===t&&(t=""),void 0===e&&(e=""),void 0===n&&(n=void 0);var r=n?Object.assign(n,{message:e}):{message:e};if("string"==typeof t){var i=this.USERS[t];i&&i.send(r)}else if("object"==typeof t)return t.send(r),!0;return!1},t.prototype.addRoute=function(t){var e=this,n=l([(t=Object.assign({},t)).route],u(t.aliases?t.aliases:[]),!1);return delete t.aliases,n.forEach((function(n){var r,i,s;if(!n||!t.post&&!t.get)return!1;n=t.route="".concat(t.service?"".concat(t.service,"/"):"")+n,e.removeRoute(n),"/"===n[0]&&(n=n.slice(1)),t.args=function(t){if(t instanceof Function){var e=t.toString().replace(dt,""),n=e.slice(e.indexOf("(")+1,e.indexOf(")")).match(ft);return null===n&&(n=[]),n}}(t.post),e.ROUTES[n]=Object.assign(t,{route:n}),t.get&&(e.STATE.setState(((r={})[n]=null!==(s=null===(i=t.get)||void 0===i?void 0:i.object)&&void 0!==s?s:t.get,r)),e.STATE.subscribe(n,(function(r){var i,s,o=(null===(s=t.get)||void 0===s?void 0:s.transform)?(i=t.get).transform.apply(i,l([r],[],!1)):r;e.SUBSCRIPTIONS.forEach((function(t){return t(e,{route:n,message:o})}))})))})),!0},t.prototype.removeRoute=function(t){return delete this.ROUTES[t]},t.prototype.runCallback=function(t,e,n,r){var i=this;return void 0===e&&(e=[]),void 0===r&&(r=e.length>0?"POST":"GET"),new Promise((function(s){return a(i,void 0,void 0,(function(){var i,o,h=this;return c(this,(function(d){return i=lt(t),o={route:t,block:!0,message:{html:'<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="utf-8">\n<title>Error</title>\n</head>\n<body>\n<pre>404 Not Found</pre>\n</body>\n</html>'},headers:{"Content-Type":"text/html"}},Promise.all(i.map((function(i){return a(h,void 0,void 0,(function(){var a,h,d,f,p,v,g,b,m;return c(this,(function(c){switch(c.label){case 0:if(!(a=this.ROUTES[i]))return[3,14];this.DEBUG&&console.log("routeInfo",a),c.label=1;case 1:return c.trys.push([1,13,,14]),h=void 0,(null==a?void 0:a.delete)&&"DELETE"===r.toUpperCase()?[4,a.delete(this,e,n)]:[3,3];case 2:return h=c.sent(),[3,12];case 3:return"GET"!==r.toUpperCase()&&(null==a?void 0:a.post)?[3,9]:(d=this.STATE.data[a.route])?(f=t.replace(a.route.split("/").filter((function(t){return"*"!=t&&"**"!=t})).join("/"),"").split("/").filter((function(t){return!!t})),g={},(null===(m=a.get)||void 0===m?void 0:m.transform)?[4,(b=a.get).transform.apply(b,l([d],u(f),!1))]:[3,5]):[3,7];case 4:return p=c.sent(),[3,6];case 5:p=d,c.label=6;case 6:return g.message=p,h=g,[3,8];case 7:h=o,c.label=8;case 8:return[3,12];case 9:return(null==a?void 0:a.post)?[4,null==a?void 0:a.post(this,e,n)]:[3,11];case 10:return h=c.sent(),[3,12];case 11:h=o,c.label=12;case 12:return s(this.format(h,a)),[3,14];case 13:return v=c.sent(),console.log("Callback Failed: ",v),[3,14];case 14:return[2]}}))}))}))).then((function(t){return s(o)})),[2]}))}))}))},t.prototype.checkRoutes=function(t){var e,n;return a(this,void 0,void 0,(function(){var r;return c(this,(function(i){switch(i.label){case 0:return t.data?((r=null!==(n=null!==(e=this.ROUTES[t.data.foo])&&void 0!==e?e:this.ROUTES[t.data.route])&&void 0!==n?n:this.ROUTES[t.data.functionName])||(r=this.ROUTES[t.data.foo]),r?t.data.message?[4,r.post(this,t.data.message,t.data.origin)]:[3,2]:[3,4]):[2];case 1:return[2,i.sent()];case 2:case 5:return[2];case 3:return[3,5];case 4:return[2,!1]}}))}))},t}(),bt=function(t){return"string"==typeof t&&24===t.length?I(t):t},mt=["user","group","authorization","discussion","chatroom","comment","dataInstance","event","notification","schedule","date"],yt=function(t){function a(e,n,s){void 0===n&&(n={});var o=t.call(this,e)||this;return o.name="structs",o.collections={},o.wipeDB=function(){return r(o,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,Promise.all(Object.values(this.collections).map((function(t){return t.instance.deleteMany({})})))];case 1:return t.sent(),[2,!0]}}))}))},o.db=null==n?void 0:n.db,o.mode=o.db&&n.mode?n.mode:"local",n.collections||(n.collections={}),mt.forEach((function(t){n.collections[t]||(n.collections[t]=o.db?{instance:o.db.collection(t)}:{},n.collections[t].reference={})})),o.collections=n.collections,o.routes=[{route:"getUser",post:function(t,e,n){return r(o,void 0,void 0,(function(){var r,s,o,a,c;return i(this,(function(i){switch(i.label){case 0:return(r=t.USERS[n])?"mongo"!==this.mode?[3,2]:[4,this.getMongoUser(r,e[0])]:[2,!1];case 1:return s=i.sent(),[3,5];case 2:return(o=this.getLocalData("user",{_id:e[0]}))?[3,3]:(s={user:{}},[3,5]);case 3:return[4,this.checkAuthorization(r,o)];case 4:i.sent()?(a=this.getLocalData("group",{ownerId:e[0]}),c=this.getLocalData("authorization",{ownerId:e[0]}),s={user:o,groups:a,authorizations:c}):s={user:{}},i.label=5;case 5:return[2,s]}}))}))}},{route:"setUser",aliases:["addUser"],post:function(t,e,n){return r(o,void 0,void 0,(function(){var r,s;return i(this,(function(i){switch(i.label){case 0:return(r=t.USERS[n])?"mongo"!==this.mode?[3,2]:[4,this.setMongoUser(r,e[0])]:[2,!1];case 1:return s=i.sent(),[3,4];case 2:return[4,this.checkAuthorization(r,e[0],"WRITE")];case 3:return i.sent()&&this.setLocalData(e[0]),[2,!0];case 4:return[2,s]}}))}))}},{route:"getUsersByIds",post:function(t,e,n){return r(o,void 0,void 0,(function(){var r,s,o;return i(this,(function(i){switch(i.label){case 0:return(r=t.USERS[n])?"mongo"!==this.mode?[3,2]:[4,this.getMongoUsersByIds(r,e[0])]:[2,!1];case 1:return s=i.sent(),[3,3];case 2:s=[],Array.isArray(e[0])&&(o=this.getLocalData("user",{_id:e[0]}))&&s.push(o),i.label=3;case 3:return[2,s]}}))}))}},{route:"getUsersByRoles",post:function(t,e,n){return r(o,void 0,void 0,(function(){var r,s,o;return i(this,(function(i){switch(i.label){case 0:return(r=t.USERS[n])?this.mode.includes("mongo")?[4,this.getMongoUsersByRoles(r,e[0])]:[3,2]:[2,!1];case 1:return s=i.sent(),[3,3];case 2:o=this.getLocalData("user"),s=[],o.forEach((function(t){var n;(null===(n=t.userRoles)||void 0===n?void 0:n.includes(e[0]))&&s.push(t)})),i.label=3;case 3:return[2,s]}}))}))}},{route:"deleteUser",aliases:["removeUser"],post:function(t,e,n){return r(o,void 0,void 0,(function(){var r,s,o;return i(this,(function(i){switch(i.label){case 0:return(r=t.USERS[n])?"mongo"!==this.mode?[3,2]:[4,this.deleteMongoUser(r,e[0])]:[2,!1];case 1:return s=i.sent(),[3,3];case 2:s=!1,(o=this.getLocalData(e[0]))&&this.checkAuthorization(r,o,"WRITE")&&(s=this.deleteLocalData(o)),i.label=3;case 3:return[2,s]}}))}))}},{route:"setData",aliases:["setMongoData"],post:function(t,e,n){return r(o,void 0,void 0,(function(){var s,o,a,c=this;return i(this,(function(u){switch(u.label){case 0:return(s=t.USERS[n])?this.mode.includes("mongo")?[4,this.setMongoData(s,e)]:[3,2]:[2,!1];case 1:return o=u.sent(),[3,4];case 2:return a=[],o=[],[4,Promise.all(e.map((function(t){return r(c,void 0,void 0,(function(){var e;return i(this,(function(n){switch(n.label){case 0:return e=this.getLocalData(t),[4,this.checkAuthorization(s,e,"WRITE")];case 1:return n.sent()&&(this.setLocalData(e),o.push(e),"notification"!==e.structType&&a.push(e)),[2]}}))}))})))];case 3:return u.sent(),a.length>0&&this.checkToNotify(s,a,this.mode),[2,!0];case 4:return[2,o]}}))}))}},{route:"getData",aliases:["getMongoData","getUserData"],post:function(t,e,n){return r(o,void 0,void 0,(function(){var s,o,a,c=this;return i(this,(function(u){switch(u.label){case 0:return(s=t.USERS[n])?this.mode.includes("mongo")?[4,this.getMongoData(s,e[0],e[1],e[2],e[4],e[5])]:[3,2]:[2,!1];case 1:return o=u.sent(),[3,4];case 2:return o=[],a=void 0,e[0]&&(a=this.getLocalData(e[0])),a&&e[1]&&(a=a.filter((function(t){if(t.ownerId===e[1])return!0}))),a?[4,Promise.all(a.map((function(t){return r(c,void 0,void 0,(function(){var e;return i(this,(function(n){switch(n.label){case 0:return e=this.getLocalData(t._id),[4,this.checkAuthorization(s,e)];case 1:return n.sent()&&o.push(e),[2]}}))}))})))]:[3,4];case 3:u.sent(),u.label=4;case 4:return[2,o]}}))}))}},{route:"getDataByIds",aliases:["getMongoDataByIds","getUserDataByIds"],post:function(t,e,n){return r(o,void 0,void 0,(function(){var s,o,a,c=this;return i(this,(function(u){switch(u.label){case 0:return(s=t.USERS[n])?this.mode.includes("mongo")?[4,this.getMongoDataByIds(s,e[0],e[1],e[2])]:[3,2]:[2,!1];case 1:return o=u.sent(),[3,4];case 2:return o=[],a=void 0,e[2]&&(a=this.getLocalData(e[2])),a&&e[1]&&(a=a.filter((function(t){if(t.ownerId===e[1])return!0}))),a?[4,Promise.all(a.map((function(t){return r(c,void 0,void 0,(function(){var e;return i(this,(function(n){switch(n.label){case 0:return e=this.getLocalData(t._id),[4,this.checkAuthorization(s,e)];case 1:return n.sent()&&o.push(e),[2]}}))}))})))]:[3,4];case 3:u.sent(),u.label=4;case 4:return[2,o]}}))}))}},{route:"getAllData",post:function(t,e,n){return r(o,void 0,void 0,(function(){var s,o,a,c=this;return i(this,(function(u){switch(u.label){case 0:return(s=t.USERS[n])?this.mode.includes("mongo")?[4,this.getAllUserMongoData(s,e[0],e[1])]:[3,2]:[2,!1];case 1:return o=u.sent(),[3,4];case 2:return a=this.getLocalData(void 0,{ownerId:e[0]}),o=[],[4,Promise.all(a.map((function(t){return r(c,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return e[1]?e[1].indexOf(t.structType)<0?[4,this.checkAuthorization(s,t)]:[3,2]:[3,3];case 1:n.sent()&&o.push(t),n.label=2;case 2:return[3,5];case 3:return[4,this.checkAuthorization(s,t)];case 4:n.sent()&&o.push(t),n.label=5;case 5:return[2]}}))}))})))];case 3:u.sent(),u.label=4;case 4:return[2,o]}}))}))}},{route:"deleteData",post:function(t,e,n){return r(o,void 0,void 0,(function(){var s,o,a=this;return i(this,(function(c){switch(c.label){case 0:return(s=t.USERS[n])?this.mode.includes("mongo")?[4,this.deleteMongoData(s,e)]:[3,2]:[2,!1];case 1:return o=c.sent(),[3,4];case 2:return o=!1,[4,Promise.all(e.map((function(t){return r(a,void 0,void 0,(function(){var e;return i(this,(function(n){switch(n.label){case 0:return e=this.getLocalData(t),[4,this.checkAuthorization(s,e,"WRITE")];case 1:return n.sent()&&this.deleteLocalData(e),o=!0,[2]}}))}))})))];case 3:c.sent(),c.label=4;case 4:return[2,o]}}))}))}},{route:"getGroup",aliases:["getGroups"],post:function(t,e,n){return r(o,void 0,void 0,(function(){var r,s,o;return i(this,(function(i){switch(i.label){case 0:return(r=t.USERS[n])?this.mode.includes("mongo")?[4,this.getMongoGroups(r,e[0],e[1])]:[3,2]:[2,!1];case 1:return s=i.sent(),[3,3];case 2:"string"==typeof e[1]?s=this.getLocalData("group",{_id:e[1]}):(s=[],o=this.getLocalData("group"),e[0]?o.forEach((function(t){t.users.includes(e[0])&&s.push(t)})):o.forEach((function(t){t.users.includes(r._id)&&s.push(t)}))),i.label=3;case 3:return[2,s]}}))}))}},{route:"setGroup",post:function(t,e,n){return r(o,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return(r=t.USERS[n])?[4,this.setGroup(r,e[0],this.mode)]:[2,!1];case 1:return[2,i.sent()]}}))}))}},{route:"deleteGroup",post:function(t,e,n){return r(o,void 0,void 0,(function(){var r,s,o,a;return i(this,(function(i){switch(i.label){case 0:return(r=t.USERS[n])?this.mode.includes("mongo")?[4,this.deleteMongoGroup(r,e[0])]:[3,2]:[2,!1];case 1:return s=i.sent(),[3,5];case 2:return o=this.getLocalData("group",e[0]),a=!1,o?[4,this.checkAuthorization(r,o,"WRITE")]:[3,4];case 3:a=i.sent(),i.label=4;case 4:a&&(s=!0),i.label=5;case 5:return[2,s]}}))}))}},{route:"setAuth",post:function(t,e,n){return r(o,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return(r=t.USERS[n])?[4,this.setAuthorization(r,e[0],this.mode)]:[2,!1];case 1:return[2,i.sent()]}}))}))}},{route:"getAuths",post:function(t,e,n){return r(o,void 0,void 0,(function(){var r,s,o;return i(this,(function(i){switch(i.label){case 0:return(r=t.USERS[n])?this.mode.includes("mongo")?[4,this.getMongoAuthorizations(r,e[0],e[1])]:[3,2]:[2,!1];case 1:return s=i.sent(),[3,3];case 2:e[1]?(o=this.getLocalData("authorization",{_id:e[1]}))&&(s=[o]):s=this.getLocalData("authorization",{ownerId:e[0]}),i.label=3;case 3:return[2,s]}}))}))}},{route:"deleteAuth",post:function(t,e,n){return r(o,void 0,void 0,(function(){var r,s,o;return i(this,(function(i){switch(i.label){case 0:return(r=t.USERS[n])?this.mode.includes("mongo")?[4,this.deleteMongoAuthorization(r,e[0])]:[3,2]:[2,!1];case 1:return s=i.sent(),[3,3];case 2:return s=!0,(o=this.getLocalData("authorization",{_id:e[0]}))&&this.checkAuthorization(r,o,"WRITE")&&(s=this.deleteLocalData(o)),[2,s];case 3:return[2]}}))}))}}],o}return e(a,t),a.prototype.notificationStruct=function(t){void 0===t&&(t={});var e="notification";return{structType:e,timestamp:Date.now(),id:h(e),note:"",ownerId:"",parentUserId:"",parent:{structType:null==t?void 0:t.structType,_id:null==t?void 0:t._id}}},a.prototype.checkToNotify=function(t,e,n){return void 0===e&&(e=[]),void 0===n&&(n=this.mode),r(this,void 0,void 0,(function(){var a,c,u,l,h,d=this;return i(this,(function(f){switch(f.label){case 0:if("string"==typeof t)for(a in this.router.USERS)(c=this.router.USERS[a])._id===t&&(t=c);return"string"==typeof t||null==t?[2,!1]:(u={},l=[],e.forEach((function(e){return r(d,void 0,void 0,(function(){var r,a,c,h=this;return i(this,(function(i){switch(i.label){case 0:return(null==t?void 0:t._id)!==e.ownerId&&((r=this.notificationStruct(e)).id="notification_"+e._id,r.ownerId=e.ownerId,r.note=e.structType,r.parentUserId=e.ownerId,l.push(r),u[e.ownerId]=e.ownerId),e.users?(e.users.forEach((function(n){if(n!==t._id){var r=h.notificationStruct(e);r.id="notification_"+e._id,r.ownerId=n,r.note=e.structType,r.parentUserId=e.ownerId,l.push(r),u[n]=n}})),[3,7]):[3,1];case 1:return a=[],"mongo"!==n?[3,5]:[4,(c=this.collections.authorizations.instance.find({$or:[{authorizedId:t._id},{authorizerId:t._id}]})).count()];case 2:return i.sent()>0?[4,c.forEach((function(t){return a.push(t)}))]:[3,4];case 3:i.sent(),i.label=4;case 4:return[3,6];case 5:(a=this.getLocalData("authorization",{authorizedId:t._id})).push.apply(a,o([],s(this.getLocalData("authorization",{authorizerId:t._id})),!1)),i.label=6;case 6:a.length>0&&a.forEach((function(t){if(e.authorizerId===e.ownerId&&!u[e.authorizedId]&&"OKAY"===t.status&&t.authorizations.indexOf("peer")>-1){var n=h.notificationStruct(e);n.ownerId=t.authorizedId,n.id="notification_"+e._id,n.note=e.structType,n.parentUserId=e.ownerId,l.push(n),u[n.ownerId]=n.ownerId}})),i.label=7;case 7:return[2]}}))}))})),l.length>0?"mongo"!==n?[3,2]:[4,this.setMongoData(t,l)]:[3,4]);case 1:return f.sent(),[3,3];case 2:this.setLocalData(l),f.label=3;case 3:for(h in u)this.router.sendMsg(h,"notifications",!0);return[2,!0];case 4:return[2,!1]}}))}))},a.prototype.setMongoData=function(t,e){return void 0===e&&(e=[]),r(this,void 0,void 0,(function(){var n,a,c,u,l,h=this;return i(this,(function(d){switch(d.label){case 0:return n=!1,e.length>0?(a=!0,c="",[4,Promise.all(e.map((function(e){return r(h,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return((null==t?void 0:t._id)!==e.ownerId||t._id===e.ownerId&&t.userRoles.includes("admin_control"))&&c!==e.ownerId?[4,this.checkAuthorization(t,e,"WRITE")]:[3,2];case 1:a=i.sent(),c=e.ownerId,i.label=2;case 2:return a?((r=JSON.parse(JSON.stringify(e)))._id&&delete r._id,e.id?e.id.includes("defaultId")?[4,this.db.collection(e.structType).insertOne(r)]:[3,4]:[3,7]):[3,11];case 3:return i.sent(),n=!0,[3,6];case 4:return[4,this.db.collection(e.structType).updateOne({id:e.id},{$set:r},{upsert:!0})];case 5:i.sent(),i.label=6;case 6:return[3,11];case 7:return e._id?e._id.includes("defaultId")?[4,this.db.collection(e.structType).insertOne(r)]:[3,9]:[3,11];case 8:return i.sent(),n=!0,[3,11];case 9:return[4,this.db.collection(e.structType).updateOne({_id:bt(e._id)},{$set:r},{upsert:!1})];case 10:i.sent(),i.label=11;case 11:return[2]}}))}))})))]):[3,5];case 1:return d.sent(),!0!==n?[3,3]:(u=[],[4,Promise.all(e.map((function(t,n){return r(h,void 0,void 0,(function(){var n,a,c,l,h,d,f,p,v,g,b,m,y,S,w=this;return i(this,(function(_){switch(_.label){case 0:return(n=JSON.parse(JSON.stringify(t)))._id&&delete n._id,"comment"===t.structType?[3,3]:(a=void 0,"notification"===t.structType?[3,2]:[4,this.db.collection(n.structType).findOne(n)]);case 1:a=_.sent(),_.label=2;case 2:return a&&(a._id=a._id.toString(),u.push(a)),[3,13];case 3:return"comment"!==t.structType?[3,13]:(c=t,(l=JSON.parse(JSON.stringify(c)))._id&&delete l._id,[4,this.db.collection("comment").findOne(l)]);case 4:return h=_.sent(),d=c.replyTo,f=e.find((function(t){if(t._id===d)return!0})),f?((p=JSON.parse(JSON.stringify(f)))._id&&delete p._id,[4,Promise.all(["discussion","chatroom","comment"].map((function(t){return r(w,void 0,void 0,(function(){var e;return i(this,(function(n){switch(n.label){case 0:return[4,this.db.collection(t).findOne({_id:bt(d)})];case 1:return(e=n.sent())&&(v=e),[2]}}))}))})))]):[3,12];case 5:return _.sent(),v?(g=c.parent._id)===d?[3,8]:(b=e.find((function(t){if(t._id===g)return!0})),b?(delete b._id,[4,Promise.all(["discussion","chatroom"].map((function(t){return r(w,void 0,void 0,(function(){var e;return i(this,(function(n){switch(n.label){case 0:return[4,this.db.collection(t).findOne(b)];case 1:return(e=n.sent())&&(m=e),[2]}}))}))})))]):[3,7]):[3,11];case 6:_.sent(),_.label=7;case 7:return[3,9];case 8:m=v,_.label=9;case 9:return v&&(y=v.replies.indexOf(c._id))>-1&&(v.replies[y]=h._id.toString(),h.replyTo=v._id.toString()),m&&(y=m.comments.indexOf(c._id))>-1&&(m.comments[y]=h._id.toString(),h.parent._id=m._id.toString()),S=[h,v],m._id.toString()!==v._id.toString()&&S.push(m),[4,Promise.all(S.map((function(t){return r(w,void 0,void 0,(function(){var e;return i(this,(function(n){switch(n.label){case 0:return delete(e=JSON.parse(JSON.stringify(t)))._id,[4,this.db.collection(t.structType).updateOne({_id:bt(t._id)},{$set:e},{upsert:!1})];case 1:return n.sent(),[2]}}))}))})))];case 10:_.sent(),o([],s(u),!1).reverse().forEach((function(t,e){S.find((function(e){if(t._id.toString()===e._id.toString())return!0}))&&u.splice(u.length-e-1,1)})),u.push.apply(u,o([],s(S),!1)),_.label=11;case 11:return[3,13];case 12:h&&u.push(h),_.label=13;case 13:return[2]}}))}))})))]);case 2:return d.sent(),this.checkToNotify(t,u),[2,u];case 3:return l=[],e.forEach((function(t){"notification"!==t.structType&&l.push(t)})),this.checkToNotify(t,l),[2,!0];case 4:return[3,6];case 5:return[2,!1];case 6:return[2]}}))}))},a.prototype.setMongoUser=function(t,e){return r(this,void 0,void 0,(function(){var n,r,s;return i(this,(function(i){switch(i.label){case 0:return e._id?t._id!==e.ownerId||t._id===e.ownerId&&t.userRoles.includes("admin_control")?[4,this.checkAuthorization(t,e,"WRITE")]:[3,2]:[3,5];case 1:if(!i.sent())return[2,!1];i.label=2;case 2:return(n=JSON.parse(JSON.stringify(e)))._id&&delete n._id,this.router.DEBUG&&console.log("RETURNS PROFILE",e),r=bt(e._id),s=r!==e._id?{_id:r}:{id:e.id},[4,this.collections.users.instance.updateOne(s,{$set:n},{upsert:!0})];case 3:return i.sent(),[4,this.collections.users.instance.findOne(s)];case 4:return t=i.sent(),this.checkToNotify(t,[e]),[2,t];case 5:return[2,!1]}}))}))},a.prototype.setGroup=function(t,e,n){return void 0===e&&(e={}),void 0===n&&(n=this.mode),r(this,void 0,void 0,(function(){var r,s,o,a,c,u,l,h,d,f=this;return i(this,(function(i){switch(i.label){case 0:return e._id?(r=void 0,"mongo"!==n?[3,2]:[4,this.collections.groups.instance.findOne({name:e.name})]):[3,17];case 1:return r=i.sent(),[3,3];case 2:r=this.getLocalData("group",{_id:e._id}),i.label=3;case 3:return r&&(r.ownerId!==e.ownerId||e.admins.indexOf(t._id)<0)?[2,!1]:t._id===e.ownerId?[3,5]:[4,this.checkAuthorization(t,e,"WRITE")];case 4:if(!i.sent())return[2,!1];i.label=5;case 5:return s=[],e.users.forEach((function(t){s.push({email:t},{id:t},{username:t})})),o=[],a=[],"mongo"!==n?[3,9]:[4,(c=this.collections.users.instance.find({$or:s})).count()];case 6:return i.sent()>0?[4,c.forEach((function(t){o.push(t),a.push(t._id)}))]:[3,8];case 7:i.sent(),i.label=8;case 8:return[3,10];case 9:s.forEach((function(t){var e=f.getLocalData("user",t);e.length>0&&(o.push(e[0]),a.push(e[0]._id))})),i.label=10;case 10:return e.users=a,u=[],l=[],h=[],o.forEach((function(t){e.admins.find((function(n,r){if(n===t._id||n===t.email||n===t.username||t._id===e.ownerId)return u.indexOf(t._id<0)&&u.push(t._id),!0})),e.peers.find((function(e,n){if(e===t._id||e===t.email||e===t.username)return l.indexOf(t._id<0)&&l.push(t._id),!0})),e.clients.find((function(e,n){if(e===t._id||e===t.email||e===t.username)return h.indexOf(t._id<0)&&h.push(t._id),!0}))})),e.admins=u,e.peers=l,e.clients=h,(d=JSON.parse(JSON.stringify(e)))._id&&delete d._id,"mongo"!==n?[3,15]:e._id.includes("defaultId")?[4,this.db.collection(e.structType).insertOne(d)]:[3,12];case 11:return i.sent(),[3,14];case 12:return[4,this.collections.groups.instance.updateOne({_id:bt(e._id)},{$set:d},{upsert:!0})];case 13:i.sent(),i.label=14;case 14:return[3,16];case 15:this.setLocalData(e),i.label=16;case 16:return this.checkToNotify(t,[e],this.mode),[2,e];case 17:return[2,!1]}}))}))},a.prototype.getMongoUser=function(t,e,n){return void 0===e&&(e=""),void 0===n&&(n=!1),r(this,void 0,void 0,(function(){var s=this;return i(this,(function(o){return[2,new Promise((function(o){return r(s,void 0,void 0,(function(){var r,s,a,c,u,l;return i(this,(function(i){switch(i.label){case 0:r=[{email:e},{id:e},{username:e}];try{r.push({_id:bt(e)})}catch(t){}return[4,this.collections.users.instance.findOne({$or:r})];case 1:return(s=i.sent())&&null!=s?[3,2]:(o({}),[3,12]);case 2:return!s._id&&s._id?s._id=s._id.toString():!s._id&&s._id&&(s._id=s._id),s.ownerId||(s.ownerId=s._id),s&&!1===n?t._id!==s._id||t._id===s._id&&t.userRoles.includes("admin_control")?[4,this.checkAuthorization(t,s)]:[3,4]:[3,11];case 3:i.sent()||o(void 0),i.label=4;case 4:return a=[],[4,(c=this.collections.authorizations.instance.find({ownerId:s._id})).count()];case 5:return i.sent()>0?[4,c.forEach((function(t){return a.push(t)}))]:[3,7];case 6:i.sent(),i.label=7;case 7:return u=this.collections.groups.instance.find({users:{$all:[s._id]}}),l=[],[4,u.count()];case 8:return i.sent()>0?[4,u.forEach((function(t){return l.push(t)}))]:[3,10];case 9:i.sent(),i.label=10;case 10:return s.authorizations=a,s.groups=l,o(s),[3,12];case 11:o(s),i.label=12;case 12:return[2]}}))}))}))]}))}))},a.prototype.getMongoUsersByIds=function(t,e){return void 0===e&&(e=[]),r(this,void 0,void 0,(function(){var t,n,r;return i(this,(function(i){switch(i.label){case 0:return t=[],e.forEach((function(e){try{t.push({_id:bt(e)})}catch(t){}})),n=[],t.length>0?[4,(r=this.collections.users.instance.find({$or:t})).count()]:[3,3];case 1:return i.sent()>0?[4,r.forEach((function(t){n.push(t)}))]:[3,3];case 2:i.sent(),i.label=3;case 3:return[2,n]}}))}))},a.prototype.getMongoUsersByRoles=function(t,e){return void 0===e&&(e=[]),r(this,void 0,void 0,(function(){var t,n;return i(this,(function(r){switch(r.label){case 0:return t=this.collections.users.instance.find({userRoles:{$all:e}}),n=[],[4,t.count()];case 1:return r.sent()>0?[4,t.forEach((function(t){n.push(t)}))]:[3,3];case 2:r.sent(),r.label=3;case 3:return[2,n]}}))}))},a.prototype.getMongoDataByIds=function(t,e,n,s){return r(this,void 0,void 0,(function(){var o,a,c,u,l,h=this;return i(this,(function(d){switch(d.label){case 0:return e.length>0?(o=[],e.forEach((function(t){var e={_id:t};n&&(e.ownerId=n),o.push(e)})),a=[],s?[3,2]:[4,Promise.all(Object.keys(this.collections).map((function(e){return r(h,void 0,void 0,(function(){var n,s,c,u=this;return i(this,(function(l){switch(l.label){case 0:return[4,this.db.collection(e).find({$or:o})];case 1:return[4,(n=l.sent()).count()];case 2:return l.sent()>0?(s=!0,c="",[4,n.forEach((function(e){return r(u,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return(t._id!==e.ownerId||t._id===e.ownerId&&t.userRoles.includes("admincontrol"))&&c!==e.ownerId?[4,this.checkAuthorization(t,e)]:[3,2];case 1:s=n.sent(),c=e.ownerId,n.label=2;case 2:return s&&a.push(e),[2]}}))}))}))]):[3,4];case 3:l.sent(),l.label=4;case 4:return[2]}}))}))})))]):[3,7];case 1:return d.sent(),[3,6];case 2:return[4,this.db.collection(s).find({$or:o})];case 3:return[4,(c=d.sent()).count()];case 4:return d.sent()>0?(u=!0,l="",[4,c.forEach((function(e){return r(h,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return(t._id!==e.ownerId||t._id===e.ownerId&&t.userRoles.includes("admincontrol"))&&l!==e.ownerId?[4,this.checkAuthorization(t,e)]:[3,2];case 1:u=n.sent(),l=e.ownerId,n.label=2;case 2:return u&&a.push(e),[2]}}))}))}))]):[3,6];case 5:d.sent(),d.label=6;case 6:return[2,a];case 7:return[2]}}))}))},a.prototype.getMongoData=function(t,e,s,o,a,c){return void 0===o&&(o={}),void 0===a&&(a=0),void 0===c&&(c=0),r(this,void 0,void 0,(function(){var u,l,h,d,f,p=this;return i(this,(function(v){switch(v.label){case 0:return s||(s=null==o?void 0:o.ownerId),o._id&&(o._id=bt(o._id)),u=[],l=!0,h="",e||s||o?[3,1]:[2,[]];case 1:return e||!s||0!==Object.keys(o).length?[3,3]:[4,this.getAllUserMongoData(t,s)];case 2:return[2,v.sent()];case 3:return o||!s?[3,7]:(d=this.db.collection(e).find({ownerId:s}).sort({$natural:-1}).skip(c),a>0&&d.limit(a),[4,d.count()]);case 4:return v.sent()>0?[4,d.forEach((function(e){return r(p,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return(t._id!==e.ownerId||t._id===e.ownerId&&t.userRoles.includes("admincontrol"))&&h!==e.ownerId?[4,this.checkAuthorization(t,e)]:[3,2];case 1:l=n.sent(),h=e.ownerId,n.label=2;case 2:return!0===l&&u.push(e),[2]}}))}))}))]:[3,6];case 5:v.sent(),v.label=6;case 6:return[3,11];case 7:return Object.keys(o).length>0&&s?[4,this.db.collection(e).findOne(n({ownerId:s},o))]:[3,9];case 8:return(f=v.sent())&&u.push(f),[3,11];case 9:return Object.keys(o).length>0&&!s?[4,Promise.all(Object.keys(this.collections).map((function(e){return r(p,void 0,void 0,(function(){var n;return i(this,(function(r){switch(r.label){case 0:return[4,this.db.collection(e).findOne(o)];case 1:return(n=r.sent())?(t._id!==n.ownerId||t._id===n.ownerId&&t.userRoles.includes("admincontrol"))&&h!==n.ownerId?[4,this.checkAuthorization(t,n)]:[3,3]:[3,4];case 2:l=r.sent(),h=n.ownerId,r.label=3;case 3:return u.push(n),[2];case 4:return[2]}}))}))})))]:[3,11];case 10:v.sent(),v.label=11;case 11:return l?[2,u]:[2,[]]}}))}))},a.prototype.getAllUserMongoData=function(t,e,n){return void 0===n&&(n=[]),r(this,void 0,void 0,(function(){var s,o,a,c=this;return i(this,(function(u){switch(u.label){case 0:return s=[],o=!0,a="",[4,Promise.all(Object.keys(this.collections).map((function(u,l){return r(c,void 0,void 0,(function(){var r,c,l,h;return i(this,(function(i){switch(i.label){case 0:return o&&n.indexOf(u)<0?[4,(r=this.db.collection(u).find({ownerId:e})).count()]:[3,7];case 1:c=i.sent(),l=0,i.label=2;case 2:return l<c?[4,r.next()]:[3,7];case 3:return h=i.sent(),(t._id!==e||t._id===e&&t.userRoles.includes("admincontrol"))&&a!==e?[4,this.checkAuthorization(t,h)]:[3,5];case 4:o=i.sent(),a=e,i.label=5;case 5:o&&s.push(h),i.label=6;case 6:return l++,[3,2];case 7:return[2]}}))}))})))];case 1:return u.sent(),o?[2,s]:[2,[]]}}))}))},a.prototype.getMongoDataByRefs=function(t,e){return void 0===e&&(e=[]),r(this,void 0,void 0,(function(){var n,s,o=this;return i(this,(function(a){return(n=[]).length>0&&(s="",e.forEach((function(e){return r(o,void 0,void 0,(function(){var r,o;return i(this,(function(i){switch(i.label){case 0:return e.structType&&e._id?[4,this.db.collection(e.structType).findOne({_id:bt(e._id)})]:[3,4];case 1:return(r=i.sent())?(o=!0,(t._id!==r.ownerId||t._id===r.ownerId&&t.userRoles.includes("admincontrol"))&&s!==r.ownerId?[4,this.checkAuthorization(t,r)]:[3,3]):[3,4];case 2:i.sent(),s=r.ownerId,i.label=3;case 3:!0===o&&n.push(r),i.label=4;case 4:return[2]}}))}))}))),[2,n]}))}))},a.prototype.getMongoAuthorizations=function(t,e,n){return void 0===e&&(e=t._id),void 0===n&&(n=""),r(this,void 0,void 0,(function(){var r,s,o,a;return i(this,(function(i){switch(i.label){case 0:return r=[],0!==n.length?[3,4]:[4,(s=this.collections.authorizations.instance.find({ownerId:e})).count];case 1:return i.sent()>0?[4,s.forEach((function(t){r.push(t)}))]:[3,3];case 2:i.sent(),i.label=3;case 3:return[3,6];case 4:return a=(o=r).push,[4,this.collections.authorizations.instance.findOne({_id:bt(n),ownerId:e})];case 5:a.apply(o,[i.sent()]),i.label=6;case 6:return t._id===r[0].ownerId?[3,8]:[4,this.checkAuthorization(t,r[0])];case 7:if(!i.sent())return[2,void 0];i.label=8;case 8:return[2,r]}}))}))},a.prototype.getMongoGroups=function(t,e,n){return void 0===e&&(e=t._id),void 0===n&&(n=""),r(this,void 0,void 0,(function(){var t,r,s,o;return i(this,(function(i){switch(i.label){case 0:return t=[],0!==n.length?[3,4]:[4,(r=this.collections.groups.instance.find({users:{$all:[e]}})).count];case 1:return i.sent()>0?[4,r.forEach((function(e){t.push(e)}))]:[3,3];case 2:i.sent(),i.label=3;case 3:return[3,7];case 4:return i.trys.push([4,6,,7]),o=(s=t).push,[4,this.collections.groups.instance.findOne({_id:bt(n),users:{$all:[e]}})];case 5:return o.apply(s,[i.sent()]),[3,7];case 6:return i.sent(),[3,7];case 7:return[2,t]}}))}))},a.prototype.deleteMongoData=function(t,e){return void 0===e&&(e=[]),r(this,void 0,void 0,(function(){var n,s,o=this;return i(this,(function(a){switch(a.label){case 0:return n=[],[4,Promise.all(e.map((function(t){return r(o,void 0,void 0,(function(){var e,r,s,o,a,c;return i(this,(function(i){switch(i.label){case 0:return i.trys.push([0,8,,9]),e=bt(t._id),[4,this.db.collection(t.structType).findOne({_id:e})];case 1:return(r=i.sent())?(n.push(r),[4,this.collections.notifications.instance.find({parent:{structType:t.structType,id:t._id}})]):[3,7];case 2:return[4,(s=i.sent()).count()];case 3:o=i.sent(),a=0,i.label=4;case 4:return a<o?[4,s.next()]:[3,7];case 5:(c=i.sent())&&n.push(c),i.label=6;case 6:return a++,[3,4];case 7:return[3,9];case 8:return i.sent(),[3,9];case 9:return[2]}}))}))})))];case 1:return a.sent(),s="",[4,Promise.all(n.map((function(e,n){return r(o,void 0,void 0,(function(){var n,r,o=this;return i(this,(function(i){switch(i.label){case 0:return n=!0,(e.ownerId!==t._id||t._id===e.ownerId&&(null===(r=t.userRoles)||void 0===r?void 0:r.includes("admincontrol")))&&e.ownerId!==s?(s=e.ownerId,[4,this.checkAuthorization(t,e,"WRITE")]):[3,2];case 1:n=i.sent(),i.label=2;case 2:return n?[4,this.db.collection(e.structType).deleteOne({_id:bt(e._id)})]:[3,4];case 3:i.sent(),e.users&&e.users.forEach((function(n){n!==t._id&&n!==e.ownerId&&o.router.sendMsg(n,"deleted",e._id)})),e.ownerId!==t._id&&this.router.sendMsg(e.ownerId,"deleted",e._id),i.label=4;case 4:return[2]}}))}))})))];case 2:return a.sent(),[2,!0]}}))}))},a.prototype.deleteMongoUser=function(t,e){return r(this,void 0,void 0,(function(){var n;return i(this,(function(r){switch(r.label){case 0:return t._id!==e||t._id===e&&t.userRoles.includes("admincontrol")?[4,this.collections.users.instance.findOne({id:e})]:[3,3];case 1:return n=r.sent(),[4,this.checkAuthorization(t,n,"WRITE")];case 2:if(!r.sent())return[2,!1];r.label=3;case 3:return[4,this.collections.users.instance.deleteOne({id:e})];case 4:return r.sent(),t._id!==e&&this.router.sendMsg(e,"deleted",e),[2,!0]}}))}))},a.prototype.deleteMongoGroup=function(t,e){return r(this,void 0,void 0,(function(){var n,r=this;return i(this,(function(i){switch(i.label){case 0:return[4,this.collections.groups.instance.findOne({_id:bt(e)})];case 1:return(n=i.sent())?t._id!==n.ownerId||t._id===n.ownerId&&t.userRoles.includes("admincontrol")?[4,this.checkAuthorization(t,n,"WRITE")]:[3,3]:[3,5];case 2:if(!i.sent())return[2,!1];i.label=3;case 3:return n.users&&n.users.forEach((function(t){r.router.sendMsg(n.authorizerId,"deleted",n._id)})),[4,this.collections.groups.instance.deleteOne({_id:bt(e)})];case 4:return i.sent(),[2,!0];case 5:return[2,!1]}}))}))},a.prototype.deleteMongoAuthorization=function(t,e){return r(this,void 0,void 0,(function(){var n;return i(this,(function(r){switch(r.label){case 0:return[4,this.collections.authorizations.instance.findOne({_id:bt(e)})];case 1:return(n=r.sent())?t._id!==n.ownerId||t._id===n.ownerId&&t.userRoles.includes("admincontrol")?[4,this.checkAuthorization(t,n,"WRITE")]:[3,3]:[3,7];case 2:if(!r.sent())return[2,!1];r.label=3;case 3:return n.associatedAuthId?(this.router.DEBUG&&console.log(n),[4,this.collections.authorizations.instance.deleteOne({_id:bt(n.associatedAuthId)})]):[3,5];case 4:r.sent(),n.authorizerId!==t._id?this.router.sendMsg(n.authorizerId,"deleted",n._id):n.authorizedId!==t._id&&this.router.sendMsg(n.authorizedId,"deleted",n._id),r.label=5;case 5:return[4,this.collections.authorizations.instance.deleteOne({_id:bt(e)})];case 6:return r.sent(),[2,!0];case 7:return[2,!1]}}))}))},a.prototype.setAuthorization=function(t,e,n){return void 0===n&&(n=this.mode),r(this,void 0,void 0,(function(){var s,o,a,c,u,l,h,d,f=this;return i(this,(function(p){switch(p.label){case 0:return"mongo"!==n?[3,3]:[4,this.getMongoUser(t,e.authorizedId,!0)];case 1:return s=p.sent(),[4,this.getMongoUser(t,e.authorizerId,!0)];case 2:return o=p.sent(),[3,4];case 3:s=this.getLocalData("user",{_id:e.authorizedId}),o=this.getLocalData("user",{_id:e.authorizedId}),p.label=4;case 4:return s&&o?(e.authorizedId!==s._id&&(e.authorizedId=s._id),e.authorizerId!==o._id&&(e.authorizerId=o._id),e.authorizedName||(s.username?e.authorizedName=s.username:s.email&&(e.authorizedName=s.email)),e.authorizerName||(s.username?e.authorizerName=s.username:s.email&&(e.authorizerName=s.email)),(t._id!==e.ownerId||t._id===e.ownerId&&t.userRoles.includes("admincontrol"))&&t._id!==e.authorizedId&&t._id!==e.authorizerId?[4,this.checkAuthorization(t,e,"WRITE")]:[3,6]):[2,!1];case 5:if(!p.sent())return[2,!1];p.label=6;case 6:return a=[],"mongo"!==n?[3,10]:[4,(c=this.collections.authorizations.instance.find({$and:[{authorizedId:e.authorizedId},{authorizerId:e.authorizerId}]})).count()];case 7:return p.sent()>0?[4,c.forEach((function(t){return a.push(t)}))]:[3,9];case 8:p.sent(),p.label=9;case 9:return[3,11];case 10:c=this.getLocalData("authorization",{authorizedId:e.authorizedId}),Array.isArray(c)&&c.forEach((function(t){t.authorizerId===e.authorizerId&&a.push(t)})),p.label=11;case 11:return Array.isArray(a)&&a.forEach((function(n){return r(f,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return n.ownerId!==t._id?[3,1]:[3,4];case 1:return e.authorizerId===t._id?(n.authorizations=e.authorizations,n.structIds=e.structIds,n.excluded=e.excluded,n.expires=e.expires,n.status="OKAY",e.status="OKAY"):(e.authorizations=n.authorizations,e.structIds=n.structIds,e.excluded=n.excluded,e.expires=n.expires,n.status="OKAY",e.status="OKAY"),e.associatedAuthId=n._id.toString(),n.associatedAuthId=e._id.toString(),u=n,r=JSON.parse(JSON.stringify(n)),this.mode.includes("mongo")?(delete r._id,[4,this.collections.authorizations.instance.updateOne({$and:[{authorizedId:e.authorizedId},{authorizerId:e.authorizerId},{ownerId:n.ownerId}]},{$set:r},{upsert:!0})]):[3,3];case 2:return i.sent(),[3,4];case 3:this.setLocalData(r),i.label=4;case 4:return[2]}}))}))})),l=JSON.parse(JSON.stringify(e)),"mongo"!==n?[3,13]:(delete l._id,[4,this.collections.authorizations.instance.updateOne({$and:[{authorizedId:e.authorizedId},{authorizerId:e.authorizerId},{ownerId:e.ownerId}]},{$set:l},{upsert:!0})]);case 12:return p.sent(),[3,14];case 13:this.setLocalData(l),p.label=14;case 14:return e._id.includes("defaultId")&&"mongo"===n?[4,this.collections.authorizations.instance.findOne(l)]:[3,18];case 15:return(h=p.sent())?(e._id=h._id.toString(),u?[4,this.collections.authorizations.instance.findOne({$and:[{authorizedId:u.authorizedId},{authorizerId:u.authorizerId},{ownerId:u.ownerId}]})]:[3,18]):[3,18];case 16:return(d=p.sent())?(d.associatedAuthId=e._id,delete d._id,[4,this.collections.authorizations.instance.updateOne({$and:[{authorizedId:d.authorizedId},{authorizerId:d.authorizerId},{ownerId:d.ownerId}]},{$set:d},{upsert:!0})]):[3,18];case 17:p.sent(),this.checkToNotify(t,[d]),p.label=18;case 18:return[2,e]}}))}))},a.prototype.checkAuthorization=function(t,e,n,s){var o,a,c;return void 0===n&&(n="READ"),void 0===s&&(s=this.mode),r(this,void 0,void 0,(function(){var r,u,l;return i(this,(function(i){switch(i.label){case 0:if(!t||!e)return[2,!1];if("object"==typeof t){if(e.ownerId===t._id&&!(null===(o=t.userRoles)||void 0===o?void 0:o.includes("admin_control")))return[2,!0]}else if("string"==typeof t){if(e.ownerId===t)return[2,!0];t={_id:t}}return"mongo"!==s?[3,3]:[4,this.collections.authorizations.instance.findOne({$or:[{authorizedId:t._id,authorizerId:e.ownerId,ownerId:t._id},{authorizedId:e.ownerId,authorizerId:t._id,ownerId:t._id}]})];case 1:return r=i.sent(),[4,this.collections.authorizations.instance.findOne({$or:[{authorizedId:t._id,authorizerId:e.ownerId,ownerId:e.ownerId},{authorizedId:e.ownerId,authorizerId:t._id,ownerId:e.ownerId}]})];case 2:return u=i.sent(),[3,4];case 3:r=this.getLocalData("authorization",{ownerId:t._id}).find((function(n){if(n.authorizedId===t._id&&n.authorizerId===e.ownerId)return!0})),u=this.getLocalData("authorization",{ownerId:e.ownerId}).find((function(n){if(n.authorizedId===t._id&&n.authorizerId===e.ownerId)return!0})),i.label=4;case 4:return r&&u?(l=!1,"OKAY"===r.status&&"OKAY"===u.status&&("group"===e.structType?l=r.authorizations.indexOf(e.name+"_admin")>-1&&u.authorizations.indexOf(e.name+"_admin")>-1:r.authorizations.indexOf("provider")>-1&&u.authorizations.indexOf("provider")>-1||r.authorizations.indexOf("peer")>-1&&u.authorizations.indexOf("peer")>-1||r.authorizations.indexOf("control")>-1&&u.authorizations.indexOf("control")>-1||(null===(a=r.structIds)||void 0===a?void 0:a.indexOf(e._id))>-1&&(null===(c=u.structIds)||void 0===c?void 0:c.indexOf(e._id))>-1?l=!0:r.excluded.indexOf(e.structType)>-1&&e.ownerId===t._id&&"WRITE"===n&&(l=!1)),[2,l]):[2,!1]}}))}))},a.prototype.overwriteLocalData=function(t){var e=this;if(Array.isArray(t))t.forEach((function(t){var n=e.getLocalData(t.structType,{ownerId:t.ownerId,_id:t._id});n&&0!==(null==n?void 0:n.length)?Object.assign(n,t):e.setLocalData(t)}));else{var n=this.getLocalData(t.structType,{ownerId:t.ownerId,_id:t._id});n&&0!==(null==n?void 0:n.length)?Object.assign(n,t):this.setLocalData(t)}},a.prototype.setLocalData=function(t){var e=this,n=function(t){var n=t.structType,r=e.collections[n].reference;r||(r={},e.collections[n].reference=r),r[t._id]=t};Array.isArray(t)?t.forEach((function(t){n(t)})):n(t)},a.prototype.getLocalData=function(t,e){var n,r,i;if("object"==typeof e){n=e.ownerId;var s=Object.keys(e).filter((function(t){return"ownerId"!=t}));r=s[0],i=e[r]}else i=e;if(!(t||n||r||i))return[];var o=[];if(!t&&(n||r))return Object.values(this.collections).forEach((function(t){if(t=t.reference,"_id"!==r&&"id"!==r||!i)Object.values(t).forEach((function(t){r&&i?t[r]===i&&t.ownerId===n&&o.push(t):t.ownerId===n&&o.push(t)}));else{var e=t[i];e&&o.push(e)}})),o;var a=this.collections[t].reference;return a?r||n?"_id"!==r&&"id"!==r||!i?(Object.keys(a).forEach((function(t){var e=a[t];r&&i&&!n?e[r]===i&&o.push(e):n&&!r?e.ownerId===n&&o.push(e):n&&r&&i&&e.ownerId===n&&e[r]&&e[r]===i&&o.push(e)})),o):a[i]:(Object.values(a).forEach((function(t){o.push(t)})),o):o},a.prototype.deleteLocalData=function(t){if(!t)throw new Error("Struct not supplied");return!(!t.structType||!t._id)&&(this.collections[t.structType]&&delete this.collections[t.structType].reference[t._id],!0)},a}(f),St=function(t){function n(e,n){void 0===e&&(e={});var a=t.call(this,n)||this;return a.tablet=new st,a.collections=a.tablet.collections,a.id=h(),a.baseServerCallback=function(t){var e=t;if("object"==typeof t&&(null==t?void 0:t.structType)&&(e=[t]),Array.isArray(t)){var n=e.filter((function(t){if("notification"!==t.structType)return!0}));a.tablet&&a.tablet.sortStructsIntoTable(n),e.forEach((function(t){var e;(t.structType&&"USER"!==t.structType||(t.email?t.structType="user":t.structType="uncategorized"),"user"===t.structType||"authorization"===t.structType||"group"===t.structType)?("user"===t.structType&&(t._id=t.id),a.setLocalData(t)):"notification"===t.structType?(a.getLocalData("notification",{ownerId:t.ownerId,_id:t.parent._id})?a.setLocalData(t):a.getLocalData(t.structType,{_id:t.parent._id})||a.overwriteLocalData(t),t.ownerId!==(null===(e=a.currentUser)||void 0===e?void 0:e._id)||"user"!==t.parent.structType&&"dataInstance"!==t.parent.structType&&"schedule"!==t.parent.structType&&"authorization"!==t.parent.structType||a.resolveNotifications([t],!0)):a.overwriteLocalData(t)}))}"notifications"===(null==t?void 0:t.message)&&a.checkForNotifications(),"deleted"===(null==t?void 0:t.message)&&a.deleteLocalData(t.id),a.onResult(t)},a.resolveNotifications=function(t,e,n){return void 0===t&&(t=[]),void 0===e&&(e=!0),void 0===n&&(n=a.currentUser),r(a,void 0,void 0,(function(){var r,s,o,a=this;return i(this,(function(i){switch(i.label){case 0:return n&&0!==t.length?(r=[],s=[],o=[],0===t.length&&(t=this.getLocalData("notification",{ownerId:n._id})),t.forEach((function(t){t.parent.structType,o.push(t.parent.structType),r.push(t.parent._id),s.push(t._id),a.deleteLocalData(t)})),this.deleteData(s),e?(o.reverse().forEach((function(t,e){"user"===t&&(a.getUser(s[e]),r.splice(r.length-e-1,1))})),r.length>0?[4,this.getDataByIds(r,n._id,"notification")]:[3,2]):[3,2]):[2];case 1:return[2,i.sent()];case 2:return[2,!0]}}))}))},a.getLocalUserPeerIds=function(t){if(void 0===t&&(t=a.currentUser),!t)return[];var e=[];return a.getLocalData("authorization",t._id).forEach((function(n){n.authorizations.indexOf("peer")>-1&&n.authorizerId===t._id&&e.push(n.authorizedId)})),e},a.authorizeUser=function(t,e,n,s,o,c,u,l,h,d){return void 0===t&&(t=a.userStruct()),void 0===e&&(e=""),void 0===n&&(n=""),void 0===s&&(s=""),void 0===o&&(o=""),void 0===c&&(c=[]),void 0===u&&(u=[]),void 0===l&&(l=[]),void 0===h&&(h=[]),void 0===d&&(d=!1),r(a,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return(r=this.createStruct("authorization",void 0,t,void 0)).authorizedId=s,r.authorizedName=o,r.authorizerId=e,r.authorizerName=n,r.authorizations=c,r.structs=u,r.excluded=l,r.groups=h,r.expires=d,r.status="PENDING",r.associatedAuthId="",r.ownerId=t._id,[4,this.setAuthorization(r)];case 1:return[2,r=i.sent()]}}))}))},a.addGroup=function(t,e,n,c,u,l,h){return void 0===t&&(t=a.userStruct()),void 0===e&&(e=""),void 0===n&&(n=""),void 0===c&&(c=[]),void 0===u&&(u=[]),void 0===l&&(l=[]),void 0===h&&(h=!0),r(a,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return(r=this.createStruct("group",void 0,t)).name=e,r.details=n,r.admins=c,r.peers=u,r.clients=l,r.users=o(o(o([],s(c),!1),s(u),!1),s(l),!1),r.ownerId=t._id,h?[4,this.setGroup(r)]:[3,2];case 1:r=i.sent(),i.label=2;case 2:return[2,r]}}))}))},a.addData=function(t,e,n,s,o,c,u){return void 0===t&&(t=a.userStruct()),void 0===e&&(e=""),void 0===n&&(n=""),void 0===s&&(s=""),void 0===o&&(o=[]),void 0===c&&(c=!1),void 0===u&&(u=!0),r(a,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return(r=this.createStruct("dataInstance",void 0,t)).author=e,r.title=n,r.type=s,r.data=o,r.expires=c,r.ownerId=t._id,u?[4,this.updateServerData([r])[0]]:[3,2];case 1:r=i.sent(),i.label=2;case 2:return[2,r]}}))}))},a.addEvent=function(t,e,n,s,o,c,u,l,h,d){return void 0===t&&(t=a.userStruct()),void 0===e&&(e=""),void 0===n&&(n=""),void 0===s&&(s=""),void 0===o&&(o=0),void 0===c&&(c=0),void 0===u&&(u=0),void 0===l&&(l=[]),void 0===h&&(h=[]),void 0===d&&(d=!0),r(a,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return 0===h.length&&(h=this.getLocalUserPeerIds(t)),(r=this.createStruct("event",void 0,t)).author=e,r.event=n,r.notes=s,r.startTime=o,r.endTime=c,r.grade=u,r.attachments=l,r.users=h,r.ownerId=t._id,d?[4,this.updateServerData([r])[0]]:[3,2];case 1:r=i.sent(),i.label=2;case 2:return[2,r]}}))}))},a.addDiscussion=function(t,e,n,s,o,c,u,l){return void 0===t&&(t=a.userStruct()),void 0===e&&(e=""),void 0===n&&(n=""),void 0===s&&(s=""),void 0===o&&(o=""),void 0===c&&(c=[]),void 0===u&&(u=[]),void 0===l&&(l=!0),r(a,void 0,void 0,(function(){var r,a;return i(this,(function(i){switch(i.label){case 0:return 0===u.length&&(u=this.getLocalUserPeerIds(t)),(r=this.createStruct("discussion",void 0,t)).topic=n,r.category=s,r.message=o,r.attachments=c,r.authorId=e,r.users=u,r.comments=[],r.replies=[],r.ownerId=t._id,a=[r],l?[4,this.updateServerData(a)[0]]:[3,2];case 1:r=i.sent(),i.label=2;case 2:return[2,r]}}))}))},a.addChatroom=function(t,e,n,s,o,c){return void 0===t&&(t=a.userStruct()),void 0===e&&(e=""),void 0===n&&(n=""),void 0===s&&(s=[]),void 0===o&&(o=[]),void 0===c&&(c=!0),r(a,void 0,void 0,(function(){var r,a;return i(this,(function(i){switch(i.label){case 0:return 0===o.length&&(o=this.getLocalUserPeerIds(t)),(r=this.createStruct("chatroom",void 0,t)).message=n,r.attachments=s,r.authorId=e,r.users=o,r.replies=[],r.comments=[],r.ownerId=t._id,a=[r],c?[4,this.updateServerData(a)[0]]:[3,2];case 1:r=i.sent(),i.label=2;case 2:return[2,r]}}))}))},a.addComment=function(t,e,n,s,o,c,u){return void 0===t&&(t=a.userStruct()),void 0===s&&(s=""),void 0===o&&(o=""),void 0===c&&(c=[]),void 0===u&&(u=!0),r(a,void 0,void 0,(function(){var r,a;return i(this,(function(i){switch(i.label){case 0:return(r=this.createStruct("comment",void 0,t,e)).authorId=s,r.replyTo=null==n?void 0:n._id,r.message=o,r.attachments=c,r.users=null==e?void 0:e.users,r.replies=[],r.ownerId=t._id,u?null==n||n.replies.push(r._id):null==n||n.replies.push(r),u?null==e||e.comments.push(r._id):null==e||e.comments.push(r),a=[r,e],n._id!==e._id&&a.push(n),u?[4,this.updateServerData(a)[0]]:[3,2];case 1:r=i.sent(),i.label=2;case 2:return[2,r]}}))}))},e instanceof Object&&Object.keys(e).length>0&&a.setupUser(e),a.load(new yt(a)),a}return e(n,t),n.prototype.setupUser=function(t,e){return void 0===e&&(e=function(t){}),r(this,void 0,void 0,(function(){var n,r,s,o,a,c,u,l,h,d,f,p,v,g=this;return i(this,(function(i){switch(i.label){case 0:return t?(n=!1,t.id&&(t._id=t.id),console.log("Generating/Getting User: ",t._id),[4,this.getUser(t._id)]):(console.error('must provide an info object! e.g. {_id:"abc123"}'),e(void 0),[2,void 0]);case 1:return r=i.sent(),o=!1,(null==r?void 0:r._id)?[3,3]:(s=this.userStruct(t,!0),o=!0,[4,this.setUser(s)]);case 2:return i.sent(),(null==(a=this.getLocalData(void 0,{ownerId:s._id}))?void 0:a.length)>0&&this.updateServerData(a,(function(t){console.log("setData",t)})),this.setAuthorizationsByGroup(s),[3,4];case 3:for(c in s=r.user,t)if(u=this.userStruct(),s[c]&&"_id"!==c)if(Array.isArray(t[c])){for(l=0;l<s[c].length;l++)if(t[c].indexOf(s[c][l])<0){s[c]=t[c],n=!0;break}if(!n)for(l=0;l<t[c].length;l++)if(s[c].indexOf(t[c][l])<0){s[c]=t[c],n=!0;break}}else s[c]!==t[c]&&(s[c]=t[c],n=!0);else s[c]!==t[c]&&"string"==typeof u[c]&&"_id"!==c&&(s[c]=t[c],n=!0);(null==r?void 0:r.authorizations)&&Array.isArray(r.authorizations)&&this.setLocalData(r.authorizations),(null==r?void 0:r.groups)&&Array.isArray(r.groups)&&this.setLocalData(r.groups),i.label=4;case 4:return o?(this.currentUser=s,this.setLocalData(s),[3,7]):[3,5];case 5:return[4,this.getAllUserData(s._id,void 0)];case 6:h=i.sent(),console.log("getServerData",h),h&&0!==h.length&&(this.setLocalData(h),d=h.filter((function(t){if("notification"===t.structType){if(g.getLocalData("authorization",t.parent._id))return!0;if("user"===t.parent.structType||"authorization"===t.parent.structType)return!0;if(!g.getLocalData(t.parent.structType,t.parent._id))return!0}})),f=h.filter((function(t){if("comment"===t.structType)return!0})),p=[],f.forEach((function(t){g.getLocalData("comment",{_id:t._id})||p.push(t._id)})),p.length>0&&this.deleteData(p),d.length>0&&(this.resolveNotifications(d,!1,void 0),n=!0),v=h.filter((function(t){if("notification"!==t.structType)return!0})),this.tablet&&this.tablet.sortStructsIntoTable(v)),this.setLocalData(s),console.log("currentUser",s),this.currentUser=s,console.log("collections",this.tablet.collections),i.label=7;case 7:return e(this.currentUser),[2,this.currentUser]}}))}))},n.prototype.onResult=function(t){},n.prototype.randomId=function(t){return void 0===t&&(t=""),"".concat(t+Math.floor(Math.random()+Math.random()*Math.random()*1e16))},n.prototype.addStruct=function(t,e,n,s,o){return void 0===t&&(t="struct"),void 0===e&&(e={}),void 0===n&&(n=void 0),void 0===s&&(s=void 0),void 0===o&&(o=!0),r(this,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return r=nt.Struct(t,e,n,s),o?[4,this.updateServerData([r])[0]]:[3,2];case 1:r=i.sent(),i.label=2;case 2:return[2,r]}}))}))},n.prototype.ping=function(t){var e;return void 0===t&&(t=function(t){console.log(t)}),r(this,void 0,void 0,(function(){var n;return i(this,(function(r){switch(r.label){case 0:return[4,this.send("ping")];case 1:return n=null===(e=r.sent())||void 0===e?void 0:e[0],t(n),[2,n]}}))}))},n.prototype.sendMessage=function(t,e,n,a){var c;return void 0===t&&(t=""),void 0===e&&(e=""),void 0===n&&(n=void 0),void 0===a&&(a=function(t){console.log(t)}),r(this,void 0,void 0,(function(){var r,u;return i(this,(function(i){switch(i.label){case 0:return r=[t,e],n&&(r[2]=n),[4,this.send.apply(this,o(["sendMessage"],s(r),!1))];case 1:return u=null===(c=i.sent())||void 0===c?void 0:c[0],a(u),[2,u]}}))}))},n.prototype.getUser=function(t,e){var n;return void 0===t&&(t=""),void 0===e&&(e=this.baseServerCallback),r(this,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return[4,this.send("structs/getUser",t)];case 1:return r=null===(n=i.sent())||void 0===n?void 0:n[0],e(r),[2,r]}}))}))},n.prototype.getUsers=function(t,e){var n;return void 0===t&&(t=[]),void 0===e&&(e=this.baseServerCallback),r(this,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return[4,this.send.apply(this,o(["structs/getUsers"],s(t),!1))];case 1:return r=null===(n=i.sent())||void 0===n?void 0:n[0],e(r),[2,r]}}))}))},n.prototype.getUsersByRoles=function(t,e){var n;return void 0===t&&(t=[]),void 0===e&&(e=this.baseServerCallback),r(this,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return[4,this.send("structs/getUsersByRoles",t)];case 1:return r=null===(n=i.sent())||void 0===n?void 0:n[0],e(r),[2,r]}}))}))},n.prototype.getAllUserData=function(t,e,n){var s;return void 0===e&&(e=[]),void 0===n&&(n=this.baseServerCallback),r(this,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return[4,this.send("structs/getAllData",t,e)];case 1:return r=null===(s=i.sent())||void 0===s?void 0:s[0],n(r),[2,r]}}))}))},n.prototype.getData=function(t,e,n,s,o,a){var c;return void 0===s&&(s=0),void 0===o&&(o=0),void 0===a&&(a=this.baseServerCallback),r(this,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return[4,this.send("structs/getData",t,e,n,s,o)];case 1:return r=null===(c=i.sent())||void 0===c?void 0:c[0],a(r),[2,r]}}))}))},n.prototype.getDataByIds=function(t,e,n,s){var o;return void 0===t&&(t=[]),void 0===s&&(s=this.baseServerCallback),r(this,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return[4,this.send("structs/getDataByIdss",t,e,n)];case 1:return r=null===(o=i.sent())||void 0===o?void 0:o[0],s(r),[2,r]}}))}))},n.prototype.getStructParentData=function(t,e){var n,a,c;return void 0===e&&(e=this.baseServerCallback),r(this,void 0,void 0,(function(){var r,u;return i(this,(function(i){switch(i.label){case 0:return t.parent?(r=[null===(n=t.parent)||void 0===n?void 0:n.structType,"_id",null===(a=t.parent)||void 0===a?void 0:a._id],[4,this.send.apply(this,o(["structs/getData"],s(r),!1))]):[2];case 1:return u=null===(c=i.sent())||void 0===c?void 0:c[0],e(u),[2,u]}}))}))},n.prototype.setUser=function(t,e){var n;return void 0===t&&(t={}),void 0===e&&(e=this.baseServerCallback),r(this,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return[4,this.send("structs/setUser",this.stripStruct(t))];case 1:return r=null===(n=i.sent())||void 0===n?void 0:n[0],e(r),[2,r]}}))}))},n.prototype.checkUserToken=function(t,e,n){return void 0===e&&(e=this.currentUser),void 0===n&&(n=this.baseServerCallback),r(this,void 0,void 0,(function(){var r,s,o,a;return i(this,(function(i){switch(i.label){case 0:if(!t)return[2,!1];for(s in r=!1,t)if(o=this.userStruct(),e[s]&&"_id"!==s)if(Array.isArray(t[s])){for(a=0;a<e[s].length;a++)if(t[s].indexOf(e[s][a])<0){e[s]=t[s],r=!0;break}if(!r)for(a=0;a<t[s].length;a++)if(e[s].indexOf(t[s][a])<0){e[s]=t[s],r=!0;break}}else e[s]!==t[s]&&(e[s]=t[s],r=!0);else!e[s]&&o[s]&&(e[s]=t[s],r=!0);return r?[4,this.setUser(e,n)]:[3,2];case 1:return[2,i.sent()];case 2:return[2,r]}}))}))},n.prototype.updateServerData=function(t,e){var n;return void 0===t&&(t=[]),void 0===e&&(e=this.baseServerCallback),r(this,void 0,void 0,(function(){var r,a,c=this;return i(this,(function(i){switch(i.label){case 0:return r=new Array,t.forEach((function(t){r.push(c.stripStruct(t))})),[4,this.send.apply(this,o(["structs/setData"],s(r),!1))];case 1:return a=null===(n=i.sent())||void 0===n?void 0:n[0],e(a),[2,a]}}))}))},n.prototype.deleteData=function(t,e){var n;return void 0===t&&(t=[]),void 0===e&&(e=this.baseServerCallback),r(this,void 0,void 0,(function(){var r,a,c=this;return i(this,(function(i){switch(i.label){case 0:return r=[],t.forEach((function(t){(null==t?void 0:t.structType)&&(null==t?void 0:t._id)&&(r.push({structType:t.structType,_id:t._id}),c.deleteLocalData(t))})),console.log("deleting",r),[4,this.send.apply(this,o(["structs/deleteData"],s(r),!1))];case 1:return a=null===(n=i.sent())||void 0===n?void 0:n[0],e(a),[2,a]}}))}))},n.prototype.deleteUser=function(t,e){var n;return void 0===e&&(e=this.baseServerCallback),r(this,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return t?[4,this.send("structs/deleteUser",t)]:[2];case 1:return r=null===(n=i.sent())||void 0===n?void 0:n[0],e(r),[2,r]}}))}))},n.prototype.setGroup=function(t,e){var n;return void 0===t&&(t={}),void 0===e&&(e=this.baseServerCallback),r(this,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return[4,this.send("structs/setGroup",this.stripStruct(t))];case 1:return r=null===(n=i.sent())||void 0===n?void 0:n[0],e(r),[2,r]}}))}))},n.prototype.getGroups=function(t,e,n){var s;return void 0===t&&(t=this.currentUser._id),void 0===e&&(e=""),void 0===n&&(n=this.baseServerCallback),r(this,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return[4,this.send("structs/getGroups",t,e)];case 1:return r=null===(s=i.sent())||void 0===s?void 0:s[0],n(r),[2,r]}}))}))},n.prototype.deleteGroup=function(t,e){var n;return void 0===e&&(e=this.baseServerCallback),r(this,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return t?(this.deleteLocalData(t),[4,this.send("structs/deleteGroup",t)]):[2];case 1:return r=null===(n=i.sent())||void 0===n?void 0:n[0],e(r),[2,r]}}))}))},n.prototype.setAuthorization=function(t,e){var n;return void 0===t&&(t={}),void 0===e&&(e=this.baseServerCallback),r(this,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return[4,this.send("structs/setAuth",this.stripStruct(t))];case 1:return r=null===(n=i.sent())||void 0===n?void 0:n[0],e(r),[2,r]}}))}))},n.prototype.getAuthorizations=function(t,e,n){var s,o;return void 0===t&&(t=null===(s=this.currentUser)||void 0===s?void 0:s._id),void 0===e&&(e=""),void 0===n&&(n=this.baseServerCallback),r(this,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return void 0===t?[2]:[4,this.send("structs/getAuths",t,e)];case 1:return r=null===(o=i.sent())||void 0===o?void 0:o[0],n(r),[2,r]}}))}))},n.prototype.deleteAuthorization=function(t,e){var n;return void 0===e&&(e=this.baseServerCallback),r(this,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return t?(this.deleteLocalData(t),[4,this.send("structs/deleteAuth",t)]):[2];case 1:return r=null===(n=i.sent())||void 0===n?void 0:n[0],e(r),[2,r]}}))}))},n.prototype.checkForNotifications=function(t){var e;return void 0===t&&(t=null===(e=this.currentUser)||void 0===e?void 0:e._id),r(this,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,this.getData("notification",t)];case 1:return[2,e.sent()]}}))}))},n.prototype.setAuthorizationsByGroup=function(t){return void 0===t&&(t=this.currentUser),r(this,void 0,void 0,(function(){var e,n=this;return i(this,(function(r){return e=this.getLocalData("authorization",{ownerId:t._id}),t.userRoles.forEach((function(r){var i,s=r.split("_")[0];r.includes("client")?i=s+"_peer":r.includes("peer")?i=s+"_client":r.includes("admin")&&(i=s+"_owner"),i&&n.getUsersByRoles([i],(function(i){null==i||i.forEach((function(i){var s=i.username;s||(s=i.email),s||(s=i.id);var o=t.username;if(o||(o=t.email),o||(o=t.id),s!==o)if(r.includes("client")){var a=e.find((function(e){if(e.authorizerId===i.id&&e.authorizedId===t.id)return!0}));a||n.authorizeUser(nt.ProfileStruct("user",t,t),i.id,s,t.id,o,["peer"],void 0,[r])}else if(r.includes("peer")){a=e.find((function(e){if(e.authorizedId===i.id&&e.authorizerId===t.id)return!0}));a||n.authorizeUser(nt.ProfileStruct("user",t,t),t.id,o,i.id,s,["peer"],void 0,[r])}}))}))})),[2]}))}))},n.prototype.deleteRoom=function(t){var e;return r(this,void 0,void 0,(function(){var n,r=this;return i(this,(function(i){switch(i.label){case 0:return t?(n=[t],null===(e=t.comments)||void 0===e||e.forEach((function(t){var e=r.getLocalData("comment",{_id:t});n.push(e)})),t?[4,this.deleteData(n)]:[3,2]):[2,!1];case 1:return[2,i.sent()];case 2:return[2,!1]}}))}))},n.prototype.deleteComment=function(t){var e,n,s;return r(this,void 0,void 0,(function(){var r,o,a,c,u,l,h=this;return i(this,(function(i){switch(i.label){case 0:return r=[t],(o=function(e){void 0===e&&(e=t),(null==e?void 0:e.replies)&&e.replies.forEach((function(t){var e=h.getLocalData("comment",{_id:t});e&&(e.replies.length>0&&e.replies.forEach((function(t){o(t)})),r.push(e))}))})(t),a=this.getLocalData(null===(e=t.parent)||void 0===e?void 0:e.structType,{_id:null===(n=t.parent)||void 0===n?void 0:n._id}),c=[],a&&(c=[a],r.forEach((function(t){var e,n,r=null===(e=a.replies)||void 0===e?void 0:e.indexOf(t._id);r>-1&&a.replies.splice(r,1);var i=null===(n=a.comments)||void 0===n?void 0:n.indexOf(t._id);i>-1&&a.comments.splice(i,1)}))),(null==(u=this.getLocalData("comment",{_id:t.replyTo}))?void 0:u._id)!==(null==a?void 0:a._id)&&((l=null===(s=u.replies)||void 0===s?void 0:s.indexOf(a._id))>-1&&u.replies.splice(l,1),c.push(u)),c.length>0?[4,this.updateServerData(c)]:[3,2];case 1:i.sent(),i.label=2;case 2:return[4,this.deleteData(r)];case 3:return[2,i.sent()]}}))}))},n.prototype.getUserDataByAuthorization=function(t,e,n,s,o,a){return void 0===s&&(s=0),void 0===o&&(o=0),void 0===a&&(a=this.baseServerCallback),r(this,void 0,void 0,(function(){var c,u=this;return i(this,(function(l){return(c=t.authorizerId)?[2,new Promise((function(t){return r(u,void 0,void 0,(function(){var u=this;return i(this,(function(l){return this.getUser(c,(function(l){return r(u,void 0,void 0,(function(){return i(this,(function(r){switch(r.label){case 0:return e?[3,2]:[4,this.getAllUserData(c,["notification"],a)];case 1:return r.sent(),[3,4];case 2:return[4,this.getData(e,c,n,s,o,a)];case 3:r.sent(),r.label=4;case 4:return t(l),a(l),[2]}}))}))})),[2]}))}))}))]:[2,void 0]}))}))},n.prototype.getUserDataByAuthorizationGroup=function(t,e,n,s,o,a){return void 0===t&&(t=""),void 0===s&&(s=0),void 0===o&&(o=0),void 0===a&&(a=this.baseServerCallback),r(this,void 0,void 0,(function(){var c,u,l=this;return i(this,(function(h){switch(h.label){case 0:return c=this.getLocalData("authorization"),u=[],[4,Promise.all(c.map((function(c){return r(l,void 0,void 0,(function(){var r,l,h,d;return i(this,(function(i){switch(i.label){case 0:return(null===(d=c.groups)||void 0===d?void 0:d.includes(t))?(r=c.authorizerId)?(l=void 0,[4,this.getUser(r,a)]):[3,6]:[3,7];case 1:return(h=i.sent())&&u.push(h),e?[3,3]:[4,this.getAllUserData(r,["notification"],a)];case 2:return l=i.sent(),[3,5];case 3:return[4,this.getData(e,r,n,s,o,a)];case 4:l=i.sent(),i.label=5;case 5:l&&u.push(l),i.label=6;case 6:return[2,!0];case 7:return[2]}}))}))})))];case 1:return h.sent(),[2,u]}}))}))},n.prototype.overwriteLocalData=function(t){var e=this;if(Array.isArray(t))t.forEach((function(t){var n=e.getLocalData(t.structType,{ownerId:t.ownerId,_id:t._id});n&&0!==(null==n?void 0:n.length)?Object.assign(n,t):e.setLocalData(t)}));else{var n=this.getLocalData(t.structType,{ownerId:t.ownerId,_id:t._id});n&&0!==(null==n?void 0:n.length)?Object.assign(n,t):this.setLocalData(t)}},n.prototype.setLocalData=function(t){this.tablet.setLocalData(t)},n.prototype.getLocalData=function(t,e){return this.tablet.getLocalData(t,e)},n.prototype.getLocalReplies=function(t){var e=[];return t.replies?t.replies.reduce((function(t,e){return t*("object"==typeof e?1:0)}),1)?t.replies:e=this.getLocalData("comment",{replyTo:t._id}):e},n.prototype.hasLocalAuthorization=function(t,e){void 0===e&&(e=this.currentUser._id);var n=this.getLocalData("authorization",{ownerId:e}).find((function(n){return n.authorizedId===e&&n.authorizerId===t||(n.authorizerId===e&&n.authorizedId===t||void 0)}));return n||!1},n.prototype.deleteLocalData=function(t){var e=this;return Array.isArray(t)?t.forEach((function(t){return e.deleteStruct(t)})):this.deleteStruct(t),!0},n.prototype.deleteStruct=function(t){if("string"==typeof t&&(t=this.getLocalData(t)),!t)throw new Error("Struct not supplied");return!(!t.structType||!t._id)&&(this.tablet.collections.get(t.structType).delete(t._id),!0)},n.prototype.stripStruct=function(t){void 0===t&&(t={});var e=Object.assign({},t);for(var n in e)void 0!==e[n]&&"Map"!==e[n].constructor.name||delete e[n];return e},n.prototype.createStruct=function(t,e,n,r){return void 0===n&&(n=this.currentUser),nt.Struct(t,e,n,r)},n.prototype.userStruct=function(t,e){void 0===t&&(t={}),void 0===e&&(e=!1);var n=nt.ProfileStruct("user",t,t);for(var r in t._id?n.id=t._id:t.id?n.id=t.id:n.id="user"+Math.floor(1e10*Math.random()),n._id=n.id,n.ownerId=n.id,t)Object.keys(nt.ProfileStruct()).indexOf(r)<0&&delete n[r];return e&&(this.currentUser=n),n},n.prototype.dataObject=function(t,e,n){return void 0===t&&(t=void 0),void 0===e&&(e="any"),void 0===n&&(n=Date.now()),{type:e,data:t,timestamp:n}},n}(gt);export{St as StructRouter,yt as StructService};
