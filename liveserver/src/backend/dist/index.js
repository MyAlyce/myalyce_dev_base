!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("stream"),require("zlib"),require("net"),require("tls"),require("crypto"),require("events"),require("https"),require("http"),require("url")):"function"==typeof define&&define.amd?define(["exports","stream","zlib","net","tls","crypto","events","https","http","url"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).liveserver={},e.require$$0$1,e.require$$0,e.require$$3,e.require$$4,e.require$$5,e.require$$0$2,e.require$$1,e.require$$2,e.require$$7)}(this,(function(exports,require$$0$1,require$$0,require$$3,require$$4,require$$5,require$$0$2,require$$1,require$$2,require$$7){"use strict";function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var require$$0__default$1=_interopDefaultLegacy(require$$0$1),require$$0__default=_interopDefaultLegacy(require$$0),require$$3__default=_interopDefaultLegacy(require$$3),require$$4__default=_interopDefaultLegacy(require$$4),require$$5__default=_interopDefaultLegacy(require$$5),require$$0__default$2=_interopDefaultLegacy(require$$0$2),require$$1__default=_interopDefaultLegacy(require$$1),require$$2__default=_interopDefaultLegacy(require$$2),require$$7__default=_interopDefaultLegacy(require$$7),extendStatics=function(e,t){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},extendStatics(e,t)};function __extends(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}function __awaiter(e,t,r,s){return new(r||(r=Promise))((function(n,i){function o(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((s=s.apply(e,t||[])).next())}))}function __generator(e,t){var r,s,n,i,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,s&&(n=2&i[0]?s.return:i[0]?s.throw||((n=s.return)&&n.call(s),0):s.next)&&!(n=n.call(s,i[1])).done)return n;switch(s=0,n&&(i=[2&i[0],n.value]),i[0]){case 0:case 1:n=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,s=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(n=o.trys,(n=n.length>0&&n[n.length-1])||6!==i[0]&&2!==i[0])){o=0;continue}if(3===i[0]&&(!n||i[1]>n[0]&&i[1]<n[3])){o.label=i[1];break}if(6===i[0]&&o.label<n[1]){o.label=n[1],n=i;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(i);break}n[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],s=0}finally{r=n=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function __read(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var s,n,i=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(s=i.next()).done;)o.push(s.value)}catch(e){n={error:e}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}return o}var bufferUtil$1={exports:{}},constants={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}};const{EMPTY_BUFFER:EMPTY_BUFFER$3}=constants;function concat$1(e,t){if(0===e.length)return EMPTY_BUFFER$3;if(1===e.length)return e[0];const r=Buffer.allocUnsafe(t);let s=0;for(let t=0;t<e.length;t++){const n=e[t];r.set(n,s),s+=n.length}return s<t?r.slice(0,s):r}function _mask(e,t,r,s,n){for(let i=0;i<n;i++)r[s+i]=e[i]^t[3&i]}function _unmask(e,t){for(let r=0;r<e.length;r++)e[r]^=t[3&r]}function toArrayBuffer$1(e){return e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function toBuffer$2(e){if(toBuffer$2.readOnly=!0,Buffer.isBuffer(e))return e;let t;return e instanceof ArrayBuffer?t=Buffer.from(e):ArrayBuffer.isView(e)?t=Buffer.from(e.buffer,e.byteOffset,e.byteLength):(t=Buffer.from(e),toBuffer$2.readOnly=!1),t}try{const e=require("bufferutil");bufferUtil$1.exports={concat:concat$1,mask(t,r,s,n,i){i<48?_mask(t,r,s,n,i):e.mask(t,r,s,n,i)},toArrayBuffer:toArrayBuffer$1,toBuffer:toBuffer$2,unmask(t,r){t.length<32?_unmask(t,r):e.unmask(t,r)}}}catch(e){bufferUtil$1.exports={concat:concat$1,mask:_mask,toArrayBuffer:toArrayBuffer$1,toBuffer:toBuffer$2,unmask:_unmask}}const kDone=Symbol("kDone"),kRun=Symbol("kRun");class Limiter$1{constructor(e){this[kDone]=()=>{this.pending--,this[kRun]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[kRun]()}[kRun](){if(this.pending!==this.concurrency&&this.jobs.length){const e=this.jobs.shift();this.pending++,e(this[kDone])}}}var limiter=Limiter$1;const zlib=require$$0__default.default,bufferUtil=bufferUtil$1.exports,Limiter=limiter,{kStatusCode:kStatusCode$2}=constants,TRAILER=Buffer.from([0,0,255,255]),kPerMessageDeflate=Symbol("permessage-deflate"),kTotalLength=Symbol("total-length"),kCallback=Symbol("callback"),kBuffers=Symbol("buffers"),kError$1=Symbol("error");let zlibLimiter;class PerMessageDeflate$4{constructor(e,t,r){if(this._maxPayload=0|r,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!zlibLimiter){const e=void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10;zlibLimiter=new Limiter(e)}}static get extensionName(){return"permessage-deflate"}offer(){const e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){const e=this._deflate[kCallback];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){const t=this._options,r=e.find((e=>!(!1===t.serverNoContextTakeover&&e.server_no_context_takeover||e.server_max_window_bits&&(!1===t.serverMaxWindowBits||"number"==typeof t.serverMaxWindowBits&&t.serverMaxWindowBits>e.server_max_window_bits)||"number"==typeof t.clientMaxWindowBits&&!e.client_max_window_bits)));if(!r)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(r.server_no_context_takeover=!0),t.clientNoContextTakeover&&(r.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(r.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?r.client_max_window_bits=t.clientMaxWindowBits:!0!==r.client_max_window_bits&&!1!==t.clientMaxWindowBits||delete r.client_max_window_bits,r}acceptAsClient(e){const t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach((e=>{Object.keys(e).forEach((t=>{let r=e[t];if(r.length>1)throw new Error(`Parameter "${t}" must have only a single value`);if(r=r[0],"client_max_window_bits"===t){if(!0!==r){const e=+r;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${t}": ${r}`)}else if("server_max_window_bits"===t){const e=+r;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else{if("client_no_context_takeover"!==t&&"server_no_context_takeover"!==t)throw new Error(`Unknown parameter "${t}"`);if(!0!==r)throw new TypeError(`Invalid value for parameter "${t}": ${r}`)}e[t]=r}))})),e}decompress(e,t,r){zlibLimiter.add((s=>{this._decompress(e,t,((e,t)=>{s(),r(e,t)}))}))}compress(e,t,r){zlibLimiter.add((s=>{this._compress(e,t,((e,t)=>{s(),r(e,t)}))}))}_decompress(e,t,r){const s=this._isServer?"client":"server";if(!this._inflate){const e=`${s}_max_window_bits`,t="number"!=typeof this.params[e]?zlib.Z_DEFAULT_WINDOWBITS:this.params[e];this._inflate=zlib.createInflateRaw({...this._options.zlibInflateOptions,windowBits:t}),this._inflate[kPerMessageDeflate]=this,this._inflate[kTotalLength]=0,this._inflate[kBuffers]=[],this._inflate.on("error",inflateOnError),this._inflate.on("data",inflateOnData)}this._inflate[kCallback]=r,this._inflate.write(e),t&&this._inflate.write(TRAILER),this._inflate.flush((()=>{const e=this._inflate[kError$1];if(e)return this._inflate.close(),this._inflate=null,void r(e);const n=bufferUtil.concat(this._inflate[kBuffers],this._inflate[kTotalLength]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[kTotalLength]=0,this._inflate[kBuffers]=[],t&&this.params[`${s}_no_context_takeover`]&&this._inflate.reset()),r(null,n)}))}_compress(e,t,r){const s=this._isServer?"server":"client";if(!this._deflate){const e=`${s}_max_window_bits`,t="number"!=typeof this.params[e]?zlib.Z_DEFAULT_WINDOWBITS:this.params[e];this._deflate=zlib.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:t}),this._deflate[kTotalLength]=0,this._deflate[kBuffers]=[],this._deflate.on("data",deflateOnData)}this._deflate[kCallback]=r,this._deflate.write(e),this._deflate.flush(zlib.Z_SYNC_FLUSH,(()=>{if(!this._deflate)return;let e=bufferUtil.concat(this._deflate[kBuffers],this._deflate[kTotalLength]);t&&(e=e.slice(0,e.length-4)),this._deflate[kCallback]=null,this._deflate[kTotalLength]=0,this._deflate[kBuffers]=[],t&&this.params[`${s}_no_context_takeover`]&&this._deflate.reset(),r(null,e)}))}}var permessageDeflate=PerMessageDeflate$4;function deflateOnData(e){this[kBuffers].push(e),this[kTotalLength]+=e.length}function inflateOnData(e){this[kTotalLength]+=e.length,this[kPerMessageDeflate]._maxPayload<1||this[kTotalLength]<=this[kPerMessageDeflate]._maxPayload?this[kBuffers].push(e):(this[kError$1]=new RangeError("Max payload size exceeded"),this[kError$1].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[kError$1][kStatusCode$2]=1009,this.removeListener("data",inflateOnData),this.reset())}function inflateOnError(e){this[kPerMessageDeflate]._inflate=null,e[kStatusCode$2]=1007,this[kCallback](e)}var validation={exports:{}};const tokenChars$2=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function isValidStatusCode$2(e){return e>=1e3&&e<=1014&&1004!==e&&1005!==e&&1006!==e||e>=3e3&&e<=4999}function _isValidUTF8(e){const t=e.length;let r=0;for(;r<t;)if(0==(128&e[r]))r++;else if(192==(224&e[r])){if(r+1===t||128!=(192&e[r+1])||192==(254&e[r]))return!1;r+=2}else if(224==(240&e[r])){if(r+2>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||224===e[r]&&128==(224&e[r+1])||237===e[r]&&160==(224&e[r+1]))return!1;r+=3}else{if(240!=(248&e[r]))return!1;if(r+3>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||128!=(192&e[r+3])||240===e[r]&&128==(240&e[r+1])||244===e[r]&&e[r+1]>143||e[r]>244)return!1;r+=4}return!0}try{const e=require("utf-8-validate");validation.exports={isValidStatusCode:isValidStatusCode$2,isValidUTF8:t=>t.length<150?_isValidUTF8(t):e(t),tokenChars:tokenChars$2}}catch(e){validation.exports={isValidStatusCode:isValidStatusCode$2,isValidUTF8:_isValidUTF8,tokenChars:tokenChars$2}}const{Writable:Writable}=require$$0__default$1.default,PerMessageDeflate$3=permessageDeflate,{BINARY_TYPES:BINARY_TYPES$1,EMPTY_BUFFER:EMPTY_BUFFER$2,kStatusCode:kStatusCode$1,kWebSocket:kWebSocket$2}=constants,{concat:concat,toArrayBuffer:toArrayBuffer,unmask:unmask}=bufferUtil$1.exports,{isValidStatusCode:isValidStatusCode$1,isValidUTF8:isValidUTF8}=validation.exports,GET_INFO=0,GET_PAYLOAD_LENGTH_16=1,GET_PAYLOAD_LENGTH_64=2,GET_MASK=3,GET_DATA=4,INFLATING=5;class Receiver$1 extends Writable{constructor(e={}){super(),this._binaryType=e.binaryType||BINARY_TYPES$1[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=0|e.maxPayload,this._skipUTF8Validation=!!e.skipUTF8Validation,this[kWebSocket$2]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._state=GET_INFO,this._loop=!1}_write(e,t,r){if(8===this._opcode&&this._state==GET_INFO)return r();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(r)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){const t=this._buffers[0];return this._buffers[0]=t.slice(e),t.slice(0,e)}const t=Buffer.allocUnsafe(e);do{const r=this._buffers[0],s=t.length-e;e>=r.length?t.set(this._buffers.shift(),s):(t.set(new Uint8Array(r.buffer,r.byteOffset,e),s),this._buffers[0]=r.slice(e)),e-=r.length}while(e>0);return t}startLoop(e){let t;this._loop=!0;do{switch(this._state){case GET_INFO:t=this.getInfo();break;case GET_PAYLOAD_LENGTH_16:t=this.getPayloadLength16();break;case GET_PAYLOAD_LENGTH_64:t=this.getPayloadLength64();break;case GET_MASK:this.getMask();break;case GET_DATA:t=this.getData(e);break;default:return void(this._loop=!1)}}while(this._loop);e(t)}getInfo(){if(this._bufferedBytes<2)return void(this._loop=!1);const e=this.consume(2);if(0!=(48&e[0]))return this._loop=!1,error(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");const t=64==(64&e[0]);if(t&&!this._extensions[PerMessageDeflate$3.extensionName])return this._loop=!1,error(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._fin=128==(128&e[0]),this._opcode=15&e[0],this._payloadLength=127&e[1],0===this._opcode){if(t)return this._loop=!1,error(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(!this._fragmented)return this._loop=!1,error(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented)return this._loop=!1,error(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");this._compressed=t}else{if(!(this._opcode>7&&this._opcode<11))return this._loop=!1,error(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");if(!this._fin)return this._loop=!1,error(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");if(t)return this._loop=!1,error(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._payloadLength>125)return this._loop=!1,error(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH")}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=128==(128&e[1]),this._isServer){if(!this._masked)return this._loop=!1,error(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK")}else if(this._masked)return this._loop=!1,error(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");if(126===this._payloadLength)this._state=GET_PAYLOAD_LENGTH_16;else{if(127!==this._payloadLength)return this.haveLength();this._state=GET_PAYLOAD_LENGTH_64}}getPayloadLength16(){if(!(this._bufferedBytes<2))return this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength();this._loop=!1}getPayloadLength64(){if(this._bufferedBytes<8)return void(this._loop=!1);const e=this.consume(8),t=e.readUInt32BE(0);return t>Math.pow(2,21)-1?(this._loop=!1,error(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH")):(this._payloadLength=t*Math.pow(2,32)+e.readUInt32BE(4),this.haveLength())}haveLength(){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0))return this._loop=!1,error(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");this._masked?this._state=GET_MASK:this._state=GET_DATA}getMask(){this._bufferedBytes<4?this._loop=!1:(this._mask=this.consume(4),this._state=GET_DATA)}getData(e){let t=EMPTY_BUFFER$2;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength)return void(this._loop=!1);t=this.consume(this._payloadLength),this._masked&&0!=(this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3])&&unmask(t,this._mask)}return this._opcode>7?this.controlMessage(t):this._compressed?(this._state=INFLATING,void this.decompress(t,e)):(t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage())}decompress(e,t){this._extensions[PerMessageDeflate$3.extensionName].decompress(e,this._fin,((e,r)=>{if(e)return t(e);if(r.length){if(this._messageLength+=r.length,this._messageLength>this._maxPayload&&this._maxPayload>0)return t(error(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"));this._fragments.push(r)}const s=this.dataMessage();if(s)return t(s);this.startLoop(t)}))}dataMessage(){if(this._fin){const e=this._messageLength,t=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let r;r="nodebuffer"===this._binaryType?concat(t,e):"arraybuffer"===this._binaryType?toArrayBuffer(concat(t,e)):t,this.emit("message",r,!0)}else{const r=concat(t,e);if(!this._skipUTF8Validation&&!isValidUTF8(r))return this._loop=!1,error(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("message",r,!1)}}this._state=GET_INFO}controlMessage(e){if(8===this._opcode)if(this._loop=!1,0===e.length)this.emit("conclude",1005,EMPTY_BUFFER$2),this.end();else{if(1===e.length)return error(RangeError,"invalid payload length 1",!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH");{const t=e.readUInt16BE(0);if(!isValidStatusCode$1(t))return error(RangeError,`invalid status code ${t}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");const r=e.slice(2);if(!this._skipUTF8Validation&&!isValidUTF8(r))return error(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("conclude",t,r),this.end()}}else 9===this._opcode?this.emit("ping",e):this.emit("pong",e);this._state=GET_INFO}}var receiver=Receiver$1;function error(e,t,r,s,n){const i=new e(r?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(i,error),i.code=n,i[kStatusCode$1]=s,i}const{randomFillSync:randomFillSync}=require$$5__default.default,PerMessageDeflate$2=permessageDeflate,{EMPTY_BUFFER:EMPTY_BUFFER$1}=constants,{isValidStatusCode:isValidStatusCode}=validation.exports,{mask:applyMask,toBuffer:toBuffer$1}=bufferUtil$1.exports,kByteLength=Symbol("kByteLength"),maskBuffer=Buffer.alloc(4);class Sender$1{constructor(e,t,r){this._extensions=t||{},r&&(this._generateMask=r,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(e,t){let r,s,n=!1,i=2,o=!1;t.mask&&(r=t.maskBuffer||maskBuffer,t.generateMask?t.generateMask(r):randomFillSync(r,0,4),o=0==(r[0]|r[1]|r[2]|r[3]),i=6),"string"==typeof e?s=t.mask&&!o||void 0===t[kByteLength]?(e=Buffer.from(e)).length:t[kByteLength]:(s=e.length,n=t.mask&&t.readOnly&&!o);let a=s;s>=65536?(i+=8,a=127):s>125&&(i+=2,a=126);const c=Buffer.allocUnsafe(n?s+i:i);return c[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(c[0]|=64),c[1]=a,126===a?c.writeUInt16BE(s,2):127===a&&(c[2]=c[3]=0,c.writeUIntBE(s,4,6)),t.mask?(c[1]|=128,c[i-4]=r[0],c[i-3]=r[1],c[i-2]=r[2],c[i-1]=r[3],o?[c,e]:n?(applyMask(e,r,c,i,s),[c]):(applyMask(e,r,e,0,s),[c,e])):[c,e]}close(e,t,r,s){let n;if(void 0===e)n=EMPTY_BUFFER$1;else{if("number"!=typeof e||!isValidStatusCode(e))throw new TypeError("First argument must be a valid error code number");if(void 0!==t&&t.length){const r=Buffer.byteLength(t);if(r>123)throw new RangeError("The message must not be greater than 123 bytes");n=Buffer.allocUnsafe(2+r),n.writeUInt16BE(e,0),"string"==typeof t?n.write(t,2):n.set(t,2)}else n=Buffer.allocUnsafe(2),n.writeUInt16BE(e,0)}const i={[kByteLength]:n.length,fin:!0,generateMask:this._generateMask,mask:r,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};this._deflating?this.enqueue([this.dispatch,n,!1,i,s]):this.sendFrame(Sender$1.frame(n,i),s)}ping(e,t,r){let s,n;if("string"==typeof e?(s=Buffer.byteLength(e),n=!1):(s=(e=toBuffer$1(e)).length,n=toBuffer$1.readOnly),s>125)throw new RangeError("The data size must not be greater than 125 bytes");const i={[kByteLength]:s,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:9,readOnly:n,rsv1:!1};this._deflating?this.enqueue([this.dispatch,e,!1,i,r]):this.sendFrame(Sender$1.frame(e,i),r)}pong(e,t,r){let s,n;if("string"==typeof e?(s=Buffer.byteLength(e),n=!1):(s=(e=toBuffer$1(e)).length,n=toBuffer$1.readOnly),s>125)throw new RangeError("The data size must not be greater than 125 bytes");const i={[kByteLength]:s,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:10,readOnly:n,rsv1:!1};this._deflating?this.enqueue([this.dispatch,e,!1,i,r]):this.sendFrame(Sender$1.frame(e,i),r)}send(e,t,r){const s=this._extensions[PerMessageDeflate$2.extensionName];let n,i,o=t.binary?2:1,a=t.compress;if("string"==typeof e?(n=Buffer.byteLength(e),i=!1):(n=(e=toBuffer$1(e)).length,i=toBuffer$1.readOnly),this._firstFragment?(this._firstFragment=!1,a&&s&&s.params[s._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(a=n>=s._threshold),this._compress=a):(a=!1,o=0),t.fin&&(this._firstFragment=!0),s){const s={[kByteLength]:n,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:o,readOnly:i,rsv1:a};this._deflating?this.enqueue([this.dispatch,e,this._compress,s,r]):this.dispatch(e,this._compress,s,r)}else this.sendFrame(Sender$1.frame(e,{[kByteLength]:n,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:o,readOnly:i,rsv1:!1}),r)}dispatch(e,t,r,s){if(!t)return void this.sendFrame(Sender$1.frame(e,r),s);const n=this._extensions[PerMessageDeflate$2.extensionName];this._bufferedBytes+=r[kByteLength],this._deflating=!0,n.compress(e,r.fin,((e,t)=>{if(this._socket.destroyed){const e=new Error("The socket was closed while data was being compressed");"function"==typeof s&&s(e);for(let t=0;t<this._queue.length;t++){const r=this._queue[t],s=r[r.length-1];"function"==typeof s&&s(e)}}else this._bufferedBytes-=r[kByteLength],this._deflating=!1,r.readOnly=!1,this.sendFrame(Sender$1.frame(t,r),s),this.dequeue()}))}dequeue(){for(;!this._deflating&&this._queue.length;){const e=this._queue.shift();this._bufferedBytes-=e[3][kByteLength],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][kByteLength],this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}}var sender=Sender$1;const{kForOnEventAttribute:kForOnEventAttribute$1,kListener:kListener$1}=constants,kCode=Symbol("kCode"),kData=Symbol("kData"),kError=Symbol("kError"),kMessage=Symbol("kMessage"),kReason=Symbol("kReason"),kTarget=Symbol("kTarget"),kType=Symbol("kType"),kWasClean=Symbol("kWasClean");class Event{constructor(e){this[kTarget]=null,this[kType]=e}get target(){return this[kTarget]}get type(){return this[kType]}}Object.defineProperty(Event.prototype,"target",{enumerable:!0}),Object.defineProperty(Event.prototype,"type",{enumerable:!0});class CloseEvent extends Event{constructor(e,t={}){super(e),this[kCode]=void 0===t.code?0:t.code,this[kReason]=void 0===t.reason?"":t.reason,this[kWasClean]=void 0!==t.wasClean&&t.wasClean}get code(){return this[kCode]}get reason(){return this[kReason]}get wasClean(){return this[kWasClean]}}Object.defineProperty(CloseEvent.prototype,"code",{enumerable:!0}),Object.defineProperty(CloseEvent.prototype,"reason",{enumerable:!0}),Object.defineProperty(CloseEvent.prototype,"wasClean",{enumerable:!0});class ErrorEvent extends Event{constructor(e,t={}){super(e),this[kError]=void 0===t.error?null:t.error,this[kMessage]=void 0===t.message?"":t.message}get error(){return this[kError]}get message(){return this[kMessage]}}Object.defineProperty(ErrorEvent.prototype,"error",{enumerable:!0}),Object.defineProperty(ErrorEvent.prototype,"message",{enumerable:!0});class MessageEvent extends Event{constructor(e,t={}){super(e),this[kData]=void 0===t.data?null:t.data}get data(){return this[kData]}}Object.defineProperty(MessageEvent.prototype,"data",{enumerable:!0});const EventTarget={addEventListener(e,t,r={}){let s;if("message"===e)s=function(e,r){const s=new MessageEvent("message",{data:r?e:e.toString()});s[kTarget]=this,t.call(this,s)};else if("close"===e)s=function(e,r){const s=new CloseEvent("close",{code:e,reason:r.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});s[kTarget]=this,t.call(this,s)};else if("error"===e)s=function(e){const r=new ErrorEvent("error",{error:e,message:e.message});r[kTarget]=this,t.call(this,r)};else{if("open"!==e)return;s=function(){const e=new Event("open");e[kTarget]=this,t.call(this,e)}}s[kForOnEventAttribute$1]=!!r[kForOnEventAttribute$1],s[kListener$1]=t,r.once?this.once(e,s):this.on(e,s)},removeEventListener(e,t){for(const r of this.listeners(e))if(r[kListener$1]===t&&!r[kForOnEventAttribute$1]){this.removeListener(e,r);break}}};var eventTarget={CloseEvent:CloseEvent,ErrorEvent:ErrorEvent,Event:Event,EventTarget:EventTarget,MessageEvent:MessageEvent};const{tokenChars:tokenChars$1}=validation.exports;function push(e,t,r){void 0===e[t]?e[t]=[r]:e[t].push(r)}function parse$2(e){const t=Object.create(null);let r,s,n=Object.create(null),i=!1,o=!1,a=!1,c=-1,l=-1,h=-1,u=0;for(;u<e.length;u++)if(l=e.charCodeAt(u),void 0===r)if(-1===h&&1===tokenChars$1[l])-1===c&&(c=u);else if(0===u||32!==l&&9!==l){if(59!==l&&44!==l)throw new SyntaxError(`Unexpected character at index ${u}`);{if(-1===c)throw new SyntaxError(`Unexpected character at index ${u}`);-1===h&&(h=u);const s=e.slice(c,h);44===l?(push(t,s,n),n=Object.create(null)):r=s,c=h=-1}}else-1===h&&-1!==c&&(h=u);else if(void 0===s)if(-1===h&&1===tokenChars$1[l])-1===c&&(c=u);else if(32===l||9===l)-1===h&&-1!==c&&(h=u);else if(59===l||44===l){if(-1===c)throw new SyntaxError(`Unexpected character at index ${u}`);-1===h&&(h=u),push(n,e.slice(c,h),!0),44===l&&(push(t,r,n),n=Object.create(null),r=void 0),c=h=-1}else{if(61!==l||-1===c||-1!==h)throw new SyntaxError(`Unexpected character at index ${u}`);s=e.slice(c,u),c=h=-1}else if(o){if(1!==tokenChars$1[l])throw new SyntaxError(`Unexpected character at index ${u}`);-1===c?c=u:i||(i=!0),o=!1}else if(a)if(1===tokenChars$1[l])-1===c&&(c=u);else if(34===l&&-1!==c)a=!1,h=u;else{if(92!==l)throw new SyntaxError(`Unexpected character at index ${u}`);o=!0}else if(34===l&&61===e.charCodeAt(u-1))a=!0;else if(-1===h&&1===tokenChars$1[l])-1===c&&(c=u);else if(-1===c||32!==l&&9!==l){if(59!==l&&44!==l)throw new SyntaxError(`Unexpected character at index ${u}`);{if(-1===c)throw new SyntaxError(`Unexpected character at index ${u}`);-1===h&&(h=u);let o=e.slice(c,h);i&&(o=o.replace(/\\/g,""),i=!1),push(n,s,o),44===l&&(push(t,r,n),n=Object.create(null),r=void 0),s=void 0,c=h=-1}}else-1===h&&(h=u);if(-1===c||a||32===l||9===l)throw new SyntaxError("Unexpected end of input");-1===h&&(h=u);const d=e.slice(c,h);return void 0===r?push(t,d,n):(void 0===s?push(n,d,!0):push(n,s,i?d.replace(/\\/g,""):d),push(t,r,n)),t}function format$1(e){return Object.keys(e).map((t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map((e=>[t].concat(Object.keys(e).map((t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map((e=>!0===e?t:`${t}=${e}`)).join("; ")}))).join("; "))).join(", ")})).join(", ")}var extension$1={format:format$1,parse:parse$2};const EventEmitter$1=require$$0__default$2.default,https=require$$1__default.default,http$1=require$$2__default.default,net=require$$3__default.default,tls=require$$4__default.default,{randomBytes:randomBytes,createHash:createHash$1}=require$$5__default.default,{URL:URL}=require$$7__default.default,PerMessageDeflate$1=permessageDeflate,Receiver=receiver,Sender=sender,{BINARY_TYPES:BINARY_TYPES,EMPTY_BUFFER:EMPTY_BUFFER,GUID:GUID$1,kForOnEventAttribute:kForOnEventAttribute,kListener:kListener,kStatusCode:kStatusCode,kWebSocket:kWebSocket$1,NOOP:NOOP}=constants,{EventTarget:{addEventListener:addEventListener,removeEventListener:removeEventListener}}=eventTarget,{format:format,parse:parse$1}=extension$1,{toBuffer:toBuffer}=bufferUtil$1.exports,readyStates=["CONNECTING","OPEN","CLOSING","CLOSED"],subprotocolRegex=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/,protocolVersions=[8,13],closeTimeout=3e4;class WebSocket$1 extends EventEmitter$1{constructor(e,t,r){super(),this._binaryType=BINARY_TYPES[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=EMPTY_BUFFER,this._closeTimer=null,this._extensions={},this._paused=!1,this._protocol="",this._readyState=WebSocket$1.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==e?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,void 0===t?t=[]:Array.isArray(t)||("object"==typeof t&&null!==t?(r=t,t=[]):t=[t]),initAsClient(this,e,t,r)):this._isServer=!0}get binaryType(){return this._binaryType}set binaryType(e){BINARY_TYPES.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,r){const s=new Receiver({binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:r.maxPayload,skipUTF8Validation:r.skipUTF8Validation});this._sender=new Sender(e,this._extensions,r.generateMask),this._receiver=s,this._socket=e,s[kWebSocket$1]=this,e[kWebSocket$1]=this,s.on("conclude",receiverOnConclude),s.on("drain",receiverOnDrain),s.on("error",receiverOnError),s.on("message",receiverOnMessage),s.on("ping",receiverOnPing),s.on("pong",receiverOnPong),e.setTimeout(0),e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",socketOnClose),e.on("data",socketOnData),e.on("end",socketOnEnd),e.on("error",socketOnError$1),this._readyState=WebSocket$1.OPEN,this.emit("open")}emitClose(){if(!this._socket)return this._readyState=WebSocket$1.CLOSED,void this.emit("close",this._closeCode,this._closeMessage);this._extensions[PerMessageDeflate$1.extensionName]&&this._extensions[PerMessageDeflate$1.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=WebSocket$1.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==WebSocket$1.CLOSED){if(this.readyState===WebSocket$1.CONNECTING){const e="WebSocket was closed before the connection was established";return abortHandshake$1(this,this._req,e)}this.readyState!==WebSocket$1.CLOSING?(this._readyState=WebSocket$1.CLOSING,this._sender.close(e,t,!this._isServer,(e=>{e||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())})),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),closeTimeout)):this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end()}}pause(){this.readyState!==WebSocket$1.CONNECTING&&this.readyState!==WebSocket$1.CLOSED&&(this._paused=!0,this._socket.pause())}ping(e,t,r){if(this.readyState===WebSocket$1.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(r=e,e=t=void 0):"function"==typeof t&&(r=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===WebSocket$1.OPEN?(void 0===t&&(t=!this._isServer),this._sender.ping(e||EMPTY_BUFFER,t,r)):sendAfterClose(this,e,r)}pong(e,t,r){if(this.readyState===WebSocket$1.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(r=e,e=t=void 0):"function"==typeof t&&(r=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===WebSocket$1.OPEN?(void 0===t&&(t=!this._isServer),this._sender.pong(e||EMPTY_BUFFER,t,r)):sendAfterClose(this,e,r)}resume(){this.readyState!==WebSocket$1.CONNECTING&&this.readyState!==WebSocket$1.CLOSED&&(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(e,t,r){if(this.readyState===WebSocket$1.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof t&&(r=t,t={}),"number"==typeof e&&(e=e.toString()),this.readyState!==WebSocket$1.OPEN)return void sendAfterClose(this,e,r);const s={binary:"string"!=typeof e,mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[PerMessageDeflate$1.extensionName]||(s.compress=!1),this._sender.send(e||EMPTY_BUFFER,s,r)}terminate(){if(this.readyState!==WebSocket$1.CLOSED){if(this.readyState===WebSocket$1.CONNECTING){const e="WebSocket was closed before the connection was established";return abortHandshake$1(this,this._req,e)}this._socket&&(this._readyState=WebSocket$1.CLOSING,this._socket.destroy())}}}Object.defineProperty(WebSocket$1,"CONNECTING",{enumerable:!0,value:readyStates.indexOf("CONNECTING")}),Object.defineProperty(WebSocket$1.prototype,"CONNECTING",{enumerable:!0,value:readyStates.indexOf("CONNECTING")}),Object.defineProperty(WebSocket$1,"OPEN",{enumerable:!0,value:readyStates.indexOf("OPEN")}),Object.defineProperty(WebSocket$1.prototype,"OPEN",{enumerable:!0,value:readyStates.indexOf("OPEN")}),Object.defineProperty(WebSocket$1,"CLOSING",{enumerable:!0,value:readyStates.indexOf("CLOSING")}),Object.defineProperty(WebSocket$1.prototype,"CLOSING",{enumerable:!0,value:readyStates.indexOf("CLOSING")}),Object.defineProperty(WebSocket$1,"CLOSED",{enumerable:!0,value:readyStates.indexOf("CLOSED")}),Object.defineProperty(WebSocket$1.prototype,"CLOSED",{enumerable:!0,value:readyStates.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach((e=>{Object.defineProperty(WebSocket$1.prototype,e,{enumerable:!0})})),["open","error","close","message"].forEach((e=>{Object.defineProperty(WebSocket$1.prototype,`on${e}`,{enumerable:!0,get(){for(const t of this.listeners(e))if(t[kForOnEventAttribute])return t[kListener];return null},set(t){for(const t of this.listeners(e))if(t[kForOnEventAttribute]){this.removeListener(e,t);break}"function"==typeof t&&this.addEventListener(e,t,{[kForOnEventAttribute]:!0})}})})),WebSocket$1.prototype.addEventListener=addEventListener,WebSocket$1.prototype.removeEventListener=removeEventListener;var websocket=WebSocket$1;function initAsClient(e,t,r,s){const n={protocolVersion:protocolVersions[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...s,createConnection:void 0,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:void 0,host:void 0,path:void 0,port:void 0};if(!protocolVersions.includes(n.protocolVersion))throw new RangeError(`Unsupported protocol version: ${n.protocolVersion} (supported versions: ${protocolVersions.join(", ")})`);let i;if(t instanceof URL)i=t,e._url=t.href;else{try{i=new URL(t)}catch(e){throw new SyntaxError(`Invalid URL: ${t}`)}e._url=t}const o="wss:"===i.protocol,a="ws+unix:"===i.protocol;let c;if("ws:"===i.protocol||o||a?a&&!i.pathname?c="The URL's pathname is empty":i.hash&&(c="The URL contains a fragment identifier"):c='The URL\'s protocol must be one of "ws:", "wss:", or "ws+unix:"',c){const t=new SyntaxError(c);if(0===e._redirects)throw t;return void emitErrorAndClose(e,t)}const l=o?443:80,h=randomBytes(16).toString("base64"),u=o?https.get:http$1.get,d=new Set;let f;if(n.createConnection=o?tlsConnect:netConnect,n.defaultPort=n.defaultPort||l,n.port=i.port||l,n.host=i.hostname.startsWith("[")?i.hostname.slice(1,-1):i.hostname,n.headers={"Sec-WebSocket-Version":n.protocolVersion,"Sec-WebSocket-Key":h,Connection:"Upgrade",Upgrade:"websocket",...n.headers},n.path=i.pathname+i.search,n.timeout=n.handshakeTimeout,n.perMessageDeflate&&(f=new PerMessageDeflate$1(!0!==n.perMessageDeflate?n.perMessageDeflate:{},!1,n.maxPayload),n.headers["Sec-WebSocket-Extensions"]=format({[PerMessageDeflate$1.extensionName]:f.offer()})),r.length){for(const e of r){if("string"!=typeof e||!subprotocolRegex.test(e)||d.has(e))throw new SyntaxError("An invalid or duplicated subprotocol was specified");d.add(e)}n.headers["Sec-WebSocket-Protocol"]=r.join(",")}if(n.origin&&(n.protocolVersion<13?n.headers["Sec-WebSocket-Origin"]=n.origin:n.headers.Origin=n.origin),(i.username||i.password)&&(n.auth=`${i.username}:${i.password}`),a){const e=n.path.split(":");n.socketPath=e[0],n.path=e[1]}if(n.followRedirects){if(0===e._redirects){e._originalHost=i.host;const t=s&&s.headers;if(s={...s,headers:{}},t)for(const[e,r]of Object.entries(t))s.headers[e.toLowerCase()]=r}else i.host!==e._originalHost&&(delete n.headers.authorization,delete n.headers.cookie,delete n.headers.host,n.auth=void 0);n.auth&&!s.headers.authorization&&(s.headers.authorization="Basic "+Buffer.from(n.auth).toString("base64"))}let _=e._req=u(n);n.timeout&&_.on("timeout",(()=>{abortHandshake$1(e,_,"Opening handshake has timed out")})),_.on("error",(t=>{null===_||_.aborted||(_=e._req=null,emitErrorAndClose(e,t))})),_.on("response",(i=>{const o=i.headers.location,a=i.statusCode;if(o&&n.followRedirects&&a>=300&&a<400){if(++e._redirects>n.maxRedirects)return void abortHandshake$1(e,_,"Maximum redirects exceeded");let i;_.abort();try{i=new URL(o,t)}catch(t){const r=new SyntaxError(`Invalid URL: ${o}`);return void emitErrorAndClose(e,r)}initAsClient(e,i,r,s)}else e.emit("unexpected-response",_,i)||abortHandshake$1(e,_,`Unexpected server response: ${i.statusCode}`)})),_.on("upgrade",((t,r,s)=>{if(e.emit("upgrade",t),e.readyState!==WebSocket$1.CONNECTING)return;_=e._req=null;const i=createHash$1("sha1").update(h+GUID$1).digest("base64");if(t.headers["sec-websocket-accept"]!==i)return void abortHandshake$1(e,r,"Invalid Sec-WebSocket-Accept header");const o=t.headers["sec-websocket-protocol"];let a;if(void 0!==o?d.size?d.has(o)||(a="Server sent an invalid subprotocol"):a="Server sent a subprotocol but none was requested":d.size&&(a="Server sent no subprotocol"),a)return void abortHandshake$1(e,r,a);o&&(e._protocol=o);const c=t.headers["sec-websocket-extensions"];if(void 0!==c){if(!f){return void abortHandshake$1(e,r,"Server sent a Sec-WebSocket-Extensions header but no extension was requested")}let t;try{t=parse$1(c)}catch(t){return void abortHandshake$1(e,r,"Invalid Sec-WebSocket-Extensions header")}const s=Object.keys(t);if(1!==s.length||s[0]!==PerMessageDeflate$1.extensionName){return void abortHandshake$1(e,r,"Server indicated an extension that was not requested")}try{f.accept(t[PerMessageDeflate$1.extensionName])}catch(t){return void abortHandshake$1(e,r,"Invalid Sec-WebSocket-Extensions header")}e._extensions[PerMessageDeflate$1.extensionName]=f}e.setSocket(r,s,{generateMask:n.generateMask,maxPayload:n.maxPayload,skipUTF8Validation:n.skipUTF8Validation})}))}function emitErrorAndClose(e,t){e._readyState=WebSocket$1.CLOSING,e.emit("error",t),e.emitClose()}function netConnect(e){return e.path=e.socketPath,net.connect(e)}function tlsConnect(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=net.isIP(e.host)?"":e.host),tls.connect(e)}function abortHandshake$1(e,t,r){e._readyState=WebSocket$1.CLOSING;const s=new Error(r);Error.captureStackTrace(s,abortHandshake$1),t.setHeader?(t.abort(),t.socket&&!t.socket.destroyed&&t.socket.destroy(),t.once("abort",e.emitClose.bind(e)),e.emit("error",s)):(t.destroy(s),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function sendAfterClose(e,t,r){if(t){const r=toBuffer(t).length;e._socket?e._sender._bufferedBytes+=r:e._bufferedAmount+=r}if(r){r(new Error(`WebSocket is not open: readyState ${e.readyState} (${readyStates[e.readyState]})`))}}function receiverOnConclude(e,t){const r=this[kWebSocket$1];r._closeFrameReceived=!0,r._closeMessage=t,r._closeCode=e,void 0!==r._socket[kWebSocket$1]&&(r._socket.removeListener("data",socketOnData),process.nextTick(resume,r._socket),1005===e?r.close():r.close(e,t))}function receiverOnDrain(){const e=this[kWebSocket$1];e.isPaused||e._socket.resume()}function receiverOnError(e){const t=this[kWebSocket$1];void 0!==t._socket[kWebSocket$1]&&(t._socket.removeListener("data",socketOnData),process.nextTick(resume,t._socket),t.close(e[kStatusCode])),t.emit("error",e)}function receiverOnFinish(){this[kWebSocket$1].emitClose()}function receiverOnMessage(e,t){this[kWebSocket$1].emit("message",e,t)}function receiverOnPing(e){const t=this[kWebSocket$1];t.pong(e,!t._isServer,NOOP),t.emit("ping",e)}function receiverOnPong(e){this[kWebSocket$1].emit("pong",e)}function resume(e){e.resume()}function socketOnClose(){const e=this[kWebSocket$1];let t;this.removeListener("close",socketOnClose),this.removeListener("data",socketOnData),this.removeListener("end",socketOnEnd),e._readyState=WebSocket$1.CLOSING,this._readableState.endEmitted||e._closeFrameReceived||e._receiver._writableState.errorEmitted||null===(t=e._socket.read())||e._receiver.write(t),e._receiver.end(),this[kWebSocket$1]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",receiverOnFinish),e._receiver.on("finish",receiverOnFinish))}function socketOnData(e){this[kWebSocket$1]._receiver.write(e)||this.pause()}function socketOnEnd(){const e=this[kWebSocket$1];e._readyState=WebSocket$1.CLOSING,e._receiver.end(),this.end()}function socketOnError$1(){const e=this[kWebSocket$1];this.removeListener("error",socketOnError$1),this.on("error",NOOP),e&&(e._readyState=WebSocket$1.CLOSING,this.destroy())}const{tokenChars:tokenChars}=validation.exports;function parse(e){const t=new Set;let r=-1,s=-1,n=0;for(;n<e.length;n++){const i=e.charCodeAt(n);if(-1===s&&1===tokenChars[i])-1===r&&(r=n);else if(0===n||32!==i&&9!==i){if(44!==i)throw new SyntaxError(`Unexpected character at index ${n}`);{if(-1===r)throw new SyntaxError(`Unexpected character at index ${n}`);-1===s&&(s=n);const i=e.slice(r,s);if(t.has(i))throw new SyntaxError(`The "${i}" subprotocol is duplicated`);t.add(i),r=s=-1}}else-1===s&&-1!==r&&(s=n)}if(-1===r||-1!==s)throw new SyntaxError("Unexpected end of input");const i=e.slice(r,n);if(t.has(i))throw new SyntaxError(`The "${i}" subprotocol is duplicated`);return t.add(i),t}var subprotocol$1={parse:parse};const EventEmitter=require$$0__default$2.default,http=require$$2__default.default,{createHash:createHash}=require$$5__default.default,extension=extension$1,PerMessageDeflate=permessageDeflate,subprotocol=subprotocol$1,WebSocket=websocket,{GUID:GUID,kWebSocket:kWebSocket}=constants,keyRegex=/^[+/0-9A-Za-z]{22}==$/,RUNNING=0,CLOSING=1,CLOSED=2;class WebSocketServer extends EventEmitter{constructor(e,t){if(super(),null==(e={maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:WebSocket,...e}).port&&!e.server&&!e.noServer||null!=e.port&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(null!=e.port?(this._server=http.createServer(((e,t)=>{const r=http.STATUS_CODES[426];t.writeHead(426,{"Content-Length":r.length,"Content-Type":"text/plain"}),t.end(r)})),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){const e=this.emit.bind(this,"connection");this._removeListeners=addListeners(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(t,r,s)=>{this.handleUpgrade(t,r,s,e)}})}!0===e.perMessageDeflate&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=e,this._state=RUNNING}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(this._state===CLOSED)return e&&this.once("close",(()=>{e(new Error("The server is not running"))})),void process.nextTick(emitClose,this);if(e&&this.once("close",e),this._state!==CLOSING)if(this._state=CLOSING,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients&&this.clients.size?this._shouldEmitClose=!0:process.nextTick(emitClose,this);else{const e=this._server;this._removeListeners(),this._removeListeners=this._server=null,e.close((()=>{emitClose(this)}))}}shouldHandle(e){if(this.options.path){const t=e.url.indexOf("?");if((-1!==t?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,r,s){t.on("error",socketOnError);const n=void 0!==e.headers["sec-websocket-key"]&&e.headers["sec-websocket-key"],i=+e.headers["sec-websocket-version"];if("GET"!==e.method||"websocket"!==e.headers.upgrade.toLowerCase()||!n||!keyRegex.test(n)||8!==i&&13!==i||!this.shouldHandle(e))return abortHandshake(t,400);const o=e.headers["sec-websocket-protocol"];let a=new Set;if(void 0!==o)try{a=subprotocol.parse(o)}catch(e){return abortHandshake(t,400)}const c=e.headers["sec-websocket-extensions"],l={};if(this.options.perMessageDeflate&&void 0!==c){const e=new PerMessageDeflate(this.options.perMessageDeflate,!0,this.options.maxPayload);try{const t=extension.parse(c);t[PerMessageDeflate.extensionName]&&(e.accept(t[PerMessageDeflate.extensionName]),l[PerMessageDeflate.extensionName]=e)}catch(e){return abortHandshake(t,400)}}if(this.options.verifyClient){const o={origin:e.headers[""+(8===i?"sec-websocket-origin":"origin")],secure:!(!e.socket.authorized&&!e.socket.encrypted),req:e};if(2===this.options.verifyClient.length)return void this.options.verifyClient(o,((i,o,c,h)=>{if(!i)return abortHandshake(t,o||401,c,h);this.completeUpgrade(l,n,a,e,t,r,s)}));if(!this.options.verifyClient(o))return abortHandshake(t,401)}this.completeUpgrade(l,n,a,e,t,r,s)}completeUpgrade(e,t,r,s,n,i,o){if(!n.readable||!n.writable)return n.destroy();if(n[kWebSocket])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>RUNNING)return abortHandshake(n,503);const a=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${createHash("sha1").update(t+GUID).digest("base64")}`],c=new this.options.WebSocket(null);if(r.size){const e=this.options.handleProtocols?this.options.handleProtocols(r,s):r.values().next().value;e&&(a.push(`Sec-WebSocket-Protocol: ${e}`),c._protocol=e)}if(e[PerMessageDeflate.extensionName]){const t=e[PerMessageDeflate.extensionName].params,r=extension.format({[PerMessageDeflate.extensionName]:[t]});a.push(`Sec-WebSocket-Extensions: ${r}`),c._extensions=e}this.emit("headers",a,s),n.write(a.concat("\r\n").join("\r\n")),n.removeListener("error",socketOnError),c.setSocket(n,i,{maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(c),c.on("close",(()=>{this.clients.delete(c),this._shouldEmitClose&&!this.clients.size&&process.nextTick(emitClose,this)}))),o(c,s)}}var websocketServer=WebSocketServer;function addListeners(e,t){for(const r of Object.keys(t))e.on(r,t[r]);return function(){for(const r of Object.keys(t))e.removeListener(r,t[r])}}function emitClose(e){e._state=CLOSED,e.emit("close")}function socketOnError(){this.destroy()}function abortHandshake(e,t,r,s){e.writable&&(r=r||http.STATUS_CODES[t],s={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(r),...s},e.write(`HTTP/1.1 ${t} ${http.STATUS_CODES[t]}\r\n`+Object.keys(s).map((e=>`${e}: ${s[e]}`)).join("\r\n")+"\r\n\r\n"+r)),e.removeListener("error",socketOnError),e.destroy()}var randomId=function(e){return(e?"".concat(e,"_"):"")+Math.floor(1e5*Math.random())},pseudoObjectId=function(e,t,r,s){return void 0===e&&(e=Math),void 0===t&&(t=Date),void 0===r&&(r=16),void 0===s&&(s=function(t){return e.floor(t).toString(r)}),s(t.now()/1e3)+" ".repeat(r).replace(/./g,(function(){return s(e.random()*r)}))},Service=function(){function e(e){var t,r=this;this.id=randomId("service"),this.name="service",this.callbacks=new Map,this.status=!1,this.serviceType="default",this.routes=[],this.delegate=null===(t=null===globalThis||void 0===globalThis?void 0:globalThis.document)||void 0===t?void 0:t.createDocumentFragment(),this.protocols={},this.services={},this.setEndpointRoute=function(e){r.route=e},this.notify=function(e,t,s){return __awaiter(r,void 0,void 0,(function(){var r,n=this;return __generator(this,(function(i){switch(i.label){case 0:return r=[],[4,Promise.all(Array.from(this.callbacks).map((function(i,o){return __awaiter(n,void 0,void 0,(function(){var n;return __generator(this,(function(o){switch(o.label){case 0:return[4,i[1](e,t,s)];case 1:return!(n=o.sent())||n instanceof Error||r.push(n),[2]}}))}))})))];case 1:return i.sent(),[2,null==r?void 0:r[0]]}}))}))},this.setEndpoint=function(e){r.endpoint=e},this.subscribe=function(e){if(e instanceof Function){var t=randomId();return r.callbacks.set(t,e),t}},this.unsubscribe=function(e){return r.callbacks.delete(e)},this.router=e}return e.prototype.addEventListener=function(){for(var e,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];null===(e=this.delegate)||void 0===e||e.addEventListener.apply(this.delegate,t)},e.prototype.dispatchEvent=function(){for(var e,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return null===(e=this.delegate)||void 0===e?void 0:e.dispatchEvent.apply(this.delegate,t)},e.prototype.removeEventListener=function(){for(var e,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return null===(e=this.delegate)||void 0===e?void 0:e.removeEventListener.apply(this.delegate,t)},e}();function getRouteMatches(e,t){void 0===t&&(t=!0);var r=(e=e.replace(/\/\*\*?/,"")).split("/");t&&(r=r.slice(0,r.length-1));var s=[e];return s.push(e+"/*"),s.push(e+"/**"),r.forEach((function(t,n){var i=r.slice(0,n+1).join("/");i!=e&&(n===r.length-1&&s.push(i+"/*"),s.push(i+"/**"))})),s}var SubscriptionService=function(e){function t(t){var r=e.call(this,t)||this;return r.responses=new Map,r.serviceType="subscription",r.subscribers=new Map,r.updateSubscribers=function(e,t){r.subscribers.forEach((function(r){getRouteMatches(t.route,!1).forEach((function(s){r.routes[s]&&(null==r?void 0:r.send)&&r.send(e.format(t))}))}))},r.add=function(e,t){throw"Add not implemented"},r.addResponse=function(e,t){r.responses.set(e,t)},r.removeResponse=function(e){e?r.responses.delete(e):r.responses=new Map},r.send=function(e,t){return __awaiter(r,void 0,void 0,(function(){return __generator(this,(function(e){throw"Send not implemented"}))}))},r}return __extends(t,e),t}(Service),WebsocketService=function(e){function t(t,r){var s=e.call(this,t)||this;return s.name="websocket",s.wss=new websocketServer({clientTracking:!1,noServer:!0}),s.process=function(e,t){return __awaiter(s,void 0,void 0,(function(){var r,s;return __generator(this,(function(n){switch(n.label){case 0:return this.defaultCallback(e,t),r="".concat(this.name,"/subscribe"),t.route.slice(0,r.length)!==r?[3,2]:[4,this.addSubscription(t,e)];case 1:return[2,n.sent()];case 2:return[4,this.notify(t)];case 3:"object"==typeof(s=n.sent())&&(s.callbackId=t.callbackId),s instanceof Error?e.send(JSON.stringify(s,Object.getOwnPropertyNames(s))):null!=s&&e.send(JSON.stringify(s)),n.label=4;case 4:return[2]}}))}))},s.defaultCallback=function(e,t){return __awaiter(s,void 0,void 0,(function(){var r;return __generator(this,(function(s){switch(s.label){case 0:return r="".concat(this.name,"/subscribe"),t.route.slice(0,r.length)!==r?[3,2]:[4,this.addSubscription(t,e)];case 1:return[2,s.sent()];case 2:return[2]}}))}))},s.addSubscription=function(e,t){return __awaiter(s,void 0,void 0,(function(){var r,s,n,i,o,a=this;return __generator(this,(function(c){return r=null!==(i=e.id)&&void 0!==i?i:pseudoObjectId(),s=null===(o=e.message)||void 0===o?void 0:o[0],(n=this.subscribers.get(r))||(n={id:r,routes:{},send:function(e){e.message&&e.route&&t.send(JSON.stringify(e))}},t.on("close",(function(){a.subscribers.delete(r)})),this.subscribers.set(r,n)),null==s||s.forEach((function(e){return __awaiter(a,void 0,void 0,(function(){return __generator(this,(function(t){return n.routes[e]=!0,[2]}))}))})),[2]}))}))},s.server=r,s.init(),s}return __extends(t,e),t.prototype.init=function(){return __awaiter(this,void 0,void 0,(function(){var e=this;return __generator(this,(function(t){return this.server.on("upgrade",(function(t,r,s){return __awaiter(e,void 0,void 0,(function(){var e=this;return __generator(this,(function(n){return this.wss.handleUpgrade(t,r,s,(function(r){e.wss.emit("connection",r,t)})),[2]}))}))})),this.wss.on("connection",(function(t,r){return __awaiter(e,void 0,void 0,(function(){var e,r=this;return __generator(this,(function(s){switch(s.label){case 0:return e={},decodeURIComponent(t.protocol).split(";").forEach((function(t){if(t){var r=t.split("/"),s=__read(r[2].split("?"),2),n=s[0],i=s[1],o={};i.split("&").forEach((function(e){var t=__read(e.split("="),2),r=t[0],s=t[1];o[r]=s})),e[r[1]]="true"===o.arr?n.split(","):n}})),[4,this.notify({route:"addUser",message:[Object.assign(e,{send:function(e){1===t.readyState&&t.send(JSON.stringify(e))}})]})];case 1:return s.sent(),t.on("message",(function(e){void 0===e&&(e="");var s=JSON.parse(e);Array.isArray(s)?s.forEach((function(e){r.process(t,e)})):r.process(t,s)})),t.on("close",(function(e){return console.log("WS closed")})),[2]}}))}))})),[2]}))}))},t.type="backend",t}(SubscriptionService),safeParse=function(input){if("string"==typeof input&&(input=JSON.parse(input)),"object"==typeof input){for(var key in input){var value=input[key],regex=new RegExp("(|[a-zA-Z]w*|([a-zA-Z]w*(,s*[a-zA-Z]w*)*))s*=>"),func="string"==typeof value&&"function"==value.substring(0,8),arrow="string"==typeof value&&regex.test(value);try{input[key]=func||arrow?eval("("+value+")"):value}catch(e){console.error(e,value),input[key]=value}"object"==typeof input[key]&&safeParse(input[key])}return input}return{}},EventsBackend=function(e){function t(t){var r=e.call(this,t)||this;return r.name="events",r.id=randomId("events"),r.updateUser=function(e,t,s){return __awaiter(r,void 0,void 0,(function(){var r,n,i,o,a,c,l,h,u,d=this;return __generator(this,(function(f){switch(f.label){case 0:return r=null===(c=e.message)||void 0===c?void 0:c[1],n=null!==(h=null!==(l=e.id)&&void 0!==l?l:r)&&void 0!==h?h:randomId("sse"),i=null===(u=e.message)||void 0===u?void 0:u[0],o=this.subscribers.get(null!=r?r:n),r&&o?(o.id=n,o.id==r?[3,2]:(this.subscribers.delete(r),[4,this.notify({route:"addUser",message:[{id:n,send:o.send}]})])):[3,3];case 1:f.sent(),f.label=2;case 2:return s.send(JSON.stringify({message:[!0]})),[3,4];case 3:o||(o={id:n,routes:{},send:function(e){(null==e?void 0:e.message)&&(null==e?void 0:e.route)&&s.write("data: ".concat(JSON.stringify(e),"\n\n"))}},a={"Content-Type":"text/event-stream",Connection:"keep-alive","Cache-Control":"no-cache"},s.writeHead(200,a),o.send({route:"events/subscribe",message:[n]}),t.on("close",(function(){d.subscribers.delete(o.id)}))),f.label=4;case 4:return this.subscribers.set(n,o),i&&i.forEach((function(e){return __awaiter(d,void 0,void 0,(function(){return __generator(this,(function(t){return o.routes[e]=!0,[2]}))}))})),[2,n]}}))}))},r}return __extends(t,e),t}(SubscriptionService),HTTPService=function(e){function t(t){var r=e.call(this,t)||this;return r.name="http",r.id=randomId("http"),r.services={events:null},r.routes=[{route:"add",post:function(e,t){return __awaiter(r,void 0,void 0,(function(){var r,s;return __generator(this,(function(n){return r={html:null!==(s=t[1])&&void 0!==s?s:"<p>Just a test lol</p>"},e.addRoute({route:t[0],get:r,headers:{"Content-Type":"text/html"},post:function(e,t){return r.html=t[0],{message:[r.html]}}}),[2,!0]}))}))}}],r.controller=function(e,t){return __awaiter(r,void 0,void 0,(function(){var r,s,n,i,o;return __generator(this,(function(a){return r=e.route.path.replace(/\/?\*?\*/,""),"/"===(s=e.originalUrl.replace(r,""))[0]&&(s=s.slice(1)),n=Object.keys(e.route.methods).find((function(t){return e.route.methods[t]})),(i=safeParse(e.body)).method=n,o="".concat(this.name,"/subscribe"),s.slice(0,o.length)==o?s.slice(0,o.length)==o&&(s=s.slice(o.length),this.services.events.updateUser(i,e,t)):this.handleRoute(s,i).then((function(e){var r,s;if(e instanceof Error)t.status(404).send(JSON.stringify(e,Object.getOwnPropertyNames(e)));else if(null!=e){for(var n in null==e?void 0:e.headers)t.setHeader(n,e.headers[n]);"text/html"===t.getHeader("Content-Type")?t.send(null===(s=null===(r=e.message)||void 0===r?void 0:r[0])||void 0===s?void 0:s.html):(t.setHeader("Content-Type","application/json"),t.send(JSON.stringify(e)))}})),[2]}))}))},r.handleRoute=function(e,t){return __awaiter(r,void 0,void 0,(function(){return __generator(this,(function(r){switch(r.label){case 0:return t.route=e,[4,this.notify(t)];case 1:return[2,r.sent()]}}))}))},r.services.events=new EventsBackend(t),r.services.events.subscribe(r.notify),r.updateSubscribers=r.services.events.updateSubscribers,r.subscribers=r.services.events.subscribers,r}return __extends(t,e),t.type="backend",t}(SubscriptionService);exports.HTTPService=HTTPService,exports.WebsocketService=WebsocketService,Object.defineProperty(exports,"__esModule",{value:!0})}));
